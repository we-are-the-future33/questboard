<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>í‚¤ì› â€” ê³µê°œ í”„ë¡œí•„</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css?v=20260302t">
<style>
body{background:#f1f5f9;display:flex;justify-content:center;margin:0;padding:0;}
.pub-mobile-wrap{max-width:440px;width:100%;background:var(--bg,#fff);height:100vh;display:flex;flex-direction:column;overflow:hidden;}
.pub-global-bar{padding:18px 20px 4px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.pub-global-bar .logo{font-family:var(--font-main);font-size:22px;font-weight:800;color:var(--accent);}
#content{flex:1;display:flex;flex-direction:column;overflow:hidden;min-height:0;}
/* Floating bottom banner */
.pub-float-banner{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);max-width:400px;width:calc(100% - 40px);background:rgba(30,41,59,.92);backdrop-filter:blur(8px);color:#e2e8f0;padding:10px 16px;border-radius:14px;font-size:12px;font-weight:600;text-align:center;z-index:100;box-shadow:0 4px 20px rgba(0,0,0,.25);line-height:1.5;}
.pub-float-banner .pub-float-dot{display:inline;color:#64748b;margin:0 2px;}
.pub-scroll{flex:1;overflow-y:auto;overflow-x:hidden;padding-bottom:70px;}
/* Override sub-tab-bar for public context */
.pub-scroll .sub-tab-bar{margin:8px 20px 0;position:sticky;top:0;z-index:30;}
/* Tab bar - reuse style.css .tab-bar but sticky inside pub-mobile-wrap */
.pub-mobile-wrap .tab-bar{position:sticky;top:0;z-index:40;flex-shrink:0;}
/* Footer */
.pub-footer{text-align:center;padding:30px 20px;font-size:11px;color:var(--text-dim);border-top:1px solid var(--border);margin-top:20px;}
.pub-footer a{color:var(--accent);text-decoration:none;font-weight:700;}
/* Loading/Error */
.pub-loading{text-align:center;padding:80px 20px;font-size:14px;color:var(--text-dim);}
.pub-error{text-align:center;padding:80px 20px;font-size:14px;color:#ff5e7d;}
/* Cheers */
.pub-cheers{padding:16px 20px;border-top:2px solid var(--border);margin-top:10px;}
.pub-cheers-title{font-size:15px;font-weight:800;margin-bottom:14px;}
.pub-cheer-item{background:var(--surface);border-radius:12px;padding:12px 14px;margin-bottom:8px;border:1px solid var(--border);}
.pub-cheer-from{font-size:12px;font-weight:700;color:var(--accent);margin-bottom:2px;}
.pub-cheer-text{font-size:14px;font-weight:600;}
.pub-cheer-time{font-size:11px;color:var(--text-dim);margin-top:4px;}
.pub-empty{text-align:center;color:var(--text-dim);font-size:13px;padding:30px 0;}
/* Alert */
.pub-alert{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:999;}
.pub-alert-box{background:#fff;border-radius:16px;padding:24px;max-width:300px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,.2);}
.pub-alert-box p{font-size:14px;font-weight:700;margin-bottom:16px;line-height:1.5;}
.pub-alert-box button{background:var(--accent);color:#fff;border:none;padding:10px 28px;border-radius:10px;font-size:13px;font-weight:700;font-family:var(--font-main);cursor:pointer;}
</style>
</head>
<body>
<div class="pub-mobile-wrap" id="appWrap">
  <div class="pub-global-bar">
    <div class="logo">í‚¤ì›</div>
    <div style="font-size:10px;font-weight:700;background:var(--accent);color:#fff;padding:3px 10px;border-radius:20px;">ğŸ‘€ ê³µê°œ í”„ë¡œí•„</div>
  </div>
  <div id="content">
    <div class="pub-loading">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  </div>
</div>

<!-- Bottom Sheet (read-only) -->
<div class="bottomsheet-overlay" id="bsOverlay" onclick="closePubBS()"></div>
<div class="bottomsheet" id="bottomSheet">
  <div class="bs-handle"><div class="bs-handle-bar"></div></div>
  <div class="bs-header">
    <div>
      <div class="bs-title" id="bsTitle">ëª©í‘œ ìƒì„¸</div>
      <div class="bs-meta-tags" id="bsMetaTags"></div>
    </div>
    <button class="bs-close" onclick="closePubBS()">âœ•</button>
  </div>
  <div class="bs-body" id="bsBody"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const app = initializeApp({
  apiKey: "AIzaSyAbEbLdJuWVai_NKTHuo1XtC8p76dmVPE0",
  authDomain: "grow-goal.firebaseapp.com",
  databaseURL: "https://grow-goal-default-rtdb.firebaseio.com",
  projectId: "grow-goal",
  storageBucket: "grow-goal.firebasestorage.app",
  messagingSenderId: "587441793315",
  appId: "1:587441793315:web:8ae5325a2af90953ce4496"
});
const db = getDatabase(app);

const MAX_HABITS = 25;
const LEGACY_MAP = { w1:{unit:'weekly',freq:1}, w2:{unit:'weekly',freq:2}, w4:{unit:'weekly',freq:4}, w6:{unit:'weekly',freq:6} };
const TIME_LABELS = { any:'ğŸ”„ ì–¸ì œë‚˜', dawn:'ğŸŒ… ìƒˆë²½', morning:'ğŸŒ¤ ì•„ì¹¨', midday:'ğŸ ë‚®', afternoon:'ğŸŒ‡ ì˜¤í›„', evening:'ğŸŒŸ ì €ë…', night:'ğŸ¦‰ ë°¤' };
const CAT_LABELS = { health:'ğŸ’ª ê±´ê°• & ì²´ë ¥', diet:'ğŸ¥— ì‹ë‹¨ & ì˜ì–‘', study:'ğŸ“š í•™ìŠµ & ì„±ì¥', work:'ğŸ’¼ ì—…ë¬´ & ì»¤ë¦¬ì–´', finance:'ğŸ’° ì¬ë¬´ & ìì‚°', life:'ğŸŒ± ìƒí™œ & ë£¨í‹´', home:'ğŸ§¹ ì§‘ì•ˆì¼ & ì •ë¦¬', hobby:'ğŸ¨ ì·¨ë¯¸ & ì°½ì‘', social:'ğŸ¤ ê´€ê³„ & ì†Œì…œ', mental:'ğŸ§˜ íœ´ì‹ & ë©˜íƒˆ', etc:'ğŸ“¦ ê¸°íƒ€' };
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML;}
function migrateGoal(g){if(!g)return g;if(LEGACY_MAP[g.unit])return Object.assign({},g,LEGACY_MAP[g.unit]);return g;}
function getUnitLabel(g){if(!g)return '';g=migrateGoal(g);if(g.unit==='once')return'í•œ ë²ˆ';if(g.unit==='daily')return'ë§¤ì¼';if(g.unit==='health_sleep')return'ğŸŒ™ ìˆ˜ë©´';if(g.unit==='health_workout')return'ğŸ’ª ìš´ë™';if(g.unit==='weekly')return`ì£¼ ${g.freq}íšŒ`;return g.unit;}
function getMonthDays(y,m){return new Date(y,m,0).getDate();}
function getMonthWeeks(y,m){return Math.ceil(getMonthDays(y,m)/7);}
function goalModulus(g,gi,y,m){if(!g||!g.unit||g.unit==='once')return 1;g=migrateGoal(g);if(g.unit==='daily'||g.unit==='health_sleep'||g.unit==='health_workout')return getMonthDays(y,m);if(g.unit==='weekly')return(g.freq||1)*getMonthWeeks(y,m);if(g.unit==='biweekly')return(g.freq||1)*Math.ceil(getMonthDays(y,m)/14);if(g.unit==='multiweek')return(g.freq||1)*Math.ceil(getMonthDays(y,m)/((g.weeks||3)*7));return 1;}
function goalDone(g,gi,y,m,c){if(!g||!g.unit)return 0;if(g.unit==='once')return c[`g${gi}_once`]===true?1:0;return Object.entries(c).filter(([k,v])=>k.startsWith(`g${gi}_${y}_${m}_`)&&v===true).length;}
function goalPct(g,gi,y,m,c){const mod=goalModulus(g,gi,y,m),done=goalDone(g,gi,y,m,c);return{done,mod,pct:mod>0?Math.round(done/mod*100):0};}
function calcStreak(g,gi,c){if(!g||!g.unit||g.unit==='once')return 0;g=migrateGoal(g);if(g.unit==='daily'||g.unit==='health_sleep'||g.unit==='health_workout'){const now=new Date();let s=0;if(c[`g${gi}_${now.getFullYear()}_${now.getMonth()+1}_${now.getDate()}`])s++;for(let d=1;d<=365;d++){const dt=new Date(now);dt.setDate(dt.getDate()-d);if(c[`g${gi}_${dt.getFullYear()}_${dt.getMonth()+1}_${dt.getDate()}`])s++;else break;}return s;}return 0;}
function getStreakLabel(g,streak){g=migrateGoal(g);if(g&&(g.unit==='weekly'||g.unit==='biweekly'||g.unit==='multiweek'))return`${streak}ì£¼ì§¸`;return`${streak}ì¼ì§¸`;}

function pubAlert(msg){
  const d=document.createElement('div');d.className='pub-alert';
  d.innerHTML=`<div class="pub-alert-box"><p>${msg}</p><button onclick="this.closest('.pub-alert').remove()">í™•ì¸</button></div>`;
  document.body.appendChild(d);
}
window.pubAlert=pubAlert;

const hash=new URLSearchParams(location.search).get('id');
if(!hash){document.getElementById('content').innerHTML='<div class="pub-error">ì˜ëª»ëœ ë§í¬ì˜ˆìš”.</div>';}
else{loadProfile(hash);}

async function loadProfile(hash){
  try{
    const ls=await get(ref(db,`publicLinks/${hash}`));
    if(!ls.exists()){document.getElementById('content').innerHTML='<div class="pub-error">ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í”„ë¡œí•„ì´ì—ìš”.</div>';return;}
    const uid=ls.val();
    const[uS,dS,cS]=await Promise.all([get(ref(db,`users/${uid}`)),get(ref(db,`dashboards/${uid}`)),get(ref(db,`cheers/${uid}`))]);
    if(!uS.exists()||!dS.exists()){document.getElementById('content').innerHTML='<div class="pub-error">í”„ë¡œí•„ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ìš”.</div>';return;}
    render(uS.val(),dS.val(),cS.exists()?cS.val():{},uid);
  }catch(e){console.error(e);document.getElementById('content').innerHTML='<div class="pub-error">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆì–´ìš”.</div>';}
}

let pubViewMode = 'all';
let pubCViewMode = 'all';
let _goals, _comp, _challenges;

function render(user,dash,cheersData,uid){
  const src=dash.goals||{};
  if(!Array.isArray(src)){const a=[];Object.keys(src).forEach(k=>{a[parseInt(k)]=src[k];});dash.goals=a;}
  _goals=[];for(let i=0;i<MAX_HABITS;i++)_goals.push((dash.goals||[])[i]||null);
  _comp=dash.completions||{};
  const rawC=dash.challenges||[];
  _challenges=Array.isArray(rawC)?rawC:Object.values(rawC);
  const nick=dash.nickname||user.name||'ìµëª…';

  // Build structure matching app's HTML
  let h='';
  // Tab bar (ë‚˜ì˜ íˆ¬ë‘ / ì¹œêµ¬)
  h+=`<div class="tab-bar" id="pubTabBar">`;
  h+=`<button class="tab-btn active" onclick="pubAlert('ê³µê°œ ëª¨ë“œì—ì„œëŠ” í™•ì¸í•  ìˆ˜ ì—†ì–´ìš”')">ğŸ¯ ë‚˜ì˜ íˆ¬ë‘</button>`;
  h+=`<button class="tab-btn" onclick="pubAlert('ğŸ‘€ ë‹¤ë¥¸ ì‚¬ëŒì˜ í”„ë¡œí•„ì´ë¼ ì¹œêµ¬ íƒ­ì€ í™•ì¸í•  ìˆ˜ ì—†ì–´ìš”')">ğŸ‘¥ ì¹œêµ¬</button>`;
  h+=`</div>`;

  // Scrollable area
  h+=`<div class="pub-scroll" id="pubScroll">`;

  // Avatar section
  h+=`<div class="avatar-section" id="avatarSection">`;
  h+=`<div class="avatar-art" id="avatarArt"></div>`;
  h+=`<div class="avatar-info-row">`;
  h+=`<span class="avatar-stage" id="avatarStage">1ë‹¨ê³„</span>`;
  h+=`<span class="avatar-nickname" id="avatarNickname">${esc(nick)}</span>`;
  h+=`</div>`;
  h+=`<div id="pubFriendBanner"></div>`;
  h+=`</div>`;

  // Sub tab bar
  h+=`<div class="sub-tab-bar">`;
  h+=`<button class="sub-tab-btn active" id="stH" onclick="switchPubTab('habit')">ìŠµê´€</button>`;
  h+=`<button class="sub-tab-btn" id="stC" onclick="switchPubTab('challenge')">ë„ì „</button>`;
  h+=`</div>`;

  // Habit panel
  h+=`<div class="sub-tab-panel active" id="pH">`;
  h+=`<div class="section-hdr"><div class="section-hdr-left"><div class="section-hdr-title">ë‚˜ì˜ íˆ¬ë‘</div><div class="section-hdr-count" id="hCount">0</div></div>`;
  h+=`<div style="display:flex;align-items:center;"><select class="view-mode-select" onchange="changePubHView(this.value)"><option value="all">ê¸°ë³¸ ë³´ê¸°</option><option value="time">ì‹œê°„ëŒ€ë³„</option><option value="category">ì¹´í…Œê³ ë¦¬ë³„</option></select>`;
  h+=`<button class="filter-pill active-filter" id="hFilterPill" onclick="togglePubHFilter()">ì§„í–‰ ì¤‘ <span class="filter-dot"></span></button>`;
  h+=`</div></div>`;
  h+=`<div id="hList"></div>`;
  h+=`</div>`;

  // Challenge panel
  h+=`<div class="sub-tab-panel" id="pC">`;
  h+=`<div class="section-hdr"><div class="section-hdr-left"><div class="section-hdr-title">ë‚˜ì˜ ë„ì „</div><div class="section-hdr-count" id="cCount">0</div></div>`;
  h+=`<div style="display:flex;align-items:center;"><select class="view-mode-select" onchange="changePubCView(this.value)"><option value="all">ê¸°ë³¸ ë³´ê¸°</option><option value="type">ìœ í˜•ë³„</option><option value="category">ì¹´í…Œê³ ë¦¬ë³„</option></select>`;
  h+=`<button class="filter-pill active-filter" id="cFilterPill" onclick="togglePubCFilter()">ì§„í–‰ ì¤‘ <span class="filter-dot"></span></button>`;
  h+=`</div></div>`;
  h+=`<div id="cList"></div>`;
  h+=`</div>`;

  // Divider
  h+=`<div style="height:2px;background:var(--border);margin:20px 20px 0;"></div>`;

  // Cheers
  let allCheers=[];
  Object.entries(cheersData).forEach(([gi,msgs])=>{Object.entries(msgs).forEach(([ts,msg])=>{allCheers.push({...msg,ts:parseInt(ts)});});});
  allCheers.sort((a,b)=>b.ts-a.ts);
  h+=`<div class="pub-cheers"><div class="pub-cheers-title">ğŸ’¬ ë°›ì€ ì‘ì› (${allCheers.length})</div>`;
  if(allCheers.length===0){h+=`<div class="pub-empty">ì•„ì§ ë°›ì€ ì‘ì›ì´ ì—†ì–´ìš”</div>`;}
  else{allCheers.slice(0,10).forEach(c=>{const d=new Date(c.ts);h+=`<div class="pub-cheer-item"><div class="pub-cheer-from">${esc(c.from)}</div><div class="pub-cheer-text">${esc(c.text)}</div><div class="pub-cheer-time">${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}</div></div>`;});}
  h+=`</div>`;

  h+=`<div class="pub-footer">ğŸ¹ <a href="./">í‚¤ì›</a>ì—ì„œ ë‚˜ë§Œì˜ ëª©í‘œë¥¼ í‚¤ì›Œë³´ì„¸ìš”</div>`;
  h+=`</div>`; // close pub-scroll

  document.getElementById('content').innerHTML=h;

  // Compute stage
  const now=new Date(),y=now.getFullYear(),m=now.getMonth()+1;
  let td=0,tm=0;
  _goals.forEach((g,i)=>{if(!g||!g.unit)return;const r=goalPct(g,i,y,m,_comp);td+=r.done;tm+=r.mod;});
  const gPct=tm>0?Math.round(td/tm*100):0;
  const stage=Math.min(9,Math.floor(gPct/10));
  document.getElementById('avatarStage').textContent=`${stage+1}ë‹¨ê³„`;

  renderHabits();
  renderChallenges();
  applyTimeBackground();
  renderPubFriendBanner(uid);

  // Floating bottom banner
  const existingBanner=document.getElementById('pubFloatBanner');
  if(existingBanner)existingBanner.remove();
  const banner=document.createElement('div');
  banner.className='pub-float-banner';
  banner.id='pubFloatBanner';
  banner.innerHTML=`ğŸ¹ ${esc(nick)}ì˜ ê³µê°œ ëŒ€ì‹œë³´ë“œì…ë‹ˆë‹¤<br><span style="opacity:.7">ì²´í—˜ë§Œ ê°€ëŠ¥</span> <span class="pub-float-dot">Â·</span> <span style="opacity:.7">ê°€ì…ì€ ë³„ë„ ë¬¸ì˜</span>`;
  document.body.appendChild(banner);

  // 3D hamster
  const artEl=document.getElementById('avatarArt');
  if(artEl){const s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js';s.onload=()=>buildHamster(artEl);document.head.appendChild(s);}
}

function isGoalActiveThisWeekPub(g,gi){
  if(!g||!g.unit)return true;g=migrateGoal(g);
  if(g.unit==='once')return _comp[`g${gi}_once`]!==true;
  if(g.unit==='daily'||g.unit==='health_sleep'||g.unit==='health_workout')return true;
  const freq=g.freq||1,now=new Date(),dow=now.getDay();
  const ws=new Date(now);ws.setDate(now.getDate()-dow);
  if(g.unit==='weekly'){
    let wd=0;for(let d=0;d<7;d++){const dd=new Date(ws);dd.setDate(ws.getDate()+d);if(dd>now)break;if(_comp[`g${gi}_${dd.getFullYear()}_${dd.getMonth()+1}_${dd.getDate()}`]===true)wd++;}
    return wd<freq;
  }
  return true;
}
function isChallengeCompletePub(c){
  if(c.type==='bucket'||!c.type)return c.done===true;
  if(c.type==='project'){const stages=c.stages||[];const all=stages.flatMap(s=>s.tasks||[]);return all.length>0&&all.every(t=>t.done);}
  return false;
}

function renderHabits(){
  const now=new Date(),y=now.getFullYear(),m=now.getMonth()+1;
  let activeGoals=[];
  _goals.forEach((g,i)=>{if(g&&g.unit)activeGoals.push({g,idx:i});});
  document.getElementById('hCount').textContent=activeGoals.length;

  // Filter
  if(pubHFilter==='active') activeGoals=activeGoals.filter(({g,idx})=>isGoalActiveThisWeekPub(g,idx));

  // Sort: today-done last
  const sorted=activeGoals.map(({g,idx})=>{
    const mg=migrateGoal(g);const todayK=`g${idx}_${y}_${m}_${now.getDate()}`;
    const isDone=_comp[todayK]===true||(mg.unit==='once'&&_comp[`g${idx}_once`]);
    return{g,idx,isDone};
  }).sort((a,b)=>a.isDone===b.isDone?0:a.isDone?1:-1);

  let html='';
  if(pubViewMode==='time'){
    const groups={dawn:[],morning:[],midday:[],afternoon:[],evening:[],night:[],any:[]};
    sorted.forEach(v=>{const t=v.g.time||'any';(groups[t]||groups.any).push(v);});
    Object.keys(groups).forEach(key=>{
      if(!groups[key].length)return;
      html+=`<div class="group-header"><div class="group-header-left">${TIME_LABELS[key]||key} <span style="font-size:12px;color:var(--accent);">${groups[key].length}</span></div></div>`;
      html+=`<div class="card-grid">`;
      groups[key].forEach(v=>{html+=habitCard(v.g,v.idx);});
      html+=`</div>`;
    });
  }else if(pubViewMode==='category'){
    const groups={};Object.keys(CAT_LABELS).forEach(k=>{groups[k]=[];});
    sorted.forEach(v=>{const c=v.g.category||'etc';(groups[c]||groups.etc).push(v);});
    Object.keys(groups).forEach(key=>{
      if(!groups[key].length)return;
      html+=`<div class="group-header"><div class="group-header-left">${CAT_LABELS[key]||key} <span style="font-size:12px;color:var(--accent);">${groups[key].length}</span></div></div>`;
      html+=`<div class="card-grid">`;
      groups[key].forEach(v=>{html+=habitCard(v.g,v.idx);});
      html+=`</div>`;
    });
  }else{
    if(sorted.length===0){html=`<div class="pub-empty">ë“±ë¡ëœ ìŠµê´€ì´ ì—†ì–´ìš”</div>`;}
    else{html+=`<div class="card-grid">`;sorted.forEach(v=>{html+=habitCard(v.g,v.idx);});html+=`</div>`;}
  }
  document.getElementById('hList').innerHTML=html;
  // Init swipe/tap for habit cards
  sorted.forEach(v=>{initPubHabitSwipe(v.idx);});
}

function habitCard(g,idx){
  const now=new Date(),y=now.getFullYear(),m=now.getMonth()+1;
  const mg=migrateGoal(g),{pct}=goalPct(mg,idx,y,m,_comp);
  const todayK=`g${idx}_${y}_${m}_${now.getDate()}`;
  const todayDone=_comp[todayK]===true;
  const isOnce=mg.unit==='once';
  const isCompleted=pct>=100;const isOver=pct>100;
  const isDone=todayDone||(isOnce&&_comp[`g${idx}_once`]);
  const streak=calcStreak(mg,idx,_comp);
  const streakLbl=getStreakLabel(mg,streak);
  return `<div class="habit-card-outer" id="hcO_${idx}">
    <div class="habit-card-swipe-bg-left todo"><div class="swipe-bg-text">âœ“ ì™„ë£Œ</div></div>
    <div class="habit-card-swipe-bg-right done"><div class="swipe-bg-text">â†© ì·¨ì†Œ</div></div>
    <div class="habit-card ${isCompleted?'completed':''} ${isDone?'today-done':''}" id="hc_${idx}" data-done="${isDone?1:0}" style="cursor:pointer;">
      ${isDone?'<div class="habit-card-done-badge">âœ“</div>':''}
      <div><div class="habit-card-title">${esc(g.title)}</div>
      <div class="habit-card-mid"><div class="habit-card-unit">${getUnitLabel(mg)}</div>
      <div class="habit-card-streak ${streak>0?'':'zero'}"><span class="streak-num">${streakLbl}</span></div></div></div>
      <div class="habit-card-bot"><div class="habit-card-bar"><div class="habit-card-bar-fill ${isOver?'over100':''}" style="width:${Math.min(pct,100)}%"></div></div>
      <div class="habit-card-pct">${pct}%</div></div>
    </div></div>`;
}

function renderChallenges(){
  let activeC=[];_challenges.forEach((c,i)=>{if(c)activeC.push({c,idx:i});});
  document.getElementById('cCount').textContent=activeC.length;
  // Filter
  if(pubCFilter==='active') activeC=activeC.filter(v=>!isChallengeCompletePub(v.c));
  let html='';
  if(pubCViewMode==='type'){
    const buckets=activeC.filter(v=>v.c.type==='bucket'||!v.c.type);
    const projects=activeC.filter(v=>v.c.type==='project');
    if(buckets.length){html+=`<div class="group-header"><div class="group-header-left">ğŸ¯ ë²„í‚·ë¦¬ìŠ¤íŠ¸ <span style="font-size:12px;color:var(--accent);">${buckets.length}</span></div></div><div class="card-grid">`;buckets.forEach(v=>{html+=challengeCard(v.c,v.idx);});html+=`</div>`;}
    if(projects.length){html+=`<div class="group-header"><div class="group-header-left">ğŸ“‹ í”„ë¡œì íŠ¸ <span style="font-size:12px;color:var(--accent);">${projects.length}</span></div></div><div class="card-grid">`;projects.forEach(v=>{html+=challengeCard(v.c,v.idx);});html+=`</div>`;}
  }else if(pubCViewMode==='category'){
    const groups={};Object.keys(CAT_LABELS).forEach(k=>{groups[k]=[];});
    activeC.forEach(v=>{const cat=v.c.category||'etc';(groups[cat]||groups.etc).push(v);});
    Object.keys(groups).forEach(key=>{if(!groups[key].length)return;html+=`<div class="group-header"><div class="group-header-left">${CAT_LABELS[key]} <span style="font-size:12px;color:var(--accent);">${groups[key].length}</span></div></div><div class="card-grid">`;groups[key].forEach(v=>{html+=challengeCard(v.c,v.idx);});html+=`</div>`;});
  }else{
    if(activeC.length===0){html=`<div class="pub-empty">ë“±ë¡ëœ ë„ì „ì´ ì—†ì–´ìš”</div>`;}
    else{html+=`<div class="card-grid">`;activeC.forEach(v=>{html+=challengeCard(v.c,v.idx);});html+=`</div>`;}
  }
  document.getElementById('cList').innerHTML=html;
  // Init interactions after render
  activeC.forEach(v=>{if(v.c.type==='bucket'||!v.c.type)initPubBucketSwipe(v.idx);else if(v.c.type==='project')initPubProjectTap(v.idx);});
}

function challengeCard(c,idx){
  if(c.type==='bucket'||!c.type){
    const done=c.done===true;
    return `<div class="challenge-card-outer"><div class="challenge-swipe-bg ${done?'done':'todo'}"><div class="swipe-bg-text">${done?'â†© ì·¨ì†Œ':'âœ“ ì™„ë£Œ'}</div></div><div class="challenge-card type-bucket ${done?'bucket-done':''}" id="cc_${idx}" style="cursor:default;">${done?'<div class="challenge-card-done-badge">âœ“</div>':''}<div><div class="challenge-card-title">${esc(c.title)}</div><span class="challenge-card-type bucket">ë²„í‚·ë¦¬ìŠ¤íŠ¸</span></div>${done?'<div><div class="challenge-card-achieve">ë‹¬ì„± ì™„ë£Œ</div></div>':'<div></div>'}</div></div>`;
  }else{
    const stages=c.stages||[];const all=stages.flatMap(s=>s.tasks||[]);const dn=all.filter(t=>t.done).length;const total=all.length;
    const pct=total>0?Math.round(dn/total*100):0;const projDone=pct>=100;
    return `<div class="challenge-card type-project ${projDone?'project-done':''}" id="cc_${idx}" style="cursor:pointer;">${projDone?'<div class="challenge-card-done-badge">âœ“</div>':''}<div><div class="challenge-card-title">${esc(c.title)}</div><div class="challenge-card-meta-row"><span class="challenge-card-type project">í”„ë¡œì íŠ¸</span><span class="challenge-card-stage">${dn}/${total} ë‹¨ê³„</span></div></div><div><div style="display:flex;align-items:center;gap:6px;"><div class="challenge-card-bar" style="flex:1;"><div class="challenge-card-bar-fill project" style="width:${Math.min(pct,100)}%"></div></div><div class="challenge-card-pct project">${pct}%</div></div></div></div>`;
  }
}

function applyTimeBackground(){
  const section=document.getElementById('avatarSection');if(!section)return;
  const h=new Date().getHours();
  let bg,decoHTML='',nickColor='#111827',stageColor='var(--accent)',stageBg='var(--accent-light)';
  if(h>=0&&h<5){bg='linear-gradient(180deg,#1a1650 0%,#302a78 50%,#4a42a0 100%)';nickColor='#e2e8f0';stageColor='#a5b4fc';stageBg='rgba(165,180,252,.15)';decoHTML=`<div class="sky-deco star" style="top:5%;left:8%;font-size:5px;">âœ¦</div><div class="sky-deco star" style="top:12%;left:15%;font-size:8px;animation-delay:.3s;">âœ¦</div><div class="sky-deco star" style="top:8%;left:48%;font-size:6px;animation-delay:1.2s;">âœ¦</div><div class="sky-deco star" style="top:22%;left:80%;font-size:10px;animation-delay:.6s;">âœ¦</div><div class="sky-deco moon" style="top:2%;right:12%;font-size:26px;">ğŸŒ™</div>`;}
  else if(h>=5&&h<9){bg='linear-gradient(180deg,#ffecd2 0%,#fcb69f 40%,#ff9a9e 100%)';decoHTML=`<div class="sky-deco sun-rise" style="bottom:25%;left:50%;transform:translateX(-50%);font-size:36px;">â˜€ï¸</div><div class="sky-deco cloud" style="top:12%;left:10%;font-size:20px;">â˜ï¸</div><div class="sky-deco cloud" style="top:20%;right:15%;font-size:16px;animation-delay:2s;">â˜ï¸</div>`;}
  else if(h>=9&&h<13){bg='linear-gradient(180deg,#89CFF0 0%,#a0d2f0 50%,#d4ecfc 100%)';decoHTML=`<div class="sky-deco" style="top:6%;right:18%;font-size:32px;">â˜€ï¸</div><div class="sky-deco cloud" style="top:15%;left:8%;font-size:22px;">â˜ï¸</div><div class="sky-deco cloud" style="top:25%;right:10%;font-size:14px;animation-delay:3s;">â˜ï¸</div>`;}
  else if(h>=13&&h<17){bg='linear-gradient(180deg,#74b9ff 0%,#a0c4ff 50%,#d0e8ff 100%)';decoHTML=`<div class="sky-deco" style="top:8%;right:22%;font-size:28px;">â›…</div><div class="sky-deco cloud" style="top:18%;left:12%;font-size:18px;">â˜ï¸</div>`;}
  else if(h>=17&&h<20){bg='linear-gradient(180deg,#3d2a7a 0%,#d4336e 40%,#ff8534 70%,#ffbb5c 100%)';nickColor='#fef3c7';stageColor='#fbbf24';stageBg='rgba(251,191,36,.15)';decoHTML=`<div class="sky-deco cloud" style="top:10%;left:15%;font-size:18px;opacity:.6;">â˜ï¸</div><div class="sky-deco star" style="top:5%;left:25%;font-size:5px;animation-delay:.8s;">âœ¦</div>`;}
  else{bg='linear-gradient(180deg,#111d3a 0%,#1a2d52 40%,#24396a 100%)';nickColor='#e2e8f0';stageColor='#93c5fd';stageBg='rgba(147,197,253,.15)';decoHTML=`<div class="sky-deco moon" style="top:3%;right:15%;font-size:28px;">ğŸŒ™</div><div class="sky-deco star" style="top:5%;left:8%;font-size:6px;">âœ¦</div><div class="sky-deco star" style="top:10%;left:18%;font-size:8px;animation-delay:.5s;">âœ¦</div><div class="sky-deco star" style="top:7%;left:52%;font-size:6px;animation-delay:.8s;">âœ¦</div><div class="sky-deco star" style="top:20%;left:70%;font-size:10px;animation-delay:1.6s;">âœ¦</div><div class="sky-deco star" style="top:25%;right:25%;font-size:7px;animation-delay:1.2s;">âœ¦</div><div class="sky-deco star" style="top:12%;left:85%;font-size:5px;animation-delay:2.5s;">âœ¦</div>`;}
  section.style.background=bg;section.style.position='relative';section.style.overflow='hidden';
  section.insertAdjacentHTML('beforeend',decoHTML);
  const nickEl=document.getElementById('avatarNickname');if(nickEl)nickEl.style.color=nickColor;
  const stageEl=document.getElementById('avatarStage');if(stageEl){stageEl.style.color=stageColor;stageEl.style.background=stageBg;}
  const isDark=(h>=0&&h<9)||h>=17;section.classList.toggle('dark-bg',isDark);
}

let pubHFilter = 'active';
let pubCFilter = 'active';

window.togglePubHFilter=function(){
  pubHFilter=pubHFilter==='all'?'active':'all';
  const pill=document.getElementById('hFilterPill');
  pill.classList.toggle('active-filter',pubHFilter==='active');
  pill.innerHTML=(pubHFilter==='active'?'ì§„í–‰ ì¤‘':'ì „ì²´')+' <span class="filter-dot"></span>';
  renderHabits();
};
window.togglePubCFilter=function(){
  pubCFilter=pubCFilter==='all'?'active':'all';
  const pill=document.getElementById('cFilterPill');
  pill.classList.toggle('active-filter',pubCFilter==='active');
  pill.innerHTML=(pubCFilter==='active'?'ì§„í–‰ ì¤‘':'ì „ì²´')+' <span class="filter-dot"></span>';
  renderChallenges();
};

window.switchPubTab=function(t){
  document.getElementById('stH').classList.toggle('active',t==='habit');
  document.getElementById('stC').classList.toggle('active',t==='challenge');
  document.getElementById('pH').classList.toggle('active',t==='habit');
  document.getElementById('pC').classList.toggle('active',t==='challenge');
  // Scroll so section-hdr is visible below sticky sub-tab-bar
  requestAnimationFrame(()=>{
    const scroll=document.querySelector('.pub-scroll');
    const subBar=document.querySelector('.sub-tab-bar');
    const panel=document.getElementById(t==='habit'?'pH':'pC');
    if(!scroll||!subBar||!panel)return;
    const sHdr=panel.querySelector('.section-hdr');
    if(!sHdr)return;
    const scrollRect=scroll.getBoundingClientRect();
    const hdrRect=sHdr.getBoundingClientRect();
    const subBarH=subBar.offsetHeight+8;
    const target=scroll.scrollTop+(hdrRect.top-scrollRect.top)-subBarH;
    scroll.scrollTo({top:Math.max(0,target),behavior:'smooth'});
  });
};
async function renderPubFriendBanner(uid){
  const el=document.getElementById('pubFriendBanner');if(!el)return;
  try{
    const grpSnap=await get(ref(db,'groups'));
    if(!grpSnap.exists()){el.innerHTML=`<div class="main-friend-banner idle"><span>ì•„ì§ ë“±ë¡ëœ ì¹œêµ¬ê°€ ì—†ì–´ìš” ğŸ¹</span></div>`;return;}
    const groups=grpSnap.val();
    let friendIds=new Set();
    Object.values(groups).forEach(g=>{
      const m=g.members||{};
      if(m[uid]){Object.keys(m).forEach(id=>{if(id!==uid)friendIds.add(id);});}
    });
    if(friendIds.size===0){el.innerHTML=`<div class="main-friend-banner idle"><span>ì•„ì§ ë“±ë¡ëœ ì¹œêµ¬ê°€ ì—†ì–´ìš” ğŸ¹</span></div>`;return;}
    const now=new Date(),y=now.getFullYear(),m=now.getMonth()+1,d=now.getDate();
    const active=[];
    for(const fid of friendIds){
      const dSnap=await get(ref(db,`dashboards/${fid}`));
      if(!dSnap.exists())continue;
      const fd=dSnap.val();
      const comp=fd.completions||{};
      let todayCount=0;
      Object.keys(comp).forEach(k=>{if(k.endsWith(`_${y}_${m}_${d}`)&&comp[k]===true)todayCount++;});
      if(todayCount>0){
        const nick=fd.nickname||fid.slice(0,4);
        active.push({nick,todayCount});
      }
    }
    if(active.length>0){
      const show=active.slice(0,3);
      const rest=active.length-show.length;
      let summary=show.map(f=>`${f.nick} (${f.todayCount})`).join(' Â· ');
      if(rest>0)summary+=` ì™¸ ${rest}ëª…`;
      el.innerHTML=`<div class="main-friend-banner active"><span>${summary} ì˜¤ëŠ˜ ë‹¬ì„± ì¤‘ ğŸ”¥</span></div>`;
    }else{
      el.innerHTML=`<div class="main-friend-banner idle"><span>ì•„ì§ ì•„ë¬´ë„ ì‹œì‘ ì•ˆ í–ˆì–´ìš” ğŸ˜´</span></div>`;
    }
  }catch(e){console.error(e);el.innerHTML=`<div class="main-friend-banner idle"><span>ì¹œêµ¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ì–´ìš”</span></div>`;}
}

window.changePubHView=function(v){pubViewMode=v;renderHabits();};
window.changePubCView=function(v){pubCViewMode=v;renderChallenges();};

// ===== BOTTOM SHEET =====
window.closePubBS=function(){document.getElementById('bsOverlay').classList.remove('open');document.getElementById('bottomSheet').classList.remove('open');};
function openPubBS(){document.getElementById('bsOverlay').classList.add('open');document.getElementById('bottomSheet').classList.add('open');}
function readOnlyAlert(){pubAlert('ğŸ‘€ ê³µê°œ ëª¨ë“œì—ì„œëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ì–´ìš”');}
window.readOnlyAlert=readOnlyAlert;

const TYPE_LABELS={bucket:'ğŸ¯ ë²„í‚·ë¦¬ìŠ¤íŠ¸',project:'ğŸ“‹ í”„ë¡œì íŠ¸'};
function formatTargetMonth(tm){if(!tm||tm==='someday')return'â˜ï¸ ì–¸ì  ê°€';const p=tm.split('-');return`ğŸ“… ${p[0]}ë…„ ${parseInt(p[1])}ì›”`;}

function openPubHabitBS(idx){
  const g=_goals[idx];if(!g||!g.unit)return;
  const mg=migrateGoal(g);
  document.getElementById('bsTitle').textContent=g.title;
  // Meta tags
  const el=document.getElementById('bsMetaTags');
  const unitLbl=getUnitLabel(mg);
  const timeLbl=TIME_LABELS[g.time||'any']||'ğŸ”„ ì–¸ì œë‚˜';
  const catLbl=CAT_LABELS[g.category||'etc']||'ğŸ“¦ ê¸°íƒ€';
  el.innerHTML=`<span class="bs-meta-chip">${unitLbl}</span><span class="bs-meta-chip">${timeLbl}</span><span class="bs-meta-chip">${catLbl}</span>`;
  renderPubHabitBody(idx);
  openPubBS();
}

function renderPubHabitBody(idx){
  const g=migrateGoal(_goals[idx]),body=document.getElementById('bsBody');
  const now=new Date(),y=_viewMonth.year,m=_viewMonth.month;
  const{done,mod,pct}=goalPct(g,idx,y,m,_comp);
  let h='';
  // Month nav
  h+=`<div class="month-nav"><button class="month-nav-btn" onclick="pubBSMonthPrev(${idx})">â€¹</button><div class="month-label">${y}ë…„ ${m}ì›”</div>`;
  const isFutureBlocked=y>now.getFullYear()||(y===now.getFullYear()&&m>=now.getMonth()+1);
  h+=`<button class="month-nav-btn" ${isFutureBlocked?'disabled':''} onclick="pubBSMonthNext(${idx})">â€º</button></div>`;
  // Calendar
  h+=renderPubCalendar(idx,g,y,m);
  // 6-month mini stats
  h+=renderPubStats(idx,g);
  // Edit/Delete buttons (read-only)
  h+=`<button class="proj-edit-btn" onclick="readOnlyAlert()">âœï¸ ìˆ˜ì •</button>`;
  h+=`<button class="proj-edit-btn" style="color:var(--danger,#ef4444);border-color:var(--danger,#ef4444);margin-top:8px;" onclick="readOnlyAlert()">ğŸ—‘ ì‚­ì œ</button>`;
  body.innerHTML=h;
}

let _viewMonth={year:new Date().getFullYear(),month:new Date().getMonth()+1};
window.pubBSMonthPrev=function(idx){_viewMonth.month--;if(_viewMonth.month<1){_viewMonth.month=12;_viewMonth.year--;}renderPubHabitBody(idx);};
window.pubBSMonthNext=function(idx){_viewMonth.month++;if(_viewMonth.month>12){_viewMonth.month=1;_viewMonth.year++;}renderPubHabitBody(idx);};

function renderPubCalendar(idx,g,y,m){
  const now=new Date(),days=getMonthDays(y,m),fd=new Date(y,m-1,1).getDay();
  let h=`<div class="cal-day-row">`;
  ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d=>h+=`<div class="cal-day-lbl">${d}</div>`);
  h+=`</div><div class="cal-grid">`;
  for(let i=0;i<fd;i++)h+=`<div class="cal-cell empty"></div>`;
  for(let d=1;d<=days;d++){
    const k=`g${idx}_${y}_${m}_${d}`,isDone=_comp[k]===true;
    const isToday=y===now.getFullYear()&&m===now.getMonth()+1&&d===now.getDate();
    h+=`<div class="cal-cell ${isDone?'done':''} ${isToday?'today':''}">${d}</div>`;
  }
  h+=`</div>`;
  return h;
}

function renderPubStats(idx,g){
  const now=new Date();
  let h=`<div style="margin-top:16px;"><div style="font-size:12px;font-weight:700;color:var(--text-dim);margin-bottom:8px;">ìµœê·¼ 6ê°œì›”</div><div style="display:flex;gap:6px;">`;
  for(let i=5;i>=0;i--){
    let my=now.getMonth()+1-i,yy=now.getFullYear();
    while(my<1){my+=12;yy--;}
    const{pct}=goalPct(g,idx,yy,my,_comp);
    const barH=Math.max(4,pct*0.6);
    h+=`<div style="flex:1;text-align:center;"><div style="height:60px;display:flex;align-items:flex-end;justify-content:center;"><div style="width:100%;max-width:24px;height:${barH}px;background:${pct>=100?'var(--accent3,#10b981)':'var(--accent)'};border-radius:4px;"></div></div><div style="font-size:10px;color:var(--text-dim);margin-top:4px;">${my}ì›”</div><div style="font-size:10px;font-weight:700;color:${pct>=100?'var(--accent3)':'var(--text)'}">${pct}%</div></div>`;
  }
  h+=`</div></div>`;
  return h;
}

// ===== PROJECT DETAIL BOTTOM SHEET =====
function openPubProjectBS(idx){
  const c=_challenges[idx];if(!c||c.type!=='project')return;
  document.getElementById('bsTitle').textContent=c.title;
  const el=document.getElementById('bsMetaTags');
  const typeLbl=TYPE_LABELS[c.type]||'ğŸ¯ ë²„í‚·ë¦¬ìŠ¤íŠ¸';
  const catLbl=CAT_LABELS[c.category||'etc']||'ğŸ“¦ ê¸°íƒ€';
  const monthLbl=formatTargetMonth(c.targetMonth);
  el.innerHTML=`<span class="bs-meta-chip">${typeLbl}</span><span class="bs-meta-chip">${catLbl}</span><span class="bs-meta-chip">${monthLbl}</span>`;
  const body=document.getElementById('bsBody');
  const stages=c.stages||[];
  const all=stages.flatMap(s=>s.tasks||[]);const dn=all.filter(t=>t.done).length;const total=all.length;
  const pct=total>0?Math.round(dn/total*100):0;
  let h='';
  if(c.why){h+=`<div class="proj-why-box"><span class="proj-why-label">ë‚˜ì˜ ëª©ì </span><div class="proj-why-text">"${esc(c.why)}"</div></div>`;}
  stages.forEach((s,si)=>{
    const tasks=s.tasks||[];const sd=tasks.filter(t=>t.done).length;const allDone=tasks.length>0&&sd===tasks.length;
    h+=`<div class="proj-stage"><div class="proj-stage-hdr"><div class="proj-stage-num ${allDone?'done':''}">${si+1}</div><div class="proj-stage-title">${esc(s.name)}</div></div><div class="proj-task-list">`;
    tasks.forEach(t=>{h+=`<div class="proj-task ${t.done?'task-done':''}" onclick="readOnlyAlert()"><div class="proj-task-check">${t.done?'âœ“':''}</div><div class="proj-task-text">${esc(t.name)}</div></div>`;});
    h+=`</div></div>`;
  });
  h+=`<div style="display:flex;align-items:center;gap:8px;padding:12px 0;"><div style="flex:1;height:8px;background:#f1f5f9;border-radius:100px;overflow:hidden;"><div style="height:100%;width:${Math.min(pct,100)}%;background:linear-gradient(90deg,#60a5fa,#6366f1);border-radius:100px;"></div></div><span style="font-family:var(--font-heading);font-size:16px;color:var(--accent);">${pct}%</span></div>`;
  h+=`<button class="proj-edit-btn" onclick="readOnlyAlert()">âœï¸ ìˆ˜ì •</button>`;
  h+=`<button class="proj-edit-btn" style="color:var(--danger,#ef4444);border-color:var(--danger,#ef4444);margin-top:8px;" onclick="readOnlyAlert()">ğŸ—‘ ì‚­ì œ</button>`;
  body.innerHTML=h;
  openPubBS();
}

// ===== SWIPE & TAP INIT =====
function initPubHabitSwipe(idx){
  const card=document.getElementById(`hc_${idx}`);if(!card)return;
  const outer=document.getElementById(`hcO_${idx}`);
  let sx=0,sy=0,dx=0,swiping=false,locked=false,touchStartTime=0,totalMove=0;
  const TH=60;
  card.addEventListener('touchstart',e=>{
    const t=e.touches[0];sx=t.clientX;sy=t.clientY;dx=0;swiping=false;locked=false;
    touchStartTime=Date.now();totalMove=0;
    card.classList.remove('snapping');
    if(outer)outer.classList.remove('swiping-right','swiping-left');
  },{passive:true});
  card.addEventListener('touchmove',e=>{
    if(locked)return;
    const t=e.touches[0];
    const dX=t.clientX-sx,dY=t.clientY-sy;
    totalMove=Math.abs(dX)+Math.abs(dY);
    if(!swiping&&Math.abs(dY)>Math.abs(dX)){locked=true;return;}
    if(Math.abs(dX)>8)swiping=true;
    if(!swiping)return;
    e.preventDefault();
    dx=dX;
    card.classList.add('swiping');
    card.style.transform=`translateX(${dx}px)`;
    if(outer){outer.classList.toggle('swiping-right',dx>10);outer.classList.toggle('swiping-left',dx<-10);}
  },{passive:false});
  card.addEventListener('touchend',()=>{
    if(outer)outer.classList.remove('swiping-right','swiping-left');
    const elapsed=Date.now()-touchStartTime;
    if(!swiping){
      card.style.transform='';card.classList.remove('swiping');
      if(totalMove<12&&elapsed<600){_viewMonth={year:new Date().getFullYear(),month:new Date().getMonth()+1};openPubHabitBS(idx);}
      return;
    }
    card.classList.remove('swiping');card.classList.add('snapping');
    if(Math.abs(dx)>=TH){pubAlert('ğŸ‘€ ê³µê°œ ëª¨ë“œì—ì„œëŠ” ì™„ë£Œ/ì·¨ì†Œí•  ìˆ˜ ì—†ì–´ìš”');}
    card.style.transform='translateX(0)';dx=0;swiping=false;
  });
  // PC click
  card.addEventListener('click',()=>{_viewMonth={year:new Date().getFullYear(),month:new Date().getMonth()+1};openPubHabitBS(idx);});
  card.style.cursor='pointer';
}

function initPubBucketSwipe(idx){
  const card=document.getElementById(`cc_${idx}`);if(!card)return;
  const outer=card.closest('.challenge-card-outer');
  let sx=0,sy=0,dx=0,swiping=false,locked=false,touchStartTime=0,totalMove=0;
  const TH=60;
  card.addEventListener('touchstart',e=>{
    const t=e.touches[0];sx=t.clientX;sy=t.clientY;dx=0;swiping=false;locked=false;
    touchStartTime=Date.now();totalMove=0;card.classList.remove('snapping');
  },{passive:true});
  card.addEventListener('touchmove',e=>{
    if(locked)return;
    const t=e.touches[0];
    const dX=t.clientX-sx,dY=t.clientY-sy;
    totalMove=Math.abs(dX)+Math.abs(dY);
    if(!swiping&&Math.abs(dY)>Math.abs(dX)){locked=true;return;}
    if(Math.abs(dX)>8)swiping=true;
    if(!swiping)return;
    e.preventDefault();
    dx=dX;
    card.classList.add('swiping');
    card.style.transform=`translateX(${dx}px)`;
    if(outer){outer.classList.toggle('swiping-right',dx>10);outer.classList.toggle('swiping-left',dx<-10);}
  },{passive:false});
  card.addEventListener('touchend',()=>{
    if(outer)outer.classList.remove('swiping-right','swiping-left');
    if(!swiping){card.style.transform='';card.classList.remove('swiping');return;}
    card.classList.remove('swiping');card.classList.add('snapping');
    if(Math.abs(dx)>=TH){pubAlert('ğŸ‘€ ê³µê°œ ëª¨ë“œì—ì„œëŠ” ì™„ë£Œ/ì·¨ì†Œí•  ìˆ˜ ì—†ì–´ìš”');}
    card.style.transform='translateX(0)';dx=0;swiping=false;
  });
}

function initPubProjectTap(idx){
  const card=document.getElementById(`cc_${idx}`);if(!card)return;
  card.addEventListener('click',()=>openPubProjectBS(idx));
  card.style.cursor='pointer';
}

function initAllInteractions(){
  _goals.forEach((g,i)=>{if(g&&g.unit)initPubHabitSwipe(i);});
  _challenges.forEach((c,i)=>{if(!c)return;if(c.type==='bucket'||!c.type)initPubBucketSwipe(i);else if(c.type==='project')initPubProjectTap(i);});
}
function buildHamster(container){
  if(typeof THREE==='undefined'){container.innerHTML='ğŸ¹';return;}
  let scene,camera,renderer,hamster,handsGroup,seed,clock=new THREE.Clock(),mouse=new THREE.Vector2(),targetRotation=new THREE.Vector2(),eyes=[],isBlinking=false;
  function outline(g,t=0.03,c=0x332211){const m=new THREE.MeshBasicMaterial({color:c,side:THREE.BackSide}),o=new THREE.Mesh(g,m);o.scale.multiplyScalar(1+t);return o;}
  const emojis=['â¤ï¸','â­','ğŸŒŸ','âœ¨','ğŸ’–','ğŸ‰','ğŸ’•','ğŸŒˆ','ğŸ€','ğŸ‘'];
  function spawnEmoji(cx,cy){for(let i=0;i<6;i++){const e=document.createElement('div');e.textContent=emojis[Math.floor(Math.random()*emojis.length)];e.style.cssText=`position:absolute;font-size:${18+Math.random()*14}px;pointer-events:none;z-index:10;left:${cx-10+(Math.random()-0.5)*80}px;top:${cy-10}px;opacity:1;transition:none;`;container.style.position='relative';container.appendChild(e);const dx=(Math.random()-0.5)*120,dy=-(40+Math.random()*80),rot=(Math.random()-0.5)*60;requestAnimationFrame(()=>{e.style.transition='all 1.6s cubic-bezier(.15,.9,.3,1)';e.style.transform=`translate(${dx}px,${dy}px) rotate(${rot}deg)`;e.style.opacity='0';});setTimeout(()=>e.remove(),1800);}}
  scene=new THREE.Scene();camera=new THREE.PerspectiveCamera(30,1,0.1,1000);camera.position.set(0,0,8.5);
  renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});renderer.setSize(280,280);renderer.setPixelRatio(Math.min(window.devicePixelRatio,2));container.innerHTML='';container.appendChild(renderer.domElement);
  scene.add(new THREE.AmbientLight(0xffffff,1.0));const dl=new THREE.DirectionalLight(0xfff5e6,0.9);dl.position.set(2,5,4);scene.add(dl);
  const oM=new THREE.MeshToonMaterial({color:0xfdd5a0}),cM=new THREE.MeshToonMaterial({color:0xfffdf5}),pM=new THREE.MeshToonMaterial({color:0xffc4d0}),dM=new THREE.MeshBasicMaterial({color:0x332a26});
  hamster=new THREE.Group();scene.add(hamster);
  const bG=new THREE.SphereGeometry(1.2,64,64),b=new THREE.Mesh(bG,oM);b.scale.set(1.05,0.95,0.95);b.add(outline(bG,0.025,0x5a3e2b));hamster.add(b);
  const blG=new THREE.SphereGeometry(1.05,64,64),bl=new THREE.Mesh(blG,cM);bl.position.set(0,-0.2,0.2);bl.scale.set(1.05,0.95,1.0);bl.add(outline(blG,0.02,0x5a3e2b));hamster.add(bl);
  const ckG=new THREE.SphereGeometry(0.5,32,32);const lC=new THREE.Mesh(ckG,cM);lC.position.set(-0.55,-0.25,0.7);lC.scale.set(1.1,0.9,0.8);lC.add(outline(ckG,0.03,0x5a3e2b));hamster.add(lC);const rC=new THREE.Mesh(ckG,cM);rC.position.set(0.55,-0.25,0.7);rC.scale.set(1.1,0.9,0.8);rC.add(outline(ckG,0.03,0x5a3e2b));hamster.add(rC);
  const mzG=new THREE.SphereGeometry(0.35,32,32),mz=new THREE.Mesh(mzG,cM);mz.scale.set(1.2,0.8,0.8);mz.position.set(0,-0.15,0.95);mz.add(outline(mzG,0.025,0x5a3e2b));hamster.add(mz);
  const ns=new THREE.Mesh(new THREE.SphereGeometry(0.06,16,16),pM);ns.position.set(0,0.02,1.22);hamster.add(ns);
  const mt=new THREE.Mesh(new THREE.SphereGeometry(0.035,16,16),dM);mt.scale.set(1,0.8,0.5);mt.position.set(0,-0.06,1.25);hamster.add(mt);
  function mkEye(x){const g=new THREE.Group(),e=new THREE.Mesh(new THREE.SphereGeometry(0.12,32,32),dM);e.scale.set(1,1.25,0.5);const hl=new THREE.Mesh(new THREE.SphereGeometry(0.035,16,16),new THREE.MeshBasicMaterial({color:0xffffff}));hl.position.set(0.03,0.05,0.06);g.add(e,hl);g.position.set(x,0.35,1.02);eyes.push(g);return g;}
  hamster.add(mkEye(-0.33));hamster.add(mkEye(0.33));
  function mkEar(x,rz){const g=new THREE.Group(),eG=new THREE.SphereGeometry(0.25,32,16),eo=new THREE.Mesh(eG,oM);eo.scale.set(1,1,0.3);eo.add(outline(eG,0.05,0x5a3e2b));const ei=new THREE.Mesh(new THREE.SphereGeometry(0.15,32,16),pM);ei.scale.set(1,1,0.3);ei.position.z=0.05;g.add(eo,ei);g.position.set(x,0.85,0.2);g.rotation.z=rz;return g;}
  hamster.add(mkEar(-0.65,0.3));hamster.add(mkEar(0.65,-0.3));
  handsGroup=new THREE.Group();handsGroup.position.set(0,-0.35,1.35);hamster.add(handsGroup);
  const hG=new THREE.SphereGeometry(0.1,16,16);const lH=new THREE.Mesh(hG,pM);lH.position.set(-0.16,0,0);lH.add(outline(hG,0.08,0x5a3e2b));handsGroup.add(lH);const rH=new THREE.Mesh(hG,pM);rH.position.set(0.16,0,0);rH.add(outline(hG,0.08,0x5a3e2b));handsGroup.add(rH);
  const sG=new THREE.SphereGeometry(0.08,16,16);sG.scale(1,2.2,0.6);seed=new THREE.Mesh(sG,dM);seed.position.set(0,0.05,0.05);seed.rotation.x=-0.1;const stG=new THREE.SphereGeometry(0.02,16,16);stG.scale(1,2.3,0.7);const st=new THREE.Mesh(stG,cM);st.position.z=0.03;seed.add(st);handsGroup.add(seed);
  const fG=new THREE.SphereGeometry(0.12,16,16);const lF=new THREE.Mesh(fG,pM);lF.scale.set(1,0.6,1.3);lF.position.set(-0.35,-1.05,0.6);lF.add(outline(fG,0.08,0x5a3e2b));hamster.add(lF);const rF=new THREE.Mesh(fG,pM);rF.scale.set(1,0.6,1.3);rF.position.set(0.35,-1.05,0.6);rF.add(outline(fG,0.08,0x5a3e2b));hamster.add(rF);
  container.addEventListener('mousemove',e=>{const r=container.getBoundingClientRect();targetRotation.y=((e.clientX-r.left)/r.width*2-1)*0.25;targetRotation.x=-(((e.clientY-r.top)/r.height)*2-1)*0.15;});
  container.addEventListener('touchmove',e=>{const r=container.getBoundingClientRect(),t=e.touches[0];targetRotation.y=((t.clientX-r.left)/r.width*2-1)*0.25;targetRotation.x=-(((t.clientY-r.top)/r.height)*2-1)*0.15;});
  let gyroTarget={x:0,y:0},gyroActive=false;
  function enableGyro(){if(gyroActive)return;gyroActive=true;window.addEventListener('deviceorientation',e=>{const gamma=e.gamma||0,beta=e.beta||0;gyroTarget.y=Math.max(-1,Math.min(1,gamma/30))*0.35;gyroTarget.x=Math.max(-1,Math.min(1,(beta-45)/30))*-0.2;});}
  if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission!=='function'){enableGyro();}
  function onTap(e){const r=container.getBoundingClientRect();const cx=(e.touches?e.touches[0].clientX:e.clientX)-r.left,cy=(e.touches?e.touches[0].clientY:e.clientY)-r.top;spawnEmoji(cx,cy);hamster._jt=clock.getElapsedTime();if(!hamster._gyroReq&&typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){hamster._gyroReq=true;DeviceOrientationEvent.requestPermission().then(r=>{if(r==='granted')enableGyro();}).catch(()=>{});}}
  container.addEventListener('click',onTap);container.addEventListener('touchstart',e=>{if(e.touches.length===1)onTap(e);},{passive:true});
  (function animate(){requestAnimationFrame(animate);const t=clock.getElapsedTime();if(Math.random()>0.995&&!isBlinking){isBlinking=true;eyes.forEach(e=>e.scale.y=0.1);setTimeout(()=>{eyes.forEach(e=>e.scale.y=1);isBlinking=false;},120);}const br=1+Math.sin(t*3)*0.015;hamster.scale.set(br,br,br);if(hamster._jt){const d=t-hamster._jt;if(d<0.4)hamster.position.y=Math.sin(d/0.4*Math.PI)*0.3;else{hamster.position.y=0;hamster._jt=null;}}handsGroup.position.y=-0.35+Math.sin(t*40)*0.015;seed.rotation.z=Math.sin(t*30)*0.05;const fy=gyroActive?gyroTarget.y:targetRotation.y;const fx=gyroActive?gyroTarget.x:targetRotation.x;hamster.rotation.y+=(fy-hamster.rotation.y)*0.08;hamster.rotation.x+=(fx-hamster.rotation.x)*0.08;renderer.render(scene,camera);})();
}
</script>
</body>
</html>
