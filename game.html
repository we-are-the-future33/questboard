<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QUEST BOARD</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
:root {
  --bg:#0d0d0d; --surface:#161616; --surface2:#1f1f1f; --border:#2a2a2a;
  --accent:#c8f135; --accent2:#f1c835; --accent3:#35c8f1;
  --text:#f0f0f0; --text-dim:#666; --danger:#f13535; --radius:14px;
  --mobile:480px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:#000;color:var(--text);font-family:'Noto Sans KR',sans-serif;min-height:100vh;}
body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(135deg,#0a0a0a 0px,#0a0a0a 2px,#000 2px,#000 12px);z-index:0;}
.screen{display:none;min-height:100vh;position:relative;z-index:1;}
.screen.active{display:block;}
.mobile-wrap{max-width:var(--mobile);margin:0 auto;background:var(--bg);min-height:100vh;position:relative;}

/* LOADING */
#loadingScreen.active{display:flex;align-items:center;justify-content:center;}
#loadingScreen .mobile-wrap{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;}
.loading-logo{font-family:'Black Han Sans',sans-serif;font-size:40px;letter-spacing:6px;color:var(--accent);}
.loading-spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* LOGIN */
#loginScreen.active{display:flex;align-items:center;justify-content:center;}
#loginScreen .mobile-wrap{display:flex;align-items:center;justify-content:center;padding:32px 24px;}
.login-box{width:100%;}
.login-logo{font-family:'Black Han Sans',sans-serif;font-size:42px;letter-spacing:6px;color:var(--accent);text-align:center;margin-bottom:4px;}
.login-sub{text-align:center;color:var(--text-dim);font-size:12px;letter-spacing:4px;margin-bottom:48px;}
.input-group{margin-bottom:16px;}
.input-group label{display:block;font-size:11px;color:var(--text-dim);margin-bottom:8px;letter-spacing:2px;text-transform:uppercase;}
.input-group input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px 16px;color:var(--text);font-size:15px;font-family:'Noto Sans KR',sans-serif;outline:none;transition:border-color .2s;}
.input-group input:focus{border-color:var(--accent);}
.save-login-row{display:flex;align-items:center;gap:8px;margin-bottom:4px;}
.save-login-row input[type=checkbox]{width:16px;height:16px;accent-color:var(--accent);cursor:pointer;}
.save-login-row label{font-size:12px;color:var(--text-dim);cursor:pointer;}
.btn-primary{width:100%;background:var(--accent);color:#0d0d0d;border:none;border-radius:10px;padding:16px;font-size:16px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;margin-top:8px;transition:opacity .2s;letter-spacing:1px;}
.btn-primary:hover{opacity:.88;}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;}
.login-error{color:var(--danger);font-size:13px;text-align:center;margin-top:12px;display:none;}

/* NAV */
.topnav{height:52px;background:var(--bg);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;position:sticky;top:0;z-index:50;}
.nav-logo{font-family:'Black Han Sans',sans-serif;font-size:18px;color:var(--accent);letter-spacing:3px;}
.nav-badge{font-size:10px;color:var(--accent2);margin-left:5px;}
.nav-right{display:flex;align-items:center;gap:8px;}
.nav-user{font-size:12px;color:var(--text-dim);}
.btn-sm{background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:5px 12px;font-size:12px;font-family:'Noto Sans KR',sans-serif;cursor:pointer;transition:border-color .2s,color .2s;}
.btn-sm:hover{border-color:var(--accent);color:var(--accent);}

/* ADMIN */
.page-pad{padding:24px 20px;}
.section-title{font-family:'Black Han Sans',sans-serif;font-size:18px;letter-spacing:2px;margin-bottom:18px;color:var(--accent);}
.admin-hero{text-align:center;padding:32px 0 24px;border-bottom:1px solid var(--border);margin-bottom:32px;}
.admin-hero-title{font-family:'Black Han Sans',sans-serif;font-size:24px;letter-spacing:4px;color:var(--accent2);margin-bottom:6px;}
.admin-hero-sub{color:var(--text-dim);font-size:13px;}
.create-form{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;}
.form-row{margin-bottom:14px;}
.form-row label{display:block;font-size:11px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px;}
.form-row input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:11px 13px;color:var(--text);font-size:14px;font-family:'Noto Sans KR',sans-serif;outline:none;transition:border-color .2s;}
.form-row input:focus{border-color:var(--accent2);}
.btn-accent{background:var(--accent);color:#0d0d0d;border:none;border-radius:8px;padding:12px 22px;font-size:14px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;transition:opacity .2s;}
.btn-accent:hover{opacity:.85;}
.btn-accent.full{width:100%;margin-top:4px;}
.user-chip-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:24px;}
.user-chip{background:var(--surface);border:1px solid var(--border);border-radius:100px;padding:7px 16px;display:flex;align-items:center;gap:8px;}
.user-chip-name{font-weight:700;font-size:13px;}
.user-chip-id{color:var(--text-dim);font-size:11px;}

/* DASHBOARD */
#dashboardScreen .mobile-wrap{padding-bottom:32px;}
.global-bar{padding:14px 20px;background:var(--surface);border-bottom:1px solid var(--border);}
.gb-row{display:flex;align-items:center;gap:12px;}
.gb-label{font-size:11px;letter-spacing:2px;color:var(--text-dim);white-space:nowrap;}
.gb-track{flex:1;height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;}
.gb-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;transition:width .6s ease;}
.gb-pct{font-family:'Black Han Sans',sans-serif;font-size:16px;color:var(--accent);min-width:44px;text-align:right;}

/* ì•„ë°”íƒ€ ì„¹ì…˜ */
.avatar-section{padding:28px 20px 24px;display:flex;flex-direction:column;align-items:center;gap:14px;border-bottom:1px solid var(--border);}
.avatar-art{width:140px;height:140px;flex-shrink:0;background:var(--surface);border:1px solid var(--border);border-radius:24px;overflow:hidden;display:flex;align-items:center;justify-content:center;}
.avatar-art svg{width:124px;height:124px;}
.avatar-stage{font-family:'Black Han Sans',sans-serif;font-size:16px;color:var(--accent);letter-spacing:2px;text-align:center;}
.avatar-nickname-row{display:flex;align-items:center;justify-content:center;gap:8px;}
.avatar-nickname{font-family:'Black Han Sans',sans-serif;font-size:22px;color:var(--text);letter-spacing:1px;}
.pencil-btn{background:transparent;border:1px solid var(--border);color:var(--text-dim);border-radius:6px;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:13px;transition:border-color .2s,color .2s;flex-shrink:0;}
.pencil-btn:hover{border-color:var(--accent);color:var(--accent);}
.nickname-edit-row{display:flex;align-items:center;gap:8px;width:100%;max-width:260px;}
.nickname-input{flex:1;background:var(--surface2);border:1px solid var(--accent);border-radius:8px;padding:8px 12px;color:var(--text);font-size:16px;font-family:'Black Han Sans',sans-serif;outline:none;letter-spacing:1px;text-align:center;}
.nickname-save-btn{background:var(--accent);color:#0d0d0d;border:none;border-radius:8px;padding:8px 14px;font-size:13px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;white-space:nowrap;}
.avatar-msg{font-size:13px;color:var(--text-dim);line-height:1.6;text-align:center;max-width:260px;}
.avatar-progress-row{display:flex;align-items:center;gap:8px;width:100%;max-width:260px;}
.ap-track{flex:1;height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
.ap-fill{height:100%;background:var(--accent);border-radius:3px;transition:width .5s;}
.ap-pct{font-size:12px;color:var(--accent);font-weight:700;min-width:32px;text-align:right;}

/* ëª©í‘œ ê·¸ë¦¬ë“œ */
.goals-section{padding:20px 20px 0;}
.goals-section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.goals-section-title{font-family:'Black Han Sans',sans-serif;font-size:15px;letter-spacing:2px;color:var(--text-dim);}
.goal-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.goal-btn{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 14px;cursor:pointer;text-align:left;transition:border-color .2s,background .2s;font-family:'Noto Sans KR',sans-serif;position:relative;overflow:hidden;}
.goal-btn:hover:not(.disabled){border-color:var(--accent);}
.goal-btn.active{border-color:var(--accent);background:rgba(200,241,53,.07);}
.goal-btn.disabled{border-style:dashed;opacity:.4;cursor:default;}
.goal-btn-title{font-size:13px;font-weight:700;color:var(--text);margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.goal-btn.disabled .goal-btn-title{color:var(--text-dim);}
.goal-btn-pct{font-family:'Black Han Sans',sans-serif;font-size:20px;color:var(--accent);}
.goal-btn-bar{height:3px;background:var(--border);border-radius:2px;overflow:hidden;margin-top:8px;}
.goal-btn-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .4s;}
.goal-btn-need{font-size:11px;color:var(--text-dim);margin-top:4px;}

/* ìƒì„¸ íŒ¨ë„ */
.detail-section{padding:20px;}
.detail-divider{height:1px;background:var(--border);margin:0 20px 20px;}
.unit-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:22px;}
.unit-card-title{font-family:'Black Han Sans',sans-serif;font-size:17px;letter-spacing:1px;margin-bottom:6px;}
.unit-card-sub{color:var(--text-dim);font-size:13px;margin-bottom:20px;}
.unit-opts{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px;}
.unit-opt{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 8px;cursor:pointer;text-align:center;font-size:13px;font-weight:500;transition:border-color .2s,background .2s;font-family:'Noto Sans KR',sans-serif;color:var(--text);}
.unit-opt:hover{border-color:var(--accent);}
.unit-opt.selected{border-color:var(--accent);background:rgba(200,241,53,.1);color:var(--accent);}
.unit-confirm-btn{width:100%;background:var(--accent);color:#0d0d0d;border:none;border-radius:8px;padding:13px;font-size:14px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;}
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.cal-goal-name{font-family:'Black Han Sans',sans-serif;font-size:18px;letter-spacing:1px;}
.cal-meta{display:flex;align-items:center;gap:8px;}
.cal-unit-badge{background:var(--surface2);border:1px solid var(--border);border-radius:100px;padding:3px 10px;font-size:11px;color:var(--text-dim);}
.edit-unit-btn{background:transparent;border:1px solid var(--border);color:var(--text-dim);border-radius:6px;padding:4px 10px;font-size:11px;font-family:'Noto Sans KR',sans-serif;cursor:pointer;}
.edit-unit-btn:hover{border-color:var(--accent);color:var(--accent);}
.month-nav{display:flex;align-items:center;gap:10px;margin-bottom:14px;}
.month-nav-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:6px;padding:5px 12px;font-size:14px;cursor:pointer;}
.month-nav-btn:hover{border-color:var(--accent);}
.month-nav-btn:disabled{opacity:.3;cursor:default;}
.month-label{font-family:'Black Han Sans',sans-serif;font-size:15px;letter-spacing:1px;}
.cal-day-row{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:3px;}
.cal-day-lbl{text-align:center;font-size:10px;color:var(--text-dim);padding:3px 0;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;}
.cal-cell{aspect-ratio:1;background:var(--surface);border:1px solid var(--border);border-radius:7px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:border-color .15s,background .15s;user-select:none;}
.cal-cell:active{transform:scale(.93);}
.cal-cell.empty{background:transparent;border-color:transparent;cursor:default;}
.cal-cell.future{opacity:.3;cursor:default;}
.cal-cell.done{background:var(--accent);border-color:var(--accent);}
.cal-cell.done .cal-dn{color:#0d0d0d;}
.cal-cell.done .cal-chk{opacity:1;color:#0d0d0d;}
.cal-cell.week-ok{background:rgba(200,241,53,.12);border-color:rgba(200,241,53,.4);}
.cal-today{border-color:var(--accent3)!important;}
.cal-today .cal-dn{color:var(--accent3);}
.cal-dn{font-size:11px;font-weight:500;}
.cal-chk{font-size:10px;opacity:0;}
.month-stat{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-top:12px;display:flex;align-items:center;gap:12px;}
.ms-label{font-size:12px;color:var(--text-dim);white-space:nowrap;}
.ms-track{flex:1;height:5px;background:var(--surface2);border-radius:3px;overflow:hidden;}
.ms-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;transition:width .5s;}
.ms-nums{font-family:'Black Han Sans',sans-serif;font-size:13px;color:var(--accent);white-space:nowrap;}
.once-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:28px;text-align:center;}
.once-sub{color:var(--text-dim);font-size:12px;margin-bottom:24px;}
.once-btn{background:var(--surface2);border:2px solid var(--border);border-radius:50%;width:80px;height:80px;font-size:30px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;transition:border-color .2s,transform .15s;}
.once-btn:active{transform:scale(.9);}
.once-btn.done{background:rgba(200,241,53,.15);border-color:var(--accent);}
.once-done{margin-top:12px;font-family:'Black Han Sans',sans-serif;font-size:15px;color:var(--accent);}
.add-goal-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;}
.add-goal-input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:11px 13px;color:var(--text);font-size:14px;font-family:'Noto Sans KR',sans-serif;outline:none;margin-bottom:14px;}
.add-goal-input:focus{border-color:var(--accent);}
.detail-empty{text-align:center;padding:48px 20px;color:var(--text-dim);font-size:14px;line-height:1.8;}

/* ===== TUTORIAL ===== */
#tutorialScreen .mobile-wrap{padding-bottom:40px;}
.tut-topbar{height:52px;background:var(--bg);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:center;position:sticky;top:0;z-index:50;}
.tut-topbar-logo{font-family:'Black Han Sans',sans-serif;font-size:18px;color:var(--accent);letter-spacing:3px;}
.tut-progress{padding:16px 20px 0;}
.tut-step-dots{display:flex;gap:6px;justify-content:center;margin-bottom:12px;}
.tut-dot{width:8px;height:8px;border-radius:50%;background:var(--border);transition:background .3s,transform .2s;}
.tut-dot.active{background:var(--accent);transform:scale(1.3);}
.tut-dot.done{background:var(--accent2);}
.tut-track{height:3px;background:var(--surface2);border-radius:2px;overflow:hidden;margin-bottom:20px;}
.tut-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .5s ease;}
.tut-body{padding:0 20px;}
.tut-step{display:none;}
.tut-step.active{display:block;}
.tut-bubble{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:20px;position:relative;}
.tut-bubble-tag{font-size:10px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;margin-bottom:8px;}
.tut-bubble-text{font-size:15px;line-height:1.7;color:var(--text);}
.tut-bubble-text strong{color:var(--accent);}
.tut-hint{font-size:12px;color:var(--text-dim);text-align:center;margin-bottom:16px;letter-spacing:1px;}
/* íŠœí† ë¦¬ì–¼ ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ */
.tut-preview{background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:20px;}
.tut-preview-title{font-size:11px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;margin-bottom:12px;}
.tut-goal-preview{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;}
.tut-goal-name{font-size:14px;font-weight:700;}
.tut-goal-pct{font-family:'Black Han Sans',sans-serif;font-size:22px;color:var(--accent);}
.tut-bar{height:4px;background:var(--border);border-radius:2px;margin-top:8px;overflow:hidden;}
.tut-bar-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .8s ease;}
/* íŠœí† ë¦¬ì–¼ ë‹¬ë ¥ */
.tut-cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin:12px 0;}
.tut-cal-day{text-align:center;font-size:10px;color:var(--text-dim);padding:3px 0;}
.tut-cal-cell{aspect-ratio:1;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:12px;border:1px solid var(--border);background:var(--surface);cursor:pointer;transition:all .15s;user-select:none;font-weight:500;}
.tut-cal-cell:active{transform:scale(.9);}
.tut-cal-cell.done{background:var(--accent);border-color:var(--accent);color:#0d0d0d;font-weight:700;}
.tut-cal-cell.empty{background:transparent;border-color:transparent;cursor:default;}
.tut-cal-cell.target{border-color:var(--accent);animation:pulse-border 1.2s ease-in-out infinite;}
@keyframes pulse-border{0%,100%{box-shadow:0 0 0 0 rgba(200,241,53,.4);}50%{box-shadow:0 0 0 4px rgba(200,241,53,.15);}}
/* í•˜ì´ë¼ì´íŠ¸ */
.highlight-box{border:2px solid var(--accent)!important;box-shadow:0 0 0 4px rgba(200,241,53,.15);animation:hl-pulse 1.4s ease-in-out infinite;}
@keyframes hl-pulse{0%,100%{box-shadow:0 0 0 4px rgba(200,241,53,.15);}50%{box-shadow:0 0 0 8px rgba(200,241,53,.05);}}
/* ì•„ë°”íƒ€ íŠœí† ë¦¬ì–¼ */
.tut-avatar-wrap{display:flex;flex-direction:column;align-items:center;gap:10px;padding:20px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:20px;}
.tut-avatar-art{width:120px;height:120px;background:var(--surface2);border:1px solid var(--border);border-radius:20px;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.tut-avatar-art svg{width:106px;height:106px;}
.tut-avatar-stage{font-family:'Black Han Sans',sans-serif;font-size:15px;color:var(--accent);letter-spacing:2px;}
/* í™•ì¸ ë²„íŠ¼ */
.tut-confirm-btn{width:100%;background:var(--accent);color:#0d0d0d;border:none;border-radius:10px;padding:15px;font-size:15px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;letter-spacing:1px;transition:opacity .2s;}
.tut-confirm-btn:hover{opacity:.88;}
.tut-confirm-btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text-dim);margin-top:8px;}
/* ì „ì²´ ì§„ì²™ë¥  ë¯¸ë¦¬ë³´ê¸° */
.tut-global-bar{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:20px;display:flex;align-items:center;gap:12px;}
.tut-gb-label{font-size:11px;letter-spacing:2px;color:var(--text-dim);white-space:nowrap;}
.tut-gb-track{flex:1;height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;}
.tut-gb-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;transition:width .8s ease;}
.tut-gb-pct{font-family:'Black Han Sans',sans-serif;font-size:16px;color:var(--accent);min-width:44px;text-align:right;}

/* ì½˜í˜í‹° */
.confetti-container{position:fixed;inset:0;pointer-events:none;z-index:9999;overflow:hidden;}
.confetti-piece{position:absolute;width:10px;height:10px;border-radius:2px;animation:confetti-fall linear forwards;}
@keyframes confetti-fall{0%{transform:translateY(-20px) rotate(0deg);opacity:1;}100%{transform:translateY(110vh) rotate(720deg);opacity:0;}}

/* TOAST */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--accent);color:#0d0d0d;padding:11px 24px;border-radius:100px;font-weight:700;font-size:14px;transition:transform .3s;z-index:999;pointer-events:none;white-space:nowrap;}
.toast.show{transform:translateX(-50%) translateY(0);}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loadingScreen" class="screen active">
  <div class="mobile-wrap">
    <div class="loading-logo">QUEST</div>
    <div class="loading-spinner"></div>
  </div>
</div>

<!-- LOGIN -->
<div id="loginScreen" class="screen">
  <div class="mobile-wrap">
    <div class="login-box">
      <div class="login-logo">QUEST</div>
      <div class="login-sub">BOARD</div>
      <div class="input-group"><label>ì•„ì´ë””</label><input type="text" id="loginId" placeholder="ì•„ì´ë”” ì…ë ¥" autocomplete="username"></div>
      <div class="input-group"><label>ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password"></div>
      <div class="save-login-row">
        <input type="checkbox" id="saveLoginChk">
        <label for="saveLoginChk">ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì €ì¥</label>
      </div>
      <button class="btn-primary" id="loginBtn" onclick="doLogin()">ë¡œê·¸ì¸</button>
      <div class="login-error" id="loginError">ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
    </div>
  </div>
</div>

<!-- ADMIN -->
<div id="adminScreen" class="screen">
  <div class="mobile-wrap">
    <nav class="topnav">
      <div class="nav-logo">QUEST <span class="nav-badge">ADMIN</span></div>
      <div class="nav-right"><button class="btn-sm" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button></div>
    </nav>
    <div class="page-pad">
      <div class="admin-hero">
        <div class="admin-hero-title">ADMIN</div>
        <div class="admin-hero-sub">ìœ ì € ê³„ì •ì„ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</div>
      </div>
      <div class="create-form">
        <div class="section-title" style="font-size:15px;margin-bottom:16px;">ìƒˆ ê³„ì • ìƒì„±</div>
        <div class="form-row"><label>ì´ë¦„</label><input type="text" id="newUserName" placeholder="ìœ ì € ì´ë¦„"></div>
        <div class="form-row"><label>ì•„ì´ë””</label><input type="text" id="newUserId" placeholder="ë¡œê·¸ì¸ ì•„ì´ë”” (ì˜ë¬¸/ìˆ«ì)"></div>
        <div class="form-row"><label>ë¹„ë°€ë²ˆí˜¸</label><input type="text" id="newUserPw" placeholder="ë¹„ë°€ë²ˆí˜¸"></div>
        <button class="btn-accent full" onclick="createUser()">ê³„ì • ìƒì„±</button>
      </div>
      <div style="margin-top:32px;">
        <div class="section-title" style="font-size:15px;margin-bottom:12px;">ë“±ë¡ëœ ìœ ì €</div>
        <div class="user-chip-list" id="adminUserChips"></div>
      </div>
    </div>
  </div>
</div>

<!-- TUTORIAL -->
<div id="tutorialScreen" class="screen">
  <div class="mobile-wrap">
    <div class="tut-topbar"><div class="tut-topbar-logo">QUEST</div></div>
    <div class="tut-progress">
      <div class="tut-step-dots" id="tutDots"></div>
      <div class="tut-track"><div class="tut-fill" id="tutFill" style="width:0%"></div></div>
    </div>
    <div class="tut-body">

      <!-- STEP 1: ëª©í‘œ ì„¤ì • -->
      <div class="tut-step active" id="tutStep1">
        <div class="tut-bubble">
          <div class="tut-bubble-tag">STEP 1 Â· ëª©í‘œ ì„¤ì •</div>
          <div class="tut-bubble-text">ë¨¼ì € <strong>ë‹¬ì„±í•˜ê³  ì‹¶ì€ ëª©í‘œ</strong>ë¥¼ ì •í•´ë³¼ê²Œìš”.<br>ì•„ë˜ ëª©í‘œë¥¼ íƒ­í•´ì„œ ì‹œì‘í•´ë³´ì„¸ìš”!</div>
        </div>
        <button id="tutGoalBtn" onclick="tutStep1Confirm()" style="width:100%;background:var(--surface);border:2px solid var(--accent);border-radius:12px;padding:18px 16px;color:var(--text);font-size:16px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;text-align:left;margin-bottom:20px;animation:pulse-border 1.2s ease-in-out infinite;transition:background .2s;">
          12ì‹œ ì „ì— ìê¸°
        </button>
      </div>

      <!-- STEP 2: ë‹¨ìœ„ ì„¤ì • -->
      <div class="tut-step" id="tutStep2">
        <div class="tut-bubble">
          <div class="tut-bubble-tag">STEP 2 Â· ë‹¨ìœ„ ì„¤ì •</div>
          <div class="tut-bubble-text"><strong>ì–¼ë§ˆë‚˜ ìì£¼</strong> ì´ ëª©í‘œë¥¼ ìˆ˜í–‰í•  ê±´ê°€ìš”?<br>ì£¼ 4~5íšŒë¥¼ íƒ­í•´ì„œ ì„ íƒí•´ë³´ì„¸ìš”!</div>
        </div>
        <div class="tut-preview">
          <div class="tut-preview-title" style="margin-bottom:12px;">ëª©í‘œ: <span id="tutGoalName2">-</span></div>
          <div class="unit-opts" id="tutUnitOpts" style="margin-bottom:0;"></div>
        </div>
      </div>

      <!-- STEP 3: ì²´í¬ ì²˜ë¦¬ -->
      <div class="tut-step" id="tutStep3">
        <div class="tut-bubble">
          <div class="tut-bubble-tag">STEP 3 Â· ì™„ë£Œ ì²´í¬</div>
          <div class="tut-bubble-text">ëª©í‘œë¥¼ ìˆ˜í–‰í–ˆë‹¤ë©´ <strong>ë‚ ì§œë¥¼ íƒ­í•´ì„œ</strong> ì™„ë£Œ ì²˜ë¦¬ë¥¼ í•´ìš”.<br>ì´ë²ˆ ì£¼ 4ì¼ì„ ì²´í¬í•´ë³´ì„¸ìš”!</div>
        </div>
        <div class="tut-preview">
          <div class="tut-preview-title" id="tutGoalName3">-</div>
          <div class="tut-cal-grid" id="tutCalDayRow"></div>
          <div class="tut-cal-grid" id="tutCalGrid"></div>
        </div>
        <div id="tutStep3Status" style="text-align:center;font-family:'Black Han Sans',sans-serif;font-size:14px;color:var(--text-dim);margin-bottom:8px;">0 / 4 ì²´í¬</div>
      </div>

      <!-- STEP 4: ëª©í‘œ ì§„ì²™ë¥  + ì „ì²´ ì§„ì²™ë¥  í•©ì¹¨ -->
      <div class="tut-step" id="tutStep4">
        <div class="tut-bubble">
          <div class="tut-bubble-tag">STEP 4 Â· ì§„ì²™ë¥ </div>
          <div class="tut-bubble-text">ì²´í¬í•œ ë‚ ì§œë§Œí¼ <strong>í•´ë‹¹ ëª©í‘œì˜ ìˆ˜í–‰ë¥ ì´ ì˜¬ë¼ê°€ìš”!</strong><br>ëª¨ë“  ëª©í‘œì˜ ìˆ˜í–‰ë¥ ì„ í•©ì‚°í•´ì„œ ì „ì²´ ë‹¬ì„±ë¥ ë„ í•¨ê»˜ ì˜¬ë¼ê°€ìš”.</div>
        </div>
        <div class="tut-preview highlight-box" id="tutGoalCard" style="margin-bottom:12px;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <div style="font-size:14px;font-weight:700;" id="tutGoalName4">-</div>
            <div class="tut-goal-pct" id="tutGoalPct4">0%</div>
          </div>
          <div class="tut-bar"><div class="tut-bar-fill" id="tutGoalBar4" style="width:0%"></div></div>
          <div style="font-size:12px;color:var(--text-dim);margin-top:8px;" id="tutGoalStat4">0/0</div>
        </div>
        <div class="tut-global-bar highlight-box" id="tutGlobalBar">
          <div class="tut-gb-label">ì´ë²ˆ ë‹¬</div>
          <div class="tut-gb-track"><div class="tut-gb-fill" id="tutGbFill" style="width:0%"></div></div>
          <div class="tut-gb-pct" id="tutGbPct">0%</div>
        </div>
        <button class="tut-confirm-btn" onclick="tutNextStep(5)">ë‹¤ìŒ â†’</button>
      </div>

      <!-- STEP 5: ìºë¦­í„° -->
      <div class="tut-step" id="tutStep5">
        <div class="tut-bubble">
          <div class="tut-bubble-tag">STEP 5 Â· ë‚˜ì˜ ìºë¦­í„°</div>
          <div class="tut-bubble-text">ì „ì²´ ë‹¬ì„±ë¥ ì— ë”°ë¼ <strong>ìºë¦­í„°ê°€ ìë¼ë‚˜ìš”!</strong><br>ì—´ì‹¬íˆ ë‹¬ì„±í• ìˆ˜ë¡ ë” ë©‹ì§„ ìºë¦­í„°ê°€ ë  ê±°ì˜ˆìš” ğŸŒŸ</div>
        </div>
        <div class="tut-avatar-wrap highlight-box" id="tutAvatarWrap">
          <div class="tut-avatar-art" id="tutAvatarArt"></div>
          <div class="tut-avatar-stage" id="tutAvatarStage">1ë‹¨ê³„ Â· ì•Œ</div>
          <div style="font-size:13px;color:var(--text-dim);">ìˆ˜í–‰ë¥ ì´ ë†’ì•„ì§ˆìˆ˜ë¡ ì„±ì¥í•´ìš”</div>
        </div>
        <button class="tut-confirm-btn" onclick="tutFinish()">ğŸ‰ ì‹œì‘í•˜ê¸°!</button>
      </div>

    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboardScreen" class="screen">
  <div class="mobile-wrap">
    <nav class="topnav">
      <div class="nav-logo">QUEST</div>
      <div class="nav-right">
        <span class="nav-user" id="navUserName"></span>
        <button class="btn-sm" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </nav>
    <div class="global-bar">
      <div class="gb-row">
        <div class="gb-label">ì´ë²ˆ ë‹¬</div>
        <div class="gb-track"><div class="gb-fill" id="gbFill" style="width:0%"></div></div>
        <div class="gb-pct" id="gbPct">0%</div>
      </div>
    </div>
    <div class="avatar-section">
      <div class="avatar-art" id="avatarArt"></div>
      <div class="avatar-stage" id="avatarStage">1ë‹¨ê³„ Â· ì•Œ</div>
      <div class="avatar-nickname-row" id="avatarNicknameRow">
        <div class="avatar-nickname" id="avatarNickname">ë‚˜ì˜ ìºë¦­í„°</div>
        <button class="pencil-btn" onclick="startEditNickname()">âœï¸</button>
      </div>
      <div class="avatar-msg" id="avatarMsg">ì˜¤ëŠ˜ë„ íŒŒì´íŒ…!</div>
      <div class="avatar-progress-row">
        <div class="ap-track"><div class="ap-fill" id="apFill" style="width:0%"></div></div>
        <div class="ap-pct" id="apPct">0%</div>
      </div>
    </div>
    <div class="goals-section">
      <div class="goals-section-header">
        <div class="goals-section-title">ğŸ¯ ëª©í‘œ</div>
      </div>
      <div class="goal-grid" id="goalGrid"></div>
    </div>
    <div class="detail-divider" style="margin-top:20px;"></div>
    <div class="detail-section" id="detailSection">
      <div class="detail-empty">ëª©í‘œë¥¼ ì„ íƒí•˜ë©´<br>ìƒì„¸ ë‚´ìš©ì´ í¼ì³ì§‘ë‹ˆë‹¤</div>
    </div>
  </div>
</div>

<div class="confetti-container" id="confettiContainer"></div>
<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAbEbLdJuWVai_NKTHuo1XtC8p76dmVPE0",
  authDomain: "grow-goal.firebaseapp.com",
  databaseURL: "https://grow-goal-default-rtdb.firebaseio.com",
  projectId: "grow-goal",
  storageBucket: "grow-goal.firebasestorage.app",
  messagingSenderId: "587441793315",
  appId: "1:587441793315:web:8ae5325a2af90953ce4496"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ===== ìƒìˆ˜ =====
const UNIT_LABELS = { once:'í•œ ë²ˆ', daily:'ë§¤ì¼', w1:'ì£¼ 1íšŒ', w2:'ì£¼ 2~3íšŒ', w4:'ì£¼ 4~5íšŒ', w6:'ì£¼ 6íšŒ' };
const UNIT_FREQ   = { once:0, daily:7, w1:1, w2:2, w4:4, w6:6 };
const MAX_GOALS   = 6;
const TUT_STEPS   = 5;

const CHEERS = [
  "ì˜¤ëŠ˜ë„ í•œ ê±¸ìŒ!","ì‘ì€ ì‹œì‘ì´ í° ë³€í™”ë¥¼ ë§Œë“¤ì–´ìš”","í¬ê¸°í•˜ì§€ ë§ˆì„¸ìš”!","ì˜ í•˜ê³  ìˆì–´ìš”!","ì˜¤ëŠ˜ì˜ ë…¸ë ¥ì´ ë‚´ì¼ì˜ ë‚˜ë¥¼ ë§Œë“¤ì–´ìš”",
  "ê¾¸ì¤€í•¨ì´ ìµœê³ ì˜ ë¬´ê¸°ì˜ˆìš”","ì–´ì œë³´ë‹¤ ë‚˜ì€ ì˜¤ëŠ˜!","ì¡°ê¸ˆì”© ë‚˜ì•„ê°€ëŠ” ì¤‘!","ë‹¹ì‹ ì€ í•  ìˆ˜ ìˆì–´ìš”","ë§¤ì¼ì´ ìƒˆë¡œìš´ ê¸°íšŒì˜ˆìš”",
  "í˜ë‚´ì„¸ìš”, ì‘ì›í•´ìš”!","ì˜¤ëŠ˜ í•˜ë£¨ë„ ìˆ˜ê³ í–ˆì–´ìš”","ì‘ì€ ìŠµê´€ì´ ì¸ìƒì„ ë°”ê¿”ìš”","ë©ˆì¶”ì§€ ì•Šìœ¼ë©´ ë°˜ë“œì‹œ ë„ë‹¬í•´ìš”","ì²œì²œíˆ ê°€ë„ ê´œì°®ì•„ìš”",
  "ì§€ê¸ˆ ì´ ìˆœê°„ì´ ì¤‘ìš”í•´ìš”","ì˜¤ëŠ˜ë„ ë©‹ì§„ í•˜ë£¨ì˜€ì–´ìš”","í•œ ë²ˆì— í•œ ê±¸ìŒì”©","ë‹¹ì‹ ì˜ ë…¸ë ¥ì„ ì‘ì›í•´ìš”","ëª©í‘œì— ê°€ê¹Œì›Œì§€ê³  ìˆì–´ìš”",
  "ì‘ì€ ì„±ê³µì„ ì¶•í•˜í•´ìš”","ì˜¤ëŠ˜ë„ ì˜ í–ˆì–´ìš”!","í¬ê¸°ë€ ì—†ì–´ìš”!","ë‚´ì¼ì€ ë” ì˜ ë  ê±°ì˜ˆìš”","ì§€ê¸ˆ ì˜ í•˜ê³  ìˆì–´ìš”",
  "ì˜¤ëŠ˜ì˜ ë•€ì´ ë¹›ë‚  ê±°ì˜ˆìš”","ìŠµê´€ì´ ìš´ëª…ì„ ë°”ê¿”ìš”","ë‹¹ì‹ ì€ íŠ¹ë³„í•´ìš”","ë§¤ì¼ ì¡°ê¸ˆì”© ì„±ì¥ ì¤‘","íŒŒì´íŒ…!",
  "ì˜¤ëŠ˜ í•˜ë£¨ ìµœì„ ì„ ë‹¤í–ˆì–´ìš”","ê¸°ë¡ì´ ìŒ“ì—¬ ì‹¤ë ¥ì´ ë¼ìš”","ê¾¸ì¤€í•œ ë‹¹ì‹ ì´ ë©‹ì ¸ìš”","ì˜¤ëŠ˜ë„ ìŠ¹ë¦¬!","ë…¸ë ¥ì€ ë°°ì‹ í•˜ì§€ ì•Šì•„ìš”",
  "ì´ ìˆœê°„ì„ ì¦ê¸°ì„¸ìš”","í•œ ê±¸ìŒ ë” ë‚˜ì•„ê°”ì–´ìš”","ë‹¹ì‹ ì˜ ê°€ëŠ¥ì„±ì€ ë¬´í•œí•´ìš”","í¬ê¸°í•˜ì§€ ì•ŠëŠ” ë‹¹ì‹  ìµœê³ ","ì˜¤ëŠ˜ë„ í•´ëƒˆì–´ìš”!",
  "ë³€í™”ëŠ” ì‹œì‘ëì–´ìš”","ì§€ì¹˜ì§€ ë§ˆì„¸ìš”, ê³§ ë¹›ë‚  ê±°ì˜ˆìš”","ì‘ì›ì´ í•¨ê»˜í•´ìš”","ì˜¤ëŠ˜ë„ ì„±ì¥í–ˆì–´ìš”","ë‚´ í˜ì´ìŠ¤ëŒ€ë¡œ ê°€ìš”",
  "ë‹¹ì‹ ì˜ ë…¸ë ¥ì´ ëˆˆë¶€ì…”ìš”","í•˜ë£¨í•˜ë£¨ê°€ ìŒ“ì—¬ìš”","ì˜¤ëŠ˜ë„ ëê¹Œì§€!","ì‹¤íŒ¨í•´ë„ ê´œì°®ì•„ìš”, ë‹¤ì‹œ ì¼ì–´ì„œë©´ ë¼ìš”","ì›°ë˜!",
  "ì‘ì€ ëª©í‘œë¶€í„° ì°¨ê·¼ì°¨ê·¼","ì„±ê³µì˜ ì”¨ì•—ì„ ì‹¬ëŠ” ì¤‘","ì˜¤ëŠ˜ í•˜ë£¨ ì¶©ì „ ì™„ë£Œ","ë‹¹ì‹ ì€ ì„±ì¥í•˜ëŠ” ì¤‘ì´ì—ìš”","ë©ˆì¶”ì§€ ì•ŠëŠ” ìš©ê¸°!",
  "í•˜ë£¨ë¥¼ ì˜ ë§ˆë¬´ë¦¬í–ˆì–´ìš”","ì§€ê¸ˆì˜ ë…¸ë ¥ì„ ë¯¿ì–´ìš”","ëª¨ë“  ìˆœê°„ì´ ì˜ë¯¸ ìˆì–´ìš”","ì¢‹ì€ ìŠµê´€ ë§Œë“œëŠ” ì¤‘","ì˜¤ëŠ˜ë„ ì¢‹ì€ ì„ íƒ!",
  "ë¯¸ë˜ì˜ ë‚˜ë¥¼ ìœ„í•œ íˆ¬ìì˜ˆìš”","ì§€ê¸ˆ ë‹¹ì‹  ìµœê³ ì˜ˆìš”","ì‘ì€ ë³€í™”ê°€ í° ê¸°ì ì„ ë§Œë“¤ì–´ìš”","ì˜¤ëŠ˜ë„ ìë‘ìŠ¤ëŸ¬ì›Œìš”","ì•ìœ¼ë¡œë§Œ!",
  "ë‹¹ì‹ ì˜ ì—´ì •ì´ ë¹›ë‚˜ìš”","ì¡°ê¸ˆë§Œ ë” í˜ë‚´ìš”","í¬ê¸° ê¸ˆì§€!","ë§¤ì¼ ì¡°ê¸ˆì”© ë” ê°•í•´ì ¸ìš”","ì˜¤ëŠ˜ì˜ ìŠµê´€ì´ ë¯¸ë˜ë¥¼ ê²°ì •í•´ìš”",
  "ì˜ ìê³  ë‚´ì¼ ë˜ íŒŒì´íŒ…!","ì–´ì œì˜ ë‚˜ë³´ë‹¤ ë‚˜ì•„ì¡Œì–´ìš”","í‰ë²”í•œ ë‚ ë„ ì†Œì¤‘í•´ìš”","ë£¨í‹´ì´ ì‚¶ì„ ë°”ê¿”ìš”","ëª©í‘œë¥¼ í–¥í•´ ì „ì§„ ì¤‘!",
  "ë‹¹ì‹ ì˜ ì˜ì§€ë ¥ì´ ëŒ€ë‹¨í•´ìš”","ì˜¤ëŠ˜ í•˜ë£¨ ìµœê³ ì˜€ì–´ìš”","í•œ ë²ˆ ë” ë„ì „!","ì§€ê¸ˆ ì´ ìˆœê°„ì„ ì¦ê²¨ìš”","í¬ê¸°í•˜ì§€ ì•ŠëŠ” í˜ì´ ìµœê³ ì˜ˆìš”",
  "ë¹›ë‚˜ëŠ” ë¯¸ë˜ë¥¼ í–¥í•´","ì˜¤ëŠ˜ë„ í•´í”¼ í€˜ìŠ¤íŠ¸!","ë…¸ë ¥í•˜ëŠ” ë‹¹ì‹ ì´ ì•„ë¦„ë‹¤ì›Œìš”","ë‚´ì¼ë„ ê°™ì´ í•´ìš”","ì˜¤ëŠ˜ì˜ ì²´í¬ê°€ ë¹›ë‚˜ìš”",
  "ì¡°ê¸ˆì”©, í™•ì‹¤í•˜ê²Œ","ë‹¹ì‹ ì˜ ë£¨í‹´ì´ ì™„ì„±ë˜ì–´ ê°€ìš”","ì´ ìˆœê°„ì— ì§‘ì¤‘í•´ìš”","ì˜¤ëŠ˜ë„ ì™„ë²½í•œ í•˜ë£¨!","êµ¿ ì¡!",
  "í•œ ë°œì”© ë‚˜ì•„ê°€ëŠ” ì¤‘","ë‹¹ì‹ ì˜ ê¾¸ì¤€í•¨ì´ ëŒ€ë‹¨í•´ìš”","ì˜¤ëŠ˜ë„ í›Œë¥­í–ˆì–´ìš”","ë©‹ì§„ ìŠµê´€ì„ ë§Œë“œëŠ” ì¤‘","ê³„ì† ê°€ìš”!",
  "ì˜¤ëŠ˜ë„ ê¸°ë¡ ì™„ë£Œ!","ë‹¹ì‹ ì€ ë§¤ì¼ ì„±ì¥í•´ìš”","ì´ ìŠµê´€ì´ ë‹¹ì‹ ì„ ë°”ê¿€ ê±°ì˜ˆìš”","ì˜¤ëŠ˜ë„ ì¶©ì‹¤í–ˆì–´ìš”","í•œê³„ë¥¼ ë„˜ì–´ì„œìš”",
  "ê¿ˆì„ í–¥í•œ ì‘ì€ ë°œê±¸ìŒ","ì˜¤ëŠ˜ë„ íŒŒì´íŒ… ë„˜ì³ìš”","ë‹¹ì‹ ì˜ í•˜ë£¨ê°€ ëˆˆë¶€ì…”ìš”","ì§€ê¸ˆ ì˜ ë‹¬ë¦¬ê³  ìˆì–´ìš”","ë‚´ì¼ë„ ê¸°ëŒ€ë¼ìš”",
  "ì‘ì€ ì™„ë£Œê°€ ëª¨ì—¬ ì„±ê³µì´ ë¼ìš”","ì˜¤ëŠ˜ë„ ì²´í¬ ì™„ë£Œ!","ë‹¹ì‹ ì˜ ëˆê¸°ê°€ ë©‹ì ¸ìš”","í•œ ê±¸ìŒì˜ ê¸°ì ","ì˜¤ëŠ˜ë„ ì´ê²¨ëƒˆì–´ìš”!",
  "ë‚´ ì•ˆì˜ ê°€ëŠ¥ì„±ì„ ë¯¿ì–´ìš”","ì˜¤ëŠ˜ë„ ë£¨í‹´ ì™„ì„±!","ë‹¹ì‹ ì˜ ë…¸ë ¥ì„ ë¯¿ì–´ìš”","ì¡°ê¸ˆì”© ë” ë‚˜ì€ ë‚˜ë¡œ","ì˜¤ëŠ˜ í•˜ë£¨ ì±™ê²¼ì–´ìš”",
  "ì˜¤ëŠ˜ë„ ìµœì„ !","ë‹¹ì‹ ì˜ ì„±ì¥ì´ ëŠê»´ì ¸ìš”","ë©ˆì¶”ì§€ ì•ŠëŠ” ê²ƒì´ ìµœê³ ì˜ˆìš”","ì˜¤ëŠ˜ë„ ë¸Œë¼ë³´!","í•œ ë°œ ì•ì„œê°€ëŠ” ë‹¹ì‹ ",
  "ê¾¸ì¤€í•¨ì´ ì‹¤ë ¥ì´ ë¼ìš”","ì˜¤ëŠ˜ë„ í›Œë¥­í•œ ì„ íƒ!","ë‹¹ì‹ ì˜ ê²°ì‹¬ì´ ëŒ€ë‹¨í•´ìš”","ì˜¤ëŠ˜ í•˜ë£¨ ì˜ ë²„í…¼ì–´ìš”","ë‚´ì¼ì˜ ë‚˜ì—ê²Œ ì„ ë¬¼í•˜ëŠ” ì˜¤ëŠ˜",
  "ì˜¤ëŠ˜ë„ ì‰¬ì§€ ì•Šì•˜ì–´ìš”","ë‹¹ì‹ ì˜ ì˜ì§€ê°€ ë¹›ë‚˜ìš”","ë£¨í‹´ì˜ ë‹¬ì¸ì´ ë˜ì–´ê°€ëŠ” ì¤‘","ì˜¤ëŠ˜ë„ ê¸°íŠ¹í•´ìš”","ìŠµê´€ì´ ë‚˜ë¥¼ ë§Œë“¤ì–´ìš”",
  "ì‘ì§€ë§Œ í™•ì‹¤í•œ ì§„ì „","ì˜¤ëŠ˜ë„ ìŠ¤ìŠ¤ë¡œ ì¹­ì°¬í•´ìš”","ë‹¹ì‹ ì€ ë§¤ì¼ ë” ê°•í•´ì ¸ìš”","ì˜¤ëŠ˜ì˜ ë…¸ë ¥ ë°•ìˆ˜!","ì•ë§Œ ë³´ê³  ê°€ìš”",
  "ì§€ê¸ˆ ì´ ìˆœê°„ì´ ì†Œì¤‘í•´ìš”","ì˜¤ëŠ˜ë„ í•œ í˜ì´ì§€ ì™„ì„±","ë‹¹ì‹ ì˜ ì—¬ì •ì„ ì‘ì›í•´ìš”","ë§¤ì¼ ì¡°ê¸ˆì”© ë¹›ë‚˜ìš”","ì˜¤ëŠ˜ë„ ì˜ í–ˆì–´!",
  "í¬ê¸°í•˜ì§€ ì•ŠëŠ” ë‹¹ì‹  ë©‹ì ¸ìš”","ì˜¤ëŠ˜ì˜ ë„ì „ ì„±ê³µ!","ë‹¹ì‹ ì˜ í•˜ë£¨ê°€ ê°’ì ¸ìš”","ì´ ìŠµê´€ì´ ì˜¤ë˜ê°€ê¸¸","ì˜¤ëŠ˜ë„ ê±´ê°•í•œ í•˜ë£¨",
  "ì˜¤ëŠ˜ë„ íŒŒì´íŒ…!","ì‘ì€ ê²ƒì´ ëª¨ì—¬ ìœ„ëŒ€í•´ì ¸ìš”","ë‹¹ì‹ ì˜ í•˜ë£¨ê°€ ì†Œì¤‘í•´ìš”","ì˜¤ëŠ˜ë„ ì˜ ì´ê²¨ëƒˆì–´ìš”","í•œ ê±¸ìŒì´ ê¸°ì ì˜ ì‹œì‘"
];

// ===== SVG ì•„ë°”íƒ€ =====
const AVATARS = [
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><ellipse cx="40" cy="44" rx="22" ry="28" fill="#f0e8d0" stroke="#c8b89a" stroke-width="2"/><ellipse cx="33" cy="36" rx="4" ry="6" fill="rgba(255,255,255,0.3)"/><circle cx="40" cy="38" r="6" fill="#f0e8d0" stroke="#c8b89a" stroke-width="1"/><path d="M36,40 Q40,44 44,40" fill="none" stroke="#c8b89a" stroke-width="1.5" stroke-linecap="round"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><circle cx="40" cy="48" r="20" fill="#f5c518"/><circle cx="40" cy="28" r="14" fill="#f5c518"/><circle cx="35" cy="25" r="3" fill="#1a1a1a"/><circle cx="45" cy="25" r="3" fill="#1a1a1a"/><circle cx="35.5" cy="24.5" r="1" fill="white"/><circle cx="45.5" cy="24.5" r="1" fill="white"/><polygon points="40,30 37,34 43,34" fill="#f39c12"/><ellipse cx="28" cy="48" rx="7" ry="10" fill="#f5c518" transform="rotate(-20,28,48)"/><ellipse cx="52" cy="48" rx="7" ry="10" fill="#f5c518" transform="rotate(20,52,48)"/><line x1="34" y1="68" x2="30" y2="75" stroke="#f39c12" stroke-width="3" stroke-linecap="round"/><line x1="40" y1="68" x2="40" y2="75" stroke="#f39c12" stroke-width="3" stroke-linecap="round"/><line x1="46" y1="68" x2="50" y2="75" stroke="#f39c12" stroke-width="3" stroke-linecap="round"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><circle cx="40" cy="48" r="22" fill="#d4a574"/><circle cx="40" cy="30" r="16" fill="#d4a574"/><polygon points="24,20 20,8 32,18" fill="#d4a574"/><polygon points="56,20 60,8 48,18" fill="#d4a574"/><polygon points="25,19 22,11 31,18" fill="#f8b4b4"/><polygon points="55,19 58,11 49,18" fill="#f8b4b4"/><circle cx="34" cy="28" r="3.5" fill="#1a1a1a"/><circle cx="46" cy="28" r="3.5" fill="#1a1a1a"/><circle cx="34.8" cy="27.2" r="1.2" fill="white"/><circle cx="46.8" cy="27.2" r="1.2" fill="white"/><ellipse cx="40" cy="33" rx="4" ry="2.5" fill="#f8b4b4"/><path d="M36,35 Q40,38 44,35" fill="none" stroke="#c8846a" stroke-width="1.5" stroke-linecap="round"/><line x1="22" y1="30" x2="10" y2="27" stroke="#c8846a" stroke-width="1.5"/><line x1="22" y1="33" x2="10" y2="33" stroke="#c8846a" stroke-width="1.5"/><line x1="22" y1="36" x2="10" y2="39" stroke="#c8846a" stroke-width="1.5"/><line x1="58" y1="30" x2="70" y2="27" stroke="#c8846a" stroke-width="1.5"/><line x1="58" y1="33" x2="70" y2="33" stroke="#c8846a" stroke-width="1.5"/><line x1="58" y1="36" x2="70" y2="39" stroke="#c8846a" stroke-width="1.5"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><circle cx="40" cy="46" r="22" fill="#c8986a"/><circle cx="40" cy="28" r="16" fill="#c8986a"/><ellipse cx="24" cy="34" rx="9" ry="14" fill="#b8845a" transform="rotate(-10,24,34)"/><ellipse cx="56" cy="34" rx="9" ry="14" fill="#c8986a" transform="rotate(10,56,34)"/><circle cx="34" cy="26" r="3.5" fill="#1a1a1a"/><circle cx="46" cy="26" r="3.5" fill="#1a1a1a"/><circle cx="34.8" cy="25.2" r="1.2" fill="white"/><circle cx="46.8" cy="25.2" r="1.2" fill="white"/><ellipse cx="40" cy="32" rx="7" ry="5" fill="#b8845a"/><ellipse cx="40" cy="31" rx="5" ry="3" fill="#f8b4b4"/><path d="M34,35 Q40,40 46,35" fill="none" stroke="#8B5E3C" stroke-width="2" stroke-linecap="round"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><circle cx="40" cy="46" r="20" fill="#e8783a"/><circle cx="40" cy="28" r="15" fill="#e8783a"/><polygon points="26,20 18,6 34,18" fill="#e8783a"/><polygon points="54,20 62,6 46,18" fill="#e8783a"/><polygon points="27,19 20,8 33,18" fill="#f8f0e8"/><polygon points="53,19 60,8 47,18" fill="#f8f0e8"/><ellipse cx="40" cy="32" rx="10" ry="8" fill="#f8f0e8"/><circle cx="34" cy="26" r="3.5" fill="#1a1a1a"/><circle cx="46" cy="26" r="3.5" fill="#1a1a1a"/><circle cx="34.8" cy="25.2" r="1.2" fill="white"/><circle cx="46.8" cy="25.2" r="1.2" fill="white"/><ellipse cx="40" cy="33" rx="4" ry="2.5" fill="#1a1a1a"/><path d="M35,36 Q40,40 45,36" fill="none" stroke="#c85a2a" stroke-width="1.5" stroke-linecap="round"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><circle cx="40" cy="46" r="22" fill="#f8f8f8"/><circle cx="40" cy="28" r="16" fill="#f8f8f8"/><ellipse cx="29" cy="25" rx="8" ry="7" fill="#2a2a2a"/><ellipse cx="51" cy="25" rx="8" ry="7" fill="#2a2a2a"/><circle cx="29" cy="23" r="4" fill="#f8f8f8"/><circle cx="51" cy="23" r="4" fill="#f8f8f8"/><circle cx="30" cy="24" r="2.5" fill="#1a1a1a"/><circle cx="52" cy="24" r="2.5" fill="#1a1a1a"/><circle cx="30.8" cy="23.2" r="0.9" fill="white"/><circle cx="52.8" cy="23.2" r="0.9" fill="white"/><ellipse cx="40" cy="33" rx="5" ry="3.5" fill="#d4d4d4"/><circle cx="40" cy="32" r="2.5" fill="#f8a0a0"/><path d="M35,36 Q40,40 45,36" fill="none" stroke="#888" stroke-width="1.5" stroke-linecap="round"/><circle cx="22" cy="18" r="6" fill="#2a2a2a"/><circle cx="58" cy="18" r="6" fill="#2a2a2a"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><ellipse cx="28" cy="18" rx="7" ry="18" fill="#f0f0f0" stroke="#ddd" stroke-width="1"/><ellipse cx="52" cy="18" rx="7" ry="18" fill="#f0f0f0" stroke="#ddd" stroke-width="1"/><ellipse cx="28" cy="18" rx="4" ry="14" fill="#f8b4b4"/><ellipse cx="52" cy="18" rx="4" ry="14" fill="#f8b4b4"/><circle cx="40" cy="46" r="22" fill="#f0f0f0"/><circle cx="40" cy="30" r="15" fill="#f0f0f0"/><circle cx="34" cy="28" r="3.5" fill="#e87eb0"/><circle cx="46" cy="28" r="3.5" fill="#e87eb0"/><circle cx="34.6" cy="27.4" r="1.2" fill="#1a1a1a"/><circle cx="46.6" cy="27.4" r="1.2" fill="#1a1a1a"/><ellipse cx="40" cy="33" rx="4" ry="2.5" fill="#f8b4b4"/><path d="M35,36 Q40,40 45,36" fill="none" stroke="#d4849a" stroke-width="1.5" stroke-linecap="round"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><circle cx="40" cy="40" r="28" fill="#e8a830" opacity="0.4"/><circle cx="40" cy="40" r="22" fill="#e8a830" opacity="0.6"/><circle cx="40" cy="36" r="16" fill="#f5d040"/><circle cx="40" cy="32" r="14" fill="#f5d040"/><circle cx="34" cy="30" r="3.5" fill="#1a1a1a"/><circle cx="46" cy="30" r="3.5" fill="#1a1a1a"/><circle cx="34.8" cy="29.2" r="1.2" fill="white"/><circle cx="46.8" cy="29.2" r="1.2" fill="white"/><ellipse cx="40" cy="36" rx="6" ry="4" fill="#e8a830"/><ellipse cx="40" cy="35" rx="4.5" ry="2.8" fill="#f8a0a0"/><path d="M33,40 Q40,45 47,40" fill="none" stroke="#c87820" stroke-width="2" stroke-linecap="round"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><path d="M10,30 Q20,10 30,20 Q20,30 10,30Z" fill="#2ecc40"/><path d="M70,30 Q60,10 50,20 Q60,30 70,30Z" fill="#2ecc40"/><circle cx="40" cy="46" r="22" fill="#27ae60"/><circle cx="40" cy="28" r="15" fill="#27ae60"/><circle cx="34" cy="26" r="4" fill="#f1c40f"/><circle cx="46" cy="26" r="4" fill="#f1c40f"/><circle cx="35" cy="26" r="2.5" fill="#1a1a1a"/><circle cx="47" cy="26" r="2.5" fill="#1a1a1a"/><circle cx="35.8" cy="25.2" r="1" fill="white"/><circle cx="47.8" cy="25.2" r="1" fill="white"/><ellipse cx="40" cy="34" rx="5" ry="3" fill="#1a5c30"/><path d="M36,37 Q40,42 44,37" fill="none" stroke="#1a5c30" stroke-width="2" stroke-linecap="round"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="ugrd" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#f8b4d4"/><stop offset="50%" style="stop-color:#c8f135"/><stop offset="100%" style="stop-color:#35c8f1"/></linearGradient><linearGradient id="hgrd" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#f1c835"/><stop offset="100%" style="stop-color:#f8b4d4"/></linearGradient></defs><circle cx="40" cy="46" r="22" fill="url(#ugrd)"/><circle cx="40" cy="28" r="15" fill="url(#ugrd)"/><path d="M40,6 L36,22 L44,22Z" fill="url(#hgrd)"/><circle cx="34" cy="26" r="3.5" fill="#1a1a1a"/><circle cx="46" cy="26" r="3.5" fill="#1a1a1a"/><circle cx="34.8" cy="25.2" r="1.4" fill="white"/><circle cx="46.8" cy="25.2" r="1.4" fill="white"/><ellipse cx="40" cy="32" rx="4" ry="2.5" fill="#f8d4e8"/><path d="M35,35 Q40,40 45,35" fill="none" stroke="#d4849a" stroke-width="1.5" stroke-linecap="round"/></svg>`
];
const STAGE_NAMES = ['ì•Œ','ë³‘ì•„ë¦¬','ê³ ì–‘ì´','ê°•ì•„ì§€','ì—¬ìš°','íŒë‹¤','í† ë¼','ì‚¬ì','ë“œë˜ê³¤','ìœ ë‹ˆì½˜'];

// ===== ìƒíƒœ =====
let currentUser = null;
let localDash = null;
let activeGoalIdx = null;
let viewMonth = null;
let selectedUnit = {};
// íŠœí† ë¦¬ì–¼ ìƒíƒœ
let tutState = { goalName:'', unit:'w4', checkedDays:new Set(), currentStep:1 };

// ===== í™”ë©´ =====
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}

// ===== INIT =====
async function init() {
  // ì €ì¥ëœ ë¡œê·¸ì¸ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
  const saved = JSON.parse(localStorage.getItem('qb_login') || 'null');
  if (saved) {
    document.getElementById('loginId').value = saved.id || '';
    document.getElementById('loginPw').value = saved.pw || '';
    document.getElementById('saveLoginChk').checked = true;
  }
  const snap = await get(ref(db,'users/admin'));
  if (!snap.exists()) await set(ref(db,'users/admin'),{name:'ê´€ë¦¬ì',password:'admin1234',role:'admin'});
  showScreen('loginScreen');
}
init();

// ===== LOGIN =====
window.doLogin = async function() {
  const id = document.getElementById('loginId').value.trim();
  const pw = document.getElementById('loginPw').value;
  const btn = document.getElementById('loginBtn');
  const saveChk = document.getElementById('saveLoginChk').checked;
  if (!id||!pw) return;
  btn.disabled=true; btn.textContent='í™•ì¸ ì¤‘...';
  try {
    const snap = await get(ref(db,`users/${id}`));
    if (!snap.exists()||snap.val().password!==pw) {
      document.getElementById('loginError').style.display='block';
    } else {
      document.getElementById('loginError').style.display='none';
      // ë¡œê·¸ì¸ ì •ë³´ ì €ì¥/ì‚­ì œ
      if (saveChk) localStorage.setItem('qb_login', JSON.stringify({id,pw}));
      else localStorage.removeItem('qb_login');
      const u = snap.val();
      currentUser = {id,...u};
      if (u.role==='admin') { showScreen('adminScreen'); renderAdminList(); }
      else {
        document.getElementById('navUserName').textContent = u.name;
        await loadDash();
        // íŠœí† ë¦¬ì–¼ ì™„ë£Œ ì—¬ë¶€ í™•ì¸
        if (!localDash.tutorialDone) {
          tutState = { goalName:'', unit:'w4', checkedDays:new Set(), currentStep:1 };
          initTutorial();
          showScreen('tutorialScreen');
        } else {
          activeGoalIdx = null; viewMonth = null;
          showScreen('dashboardScreen');
          renderDashboard();
        }
      }
    }
  } catch(e) { showToast('âŒ ì—°ê²° ì˜¤ë¥˜'); }
  btn.disabled=false; btn.textContent='ë¡œê·¸ì¸';
};
['loginId','loginPw'].forEach(id=>{
  document.getElementById(id).addEventListener('keydown',e=>{ if(e.key==='Enter') window.doLogin(); });
});

window.doLogout = function() {
  currentUser=null; localDash=null; activeGoalIdx=null;
  document.getElementById('loginId').value='';
  document.getElementById('loginPw').value='';
  if (!document.getElementById('saveLoginChk').checked) localStorage.removeItem('qb_login');
  showScreen('loginScreen');
};

// ===== DB =====
async function loadDash() {
  const snap = await get(ref(db,`dashboards/${currentUser.id}`));
  localDash = snap.exists() ? snap.val() : {};
  if (!localDash.goals) localDash.goals=[];
  if (!localDash.completions) localDash.completions={};
}
async function saveDash() { await set(ref(db,`dashboards/${currentUser.id}`),localDash); }

// ===== ADMIN =====
async function renderAdminList() {
  const snap = await get(ref(db,'users'));
  const chips = document.getElementById('adminUserChips');
  if (!snap.exists()) { chips.innerHTML='<div style="color:var(--text-dim)">ë“±ë¡ëœ ìœ ì € ì—†ìŒ</div>'; return; }
  const users = Object.entries(snap.val()).filter(([,u])=>u.role!=='admin');
  chips.innerHTML = users.length===0
    ? '<div style="color:var(--text-dim)">ë“±ë¡ëœ ìœ ì € ì—†ìŒ</div>'
    : users.map(([id,u])=>`<div class="user-chip"><span class="user-chip-name">${esc(u.name)}</span><span class="user-chip-id">@${esc(id)}</span></div>`).join('');
}
window.createUser = async function() {
  const name=document.getElementById('newUserName').value.trim();
  const id=document.getElementById('newUserId').value.trim();
  const pw=document.getElementById('newUserPw').value.trim();
  if(!name||!id||!pw){showToast('âŒ ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  if(!/^[a-zA-Z0-9_]+$/.test(id)){showToast('âŒ ì•„ì´ë””ëŠ” ì˜ë¬¸/ìˆ«ì/_ë§Œ ê°€ëŠ¥');return;}
  try {
    const snap=await get(ref(db,`users/${id}`));
    if(snap.exists()){showToast('âŒ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””');return;}
    await set(ref(db,`users/${id}`),{name,password:pw,role:'user'});
    document.getElementById('newUserName').value='';
    document.getElementById('newUserId').value='';
    document.getElementById('newUserPw').value='';
    showToast(`âœ… ${name} ê³„ì • ìƒì„± ì™„ë£Œ!`);
    renderAdminList();
  } catch(e) { showToast('âŒ ê³„ì • ìƒì„± ì‹¤íŒ¨: '+e.message); }
};

// ===== TUTORIAL =====
function initTutorial() {
  // ì  & ë°” ë Œë”
  const dots = document.getElementById('tutDots');
  dots.innerHTML = Array(TUT_STEPS).fill(0).map((_,i)=>`<div class="tut-dot ${i===0?'active':''}" id="tutDot${i+1}"></div>`).join('');
  updateTutProgress(1);
  // ë‹¨ìœ„ ì„ íƒì§€ ë Œë” - ì£¼4~5íšŒ(w4)ë§Œ í´ë¦­ ê°€ëŠ¥, ë‚˜ë¨¸ì§€ ë”¤ë“œ
  const uopts = document.getElementById('tutUnitOpts');
  uopts.innerHTML = Object.entries(UNIT_LABELS).map(([u,l])=>{
    if(u === 'w4') {
      return `<div class="unit-opt" onclick="tutPickUnit('w4')" style="animation:pulse-border 1.2s ease-in-out infinite;border-color:var(--accent);cursor:pointer;">${l}</div>`;
    }
    return `<div class="unit-opt" style="opacity:.25;pointer-events:none;cursor:not-allowed;">${l}</div>`;
  }).join('');
  buildTutCal();
}

function updateTutProgress(step) {
  tutState.currentStep = step;
  document.getElementById('tutFill').style.width = ((step-1)/(TUT_STEPS-1)*100)+'%';
  for(let i=1;i<=TUT_STEPS;i++) {
    const d = document.getElementById(`tutDot${i}`);
    if(!d) continue;
    d.className = 'tut-dot' + (i<step?' done':i===step?' active':'');
  }
  document.querySelectorAll('.tut-step').forEach(s=>s.classList.remove('active'));
  const el = document.getElementById(`tutStep${step}`);
  if(el) el.classList.add('active');
}

window.tutNextStep = function(n) { updateTutProgress(n); };

window.tutPickUnit = function(u) {
  tutState.unit = u;
  // ì„ íƒ í‘œì‹œ í›„ ì¦‰ì‹œ ë‹¤ìŒ ìŠ¤í…
  const el = document.querySelector(`#tutUnitOpts .unit-opt[onclick*="${u}"]`);
  if(el) { el.classList.add('selected'); el.style.animation='none'; }
  tutStep2Confirm();
};

window.tutStep1Confirm = function() {
  tutState.goalName = '12ì‹œ ì „ì— ìê¸°';
  document.getElementById('tutGoalName2').textContent = tutState.goalName;
  showToast('âœ… ëª©í‘œ ì„¤ì • ì™„ë£Œ!');
  setTimeout(()=> updateTutProgress(2), 400);
};

window.tutStep2Confirm = function() {
  buildTutCal();
  document.getElementById('tutGoalName3').textContent = tutState.goalName;
  showToast('âœ… ë‹¨ìœ„ ì„¤ì • ì™„ë£Œ!');
  setTimeout(()=> updateTutProgress(3), 400);
};

// íŠœí† ë¦¬ì–¼ ë‹¬ë ¥ (ì´ë²ˆ ì£¼ 7ì¼, 4ì¼ í´ë¦­ ìœ ë„)
function buildTutCal() {
  const now = new Date();
  const dayOfWeek = now.getDay(); // 0=ì¼
  // ì´ë²ˆ ì£¼ ì›”~ì¼ (ì›”ìš”ì¼ ê¸°ì¤€)
  const monday = new Date(now);
  monday.setDate(now.getDate() - ((dayOfWeek+6)%7));
  const days = Array(7).fill(0).map((_,i)=>{
    const d = new Date(monday);
    d.setDate(monday.getDate()+i);
    return d;
  });

  const DAY_KR=['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† ','ì¼'];
  const dayRow = document.getElementById('tutCalDayRow');
  if(dayRow) dayRow.innerHTML = DAY_KR.map(d=>`<div class="tut-cal-day">${d}</div>`).join('');

  const grid = document.getElementById('tutCalGrid');
  if(!grid) return;

  // ëŒ€ìƒ ë‚ ì§œ: ì´ë²ˆ ì£¼ ì›”~ëª© (ì• 4ì¼) í•˜ì´ë¼ì´íŠ¸
  const targetDates = new Set(days.slice(0,4).map(d=>d.getDate()));

  grid.innerHTML = days.map(d=>{
    const isFut = d > now;
    const isChecked = tutState.checkedDays.has(d.getDate());
    const isTarget = targetDates.has(d.getDate()) && !isFut && !isChecked;
    const cls = ['tut-cal-cell', isChecked?'done':'', isFut?'future':'', isTarget?'target':''].filter(Boolean).join(' ');
    return `<div class="${cls}" onclick="${isFut?'':(`tutToggleDay(${d.getDate()})`)}">${d.getDate()}</div>`;
  }).join('');
}

window.tutToggleDay = function(day) {
  if(tutState.checkedDays.has(day)) tutState.checkedDays.delete(day);
  else tutState.checkedDays.add(day);
  buildTutCal();
  const cnt = tutState.checkedDays.size;
  const status = document.getElementById('tutStep3Status');
  if(status) {
    status.textContent = `${cnt} / 4 ì²´í¬`;
    status.style.color = cnt>=4?'var(--accent)':'var(--text-dim)';
  }
  if(cnt >= 4) {
    showToast('âœ… ì²´í¬ ì™„ë£Œ!');
    setTimeout(()=> tutStep3Confirm(), 600);
  }
};

window.tutStep3Confirm = function() {
  if(tutState.checkedDays.size < 4) return;
  const now = new Date();
  const y=now.getFullYear(), m=now.getMonth()+1;
  const dim = new Date(y,m,0).getDate();
  const weeks = Math.ceil(dim/7);
  const freq = UNIT_FREQ[tutState.unit]||4;
  const mod = freq * weeks;
  const done = tutState.checkedDays.size;
  const pct = Math.min(100,Math.round(done/mod*100));

  document.getElementById('tutGoalName4').textContent = tutState.goalName;
  document.getElementById('tutGoalPct4').textContent = pct+'%';
  document.getElementById('tutGoalBar4').style.width = pct+'%';
  document.getElementById('tutGoalStat4').textContent = `${done}ì¼ ì™„ë£Œ / ì´ë²ˆ ë‹¬ ëª©í‘œ ${mod}ì¼`;
  document.getElementById('tutGbFill').style.width = pct+'%';
  document.getElementById('tutGbPct').textContent = pct+'%';
  const stage = Math.min(9,Math.floor(pct/10));
  document.getElementById('tutAvatarArt').innerHTML = AVATARS[stage];
  document.getElementById('tutAvatarStage').textContent = `${stage+1}ë‹¨ê³„ Â· ${STAGE_NAMES[stage]}`;
  updateTutProgress(4);
};

window.tutFinish = async function() {
  // íŠœí† ë¦¬ì–¼ ë°ì´í„°ë¥¼ ì‹¤ì œ DBì— ì €ì¥
  const now = new Date();
  const y=now.getFullYear(), m=now.getMonth()+1;
  if(!localDash.goals) localDash.goals=[];
  if(!localDash.completions) localDash.completions={};

  // ìŠ¬ë¡¯ 0ì— ëª©í‘œ ë“±ë¡
  localDash.goals[0] = { title: tutState.goalName, unit: tutState.unit };

  // ì²´í¬í•œ ë‚ ì§œ ë°˜ì˜
  tutState.checkedDays.forEach(d=>{
    localDash.completions[`g0_${y}_${m}_${d}`] = true;
  });

  localDash.tutorialDone = true;
  await saveDash();

  showConfetti();
  setTimeout(()=>{
    activeGoalIdx = null; viewMonth = null;
    showScreen('dashboardScreen');
    renderDashboard();
  }, 2800);
};

// ===== ì½˜í˜í‹° =====
function showConfetti() {
  const container = document.getElementById('confettiContainer');
  const colors = ['#c8f135','#f1c835','#35c8f1','#f13535','#f1a7d0','#ffffff'];
  container.innerHTML = '';
  for(let i=0;i<120;i++) {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    el.style.cssText = `
      left:${Math.random()*100}%;
      background:${colors[Math.floor(Math.random()*colors.length)]};
      width:${6+Math.random()*8}px;
      height:${6+Math.random()*8}px;
      border-radius:${Math.random()>0.5?'50%':'2px'};
      animation-duration:${2+Math.random()*2}s;
      animation-delay:${Math.random()*0.8}s;
    `;
    container.appendChild(el);
  }
  setTimeout(()=>{ container.innerHTML=''; }, 4000);
}

// ===== ì§„ì²™ ê³„ì‚° =====
function getMonthDays(y,m){ return new Date(y,m,0).getDate(); }
function getMonthWeeks(y,m){ return Math.ceil(getMonthDays(y,m)/7); }
function goalModulus(g,gi,y,m){
  if(!g||!g.unit||g.unit==='once') return 1;
  if(g.unit==='daily') return getMonthDays(y,m);
  return UNIT_FREQ[g.unit]*getMonthWeeks(y,m);
}
function goalDone(g,gi,y,m){
  if(!g||!g.unit) return 0;
  if(g.unit==='once') return localDash.completions[`g${gi}_once`]===true?1:0;
  const pfx=`g${gi}_${y}_${m}_`;
  return Object.entries(localDash.completions).filter(([k,v])=>k.startsWith(pfx)&&v===true).length;
}
function goalPct(g,gi,y,m){
  const mod=goalModulus(g,gi,y,m);
  const done=goalDone(g,gi,y,m);
  return {done,mod,pct:mod>0?Math.min(100,Math.round(done/mod*100)):0};
}
function globalPct(){
  const now=new Date(); const y=now.getFullYear(),m=now.getMonth()+1;
  let td=0,tm=0;
  getAllGoals().forEach((g,i)=>{
    if(!g||!g.unit) return;
    const {done,mod}=goalPct(g,i,y,m);
    td+=done; tm+=mod;
  });
  return tm>0?Math.round(td/tm*100):0;
}
function getAllGoals(){
  const g=[];
  for(let i=0;i<MAX_GOALS;i++) g.push(localDash.goals[i]||null);
  return g;
}

// ===== DASHBOARD =====
function renderDashboard(){
  const now=new Date();
  if(!viewMonth) viewMonth={year:now.getFullYear(),month:now.getMonth()+1};
  renderGlobal(); renderAvatar(); renderGoalGrid();
  if(activeGoalIdx!==null) renderDetail(activeGoalIdx);
}
function renderGlobal(){
  const p=globalPct();
  document.getElementById('gbFill').style.width=p+'%';
  document.getElementById('gbPct').textContent=p+'%';
}
function renderAvatar(){
  const p=globalPct();
  const stage=Math.min(9,Math.floor(p/10));
  document.getElementById('avatarArt').innerHTML=AVATARS[stage];
  document.getElementById('avatarStage').textContent=`${stage+1}ë‹¨ê³„ Â· ${STAGE_NAMES[stage]}`;
  document.getElementById('apFill').style.width=p+'%';
  document.getElementById('apPct').textContent=p+'%';
  const nick=localDash.nickname||currentUser.name||'ë‚˜ì˜ ìºë¦­í„°';
  document.getElementById('avatarNickname').textContent=nick;
  const now=new Date();
  const doy=Math.floor((now-new Date(now.getFullYear(),0,0))/86400000);
  document.getElementById('avatarMsg').textContent=CHEERS[doy%CHEERS.length];
}
function renderGoalGrid(){
  const goals=getAllGoals();
  const now=new Date(); const y=now.getFullYear(),m=now.getMonth()+1;
  let html='';
  for(let i=0;i<MAX_GOALS;i++){
    const g=goals[i];
    const isActive=activeGoalIdx===i;
    if(!g){
      html+=`<button class="goal-btn disabled" onclick="selectGoal(${i})"><div class="goal-btn-title">+ ëª©í‘œ ì¶”ê°€</div></button>`;
    } else if(!g.unit){
      html+=`<button class="goal-btn ${isActive?'active':''}" onclick="selectGoal(${i})">
        <div class="goal-btn-title">${esc(g.title||'ëª©í‘œ'+(i+1))}</div>
        <div class="goal-btn-need">ë‹¨ìœ„ ì„¤ì • í•„ìš”</div>
      </button>`;
    } else {
      const {pct}=goalPct(g,i,y,m);
      html+=`<button class="goal-btn ${isActive?'active':''}" onclick="selectGoal(${i})">
        <div class="goal-btn-title">${esc(g.title||'ëª©í‘œ'+(i+1))}</div>
        <div class="goal-btn-pct">${pct}%</div>
        <div class="goal-btn-bar"><div class="goal-btn-fill" style="width:${pct}%"></div></div>
      </button>`;
    }
  }
  document.getElementById('goalGrid').innerHTML=html;
}
window.selectGoal=function(idx){
  activeGoalIdx=idx;
  renderGoalGrid();
  renderDetail(idx);
  setTimeout(()=>document.getElementById('detailSection').scrollIntoView({behavior:'smooth',block:'start'}),50);
};

// ===== DETAIL =====
function renderDetail(idx){
  const goals=getAllGoals();
  const g=goals[idx];
  const panel=document.getElementById('detailSection');
  if(!g){
    panel.innerHTML=`<div class="add-goal-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <div class="unit-card-title">ìƒˆ ëª©í‘œ ì¶”ê°€</div>
        <button onclick="closeDetailPanel()" style="background:transparent;border:1px solid var(--border);color:var(--text-dim);border-radius:6px;width:30px;height:30px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;">âœ•</button>
      </div>
      <input class="add-goal-input" id="newGoalTitle" type="text" placeholder="ëª©í‘œ ì´ë¦„ ì…ë ¥">
      <div class="unit-opts" id="unitOpts${idx}"></div>
      <button class="unit-confirm-btn" onclick="saveNewGoal(${idx})">ëª©í‘œ ë“±ë¡</button>
    </div>`;
    renderUnitOpts(`unitOpts${idx}`,null,idx);
    return;
  }
  if(!g.unit){
    panel.innerHTML=`<div class="unit-card">
      <div class="unit-card-title">${esc(g.title)}</div>
      <div class="unit-card-sub">ë‹¬ì„± ë‹¨ìœ„ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
      <div class="unit-opts" id="unitOpts${idx}"></div>
      <button class="unit-confirm-btn" onclick="confirmUnit(${idx})">ì„¤ì • ì™„ë£Œ</button>
    </div>`;
    renderUnitOpts(`unitOpts${idx}`,null,idx);
    return;
  }
  if(g.unit==='once') renderOnce(panel,g,idx);
  else renderCalendar(panel,g,idx);
}

function renderUnitOpts(cid,cur,idx){
  const c=document.getElementById(cid);
  if(!c) return;
  if(!selectedUnit[idx]) selectedUnit[idx]=cur||null;
  c.innerHTML=Object.entries(UNIT_LABELS).map(([u,l])=>
    `<div class="unit-opt ${selectedUnit[idx]===u?'selected':''}" onclick="pickUnit('${u}',${idx},'${cid}')">${l}</div>`
  ).join('');
}
window.pickUnit=function(u,idx,cid){ selectedUnit[idx]=u; renderUnitOpts(cid,u,idx); };

window.confirmUnit=async function(idx){
  const u=selectedUnit[idx];
  if(!u){showToast('ë‹¨ìœ„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”');return;}
  if(!localDash.goals[idx]) localDash.goals[idx]={};
  localDash.goals[idx].unit=u;
  await saveDash();
  showToast('âœ… ë‹¨ìœ„ ì„¤ì • ì™„ë£Œ!');
  renderGoalGrid(); renderDetail(idx); renderGlobal(); renderAvatar();
};

window.saveNewGoal=async function(idx){
  const title=(document.getElementById('newGoalTitle')||{}).value?.trim();
  const u=selectedUnit[idx];
  if(!title){showToast('ëª©í‘œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  if(!u){showToast('ë‹¨ìœ„ë¥¼ ì„ íƒí•˜ì„¸ìš”');return;}
  if(!localDash.goals[idx]) localDash.goals[idx]={};
  localDash.goals[idx].title=title;
  localDash.goals[idx].unit=u;
  await saveDash();
  showToast('ğŸ¯ ëª©í‘œ ë“±ë¡!');
  renderGoalGrid(); renderDetail(idx); renderGlobal(); renderAvatar();
};

window.enterEditUnit=function(idx){
  const goals=getAllGoals(); const g=goals[idx];
  const panel=document.getElementById('detailSection');
  panel.innerHTML=`<div class="unit-card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div class="unit-card-title">ëª©í‘œ ìˆ˜ì •</div>
      <button onclick="renderDetail(${idx})" style="background:transparent;border:1px solid var(--border);color:var(--text-dim);border-radius:6px;width:30px;height:30px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;">âœ•</button>
    </div>
    <div style="font-size:11px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px;">ëª©í‘œ ì œëª©</div>
    <input id="editGoalTitle${idx}" type="text" value="${escAttr(g.title||'')}" placeholder="ëª©í‘œ ì´ë¦„" style="width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:11px 13px;color:var(--text);font-size:14px;font-family:'Noto Sans KR',sans-serif;outline:none;margin-bottom:20px;" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
    <div style="font-size:11px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px;">ë‹¬ì„± ë‹¨ìœ„</div>
    <div class="unit-opts" id="unitOpts${idx}"></div>
    <button class="unit-confirm-btn" onclick="confirmEditGoal(${idx})">ìˆ˜ì • ì™„ë£Œ</button>
  </div>`;
  selectedUnit[idx]=g.unit;
  renderUnitOpts(`unitOpts${idx}`,g.unit,idx);
};

window.confirmEditGoal=async function(idx){
  const titleEl=document.getElementById(`editGoalTitle${idx}`);
  const title=titleEl?titleEl.value.trim():'';
  const u=selectedUnit[idx];
  if(!title){showToast('âŒ ëª©í‘œ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  if(!u){showToast('âŒ ë‹¨ìœ„ë¥¼ ì„ íƒí•˜ì„¸ìš”');return;}
  if(!localDash.goals[idx]) localDash.goals[idx]={};
  localDash.goals[idx].title=title;
  localDash.goals[idx].unit=u;
  await saveDash();
  showToast('âœ… ìˆ˜ì • ì™„ë£Œ!');
  renderGoalGrid(); renderDetail(idx);
};

window.closeDetailPanel=function(){
  activeGoalIdx=null;
  renderGoalGrid();
  document.getElementById('detailSection').innerHTML='<div class="detail-empty">ëª©í‘œë¥¼ ì„ íƒí•˜ë©´<br>ìƒì„¸ ë‚´ìš©ì´ í¼ì³ì§‘ë‹ˆë‹¤</div>';
};

function renderOnce(panel,g,idx){
  const done=localDash.completions[`g${idx}_once`]===true;
  panel.innerHTML=`<div class="once-card">
    <div class="cal-header">
      <div class="cal-goal-name">${esc(g.title)}</div>
      <div class="cal-meta">
        <div class="cal-unit-badge">${UNIT_LABELS[g.unit]}</div>
        <button class="edit-unit-btn" onclick="enterEditUnit(${idx})">ìˆ˜ì •</button>
      </div>
    </div>
    <div class="once-sub">ì™„ë£Œí•˜ë©´ ì´ ëª©í‘œ 100% ë‹¬ì„±!</div>
    <button class="once-btn ${done?'done':''}" onclick="toggleOnce(${idx})">${done?'âœ…':'â—‹'}</button>
    ${done?'<div class="once-done">ğŸ‰ ì™„ë£Œ!</div>':''}
  </div>`;
}
window.toggleOnce=async function(idx){
  const k=`g${idx}_once`;
  localDash.completions[k]=!(localDash.completions[k]===true);
  await saveDash();
  showToast(localDash.completions[k]?'ğŸ‰ ì™„ë£Œ!':'â†©ï¸ í•´ì œ');
  renderDetail(idx); renderGoalGrid(); renderGlobal(); renderAvatar();
};

function renderCalendar(panel,g,idx){
  const now=new Date();
  const {year,month}=viewMonth;
  const {done,mod,pct}=goalPct(g,idx,year,month);
  const freq=UNIT_FREQ[g.unit]||1;
  const firstDay=new Date(year,month-1,1).getDay();
  const dim=getMonthDays(year,month);
  const DAY=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  let weeks=[]; let week=[];
  for(let i=0;i<firstDay;i++) week.push(0);
  for(let d=1;d<=dim;d++){
    week.push(d);
    if(week.length===7){weeks.push(week);week=[];}
  }
  if(week.length>0){while(week.length<7)week.push(0);weeks.push(week);}
  let calHtml=`<div class="cal-day-row">${DAY.map(d=>`<div class="cal-day-lbl">${d}</div>`).join('')}</div><div class="cal-grid">`;
  weeks.forEach(w=>{
    const valid=w.filter(d=>d>0);
    const wdone=valid.filter(d=>localDash.completions[`g${idx}_${year}_${month}_${d}`]===true).length;
    const wok=wdone>=freq;
    w.forEach(d=>{
      if(d===0){calHtml+=`<div class="cal-cell empty"></div>`;return;}
      const dt=new Date(year,month-1,d);
      const isToday=dt.toDateString()===now.toDateString();
      const isFut=dt>now;
      const isDone=localDash.completions[`g${idx}_${year}_${month}_${d}`]===true;
      const cls=['cal-cell',isDone?'done':'',isFut?'future':'',isToday?'cal-today':'',(!isDone&&wok&&!isFut)?'week-ok':''].filter(Boolean).join(' ');
      calHtml+=`<div class="${cls}" onclick="${isFut?'':(`toggleDay(${idx},${d})`)}">
        <div class="cal-dn">${d}</div><div class="cal-chk">âœ“</div>
      </div>`;
    });
  });
  calHtml+='</div>';
  const isCur=year===now.getFullYear()&&month===now.getMonth()+1;
  panel.innerHTML=`
    <div class="cal-header">
      <div class="cal-goal-name">${esc(g.title)}</div>
      <div class="cal-meta">
        <div class="cal-unit-badge">${UNIT_LABELS[g.unit]}</div>
        <button class="edit-unit-btn" onclick="enterEditUnit(${idx})">ìˆ˜ì •</button>
      </div>
    </div>
    <div class="month-nav">
      <button class="month-nav-btn" onclick="changeMonth(-1)">â€¹</button>
      <div class="month-label">${year}ë…„ ${month}ì›”</div>
      <button class="month-nav-btn" onclick="changeMonth(1)" ${isCur?'disabled':''}>â€º</button>
    </div>
    ${calHtml}
    <div class="month-stat">
      <div class="ms-label">ì´ë‹¬ ì§„ì²™</div>
      <div class="ms-track"><div class="ms-fill" style="width:${pct}%"></div></div>
      <div class="ms-nums">${done}/${mod} Â· ${pct}%</div>
    </div>`;
}
window.changeMonth=function(dir){
  let {year,month}=viewMonth;
  month+=dir;
  if(month<1){month=12;year--;}
  if(month>12){month=1;year++;}
  const now=new Date();
  if(year>now.getFullYear()||(year===now.getFullYear()&&month>now.getMonth()+1)) return;
  viewMonth={year,month};
  renderDetail(activeGoalIdx);
};
window.toggleDay=async function(idx,day){
  const {year,month}=viewMonth;
  const k=`g${idx}_${year}_${month}_${day}`;
  localDash.completions[k]=!(localDash.completions[k]===true);
  await saveDash();
  showToast(localDash.completions[k]?'âœ… ì™„ë£Œ!':'â†©ï¸ í•´ì œ');
  renderDetail(idx); renderGoalGrid(); renderGlobal(); renderAvatar();
};

// ===== ë‹‰ë„¤ì„ í¸ì§‘ =====
window.startEditNickname=function(){
  const row=document.getElementById('avatarNicknameRow');
  const cur=localDash.nickname||currentUser.name||'ë‚˜ì˜ ìºë¦­í„°';
  row.innerHTML=`<div class="nickname-edit-row">
    <input class="nickname-input" id="nicknameInput" type="text" value="${escAttr(cur)}" maxlength="12" placeholder="ì• ì¹­ ì…ë ¥">
    <button class="nickname-save-btn" onclick="saveNickname()">ì €ì¥</button>
  </div>`;
  document.getElementById('nicknameInput').focus();
  document.getElementById('nicknameInput').addEventListener('keydown',e=>{if(e.key==='Enter') window.saveNickname();});
};
window.saveNickname=async function(){
  const val=(document.getElementById('nicknameInput')||{}).value?.trim();
  if(!val){showToast('âŒ ì• ì¹­ì„ ì…ë ¥í•˜ì„¸ìš”');return;}
  localDash.nickname=val;
  await saveDash();
  showToast('âœ… ì• ì¹­ ì €ì¥ ì™„ë£Œ!');
  renderAvatar();
};

// ===== UTILS =====
window.renderDetail=renderDetail;
function escAttr(s){ return (s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function esc(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('show'),2200);
}
window.showToast=showToast;
</script>
</body>
</html>
