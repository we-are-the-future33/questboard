<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>QUEST BOARD</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

  :root {
    --bg: #0d0d0d;
    --surface: #161616;
    --surface2: #1f1f1f;
    --border: #2a2a2a;
    --accent: #c8f135;
    --accent2: #f1c835;
    --text: #f0f0f0;
    --text-dim: #888;
    --danger: #f13535;
    --radius: 12px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Sans KR', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  .screen { display: none; min-height: 100vh; }
  .screen.active { display: flex; }

  /* ===== LOADING ===== */
  #loadingScreen {
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 20px;
  }
  .loading-logo {
    font-family: 'Black Han Sans', sans-serif;
    font-size: 38px;
    letter-spacing: 5px;
    color: var(--accent);
  }
  .loading-spinner {
    width: 32px; height: 32px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ===== LOGIN ===== */
  #loginScreen {
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }
  #loginScreen::before {
    content: '';
    position: absolute;
    width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(200,241,53,0.07) 0%, transparent 70%);
    top: -150px; left: -150px;
    pointer-events: none;
  }
  #loginScreen::after {
    content: '';
    position: absolute;
    width: 400px; height: 400px;
    background: radial-gradient(circle, rgba(53,200,241,0.05) 0%, transparent 70%);
    bottom: -50px; right: -50px;
    pointer-events: none;
  }

  .login-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 48px 40px;
    width: 380px;
    max-width: 92vw;
    position: relative;
    z-index: 1;
  }
  .login-logo { font-family: 'Black Han Sans', sans-serif; font-size: 38px; letter-spacing: 5px; color: var(--accent); text-align: center; margin-bottom: 4px; }
  .login-sub { text-align: center; color: var(--text-dim); font-size: 12px; letter-spacing: 3px; margin-bottom: 40px; }

  .input-group { margin-bottom: 16px; }
  .input-group label { display: block; font-size: 11px; color: var(--text-dim); margin-bottom: 7px; letter-spacing: 1.5px; text-transform: uppercase; }
  .input-group input {
    width: 100%; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; padding: 13px 16px; color: var(--text); font-size: 15px;
    font-family: 'Noto Sans KR', sans-serif; outline: none; transition: border-color 0.2s;
  }
  .input-group input:focus { border-color: var(--accent); }

  .btn-primary {
    width: 100%; background: var(--accent); color: #0d0d0d; border: none;
    border-radius: 8px; padding: 14px; font-size: 15px; font-weight: 700;
    font-family: 'Noto Sans KR', sans-serif; cursor: pointer; margin-top: 8px;
    transition: opacity 0.2s, transform 0.1s; letter-spacing: 1px;
  }
  .btn-primary:hover { opacity: 0.88; }
  .btn-primary:active { transform: scale(0.98); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

  .login-error { color: var(--danger); font-size: 13px; text-align: center; margin-top: 14px; display: none; }

  /* ===== NAV ===== */
  .topnav {
    position: fixed; top: 0; left: 0; right: 0; height: 56px;
    background: rgba(13,13,13,0.96); backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border); display: flex;
    align-items: center; justify-content: space-between; padding: 0 24px; z-index: 100;
  }
  .nav-logo { font-family: 'Black Han Sans', sans-serif; font-size: 20px; color: var(--accent); letter-spacing: 3px; }
  .nav-badge { font-size: 10px; color: var(--accent2); letter-spacing: 1px; margin-left: 6px; vertical-align: middle; }
  .nav-right { display: flex; align-items: center; gap: 10px; }
  .nav-user { font-size: 13px; color: var(--text-dim); }

  .btn-sm {
    background: var(--surface2); border: 1px solid var(--border); color: var(--text);
    border-radius: 6px; padding: 6px 14px; font-size: 13px;
    font-family: 'Noto Sans KR', sans-serif; cursor: pointer;
    transition: border-color 0.2s, color 0.2s; white-space: nowrap;
  }
  .btn-sm:hover { border-color: var(--accent); color: var(--accent); }

  /* ===== PAGE LAYOUT ===== */
  #dashboardScreen, #goalDetailScreen, #adminScreen, #userSettingsScreen {
    flex-direction: column; padding-top: 56px;
  }
  .page-content { padding: 32px 24px; max-width: 820px; margin: 0 auto; width: 100%; }

  .section-title { font-family: 'Black Han Sans', sans-serif; font-size: 20px; letter-spacing: 2px; margin-bottom: 20px; color: var(--accent); }

  /* ===== ADMIN ===== */
  .admin-hero { text-align: center; padding: 36px 0 28px; border-bottom: 1px solid var(--border); margin-bottom: 36px; }
  .admin-hero-title { font-family: 'Black Han Sans', sans-serif; font-size: 26px; letter-spacing: 4px; color: var(--accent2); margin-bottom: 8px; }
  .admin-hero-sub { color: var(--text-dim); font-size: 14px; }

  .create-form { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 28px; max-width: 460px; margin: 0 auto; }

  .form-row { margin-bottom: 16px; }
  .form-row label { display: block; font-size: 11px; color: var(--text-dim); letter-spacing: 1.5px; text-transform: uppercase; margin-bottom: 7px; }
  .form-row input {
    width: 100%; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; padding: 12px 14px; color: var(--text); font-size: 14px;
    font-family: 'Noto Sans KR', sans-serif; outline: none; transition: border-color 0.2s;
  }
  .form-row input:focus { border-color: var(--accent2); }

  .btn-accent {
    background: var(--accent); color: #0d0d0d; border: none; border-radius: 8px;
    padding: 13px 24px; font-size: 14px; font-weight: 700; font-family: 'Noto Sans KR', sans-serif;
    cursor: pointer; transition: opacity 0.2s, transform 0.1s; letter-spacing: 1px;
  }
  .btn-accent:hover { opacity: 0.85; }
  .btn-accent.full { width: 100%; margin-top: 4px; }

  .admin-user-list { margin-top: 44px; }
  .user-chip-list { display: flex; flex-wrap: wrap; gap: 10px; max-width: 460px; margin: 0 auto; }
  .user-chip { background: var(--surface); border: 1px solid var(--border); border-radius: 100px; padding: 8px 18px; display: flex; align-items: center; gap: 10px; }
  .user-chip-name { font-weight: 700; font-size: 14px; }
  .user-chip-id { color: var(--text-dim); font-size: 12px; }

  /* ===== DASHBOARD ===== */
  .dash-header { margin-bottom: 36px; }
  .dash-greeting { font-size: 14px; color: var(--text-dim); margin-bottom: 4px; }
  .dash-name { font-family: 'Black Han Sans', sans-serif; font-size: 34px; letter-spacing: 2px; }

  .goals-grid { display: flex; flex-direction: column; gap: 10px; margin-bottom: 40px; }

  .goal-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px 24px; cursor: pointer; transition: border-color 0.2s, transform 0.15s; }
  .goal-card:hover { border-color: var(--accent); transform: translateX(4px); }
  .goal-card-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .goal-card-title { font-weight: 700; font-size: 16px; }
  .goal-card-pct { font-family: 'Black Han Sans', sans-serif; font-size: 22px; color: var(--accent); }

  .progress-bar { height: 4px; background: var(--surface2); border-radius: 2px; overflow: hidden; }
  .progress-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.5s ease; }

  .sticker-section-title { font-family: 'Black Han Sans', sans-serif; font-size: 16px; letter-spacing: 2px; color: var(--text-dim); margin-bottom: 14px; }
  .sticker-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
  .sticker-cell { aspect-ratio: 1; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 28px; }
  .sticker-cell.filled { animation: pop 0.3s ease; }

  @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 70% { transform: scale(1.15); } 100% { transform: scale(1); opacity: 1; } }

  .no-content { text-align: center; padding: 48px 20px; color: var(--text-dim); font-size: 15px; line-height: 1.7; }

  /* ===== GOAL DETAIL ===== */
  .back-btn { background: transparent; border: none; color: var(--text-dim); font-size: 14px; font-family: 'Noto Sans KR', sans-serif; cursor: pointer; padding: 0; margin-bottom: 20px; display: inline-flex; align-items: center; gap: 6px; transition: color 0.2s; }
  .back-btn:hover { color: var(--accent); }
  .detail-title { font-family: 'Black Han Sans', sans-serif; font-size: 26px; letter-spacing: 2px; margin-bottom: 16px; }
  .detail-progress-row { display: flex; align-items: center; gap: 20px; margin-bottom: 32px; }
  .detail-pct { font-family: 'Black Han Sans', sans-serif; font-size: 52px; color: var(--accent); line-height: 1; min-width: 110px; }
  .detail-bar-wrap { flex: 1; }
  .detail-bar { height: 8px; background: var(--surface2); border-radius: 4px; overflow: hidden; }
  .detail-bar-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2)); border-radius: 4px; transition: width 0.5s ease; }
  .detail-count { font-size: 13px; color: var(--text-dim); margin-top: 6px; }

  .sub-goals-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
  .sub-item { aspect-ratio: 1; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; padding: 8px; text-align: center; transition: border-color 0.2s, background 0.2s, transform 0.15s; user-select: none; position: relative; overflow: hidden; }
  .sub-item:hover { transform: scale(1.05); }
  .sub-item:active { transform: scale(0.94); }
  .sub-item.done { background: var(--accent); border-color: var(--accent); }
  .sub-item.done .sub-num { color: rgba(0,0,0,0.4); }
  .sub-item.done .sub-text { color: #0d0d0d; }
  .sub-num { font-size: 11px; color: var(--text-dim); margin-bottom: 4px; }
  .sub-text { font-size: 12px; font-weight: 500; line-height: 1.3; word-break: break-all; }
  .sub-check { position: absolute; top: 4px; right: 6px; font-size: 13px; opacity: 0; transition: opacity 0.2s; color: rgba(0,0,0,0.45); }
  .sub-item.done .sub-check { opacity: 1; }

  /* ===== USER SETTINGS ===== */
  .settings-tabs { display: flex; border-bottom: 1px solid var(--border); margin-bottom: 28px; }
  .stab { background: transparent; border: none; border-bottom: 2px solid transparent; color: var(--text-dim); font-size: 14px; font-family: 'Noto Sans KR', sans-serif; padding: 10px 20px; cursor: pointer; transition: color 0.2s, border-color 0.2s; margin-bottom: -1px; }
  .stab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .stab-panel { display: none; }
  .stab-panel.active { display: block; }

  .goal-setting-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 12px; }
  .gscard-row { display: flex; gap: 10px; align-items: center; margin-bottom: 14px; }
  .gscard-row input { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 10px 12px; color: var(--text); font-size: 14px; font-family: 'Noto Sans KR', sans-serif; outline: none; }
  .gscard-row input:focus { border-color: var(--accent); }
  .subgoals-config-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
  .sg-input { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 7px 8px; color: var(--text); font-size: 12px; font-family: 'Noto Sans KR', sans-serif; outline: none; width: 100%; }
  .sg-input:focus { border-color: var(--accent2); }

  .add-goal-btn { background: transparent; border: 1px dashed var(--border); color: var(--text-dim); border-radius: var(--radius); padding: 14px; width: 100%; cursor: pointer; font-size: 14px; font-family: 'Noto Sans KR', sans-serif; transition: border-color 0.2s, color 0.2s; margin-top: 4px; }
  .add-goal-btn:hover { border-color: var(--accent); color: var(--accent); }

  .rm-btn { background: transparent; border: 1px solid var(--border); color: var(--text-dim); border-radius: 6px; padding: 9px 11px; cursor: pointer; font-size: 13px; transition: border-color 0.2s, color 0.2s; flex-shrink: 0; }
  .rm-btn:hover { border-color: var(--danger); color: var(--danger); }

  .sticker-setting-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
  .ss-cell { aspect-ratio: 1; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; transition: border-color 0.2s, transform 0.1s; }
  .ss-cell:hover { border-color: var(--accent2); transform: scale(1.06); }
  .ss-cell.has-sticker { border-color: var(--accent2); }
  .ss-plus { color: var(--border); font-size: 18px; }

  /* ===== MODAL ===== */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.82); display: none; align-items: center; justify-content: center; z-index: 200; }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 32px; width: 360px; max-width: 90vw; }
  .modal-title { font-family: 'Black Han Sans', sans-serif; font-size: 20px; margin-bottom: 20px; letter-spacing: 2px; }
  .emoji-picker { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; max-height: 240px; overflow-y: auto; }
  .emoji-opt { aspect-ratio: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; transition: border-color 0.2s, transform 0.1s; }
  .emoji-opt:hover { border-color: var(--accent2); transform: scale(1.12); }
  .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
  .btn-ghost { flex: 1; background: transparent; border: 1px solid var(--border); color: var(--text-dim); border-radius: 6px; padding: 10px; font-size: 14px; font-family: 'Noto Sans KR', sans-serif; cursor: pointer; transition: border-color 0.2s; }
  .btn-ghost:hover { border-color: var(--text-dim); }

  /* ===== TOAST ===== */
  .toast { position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%) translateY(80px); background: var(--accent); color: #0d0d0d; padding: 12px 26px; border-radius: 100px; font-weight: 700; font-size: 14px; transition: transform 0.3s ease; z-index: 999; pointer-events: none; white-space: nowrap; }
  .toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- LOADING -->
<div id="loadingScreen" class="screen active">
  <div class="loading-logo">QUEST</div>
  <div class="loading-spinner"></div>
</div>

<!-- LOGIN -->
<div id="loginScreen" class="screen">
  <div class="login-box">
    <div class="login-logo">QUEST</div>
    <div class="login-sub">BOARD</div>
    <div class="input-group">
      <label>ì•„ì´ë””</label>
      <input type="text" id="loginId" placeholder="ì•„ì´ë”” ì…ë ¥" autocomplete="username">
    </div>
    <div class="input-group">
      <label>ë¹„ë°€ë²ˆí˜¸</label>
      <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password">
    </div>
    <button class="btn-primary" id="loginBtn" onclick="doLogin()">ë¡œê·¸ì¸</button>
    <div class="login-error" id="loginError">ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
  </div>
</div>

<!-- ADMIN -->
<div id="adminScreen" class="screen">
  <nav class="topnav">
    <div class="nav-logo">QUEST <span class="nav-badge">ADMIN</span></div>
    <div class="nav-right">
      <button class="btn-sm" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </nav>
  <div class="page-content">
    <div class="admin-hero">
      <div class="admin-hero-title">ADMIN PANEL</div>
      <div class="admin-hero-sub">ìœ ì € ê³„ì •ì„ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ì„¸ìš”</div>
    </div>
    <div class="create-form">
      <div class="section-title" style="font-size:16px;margin-bottom:20px;">ìƒˆ ê³„ì • ìƒì„±</div>
      <div class="form-row"><label>ì´ë¦„</label><input type="text" id="newUserName" placeholder="ìœ ì € ì´ë¦„"></div>
      <div class="form-row"><label>ì•„ì´ë””</label><input type="text" id="newUserId" placeholder="ë¡œê·¸ì¸ ì•„ì´ë””"></div>
      <div class="form-row"><label>ë¹„ë°€ë²ˆí˜¸</label><input type="text" id="newUserPw" placeholder="ë¹„ë°€ë²ˆí˜¸"></div>
      <button class="btn-accent full" onclick="createUser()">ê³„ì • ìƒì„±</button>
    </div>
    <div class="admin-user-list">
      <div class="section-title" style="font-size:16px;text-align:center;margin-bottom:16px;">ë“±ë¡ëœ ìœ ì €</div>
      <div class="user-chip-list" id="adminUserChips"></div>
    </div>
  </div>
</div>

<!-- USER DASHBOARD -->
<div id="dashboardScreen" class="screen">
  <nav class="topnav">
    <div class="nav-logo">QUEST</div>
    <div class="nav-right">
      <span class="nav-user" id="navUserName"></span>
      <button class="btn-sm" onclick="goToSettings()">âš™ ì„¤ì •</button>
      <button class="btn-sm" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </nav>
  <div class="page-content">
    <div class="dash-header">
      <div class="dash-greeting">ì•ˆë…•í•˜ì„¸ìš”,</div>
      <div class="dash-name" id="dashUsername"></div>
    </div>
    <div class="section-title">ğŸ¯ ëª©í‘œ</div>
    <div class="goals-grid" id="goalsList"></div>
    <div class="sticker-section-title">âœ¨ ìŠ¤í‹°ì»¤ ë³´ë“œ</div>
    <div class="sticker-grid" id="stickerBoard"></div>
  </div>
</div>

<!-- GOAL DETAIL -->
<div id="goalDetailScreen" class="screen">
  <nav class="topnav">
    <div class="nav-logo">QUEST</div>
    <div class="nav-right">
      <span class="nav-user" id="navUserName2"></span>
      <button class="btn-sm" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </nav>
  <div class="page-content">
    <button class="back-btn" onclick="goToDashboard()">â† ëŒ€ì‹œë³´ë“œ</button>
    <div class="detail-title" id="detailGoalTitle"></div>
    <div class="detail-progress-row">
      <div class="detail-pct" id="detailPct">0%</div>
      <div class="detail-bar-wrap">
        <div class="detail-bar"><div class="detail-bar-fill" id="detailBarFill" style="width:0%"></div></div>
        <div class="detail-count" id="detailCount">0 / 25 ë‹¬ì„±</div>
      </div>
    </div>
    <div class="sub-goals-grid" id="subGoalsList"></div>
  </div>
</div>

<!-- USER SETTINGS -->
<div id="userSettingsScreen" class="screen">
  <nav class="topnav">
    <div class="nav-logo">QUEST</div>
    <div class="nav-right">
      <span class="nav-user" id="navUserName3"></span>
      <button class="btn-sm" onclick="goToDashboard()">â† ëŒ€ì‹œë³´ë“œ</button>
      <button class="btn-sm" onclick="doLogout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>
  </nav>
  <div class="page-content">
    <div class="section-title">âš™ï¸ ë‚´ ëŒ€ì‹œë³´ë“œ ì„¤ì •</div>
    <div class="settings-tabs">
      <button class="stab active" onclick="switchStab(this,'stabGoals')">ëª©í‘œ ê´€ë¦¬</button>
      <button class="stab" onclick="switchStab(this,'stabStickers')">ìŠ¤í‹°ì»¤ ì„¤ì •</button>
    </div>
    <div class="stab-panel active" id="stabGoals">
      <div id="goalSettingsList"></div>
      <button class="add-goal-btn" id="addGoalBtn" onclick="addGoal()">+ ëª©í‘œ ì¶”ê°€</button>
    </div>
    <div class="stab-panel" id="stabStickers">
      <div class="sticker-setting-grid" id="stickerSettingGrid"></div>
    </div>
  </div>
</div>

<!-- EMOJI MODAL -->
<div class="modal-overlay" id="emojiModal">
  <div class="modal">
    <div class="modal-title">ìŠ¤í‹°ì»¤ ì„ íƒ</div>
    <div class="emoji-picker" id="emojiPicker"></div>
    <div class="modal-actions">
      <button class="btn-ghost" onclick="clearSticker()">ë¹„ìš°ê¸°</button>
      <button class="btn-ghost" onclick="closeEmojiModal()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, get, set, update, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAbEbLdJuWVai_NKTHuo1XtC8p76dmVPE0",
    authDomain: "grow-goal.firebaseapp.com",
    databaseURL: "https://grow-goal-default-rtdb.firebaseio.com",
    projectId: "grow-goal",
    storageBucket: "grow-goal.firebasestorage.app",
    messagingSenderId: "587441793315",
    appId: "1:587441793315:web:8ae5325a2af90953ce4496",
    measurementId: "G-YPQ00335VX"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const EMOJIS = ['â­','ğŸŒŸ','ğŸ”¥','ğŸ’','ğŸ†','ğŸ¯','ğŸª','ğŸŒˆ','ğŸ¦‹','ğŸŒ¸','ğŸµ','ğŸ¨','ğŸš€','ğŸŒ™','â˜€ï¸','â¤ï¸','ğŸ’œ','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ€','ğŸŒº','ğŸ¦„','ğŸ­','ğŸ ','ğŸ­','ğŸ‹','ğŸŒŠ','âš¡','ğŸ','ğŸ¦Š','ğŸ¬','ğŸ¦','ğŸ¯','ğŸŒ»','ğŸ','ğŸ‰','ğŸŠ','ğŸŒ','ğŸŒ€','âœ¨','ğŸ“','ğŸ¥','ğŸŒ´','ğŸ¸'];

  let currentUser = null;
  let currentGoalIdx = null;
  let editStickerIdx = null;
  let localDash = null; // í˜„ì¬ ìœ ì € ëŒ€ì‹œë³´ë“œ ë¡œì»¬ ìºì‹œ

  // ===== SCREENS =====
  function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    window.scrollTo(0, 0);
  }

  function goToDashboard() { showScreen('dashboardScreen'); renderDashboard(); }
  function goToSettings() { showScreen('userSettingsScreen'); renderUserSettings(); }

  window.goToDashboard = goToDashboard;
  window.goToSettings = goToSettings;

  // ===== INIT =====
  // ê´€ë¦¬ì ê³„ì • ì´ˆê¸°í™” (ì—†ìœ¼ë©´ ìƒì„±)
  async function initAdmin() {
    const adminRef = ref(db, 'users/admin');
    const snap = await get(adminRef);
    if (!snap.exists()) {
      await set(adminRef, { name: 'ê´€ë¦¬ì', password: 'admin1234', role: 'admin' });
    }
    showScreen('loginScreen');
  }

  initAdmin();

  // ===== LOGIN =====
  window.doLogin = async function() {
    const id = document.getElementById('loginId').value.trim();
    const pw = document.getElementById('loginPw').value;
    const btn = document.getElementById('loginBtn');

    if (!id || !pw) return;
    btn.disabled = true;
    btn.textContent = 'í™•ì¸ ì¤‘...';

    try {
      const snap = await get(ref(db, `users/${id}`));
      if (!snap.exists() || snap.val().password !== pw) {
        document.getElementById('loginError').style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'ë¡œê·¸ì¸';
        return;
      }
      document.getElementById('loginError').style.display = 'none';
      const u = snap.val();
      currentUser = { id, ...u };

      if (u.role === 'admin') {
        showScreen('adminScreen');
        renderAdminUserList();
      } else {
        setNavNames(u.name);
        await loadDash();
        showScreen('dashboardScreen');
        renderDashboard();
      }
    } catch(e) {
      showToast('âŒ ì—°ê²° ì˜¤ë¥˜. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    }
    btn.disabled = false;
    btn.textContent = 'ë¡œê·¸ì¸';
  };

  ['loginId','loginPw'].forEach(id => {
    document.getElementById(id).addEventListener('keydown', e => { if (e.key === 'Enter') window.doLogin(); });
  });

  window.doLogout = function() {
    currentUser = null; currentGoalIdx = null; localDash = null;
    document.getElementById('loginId').value = '';
    document.getElementById('loginPw').value = '';
    showScreen('loginScreen');
  };

  function setNavNames(name) {
    document.getElementById('navUserName').textContent = name;
    document.getElementById('navUserName2').textContent = name;
    document.getElementById('navUserName3').textContent = name;
  }

  // ===== DASH LOAD/SAVE =====
  async function loadDash() {
    const snap = await get(ref(db, `dashboards/${currentUser.id}`));
    if (snap.exists()) {
      localDash = snap.val();
    } else {
      localDash = { goals: [], stickers: Array(25).fill(null) };
    }
    // ë°°ì—´ ì •ê·œí™”
    if (!localDash.stickers) localDash.stickers = Array(25).fill(null);
    if (!localDash.goals) localDash.goals = [];
  }

  async function saveDash() {
    await set(ref(db, `dashboards/${currentUser.id}`), localDash);
  }

  // ===== ADMIN =====
  async function renderAdminUserList() {
    const snap = await get(ref(db, 'users'));
    const chips = document.getElementById('adminUserChips');
    if (!snap.exists()) { chips.innerHTML = '<div style="color:var(--text-dim);font-size:14px;padding:20px 0;text-align:center;width:100%;">ë“±ë¡ëœ ìœ ì € ì—†ìŒ</div>'; return; }
    const users = Object.entries(snap.val()).filter(([, u]) => u.role !== 'admin');
    if (users.length === 0) { chips.innerHTML = '<div style="color:var(--text-dim);font-size:14px;padding:20px 0;text-align:center;width:100%;">ë“±ë¡ëœ ìœ ì € ì—†ìŒ</div>'; return; }
    chips.innerHTML = users.map(([id, u]) =>
      `<div class="user-chip"><span class="user-chip-name">${esc(u.name)}</span><span class="user-chip-id">@${esc(id)}</span></div>`
    ).join('');
  }

  window.createUser = async function() {
    const name = document.getElementById('newUserName').value.trim();
    const id = document.getElementById('newUserId').value.trim();
    const pw = document.getElementById('newUserPw').value.trim();
    if (!name || !id || !pw) { showToast('âŒ ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”'); return; }

    const snap = await get(ref(db, `users/${id}`));
    if (snap.exists()) { showToast('âŒ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””'); return; }

    await set(ref(db, `users/${id}`), { name, password: pw, role: 'user' });
    document.getElementById('newUserName').value = '';
    document.getElementById('newUserId').value = '';
    document.getElementById('newUserPw').value = '';
    showToast(`âœ… ${name} ê³„ì • ìƒì„± ì™„ë£Œ!`);
    renderAdminUserList();
  };

  // ===== DASHBOARD =====
  function renderDashboard() {
    document.getElementById('dashUsername').textContent = currentUser.name + 'ë‹˜';
    const dash = localDash;

    const gl = document.getElementById('goalsList');
    if (!dash.goals || dash.goals.length === 0) {
      gl.innerHTML = '<div class="no-content">ì•„ì§ ì„¤ì •ëœ ëª©í‘œê°€ ì—†ìŠµë‹ˆë‹¤.<br><small style="font-size:13px;margin-top:8px;display:block;">ì˜¤ë¥¸ìª½ ìƒë‹¨ âš™ ì„¤ì •ì—ì„œ ëª©í‘œë¥¼ ì¶”ê°€í•˜ì„¸ìš”</small></div>';
    } else {
      gl.innerHTML = dash.goals.map((g, i) => {
        const done = (g.subGoals || []).filter(s => s && s.done).length;
        const pct = Math.round((done / 25) * 100);
        return `<div class="goal-card" onclick="openGoalDetail(${i})">
          <div class="goal-card-row">
            <div class="goal-card-title">${esc(g.title || 'ëª©í‘œ ' + (i+1))}</div>
            <div class="goal-card-pct">${pct}%</div>
          </div>
          <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
        </div>`;
      }).join('');
    }

    const sb = document.getElementById('stickerBoard');
    const stickers = Array.isArray(dash.stickers) ? dash.stickers : Object.values(dash.stickers || {});
    sb.innerHTML = Array(25).fill(0).map((_, i) => {
      const s = stickers[i];
      return `<div class="sticker-cell ${s ? 'filled' : ''}">${s || ''}</div>`;
    }).join('');
  }

  window.openGoalDetail = function(gi) {
    currentGoalIdx = gi;
    const goal = localDash.goals[gi];
    if (!goal.subGoals || goal.subGoals.length < 25) {
      goal.subGoals = Array(25).fill(null).map((_, i) =>
        (goal.subGoals && goal.subGoals[i]) ? goal.subGoals[i] : { title: '', done: false, count: 0 }
      );
    }
    document.getElementById('detailGoalTitle').textContent = goal.title || 'ëª©í‘œ ' + (gi+1);
    renderSubGoals();
    showScreen('goalDetailScreen');
  };

  function renderSubGoals() {
    const goal = localDash.goals[currentGoalIdx];
    const done = goal.subGoals.filter(s => s && s.done).length;
    const pct = Math.round((done / 25) * 100);
    document.getElementById('detailPct').textContent = pct + '%';
    document.getElementById('detailBarFill').style.width = pct + '%';
    document.getElementById('detailCount').textContent = `${done} / 25 ë‹¬ì„±`;
    document.getElementById('subGoalsList').innerHTML = goal.subGoals.map((s, i) =>
      `<div class="sub-item ${s && s.done ? 'done' : ''}" onclick="toggleSub(${i})">
        <div class="sub-check">âœ“</div>
        <div class="sub-num">${i+1}</div>
        <div class="sub-text">${esc((s && s.title) || '')}</div>
      </div>`
    ).join('');
  }

  window.toggleSub = async function(idx) {
    const sub = localDash.goals[currentGoalIdx].subGoals[idx];
    sub.count = (sub.count || 0) + 1;
    sub.done = sub.count % 2 === 1;
    renderSubGoals();
    showToast(sub.done ? 'âœ… ë‹¬ì„±!' : 'â†©ï¸ í•´ì œ');
    await saveDash();
  };

  // ===== USER SETTINGS =====
  function renderUserSettings() { renderGoalSettings(); renderStickerSettings(); }

  window.switchStab = function(btn, panelId) {
    document.querySelectorAll('.stab').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.stab-panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(panelId).classList.add('active');
  };

  function renderGoalSettings() {
    const dash = localDash;
    const list = document.getElementById('goalSettingsList');
    const addBtn = document.getElementById('addGoalBtn');
    const goalCount = (dash.goals || []).length;

    list.innerHTML = (dash.goals || []).map((g, gi) => {
      const subInputs = Array(25).fill(0).map((_, si) => {
        const val = g.subGoals && g.subGoals[si] ? g.subGoals[si].title : '';
        return `<input class="sg-input" placeholder="${si+1}ë²ˆ" value="${escAttr(val)}" oninput="updateSubTitle(${gi},${si},this.value)">`;
      }).join('');
      return `<div class="goal-setting-card">
        <div class="gscard-row">
          <input type="text" placeholder="ëª©í‘œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" value="${escAttr(g.title||'')}" oninput="updateGoalTitle(${gi},this.value)">
          <button class="rm-btn" onclick="removeGoal(${gi})">âœ•</button>
        </div>
        <div class="subgoals-config-grid">${subInputs}</div>
      </div>`;
    }).join('');

    if (goalCount < 5) {
      addBtn.style.display = 'block';
      addBtn.textContent = `+ ëª©í‘œ ì¶”ê°€ (${goalCount}/5)`;
    } else {
      addBtn.style.display = 'none';
    }
  }

  let saveTimer = null;
  function debounceSave() {
    clearTimeout(saveTimer);
    saveTimer = setTimeout(() => saveDash(), 800);
  }

  window.updateGoalTitle = function(gi, val) {
    localDash.goals[gi].title = val;
    debounceSave();
  };

  window.updateSubTitle = function(gi, si, val) {
    if (!localDash.goals[gi].subGoals) {
      localDash.goals[gi].subGoals = Array(25).fill(null).map(() => ({ title: '', done: false, count: 0 }));
    }
    localDash.goals[gi].subGoals[si].title = val;
    debounceSave();
  };

  window.addGoal = function() {
    if (!localDash.goals) localDash.goals = [];
    if (localDash.goals.length >= 5) return;
    localDash.goals.push({ title: '', subGoals: Array(25).fill(null).map(() => ({ title: '', done: false, count: 0 })) });
    saveDash();
    renderGoalSettings();
  };

  window.removeGoal = function(gi) {
    if (!confirm('ì´ ëª©í‘œë¥¼ ì‚­ì œí• ê¹Œìš”?\në‹¬ì„± ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;
    localDash.goals.splice(gi, 1);
    saveDash();
    renderGoalSettings();
    showToast('ğŸ—‘ï¸ ëª©í‘œ ì‚­ì œë¨');
  };

  function renderStickerSettings() {
    const stickers = Array.isArray(localDash.stickers) ? localDash.stickers : Object.values(localDash.stickers || {});
    document.getElementById('stickerSettingGrid').innerHTML = Array(25).fill(0).map((_, i) => {
      const s = stickers[i];
      return `<div class="ss-cell ${s ? 'has-sticker' : ''}" onclick="openEmojiModal(${i})">${s || '<span class="ss-plus">+</span>'}</div>`;
    }).join('');
  }

  window.openEmojiModal = function(idx) {
    editStickerIdx = idx;
    document.getElementById('emojiPicker').innerHTML = EMOJIS.map(e =>
      `<div class="emoji-opt" onclick="selectEmoji('${e}')">${e}</div>`
    ).join('');
    document.getElementById('emojiModal').classList.add('open');
  };

  window.selectEmoji = async function(emoji) {
    if (!Array.isArray(localDash.stickers)) localDash.stickers = Array(25).fill(null);
    localDash.stickers[editStickerIdx] = emoji;
    closeEmojiModal();
    renderStickerSettings();
    showToast('âœ¨ ìŠ¤í‹°ì»¤ ë“±ë¡!');
    await saveDash();
  };

  window.clearSticker = async function() {
    if (!Array.isArray(localDash.stickers)) localDash.stickers = Array(25).fill(null);
    localDash.stickers[editStickerIdx] = null;
    closeEmojiModal();
    renderStickerSettings();
    await saveDash();
  };

  window.closeEmojiModal = function() {
    document.getElementById('emojiModal').classList.remove('open');
  };

  // ===== UTILS =====
  function esc(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }

  function escAttr(str) {
    return (str || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    clearTimeout(t._timer);
    t._timer = setTimeout(() => t.classList.remove('show'), 2200);
  }

  window.showToast = showToast;
</script>
</body>
</html>
