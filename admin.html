<!DOCTYPE html>

<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ë™ë¬¼ í‚¤ìš°ê¸° Â· ì–´ë“œë¯¼</title>
<link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0a0a;--surface:#141414;--surface2:#1e1e1e;--border:#2a2a2a;
  --accent:#c8f135;--accent2:#f1c835;--danger:#f13535;
  --text:#f0f0f0;--text-dim:#666;--radius:14px;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--text);font-family:'Noto Sans KR',sans-serif;min-height:100vh;}

/* LOGIN */
#loginWrap{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:32px 24px;}
.login-card{width:100%;max-width:380px;background:var(â€“surface);border:1px solid var(â€“border);border-radius:20px;padding:40px 32px;}
.login-logo{font-family:â€˜Black Han Sansâ€™,sans-serif;font-size:22px;letter-spacing:3px;color:var(â€“accent);margin-bottom:4px;}
.login-sub{font-size:11px;color:var(â€“text-dim);letter-spacing:3px;margin-bottom:32px;}
.field{margin-bottom:16px;}
.field label{display:block;font-size:11px;color:var(â€“text-dim);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:7px;}
.field input{width:100%;background:var(â€“surface2);border:1px solid var(â€“border);border-radius:10px;padding:12px 14px;color:var(â€“text);font-size:14px;font-family:â€˜Noto Sans KRâ€™,sans-serif;outline:none;transition:border-color .2s;}
.field input:focus{border-color:var(â€“accent);}
.btn-primary{width:100%;background:var(â€“accent);color:#0a0a0a;border:none;border-radius:10px;padding:14px;font-size:15px;font-weight:700;font-family:â€˜Noto Sans KRâ€™,sans-serif;cursor:pointer;margin-top:8px;transition:opacity .2s;}
.btn-primary:hover{opacity:.88;}
.login-err{color:var(â€“danger);font-size:12px;text-align:center;margin-top:10px;display:none;}

/* LAYOUT */
#adminWrap{display:none;max-width:900px;margin:0 auto;padding:24px 20px 60px;}
.topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:32px;padding-bottom:20px;border-bottom:1px solid var(â€“border);}
.topbar-logo{font-family:â€˜Black Han Sansâ€™,sans-serif;font-size:20px;letter-spacing:3px;color:var(â€“accent);}
.topbar-sub{font-size:11px;color:var(â€“text-dim);letter-spacing:2px;margin-top:2px;}
.btn-sm{background:var(â€“surface2);border:1px solid var(â€“border);color:var(â€“text-dim);border-radius:8px;padding:7px 14px;font-size:12px;font-family:â€˜Noto Sans KRâ€™,sans-serif;cursor:pointer;transition:border-color .2s,color .2s;}
.btn-sm:hover{border-color:var(â€“accent);color:var(â€“accent);}

/* SECTION */
.section{margin-bottom:40px;}
.section-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.section-title{font-family:â€˜Black Han Sansâ€™,sans-serif;font-size:16px;letter-spacing:2px;color:var(â€“accent);}
.card{background:var(â€“surface);border:1px solid var(â€“border);border-radius:var(â€“radius);padding:20px;}

/* FORM ROW */
.form-inline{display:flex;gap:8px;flex-wrap:wrap;}
.form-inline input,.form-inline select{flex:1;min-width:120px;background:var(â€“surface2);border:1px solid var(â€“border);border-radius:8px;padding:10px 12px;color:var(â€“text);font-size:13px;font-family:â€˜Noto Sans KRâ€™,sans-serif;outline:none;transition:border-color .2s;}
.form-inline input:focus,.form-inline select:focus{border-color:var(â€“accent);}
.btn-accent{background:var(â€“accent);color:#0a0a0a;border:none;border-radius:8px;padding:10px 18px;font-size:13px;font-weight:700;font-family:â€˜Noto Sans KRâ€™,sans-serif;cursor:pointer;white-space:nowrap;transition:opacity .2s;}
.btn-accent:hover{opacity:.85;}
.btn-danger{background:transparent;border:1px solid var(â€“danger);color:var(â€“danger);border-radius:6px;padding:4px 10px;font-size:11px;font-family:â€˜Noto Sans KRâ€™,sans-serif;cursor:pointer;transition:background .2s;}
.btn-danger:hover{background:rgba(241,53,53,.1);}

/* USER TABLE */
.user-table{width:100%;border-collapse:collapse;margin-top:16px;}
.user-table th{font-size:10px;letter-spacing:1.5px;color:var(â€“text-dim);text-transform:uppercase;padding:8px 12px;text-align:left;border-bottom:1px solid var(â€“border);}
.user-table td{padding:12px 12px;font-size:13px;border-bottom:1px solid rgba(255,255,255,.04);vertical-align:middle;}
.user-table tr:last-child td{border-bottom:none;}
.user-table tr.clickable{cursor:pointer;transition:background .15s;}
.user-table tr.clickable:hover{background:rgba(200,241,53,.04);}
.u-name{font-weight:700;}
.u-id{font-size:11px;color:var(â€“text-dim);}
.u-badge{font-size:10px;padding:2px 8px;border-radius:100px;background:var(â€“surface2);border:1px solid var(â€“border);color:var(â€“text-dim);}
.u-badge.active{border-color:rgba(200,241,53,.4);color:var(â€“accent);}

/* GROUP CARDS */
.group-grid{display:flex;flex-direction:column;gap:12px;margin-top:16px;}
.group-card{background:var(â€“surface2);border:1px solid var(â€“border);border-radius:12px;padding:16px 18px;}
.group-card-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
.group-name{font-family:â€˜Black Han Sansâ€™,sans-serif;font-size:15px;letter-spacing:1px;}
.member-chips{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;}
.member-chip{display:flex;align-items:center;gap:6px;background:var(â€“surface);border:1px solid var(â€“border);border-radius:100px;padding:4px 10px 4px 12px;font-size:12px;}
.member-chip-x{background:transparent;border:none;color:var(â€“text-dim);cursor:pointer;font-size:14px;line-height:1;padding:0 2px;transition:color .15s;}
.member-chip-x:hover{color:var(â€“danger);}
.group-add-row{display:flex;gap:6px;margin-top:8px;}
.group-add-sel{flex:1;background:var(â€“surface);border:1px solid var(â€“border);border-radius:8px;padding:8px 10px;color:var(â€“text);font-size:12px;font-family:â€˜Noto Sans KRâ€™,sans-serif;outline:none;}
.group-add-sel:focus{border-color:var(â€“accent);}
.btn-sm-accent{background:rgba(200,241,53,.15);border:1px solid rgba(200,241,53,.3);color:var(â€“accent);border-radius:8px;padding:8px 12px;font-size:12px;font-weight:700;font-family:â€˜Noto Sans KRâ€™,sans-serif;cursor:pointer;transition:background .2s;}
.btn-sm-accent:hover{background:rgba(200,241,53,.25);}

/* DASHBOARD DETAIL */
.detail-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;overflow-y:auto;padding:24px 16px;}
.detail-panel{max-width:560px;margin:0 auto;background:var(â€“surface);border:1px solid var(â€“border);border-radius:20px;padding:28px;}
.detail-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.detail-name{font-family:â€˜Black Han Sansâ€™,sans-serif;font-size:20px;letter-spacing:1px;}
.detail-id{font-size:12px;color:var(â€“text-dim);margin-top:2px;}
.detail-close{background:transparent;border:1px solid var(â€“border);color:var(â€“text-dim);border-radius:8px;width:32px;height:32px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;}
.meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;}
.meta-card{background:var(â€“surface2);border-radius:10px;padding:12px 14px;}
.meta-label{font-size:10px;color:var(â€“text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;}
.meta-val{font-size:12px;color:var(â€“text);line-height:1.5;}
.meta-val.big{font-family:â€˜Black Han Sansâ€™,sans-serif;font-size:22px;color:var(â€“accent);}
.goal-list{display:flex;flex-direction:column;gap:10px;}
.goal-card{background:var(â€“surface2);border:1px solid var(â€“border);border-radius:10px;padding:14px 16px;}
.goal-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.goal-title{font-size:13px;font-weight:700;}
.goal-pct{font-family:â€˜Black Han Sansâ€™,sans-serif;font-size:20px;}
.goal-bar{height:4px;background:var(â€“border);border-radius:2px;overflow:hidden;margin-bottom:8px;}
.goal-bar-fill{height:100%;border-radius:2px;transition:width .5s;}
.goal-tags{display:flex;flex-wrap:wrap;gap:5px;}
.goal-tag{font-size:10px;background:var(â€“surface);border:1px solid var(â€“border);border-radius:100px;padding:2px 8px;color:var(â€“text-dim);}
.goal-tag.hi{border-color:rgba(200,241,53,.4);color:var(â€“accent);}

/* TOAST */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(â€“accent);color:#0a0a0a;padding:10px 22px;border-radius:100px;font-weight:700;font-size:13px;transition:transform .3s;z-index:9999;pointer-events:none;white-space:nowrap;}
.toast.show{transform:translateX(-50%) translateY(0);}

.empty{color:var(â€“text-dim);font-size:13px;padding:16px 0;text-align:center;}
.divider{height:1px;background:var(â€“border);margin:20px 0;}
</style>

</head>
<body>

<!-- LOGIN -->

<div id="loginWrap">
  <div class="login-card">
    <div class="login-logo">ë™ë¬¼ í‚¤ìš°ê¸°</div>
    <div class="login-sub">ADMIN PANEL</div>
    <div class="field"><label>ì–´ë“œë¯¼ ì•„ì´ë””</label><input type="text" id="aId" placeholder="ì•„ì´ë””" autocomplete="username"></div>
    <div class="field"><label>ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="aPw" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password"></div>
    <button class="btn-primary" onclick="adminLogin()">ë¡œê·¸ì¸</button>
    <div class="login-err" id="loginErr">ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>
  </div>
</div>

<!-- ADMIN -->

<div id="adminWrap">
  <div class="topbar">
    <div>
      <div class="topbar-logo">ë™ë¬¼ í‚¤ìš°ê¸° ADMIN</div>
      <div class="topbar-sub">MANAGEMENT PANEL</div>
    </div>
    <button class="btn-sm" onclick="adminLogout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <!-- ìœ ì € ê´€ë¦¬ -->

  <div class="section">
    <div class="section-hdr">
      <div class="section-title">ğŸ‘¤ ìœ ì € ê´€ë¦¬</div>
      <button class="btn-sm" onclick="loadAll()">ìƒˆë¡œê³ ì¹¨</button>
    </div>
    <div class="card">
      <div style="font-size:12px;color:var(--text-dim);margin-bottom:14px;">ìƒˆ ê³„ì • ìƒì„±</div>
      <div class="form-inline">
        <input type="text" id="newName" placeholder="ì´ë¦„">
        <input type="text" id="newId" placeholder="ì•„ì´ë”” (ì˜ë¬¸/ìˆ«ì)">
        <input type="text" id="newPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button class="btn-accent" onclick="createUser()">ìƒì„±</button>
      </div>
      <div id="userTableWrap"><div class="empty">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
    </div>
  </div>

  <!-- ê·¸ë£¹ ê´€ë¦¬ -->

  <div class="section">
    <div class="section-hdr">
      <div class="section-title">ğŸ“ ê·¸ë£¹ ê´€ë¦¬</div>
    </div>
    <div class="card">
      <div style="font-size:12px;color:var(--text-dim);margin-bottom:14px;">ìƒˆ ê·¸ë£¹ ìƒì„±</div>
      <div class="form-inline">
        <input type="text" id="newGroupName" placeholder="ê·¸ë£¹ ì´ë¦„">
        <button class="btn-accent" onclick="createGroup()">ìƒì„±</button>
      </div>
      <div class="divider"></div>
      <div id="groupListWrap"><div class="empty">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
    </div>
  </div>
</div>

<!-- ìœ ì € ìƒì„¸ -->

<div class="detail-overlay" id="detailOverlay" onclick="closeDetail(event)">
  <div class="detail-panel" id="detailPanel"></div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, set, remove, push } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAbEbLdJuWVai_NKTHuo1XtC8p76dmVPE0",
  authDomain: "grow-goal.firebaseapp.com",
  databaseURL: "https://grow-goal-default-rtdb.firebaseio.com",
  projectId: "grow-goal",
  storageBucket: "grow-goal.firebasestorage.app",
  messagingSenderId: "587441793315",
  appId: "1:587441793315:web:8ae5325a2af90953ce4496"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const UNIT_LABELS = { once:'í•œ ë²ˆ', daily:'ë§¤ì¼', w1:'ì£¼ 1íšŒ', w2:'ì£¼ 2~3íšŒ', w4:'ì£¼ 4~5íšŒ', w6:'ì£¼ 6íšŒ' };
const UNIT_FREQ   = { once:0, daily:7, w1:1, w2:2, w4:4, w6:6 };

let currentAdmin = null;
let allUsers = {};
let allDash = {};
let allGroups = {};

// ===== UTILS =====
function esc(s){ const d=document.createElement('div'); d.textContent=String(s||''); return d.innerHTML; }
function toast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('show'),2400);
}

// ===== LOGIN =====
window.adminLogin = async function(){
  const id = document.getElementById('aId').value.trim();
  const pw = document.getElementById('aPw').value;
  if(!id||!pw) return;
  try {
    const snap = await get(ref(db,`users/${id}`));
    if(!snap.exists()||snap.val().password!==pw||snap.val().role!=='admin'){
      document.getElementById('loginErr').style.display='block'; return;
    }
    currentAdmin = {id, ...snap.val()};
    document.getElementById('loginWrap').style.display='none';
    document.getElementById('adminWrap').style.display='block';
    loadAll();
  } catch(e){ toast('âŒ ì—°ê²° ì˜¤ë¥˜: '+e.message); }
};
window.adminLogout = function(){
  currentAdmin=null;
  document.getElementById('loginWrap').style.display='flex';
  document.getElementById('adminWrap').style.display='none';
  document.getElementById('aId').value='';
  document.getElementById('aPw').value='';
};
['aId','aPw'].forEach(id=>{
  document.getElementById(id).addEventListener('keydown',e=>{ if(e.key==='Enter') window.adminLogin(); });
});

// ===== LOAD ALL =====
window.loadAll = async function(){
  try {
    const [uSnap, dSnap, gSnap] = await Promise.all([
      get(ref(db,'users')),
      get(ref(db,'dashboards')),
      get(ref(db,'groups'))
    ]);
    allUsers  = uSnap.exists()  ? uSnap.val()  : {};
    allDash   = dSnap.exists()  ? dSnap.val()  : {};
    allGroups = gSnap.exists()  ? gSnap.val()  : {};
    renderUserTable();
    renderGroupList();
  } catch(e){ toast('âŒ ë¡œë“œ ì˜¤ë¥˜: '+e.message); }
};

// ===== USER TABLE =====
function renderUserTable(){
  const wrap = document.getElementById('userTableWrap');
  const users = Object.entries(allUsers).filter(([,u])=>u.role!=='admin');
  if(users.length===0){ wrap.innerHTML='<div class="empty">ë“±ë¡ëœ ìœ ì € ì—†ìŒ</div>'; return; }
  const rows = users.map(([id,u])=>{
    const dash=allDash[id]||{};
    const goals=Array.isArray(dash.goals)?dash.goals.filter(g=>g&&g.title):[];
    const lastLogin=u.lastLogin?new Date(u.lastLogin).toLocaleDateString('ko-KR',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}):'ì—†ìŒ';
    const tut=dash.tutorialDone?'<span class="u-badge active">ì™„ë£Œ</span>':'<span class="u-badge">ë¯¸ì™„ë£Œ</span>';
    return `<tr class="clickable" onclick="showDetail('${id}')">
      <td><div class="u-name">${esc(u.name)}</div><div class="u-id">@${esc(id)}</div></td>
      <td>${goals.length}ê°œ</td>
      <td>${tut}</td>
      <td style="font-size:11px;color:var(--text-dim);">${lastLogin}</td>
      <td onclick="event.stopPropagation()">
        <div style="display:flex;align-items:center;gap:6px;">
          <span id="pw_${id}" style="font-size:12px;color:var(--text-dim);font-family:monospace;">${esc(u.password||'')}</span>
          <button class="btn-sm" style="padding:3px 8px;font-size:11px;" onclick="startEditPw('${id}')">ìˆ˜ì •</button>
        </div>
        <div id="pwEdit_${id}" style="display:none;gap:6px;align-items:center;margin-top:4px;">
          <input id="pwInput_${id}" type="text" value="${esc(u.password||'')}" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:4px 8px;color:var(--text);font-size:12px;font-family:monospace;width:90px;outline:none;">
          <button class="btn-accent" style="padding:4px 8px;font-size:11px;" onclick="savePw('${id}')">ì €ì¥</button>
          <button class="btn-sm" style="padding:4px 8px;font-size:11px;" onclick="cancelEditPw('${id}')">ì·¨ì†Œ</button>
        </div>
      </td>
      <td onclick="event.stopPropagation()"><button class="btn-danger" onclick="deleteUser('${id}')">ì‚­ì œ</button></td>
    </tr>`;
  }).join('');
  wrap.innerHTML=`<table class="user-table">
    <thead><tr><th>ìœ ì €</th><th>ëª©í‘œ</th><th>íŠœí† ë¦¬ì–¼</th><th>ë§ˆì§€ë§‰ ì ‘ì†</th><th>ë¹„ë°€ë²ˆí˜¸</th><th></th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

window.startEditPw = function(id) {
  document.getElementById(`pwEdit_${id}`).style.display='flex';
  document.getElementById(`pw_${id}`).parentElement.style.display='none';
  document.getElementById(`pwInput_${id}`).focus();
};
window.cancelEditPw = function(id) {
  document.getElementById(`pwEdit_${id}`).style.display='none';
  document.getElementById(`pw_${id}`).parentElement.style.display='flex';
};
window.savePw = async function(id) {
  const newPw = document.getElementById(`pwInput_${id}`).value.trim();
  if(!newPw){ toast('âŒ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”'); return; }
  try {
    await set(ref(db,`users/${id}/password`), newPw);
    toast(`âœ… ${allUsers[id]?.name||id} ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì™„ë£Œ`);
    loadAll();
  } catch(e){ toast('âŒ ë³€ê²½ ì‹¤íŒ¨: '+e.message); }
};

// ===== CREATE / DELETE USER =====
window.createUser = async function(){
  const name=document.getElementById('newName').value.trim();
  const id=document.getElementById('newId').value.trim();
  const pw=document.getElementById('newPw').value.trim();
  if(!name||!id||!pw){toast('âŒ ëª¨ë“  í•­ëª© ì…ë ¥ í•„ìš”');return;}
  if(!/^[a-zA-Z0-9_]+$/.test(id)){toast('âŒ ì•„ì´ë””ëŠ” ì˜ë¬¸/ìˆ«ì/_ë§Œ ê°€ëŠ¥');return;}
  if(allUsers[id]){toast('âŒ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””');return;}
  try {
    await set(ref(db,`users/${id}`),{name,password:pw,role:'user'});
    document.getElementById('newName').value='';
    document.getElementById('newId').value='';
    document.getElementById('newPw').value='';
    toast(`âœ… ${name} ê³„ì • ìƒì„± ì™„ë£Œ!`);
    loadAll();
  } catch(e){toast('âŒ ìƒì„± ì‹¤íŒ¨: '+e.message);}
};

window.deleteUser = async function(id){
  if(!confirm(`"${allUsers[id]?.name||id}" ê³„ì •ì„ ì‚­ì œí• ê¹Œìš”?\nëŒ€ì‹œë³´ë“œ ë°ì´í„°ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) return;
  try {
    await Promise.all([
      set(ref(db,`users/${id}`),null),
      set(ref(db,`dashboards/${id}`),null)
    ]);
    toast(`ğŸ—‘ï¸ ${id} ê³„ì • ì‚­ì œ ì™„ë£Œ`);
    loadAll();
  } catch(e){toast('âŒ ì‚­ì œ ì‹¤íŒ¨: '+e.message);}
};

// ===== USER DETAIL =====
window.showDetail = function(id){
  const u=allUsers[id]||{};
  const dash=allDash[id]||{};
  const goals=Array.isArray(dash.goals)?dash.goals:[];
  const completions=dash.completions||{};
  const now=new Date(); const cy=now.getFullYear(),cm=now.getMonth()+1;
  const lastLogin=u.lastLogin?new Date(u.lastLogin).toLocaleString('ko-KR'):'ê¸°ë¡ ì—†ìŒ';
  const lastUpdate=dash.lastUpdate?new Date(dash.lastUpdate).toLocaleString('ko-KR'):'ê¸°ë¡ ì—†ìŒ';

  // ëª©í‘œë³„ ì§„ì²™ë¥ 
  let totalDone=0,totalMod=0;
  const goalCards=goals.map((g,gi)=>{
    if(!g||!g.title||!g.unit) return '';
    const freq=UNIT_FREQ[g.unit]||1;
    let pct=0,done=0,mod=0,streak=0;
    if(g.unit==='once'){
      done=completions[`g${gi}_once`]===true?1:0; mod=1; pct=done*100;
    } else {
      const dim=new Date(cy,cm,0).getDate();
      mod=freq*Math.ceil(dim/7);
      const pfx=`g${gi}_${cy}_${cm}_`;
      done=Object.entries(completions).filter(([k,v])=>k.startsWith(pfx)&&v===true).length;
      pct=mod>0?Math.min(100,Math.round(done/mod*100)):0;
      totalDone+=done; totalMod+=mod;
      // ì—°ì† ë‹¬ì„±
      for(let i=0;i<3;i++){
        let y=cy,m=cm-i; if(m<=0){m+=12;y--;}
        const d2=new Date(y,m,0).getDate();
        const mod2=freq*Math.ceil(d2/7);
        const done2=Object.entries(completions).filter(([k,v])=>k.startsWith(`g${gi}_${y}_${m}_`)&&v===true).length;
        if(mod2>0&&Math.round(done2/mod2*100)>=50) streak++; else break;
      }
    }
    const col=pct>=70?'var(--accent)':pct>=40?'var(--accent2)':'var(--danger)';
    return `<div class="goal-card">
      <div class="goal-top">
        <div class="goal-title">${esc(g.title)}</div>
        <div class="goal-pct" style="color:${col}">${pct}%</div>
      </div>
      <div class="goal-bar"><div class="goal-bar-fill" style="width:${pct}%;background:${col};"></div></div>
      <div class="goal-tags">
        <span class="goal-tag">${UNIT_LABELS[g.unit]||g.unit}</span>
        <span class="goal-tag">${done}/${mod} ì™„ë£Œ</span>
        ${streak>=2?`<span class="goal-tag hi">ğŸ”¥ ${streak}ê°œì›” ì—°ì†</span>`:''}
      </div>
    </div>`;
  }).filter(Boolean).join('');

  const totalGoals=goals.filter(g=>g&&g.title).length;
  const totalPct=totalMod>0?Math.min(100,Math.round(totalDone/totalMod*100)):0;

  document.getElementById('detailPanel').innerHTML=`
    <div class="detail-hdr">
      <div>
        <div class="detail-name">${esc(u.name||id)}</div>
        <div class="detail-id">@${esc(id)}</div>
      </div>
      <button class="detail-close" onclick="closeDetail()">âœ•</button>
    </div>
    <div class="meta-grid">
      <div class="meta-card"><div class="meta-label">ë§ˆì§€ë§‰ ì ‘ì†</div><div class="meta-val">${lastLogin}</div></div>
      <div class="meta-card"><div class="meta-label">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div><div class="meta-val">${lastUpdate}</div></div>
      <div class="meta-card"><div class="meta-label">ë“±ë¡ ëª©í‘œ</div><div class="meta-val big">${totalGoals}ê°œ</div></div>
      <div class="meta-card"><div class="meta-label">ì´ë‹¬ ë‹¬ì„±ë¥ </div><div class="meta-val big" style="color:${totalPct>=70?'var(--accent)':totalPct>=40?'var(--accent2)':'var(--danger)'}">${totalPct}%</div></div>
    </div>
    <div style="font-size:10px;letter-spacing:1.5px;color:var(--text-dim);text-transform:uppercase;margin-bottom:10px;">ëª©í‘œë³„ í˜„í™© (ì´ë²ˆ ë‹¬)</div>
    <div class="goal-list">${goalCards||'<div class="empty">ë“±ë¡ëœ ëª©í‘œ ì—†ìŒ</div>'}</div>`;
  document.getElementById('detailOverlay').style.display='block';
};
window.closeDetail = function(e){
  if(!e||e.target===document.getElementById('detailOverlay'))
    document.getElementById('detailOverlay').style.display='none';
};

// ===== GROUP LIST =====
function renderGroupList(){
  const wrap=document.getElementById('groupListWrap');
  const groups=Object.entries(allGroups);
  const nonAdminUsers=Object.entries(allUsers).filter(([,u])=>u.role!=='admin');
  if(groups.length===0){wrap.innerHTML='<div class="empty">ìƒì„±ëœ ê·¸ë£¹ ì—†ìŒ</div>';return;}
  wrap.innerHTML=`<div class="group-grid">${groups.map(([gid,g])=>{
    const members=g.members?Object.entries(g.members):[];
    const chips=members.map(([mk,uid])=>{
      const name=allUsers[uid]?.name||uid;
      return `<div class="member-chip">${esc(name)} <button class="member-chip-x" onclick="removeMember('${gid}','${mk}')">Ã—</button></div>`;
    }).join('');
    const addOpts=nonAdminUsers.filter(([uid])=>!members.some(([,m])=>m===uid))
      .map(([uid,u])=>`<option value="${uid}">${esc(u.name)} (@${uid})</option>`).join('');
    return `<div class="group-card">
      <div class="group-card-hdr">
        <div class="group-name">ğŸ“ ${esc(g.name)}</div>
        <button class="btn-danger" onclick="deleteGroup('${gid}')">ê·¸ë£¹ ì‚­ì œ</button>
      </div>
      <div class="member-chips">${chips||'<span style="color:var(--text-dim);font-size:12px;">ë©¤ë²„ ì—†ìŒ</span>'}</div>
      ${addOpts?`<div class="group-add-row">
        <select class="group-add-sel" id="sel_${gid}">
          <option value="">+ ë©¤ë²„ ì¶”ê°€...</option>${addOpts}
        </select>
        <button class="btn-sm-accent" onclick="addMember('${gid}')">ì¶”ê°€</button>
      </div>`:'<div style="font-size:11px;color:var(--text-dim);margin-top:4px;">ì¶”ê°€ ê°€ëŠ¥í•œ ìœ ì € ì—†ìŒ</div>'}
    </div>`;
  }).join('')}</div>`;
}

// ===== GROUP CRUD =====
window.createGroup = async function(){
  const name=document.getElementById('newGroupName').value.trim();
  if(!name){toast('âŒ ê·¸ë£¹ ì´ë¦„ ì…ë ¥ í•„ìš”');return;}
  try {
    await push(ref(db,'groups'),{name,members:{}});
    document.getElementById('newGroupName').value='';
    toast(`âœ… "${name}" ê·¸ë£¹ ìƒì„±!`);
    loadAll();
  } catch(e){toast('âŒ ê·¸ë£¹ ìƒì„± ì‹¤íŒ¨: '+e.message);}
};

window.deleteGroup = async function(gid){
  if(!confirm(`"${allGroups[gid]?.name}" ê·¸ë£¹ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
  try {
    await set(ref(db,`groups/${gid}`),null);
    toast('ğŸ—‘ï¸ ê·¸ë£¹ ì‚­ì œ ì™„ë£Œ');
    loadAll();
  } catch(e){toast('âŒ ì‚­ì œ ì‹¤íŒ¨: '+e.message);}
};

window.addMember = async function(gid){
  const sel=document.getElementById(`sel_${gid}`);
  const uid=sel?.value;
  if(!uid) return;
  const key=uid.replace(/[^a-zA-Z0-9_]/g,'_')+'_'+Date.now();
  try {
    await set(ref(db,`groups/${gid}/members/${key}`),uid);
    toast('âœ… ë©¤ë²„ ì¶”ê°€!');
    loadAll();
  } catch(e){toast('âŒ ë©¤ë²„ ì¶”ê°€ ì‹¤íŒ¨: '+e.message);}
};

window.removeMember = async function(gid,mk){
  try {
    await set(ref(db,`groups/${gid}/members/${mk}`),null);
    toast('âœ… ë©¤ë²„ ì œê±°');
    loadAll();
  } catch(e){toast('âŒ ì œê±° ì‹¤íŒ¨: '+e.message);}
};
</script>

</body>
</html>