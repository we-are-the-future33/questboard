<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÎèôÎ¨º ÌÇ§Ïö∞Í∏∞ - Î™©Ìëú Îã¨ÏÑ± Í≤åÏûÑ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://www.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#ffffff;
  --surface:#f4f6ff;
  --surface2:#eaedfc;
  --border:#d6dcf5;
  --accent:#1952f5;
  --accent-light:#e8eeff;
  --accent2:#ff5e7d;
  --accent3:#00b96b;
  --text:#1a1d30;
  --text-dim:#8892b8;
  --danger:#f03e3e;
  --radius:16px;
  --mobile:480px;
  --shadow:0 4px 18px rgba(25,82,245,.13);
  --shadow-sm:0 1px 6px rgba(25,82,245,.09);
}
*{box-sizing:border-box;margin:0;padding:0;}
button{-webkit-appearance:none;appearance:none;-webkit-tap-highlight-color:transparent;}
body{background:#f1f5f9;color:var(--text);font-family:'Noto Sans KR',sans-serif;min-height:100vh;}

.screen{display:none;min-height:100vh;position:relative;z-index:1;}
.screen.active{display:block;}
.mobile-wrap{max-width:var(--mobile);margin:0 auto;background:var(--bg);min-height:100vh;position:relative;box-shadow:0 25px 50px rgba(0,0,0,.12);}

/* LOADING */
#loadingScreen.active{display:flex;align-items:center;justify-content:center;}
#loadingScreen .mobile-wrap{display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px;}
.loading-logo{font-family:'Black Han Sans',sans-serif;font-size:40px;letter-spacing:6px;color:var(--accent);}
.loading-spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* LOGIN */
#loginScreen.active{display:flex;align-items:center;justify-content:center;min-height:100vh;}
#loginScreen .mobile-wrap{display:flex;align-items:center;justify-content:center;min-height:100vh;width:100%;padding:48px 32px;background:linear-gradient(150deg,#dde6ff 0%,#ffffff 55%,#ffe8ef 100%);}
.login-box{width:100%;}
.login-logo{font-size:60px;text-align:center;margin-bottom:8px;display:block;animation:egg-bounce 1.6s ease-in-out infinite;}
@keyframes egg-bounce{0%,100%{transform:translateY(0) rotate(-5deg);}50%{transform:translateY(-12px) rotate(5deg);}}
.login-title{font-family:'Black Han Sans',sans-serif;font-size:32px;letter-spacing:4px;color:var(--accent);text-align:center;margin-bottom:4px;}
.login-sub{text-align:center;color:var(--text-dim);font-size:12px;letter-spacing:3px;margin-bottom:40px;}
.input-group{margin-bottom:16px;}
.input-group label{display:block;font-size:11px;color:var(--text-dim);margin-bottom:8px;letter-spacing:2px;text-transform:uppercase;font-weight:700;}
.input-group input{width:100%;background:#fff;border:2px solid var(--border);border-radius:12px;padding:14px 16px;color:var(--text);font-size:15px;font-family:'Noto Sans KR',sans-serif;outline:none;transition:border-color .2s,box-shadow .2s;box-shadow:var(--shadow-sm);}
.input-group input:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(25,82,245,.10);}
.save-login-row{display:flex;align-items:center;gap:8px;margin-bottom:4px;}
.save-login-row input[type=checkbox]{width:16px;height:16px;accent-color:var(--accent);cursor:pointer;}
.save-login-row label{font-size:12px;color:var(--text-dim);cursor:pointer;}
.btn-primary{width:100%;background:var(--accent);color:#fff;border:none;border-radius:12px;padding:16px;font-size:16px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;margin-top:8px;transition:all .2s;letter-spacing:1px;box-shadow:0 6px 18px rgba(25,82,245,.32);}
.btn-primary:hover{opacity:.9;transform:translateY(-1px);}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.login-error{color:var(--danger);font-size:13px;text-align:center;margin-top:12px;display:none;}

/* NAV */
.topnav{height:56px;background:#fff;border-bottom:2px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 20px;position:sticky;top:0;z-index:50;box-shadow:0 2px 10px rgba(25,82,245,.08);}
.nav-logo{font-family:'Black Han Sans',sans-serif;font-size:18px;color:var(--accent);letter-spacing:2px;}
.nav-badge{font-size:10px;color:var(--accent2);margin-left:5px;}
.nav-right{display:flex;align-items:center;gap:8px;}
.nav-user{font-size:12px;color:var(--text-dim);font-weight:700;}
.btn-sm{background:var(--surface2);border:2px solid var(--border);color:var(--text-dim);border-radius:8px;padding:5px 12px;font-size:12px;font-family:'Noto Sans KR',sans-serif;cursor:pointer;transition:all .2s;font-weight:700;}
.btn-sm:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light);}

/* ADMIN */
.page-pad{padding:24px 20px;}
.section-title{font-family:'Black Han Sans',sans-serif;font-size:18px;letter-spacing:2px;margin-bottom:18px;color:var(--accent);}
.admin-hero{text-align:center;padding:28px 0 20px;border-bottom:2px solid var(--border);margin-bottom:28px;}
.admin-hero-title{font-family:'Black Han Sans',sans-serif;font-size:22px;letter-spacing:4px;color:var(--accent);margin-bottom:6px;}
.admin-hero-sub{color:var(--text-dim);font-size:13px;}
.create-form{background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow-sm);}
.form-row{margin-bottom:14px;}
.form-row label{display:block;font-size:11px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px;font-weight:700;}
.form-row input{width:100%;background:#fff;border:2px solid var(--border);border-radius:10px;padding:11px 13px;color:var(--text);font-size:14px;font-family:'Noto Sans KR',sans-serif;outline:none;transition:border-color .2s;}
.form-row input:focus{border-color:var(--accent);}
.btn-accent{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:12px 22px;font-size:14px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;transition:all .2s;box-shadow:0 4px 12px rgba(25,82,245,.28);}
.btn-accent:hover{opacity:.9;transform:translateY(-1px);}
.btn-accent.full{width:100%;margin-top:4px;}
.user-table{width:100%;border-collapse:collapse;margin-top:4px;}
.user-table th{font-size:10px;letter-spacing:1.5px;color:var(--text-dim);text-transform:uppercase;padding:8px 10px;text-align:left;border-bottom:2px solid var(--border);font-weight:700;}
.user-table td{padding:12px 10px;font-size:13px;border-bottom:1px solid var(--border);vertical-align:middle;color:var(--text);}
.user-table tr.user-row{cursor:pointer;transition:background .15s;}
.user-table tr.user-row:hover{background:var(--accent-light);}
.user-table tr.user-row.selected{background:var(--accent-light);}
.user-tbl-name{font-weight:700;color:var(--text);}
.user-tbl-id{font-size:11px;color:var(--text-dim);}
.user-tbl-goals{font-weight:700;font-size:13px;color:var(--accent);}
.user-tbl-badge{font-size:10px;padding:2px 8px;border-radius:100px;background:var(--surface2);border:2px solid var(--border);color:var(--text-dim);}
.admin-detail{background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);padding:20px;margin-top:16px;box-shadow:var(--shadow-sm);}
.admin-detail-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding-bottom:14px;border-bottom:2px solid var(--border);}
.admin-detail-name{font-family:'Black Han Sans',sans-serif;font-size:18px;letter-spacing:1px;color:var(--text);}
.admin-detail-id{font-size:11px;color:var(--text-dim);margin-top:2px;}
.admin-meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px;}
.admin-meta-card{background:#fff;border:2px solid var(--border);border-radius:10px;padding:12px 14px;}
.admin-meta-label{font-size:10px;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px;font-weight:700;}
.admin-meta-val{font-size:12px;color:var(--text);font-weight:500;line-height:1.5;}
.admin-goal-list{display:flex;flex-direction:column;gap:10px;}
.admin-goal-card{background:#fff;border:2px solid var(--border);border-radius:10px;padding:14px 16px;}
.admin-goal-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.admin-goal-title{font-size:13px;font-weight:700;color:var(--text);}
.admin-goal-pct{font-family:'Black Han Sans',sans-serif;font-size:18px;color:var(--accent);}
.admin-goal-bar{height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;margin-bottom:8px;}
.admin-goal-bar-fill{height:100%;background:var(--accent);border-radius:3px;transition:width .5s;}
.admin-goal-meta{display:flex;flex-wrap:wrap;gap:6px;}
.admin-goal-tag{font-size:10px;background:var(--surface);border:1.5px solid var(--border);border-radius:100px;padding:2px 8px;color:var(--text-dim);font-weight:700;}
.admin-goal-tag.highlight{border-color:var(--accent);color:var(--accent);background:var(--accent-light);}
.admin-empty{text-align:center;color:var(--text-dim);font-size:13px;padding:20px 0;}
.user-chip-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:24px;}
.user-chip{background:#fff;border:2px solid var(--border);border-radius:100px;padding:7px 16px;display:flex;align-items:center;gap:8px;}
.user-chip-name{font-weight:700;font-size:13px;color:var(--text);}
.user-chip-id{color:var(--text-dim);font-size:11px;}

/* DASHBOARD */
#dashboardScreen .mobile-wrap{display:flex;flex-direction:column;height:100vh;overflow:hidden;padding-bottom:0;}
#dashboardScreen .dash-scroll{flex:1;overflow-y:auto;padding-bottom:160px;}
.global-bar{padding:18px 0 20px;background:transparent;border-radius:0;margin:0 0 4px;box-shadow:none;}
.gb-top{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:12px;}
.gb-label{font-size:12px;color:#6b7280;font-weight:600;padding-bottom:4px;}
.gb-pct{font-size:28px;font-weight:900;color:#1952f5;line-height:1;letter-spacing:-1px;font-family:system-ui,-apple-system,sans-serif;}
.gb-track{width:100%;height:12px;background:#f1f5f9;border-radius:100px;overflow:hidden;}
.gb-fill{height:100%;background:linear-gradient(90deg,#60a5fa,#6366f1,#a78bfa);border-radius:100px;transition:width .9s cubic-bezier(.4,0,.2,1);position:relative;}
.gb-fill::after{content:'';position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,.25) 0%,transparent 60%);border-radius:100px;}

/* ÏïÑÎ∞îÌÉÄ */
.avatar-section{padding:28px 20px 24px;display:flex;flex-direction:column;align-items:center;gap:14px;border-bottom:2px solid var(--border);}
.avatar-art{width:280px;height:280px;flex-shrink:0;background:transparent;border:none;border-radius:0;overflow:visible;display:flex;align-items:center;justify-content:center;box-shadow:none;}
.avatar-art svg{width:260px;height:260px;}
.avatar-art canvas{width:280px!important;height:280px!important;border-radius:0;}
.avatar-stage{font-family:'Black Han Sans',sans-serif;font-size:15px;color:var(--accent);letter-spacing:2px;text-align:center;}
.avatar-nickname-row{display:flex;align-items:center;justify-content:center;gap:8px;}
.avatar-nickname{font-family:'Black Han Sans',sans-serif;font-size:22px;color:var(--text);letter-spacing:1px;}
.pencil-btn{background:var(--surface2);border:2px solid var(--border);color:var(--text-dim);border-radius:8px;width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:13px;transition:all .2s;flex-shrink:0;}
.pencil-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light);}
.nickname-edit-row{display:flex;align-items:center;gap:8px;width:100%;max-width:260px;}
.nickname-input{flex:1;background:#fff;border:2px solid var(--accent);border-radius:10px;padding:10px 12px;color:var(--text);font-size:14px;font-family:'Noto Sans KR',sans-serif;outline:none;text-align:center;}
.nickname-save-btn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:8px 14px;font-size:13px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;white-space:nowrap;box-shadow:0 3px 10px rgba(25,82,245,.25);}
.avatar-msg{font-size:13px;color:var(--text-dim);line-height:1.6;text-align:center;max-width:260px;}
.avatar-progress-row{display:flex;align-items:center;gap:8px;width:100%;max-width:260px;}
.ap-track{flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden;}
.ap-fill{height:100%;background:var(--accent);border-radius:3px;transition:width .5s;}
.ap-pct{font-size:12px;color:var(--accent);font-weight:700;min-width:32px;text-align:right;}

/* Î™©Ìëú Í∑∏Î¶¨Îìú */
.goals-section{padding:20px 20px 0;}
.goals-section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.goals-section-title{font-family:'Black Han Sans',sans-serif;font-size:15px;letter-spacing:2px;color:var(--text-dim);}
.goal-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
.goal-btn{background:#fff;border:2px solid var(--border);border-radius:var(--radius);padding:12px 10px;cursor:pointer;text-align:left;transition:all .2s;font-family:'Noto Sans KR',sans-serif;position:relative;overflow:hidden;height:88px;display:flex;flex-direction:column;justify-content:center;color:var(--text);-webkit-appearance:none;appearance:none;box-shadow:var(--shadow-sm);}
.goal-btn:hover:not(.disabled){border-color:var(--accent);transform:translateY(-2px);box-shadow:var(--shadow);}
.goal-btn.active{border-color:var(--accent);background:var(--accent-light);box-shadow:0 4px 14px rgba(25,82,245,.18);}
.goal-btn.disabled{border-style:dashed;cursor:default;background:#fafafa;box-shadow:none;border-color:#c4cae8;border-width:2px;}
.goal-btn-title{font-size:11px;font-weight:700;color:var(--text);margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.goal-btn.disabled .goal-btn-title{color:var(--text-dim);}
.goal-btn-pct{font-family:'Black Han Sans',sans-serif;font-size:17px;color:var(--accent);}
.goal-btn-bar{height:3px;background:var(--surface2);border-radius:2px;overflow:hidden;margin-top:6px;}
.goal-btn-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .4s;}
.goal-btn-need{font-size:10px;color:var(--text-dim);margin-top:4px;}
.goal-btn .unread-dot{position:absolute;top:7px;right:7px;width:9px;height:9px;background:var(--danger);border-radius:50%;display:none;box-shadow:0 0 0 2px #fff;}
.goal-btn.has-unread .unread-dot{display:block;}

/* ÏÉÅÏÑ∏ Ìå®ÎÑê */
.detail-section{padding:20px;}
.detail-divider{height:2px;background:var(--border);margin:0 20px 20px;}
.unit-card{background:#fff;border:2px solid var(--border);border-radius:var(--radius);padding:22px;box-shadow:var(--shadow-sm);}
.unit-card-title{font-family:'Black Han Sans',sans-serif;font-size:17px;letter-spacing:1px;margin-bottom:6px;color:var(--text);}
.unit-card-sub{color:var(--text-dim);font-size:13px;margin-bottom:20px;}
.unit-opts{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:20px;}
.unit-opt{background:#fff;border:2px solid var(--border);border-radius:10px;padding:12px 8px;cursor:pointer;text-align:center;font-size:13px;font-weight:700;transition:all .2s;font-family:'Noto Sans KR',sans-serif;color:var(--text);}
.unit-opt:hover{border-color:var(--accent);background:var(--accent-light);}
.unit-opt.selected{border-color:var(--accent);background:var(--accent-light);color:var(--accent);}
.unit-confirm-btn{width:100%;background:var(--accent);color:#fff;border:none;border-radius:10px;padding:13px;font-size:14px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;box-shadow:0 4px 12px rgba(25,82,245,.28);}

/* CALENDAR */
.cal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.cal-goal-name{font-family:'Black Han Sans',sans-serif;font-size:18px;letter-spacing:1px;color:var(--text);}
.cal-meta{display:flex;align-items:center;gap:8px;}
.cal-unit-badge{background:var(--accent-light);border:2px solid rgba(25,82,245,.2);border-radius:100px;padding:3px 10px;font-size:11px;color:var(--accent);font-weight:700;}
.edit-unit-btn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:5px 12px;font-size:12px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;box-shadow:0 2px 8px rgba(25,82,245,.22);}
.month-nav{display:flex;align-items:center;gap:10px;margin-bottom:14px;}
.month-nav-btn{background:#fff;border:2px solid var(--border);color:var(--text);border-radius:10px;padding:6px 14px;font-size:14px;cursor:pointer;font-weight:700;transition:all .2s;}
.month-nav-btn:hover{border-color:var(--accent);color:var(--accent);}
.month-nav-btn:disabled{opacity:.3;cursor:default;}
.month-label{font-family:'Black Han Sans',sans-serif;font-size:15px;letter-spacing:1px;color:var(--text);}
.cal-day-row{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin-bottom:4px;}
.cal-day-lbl{text-align:center;font-size:11px;color:#9ca3af;padding:6px 0;font-weight:700;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;}
.cal-cell{aspect-ratio:1;background:#f8fafc;border:1.5px solid #e2e8f0;border-radius:14px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;user-select:none;position:relative;}
.cal-cell:active{transform:scale(.93);}
.cal-cell.empty{background:transparent;border-color:transparent;cursor:default;}
.cal-cell.locked{opacity:.4;cursor:not-allowed;}
.cal-cell.locked.done{background:var(--surface2);border-color:var(--border);opacity:.5;}
.cal-cell.locked.done .cal-dn{color:var(--text-dim);}
.cal-cell.done{background:#dbeafe;border-color:#93c5fd;}
.cal-cell.done .cal-dn{color:#93c5fd;font-size:9px;font-weight:600;}
.cal-cell.done .cal-chk{opacity:1;color:#2563eb;font-size:16px;font-weight:900;line-height:1;}
.cal-cell.week-ok{background:rgba(25,82,245,.07);border-color:rgba(25,82,245,.25);}
.cal-today{border-color:#60a5fa!important;box-shadow:0 0 0 4px rgba(96,165,250,.15)!important;}
.cal-today .cal-dn{color:var(--accent);}
.cal-dn{font-size:12px;font-weight:600;color:#4b5563;}
.cal-chk{font-size:10px;opacity:0;}
.month-stat{background:#fff;border:2px solid var(--border);border-radius:14px;padding:14px 18px;margin-top:12px;display:flex;align-items:center;gap:14px;box-shadow:var(--shadow-sm);}
.month-stat-top{margin-top:0;margin-bottom:16px;background:linear-gradient(135deg,var(--accent-light),#fff0f8);border-color:rgba(25,82,245,.18);}
.ms-label{font-size:13px;color:var(--text-dim);white-space:nowrap;font-weight:700;}
.ms-track{flex:1;height:10px;background:var(--surface2);border-radius:5px;overflow:hidden;}
.ms-fill{height:100%;background:linear-gradient(90deg,#1952f5,#a78bfa,#ff5e7d);border-radius:5px;transition:width .6s ease;}
.ms-nums{font-family:'Black Han Sans',sans-serif;font-size:16px;color:var(--accent);white-space:nowrap;}

/* Ìè∞Ìä∏ ÏúÑÍ≥Ñ Í∞úÏÑ† */
.cal-goal-name{font-size:20px;font-weight:800;letter-spacing:0;color:#111827;}
.cal-unit-badge{background:var(--accent-light);border:2px solid rgba(25,82,245,.2);border-radius:100px;padding:5px 13px;font-size:12px;color:var(--accent);font-weight:700;}
.edit-unit-btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:7px 16px;font-size:12px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;box-shadow:0 2px 8px rgba(25,82,245,.22);}
.month-label{font-size:15px;font-weight:700;color:#1f2937;}
.month-nav-btn{background:#fff;border:1.5px solid #e2e8f0;color:#6b7280;border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;font-weight:700;transition:all .2s;}
.month-nav-btn:hover{border-color:var(--accent);color:var(--accent);}
.month-nav-btn:disabled{opacity:.3;cursor:default;}
.cal-day-lbl{text-align:center;font-size:11px;color:#9ca3af;padding:6px 0;font-weight:700;}
.cal-dn{font-size:12px;font-weight:600;color:#4b5563;}
.cal-cell.done .cal-dn{color:#3b82f6;}
.goal-btn-title{font-size:13px;font-weight:800;color:#111827;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.goal-btn-pct{font-size:12px;font-weight:700;color:var(--accent);}
.goal-btn-need{font-size:11px;color:var(--text-dim);margin-top:4px;}
.avatar-nickname{font-family:'Black Han Sans',sans-serif;font-size:24px;color:#111827;letter-spacing:1px;}
.avatar-stage{font-size:12px;font-weight:700;color:var(--accent);background:var(--accent-light);padding:4px 10px;border-radius:8px;letter-spacing:.5px;}
.avatar-msg{font-size:14px;color:#6b7280;line-height:1.6;text-align:center;max-width:260px;}
.goals-section-title{font-size:14px;font-weight:700;color:#374151;letter-spacing:.5px;}
.nav-logo{font-family:'Black Han Sans',sans-serif;font-size:20px;color:var(--accent);letter-spacing:2px;}
.nav-user{font-size:13px;color:var(--text-dim);font-weight:700;}
.btn-sm{background:#f1f5f9;border:1.5px solid #e2e8f0;color:#6b7280;border-radius:8px;padding:6px 14px;font-size:12px;font-family:'Noto Sans KR',sans-serif;cursor:pointer;transition:all .2s;font-weight:600;}
.btn-sm:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light);}
.tab-btn{flex:1;padding:14px 0;font-size:14px;font-weight:700;font-family:'Noto Sans KR',sans-serif;background:#fff;border:none;color:#9ca3af;cursor:pointer;border-bottom:2px solid transparent;transition:color .15s,border-color .15s;margin-bottom:-2px;}
.friend-name{font-weight:700;font-size:15px;margin-bottom:3px;color:var(--text);}
.friend-stage{font-size:12px;color:var(--text-dim);}
.friend-pct{font-family:'Black Han Sans',sans-serif;font-size:22px;color:var(--accent);flex-shrink:0;}
.stats-title{font-weight:700;font-size:15px;color:#1f2937;margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.stats-bar-pct{font-size:10px;color:var(--text-dim);position:absolute;top:-16px;left:50%;transform:translateX(-50%);white-space:nowrap;font-weight:700;}
.stats-bar-lbl{font-size:10px;color:var(--text-dim);margin-top:4px;white-space:nowrap;font-weight:700;}
.stats-insight-text{font-size:13px;color:#374151;line-height:1.7;}
.cheer-from{font-size:12px;color:var(--accent);font-weight:700;margin-bottom:3px;}
.cheer-text{font-size:13px;color:var(--text);line-height:1.5;}
.cheer-time{font-size:11px;color:var(--text-dim);margin-top:3px;}
.once-card{background:#fff;border:2px solid var(--border);border-radius:var(--radius);padding:28px;text-align:center;box-shadow:var(--shadow-sm);}
.once-sub{color:var(--text-dim);font-size:12px;margin-bottom:24px;}
.once-btn{background:#fff;border:3px solid var(--border);border-radius:50%;width:80px;height:80px;font-size:30px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;transition:all .2s;box-shadow:var(--shadow-sm);}
.once-btn:active{transform:scale(.9);}
.once-btn.done{background:var(--accent-light);border-color:var(--accent);box-shadow:0 0 0 4px rgba(25,82,245,.12);}
.once-done{margin-top:12px;font-family:'Black Han Sans',sans-serif;font-size:15px;color:var(--accent);}
.add-goal-card{background:#fff;border:2px solid var(--border);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow-sm);}
.add-goal-input{width:100%;background:var(--surface2);border:2px solid var(--border);border-radius:10px;padding:11px 13px;color:var(--text);font-size:14px;font-family:'Noto Sans KR',sans-serif;outline:none;margin-bottom:14px;transition:border-color .2s;}
.add-goal-input:focus{border-color:var(--accent);}
.detail-empty{text-align:center;padding:48px 20px;color:var(--text-dim);font-size:14px;line-height:1.8;}

/* TUTORIAL */
#tutorialScreen .mobile-wrap{padding-bottom:40px;}
.tut-topbar{height:52px;background:#fff;border-bottom:2px solid var(--border);display:flex;align-items:center;justify-content:center;position:sticky;top:0;z-index:50;box-shadow:0 2px 8px rgba(25,82,245,.07);}
.tut-topbar-logo{font-family:'Black Han Sans',sans-serif;font-size:18px;color:var(--accent);letter-spacing:3px;}
.tut-progress{padding:16px 20px 0;}
.tut-step-dots{display:flex;gap:6px;justify-content:center;margin-bottom:12px;}
.tut-dot{width:8px;height:8px;border-radius:50%;background:var(--border);transition:background .3s,transform .2s;}
.tut-dot.active{background:var(--accent);transform:scale(1.3);}
.tut-dot.done{background:rgba(25,82,245,.3);}
.tut-track{height:4px;background:var(--surface2);border-radius:2px;overflow:hidden;margin-bottom:20px;}
.tut-fill{height:100%;background:linear-gradient(90deg,var(--accent),#6b8fff);border-radius:2px;transition:width .5s ease;}
.tut-body{padding:0 20px;}
.tut-step{display:none;}
.tut-step.active{display:block;}
.tut-bubble{background:#fff;border:2px solid var(--border);border-radius:18px;padding:20px;margin-bottom:20px;position:relative;box-shadow:var(--shadow-sm);}
.tut-bubble-tag{font-size:10px;letter-spacing:2px;color:var(--accent);text-transform:uppercase;margin-bottom:8px;font-weight:700;}
.tut-bubble-text{font-size:15px;line-height:1.7;color:var(--text);}
.tut-bubble-text strong{color:var(--accent);}
.tut-hint{font-size:12px;color:var(--text-dim);text-align:center;margin-bottom:16px;letter-spacing:1px;}
.tut-preview{background:var(--surface2);border:2px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:20px;}
.tut-preview-title{font-size:11px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;margin-bottom:12px;font-weight:700;}
.tut-goal-preview{background:#fff;border:2px solid var(--accent);border-radius:12px;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 3px 10px rgba(25,82,245,.12);}
.tut-goal-name{font-size:14px;font-weight:700;color:var(--text);}
.tut-goal-pct{font-family:'Black Han Sans',sans-serif;font-size:22px;color:var(--accent);}
.tut-bar{height:5px;background:var(--border);border-radius:3px;margin-top:8px;overflow:hidden;}
.tut-bar-fill{height:100%;background:var(--accent);border-radius:3px;transition:width .8s ease;}
.tut-cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;margin:12px 0;}
.tut-cal-day{text-align:center;font-size:10px;color:var(--text-dim);padding:3px 0;font-weight:700;}
.tut-cal-cell{aspect-ratio:1;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:12px;border:2px solid var(--border);background:#fff;cursor:pointer;transition:all .15s;user-select:none;font-weight:700;color:var(--text);}
.tut-cal-cell:active{transform:scale(.9);}
.tut-cal-cell.done{background:var(--accent);border-color:var(--accent);color:#fff;}
.tut-cal-cell.empty{background:transparent;border-color:transparent;cursor:default;}
.tut-cal-cell.target{border-color:var(--accent);animation:pulse-border 1.2s ease-in-out infinite;}
@keyframes pulse-border{0%,100%{box-shadow:0 0 0 0 rgba(25,82,245,.3);}50%{box-shadow:0 0 0 5px rgba(25,82,245,.10);}}
.highlight-box{border:3px solid var(--accent)!important;box-shadow:0 0 0 4px rgba(25,82,245,.15);animation:hl-pulse 1.4s ease-in-out infinite;}
@keyframes hl-pulse{0%,100%{box-shadow:0 0 0 4px rgba(25,82,245,.15);}50%{box-shadow:0 0 0 8px rgba(25,82,245,.06);}}
.tut-avatar-wrap{display:flex;flex-direction:column;align-items:center;gap:10px;padding:20px;background:#fff;border:2px solid var(--border);border-radius:var(--radius);margin-bottom:20px;box-shadow:var(--shadow-sm);}
.tut-avatar-art{width:120px;height:120px;background:var(--surface2);border:2px solid var(--border);border-radius:20px;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.tut-avatar-art svg{width:106px;height:106px;}
.tut-avatar-stage{font-family:'Black Han Sans',sans-serif;font-size:15px;color:var(--accent);letter-spacing:2px;}
.tut-confirm-btn{width:100%;background:var(--accent);color:#fff;border:none;border-radius:12px;padding:15px;font-size:15px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;letter-spacing:1px;transition:all .2s;box-shadow:0 6px 18px rgba(25,82,245,.30);}
.tut-confirm-btn:hover{opacity:.9;transform:translateY(-1px);}
.tut-confirm-btn.ghost{background:transparent;border:2px solid var(--border);color:var(--text-dim);margin-top:8px;box-shadow:none;}
.tut-global-bar{background:#fff;border:2px solid var(--border);border-radius:12px;padding:14px 16px;margin-bottom:20px;display:flex;align-items:center;gap:12px;box-shadow:var(--shadow-sm);}
.tut-gb-label{font-size:11px;letter-spacing:2px;color:var(--text-dim);white-space:nowrap;font-weight:700;text-transform:uppercase;}
.tut-gb-track{flex:1;height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;}
.tut-gb-fill{height:100%;background:linear-gradient(90deg,var(--accent),#6b8fff);border-radius:3px;transition:width .8s ease;}
.tut-gb-pct{font-family:'Black Han Sans',sans-serif;font-size:16px;color:var(--accent);min-width:44px;text-align:right;}

/* CONFETTI */
.confetti-container{position:fixed;inset:0;pointer-events:none;z-index:9999;overflow:hidden;}
.confetti-piece{position:absolute;width:10px;height:10px;border-radius:2px;animation:confetti-fall linear forwards;}
@keyframes confetti-fall{0%{transform:translateY(-20px) rotate(0deg);opacity:1;}100%{transform:translateY(110vh) rotate(720deg);opacity:0;}}

/* STATS */
.stats-section{margin-top:20px;padding-top:20px;border-top:2px solid var(--border);}
.stats-title{font-weight:700;font-size:15px;color:#1f2937;margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.stats-chart{display:flex;align-items:flex-end;gap:8px;height:176px;margin-bottom:8px;position:relative;padding:0 8px;margin-top:16px;}
.stats-avg-line{position:absolute;left:0;right:0;border-top:2px dashed var(--accent);opacity:.35;pointer-events:none;}
.stats-avg-label{position:absolute;right:0;font-size:9px;color:var(--accent);transform:translateY(-12px);white-space:nowrap;font-weight:700;}
.stats-bar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;height:100%;justify-content:flex-end;}
.stats-bar-col{width:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-end;height:160px;position:relative;}
.stats-bar{width:100%;max-width:32px;border-radius:4px 4px 0 0;background:#e2e8f0;transition:height .5s ease;min-height:4px;position:relative;}
.stats-bar.current-month{background:linear-gradient(180deg,#a78bfa,#1952f5);box-shadow:0 4px 14px rgba(167,139,250,.45);}
.stats-bar.past{background:#bfdbfe;}
.stats-bar-pct{font-size:9px;color:transparent;position:absolute;top:-14px;left:50%;transform:translateX(-50%);white-space:nowrap;font-weight:700;transition:color .15s;}
.stats-bar-wrap:hover .stats-bar-pct{color:#7c3aed;}
.stats-bar.current-month .stats-bar-pct{color:#7c3aed;font-weight:800;}
.stats-bar-lbl{font-size:10px;color:#4b5563;margin-top:6px;white-space:nowrap;font-weight:700;}
.stats-bar-lbl.current{color:#7c3aed;font-weight:800;}
.stats-insight{background:#f8fafc;border-radius:18px;padding:16px;margin-top:12px;}
.stats-insight-row{display:flex;align-items:flex-start;gap:12px;margin-bottom:12px;}
.stats-insight-row:last-child{margin-bottom:0;}
.stats-insight-icon{font-size:16px;flex-shrink:0;margin-top:1px;}
.stats-insight-text{font-size:13px;color:#374151;line-height:1.7;}
.stats-insight-text strong{color:#1f2937;}
.stats-cheer{background:linear-gradient(135deg,var(--accent-light),#fff0f3);border:2px solid rgba(25,82,245,.15);border-radius:14px;padding:14px 16px;margin-top:10px;font-size:13px;color:var(--text);line-height:1.7;}
.stats-cheer strong{color:var(--accent2);}

/* TOAST */
.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(100px);padding:14px 32px;border-radius:100px;font-weight:700;font-size:15px;transition:transform .35s cubic-bezier(.34,1.56,.64,1);z-index:9998;pointer-events:none;white-space:nowrap;box-shadow:0 6px 24px rgba(0,0,0,.18);min-width:140px;text-align:center;}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.toast-done{background:var(--accent);color:#fff;}
.toast.toast-undo{background:#ff5e7d;color:#fff;}
.toast.toast-normal{background:var(--text);color:#fff;}

/* Ï£ºÍ∞Ñ ÌÅ¥Î¶¨Ïñ¥ ÌåùÏóÖ */
.week-clear-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:#fff;border:3px solid var(--accent);border-radius:24px;padding:28px 36px;text-align:center;z-index:9999;box-shadow:0 20px 60px rgba(25,82,245,.25);transition:transform .4s cubic-bezier(.34,1.56,.64,1);pointer-events:none;}
.week-clear-popup.show{transform:translate(-50%,-50%) scale(1);}
.week-clear-emoji{font-size:48px;margin-bottom:8px;display:block;animation:week-spin .6s ease-out;}
@keyframes week-spin{0%{transform:rotate(-15deg) scale(0.5);}60%{transform:rotate(10deg) scale(1.1);}100%{transform:rotate(0deg) scale(1);}}
.week-clear-title{font-family:'Black Han Sans',sans-serif;font-size:20px;color:var(--accent);letter-spacing:1px;margin-bottom:4px;}
.week-clear-sub{font-size:13px;color:var(--text-dim);}

/* ÎÇ¥ Î™©Ìëú ÎåìÍ∏Ä Ïä§ÏôÄÏù¥ÌîÑ ÏòÅÏó≠ */
.my-cheers-section{margin-top:16px;}
.my-cheers-title{font-size:11px;letter-spacing:2px;color:var(--text-dim);text-transform:uppercase;font-weight:700;margin-bottom:10px;}
.my-cheers-slider{overflow:hidden;border-radius:14px;}
.my-cheers-track{display:flex;transition:transform .35s cubic-bezier(.4,0,.2,1);}
.my-cheer-page{min-width:100%;display:flex;flex-direction:column;gap:8px;}
.my-cheer-card{background:#fff;border:2px solid var(--border);border-radius:14px;padding:13px 16px;box-shadow:var(--shadow-sm);}
.my-cheer-goal{font-size:10px;letter-spacing:1px;color:var(--accent);font-weight:700;text-transform:uppercase;margin-bottom:4px;}
.my-cheer-from{font-size:13px;font-weight:700;color:var(--text);margin-bottom:2px;}
.my-cheer-text{font-size:14px;color:var(--text);line-height:1.5;}
.my-cheer-time{font-size:11px;color:var(--text-dim);margin-top:4px;}
.my-cheers-empty{text-align:center;padding:24px;color:var(--text-dim);font-size:13px;background:var(--surface);border-radius:14px;border:2px dashed var(--border);}
.my-cheers-dots{display:flex;justify-content:center;gap:6px;margin-top:10px;}
.my-cheers-dot{width:7px;height:7px;border-radius:50%;background:var(--border);transition:all .2s;cursor:pointer;}
.my-cheers-dot.active{background:var(--accent);transform:scale(1.3);}

/* Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ Í∞úÏÑ† */
#loginScreen .mobile-wrap{background:transparent;display:flex;flex-direction:column;justify-content:center;min-height:100vh;padding:0;}
.login-top-bg{position:absolute;top:0;left:0;right:0;height:55%;background:linear-gradient(160deg,#1952f5 0%,#6b8fff 60%,#a78bfa 100%);border-radius:0 0 40px 40px;z-index:0;}
.login-bottom-area{position:relative;z-index:1;padding:0 28px 40px;margin-top:auto;}
.login-card{background:#fff;border-radius:28px;padding:32px 28px 28px;box-shadow:0 20px 60px rgba(25,82,245,.18);}
.login-hero{display:flex;flex-direction:column;align-items:center;padding:60px 0 36px;position:relative;z-index:1;}
.login-logo{font-size:72px;display:block;margin-bottom:0;animation:egg-bounce 1.6s ease-in-out infinite;}
.login-title{font-family:'Black Han Sans',sans-serif;font-size:34px;letter-spacing:4px;color:#fff;text-align:center;margin-bottom:6px;text-shadow:0 2px 12px rgba(25,82,245,.3);}
.login-sub{text-align:center;color:rgba(255,255,255,.75);font-size:13px;letter-spacing:3px;}
.login-box{width:100%;}
.input-group label{color:var(--text-dim);}
.input-group input{background:var(--surface2);border:2px solid var(--border);}
.save-login-row label{color:var(--text-dim);}
.btn-primary{background:linear-gradient(135deg,#1952f5,#6b8fff);box-shadow:0 8px 24px rgba(25,82,245,.38);}
.week-info-card{background:var(--surface);border:1.5px solid var(--border);border-radius:10px;padding:7px 12px;margin-top:8px;margin-bottom:4px;display:flex;align-items:center;gap:8px;}
.week-info-icon{font-size:15px;flex-shrink:0;}
.week-info-body{flex:1;display:flex;align-items:center;gap:5px;flex-wrap:wrap;}
.week-info-main{font-family:'Black Han Sans',sans-serif;font-size:13px;color:var(--accent);}
.week-info-cheer{font-size:12px;color:var(--text-dim);}
.week-info-clear{background:linear-gradient(135deg,#e8fff4,#e8eeff);border-color:rgba(0,185,107,.3);}
.week-info-clear .week-info-main{background:linear-gradient(90deg,#00b96b,#1952f5);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}

/* ÌîåÎ°úÌåÖ ÏôÑÎ£å Î≤ÑÌäº */
.float-fab{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;padding:64px 20px 28px;background:linear-gradient(to top,#fff 65%,rgba(255,255,255,.9) 82%,transparent);pointer-events:none;z-index:200;}
.float-fab-inner{pointer-events:auto;display:flex;flex-direction:column;gap:10px;align-items:center;}
.float-week-hint{background:rgba(255,255,255,.92);border:1px solid #e2e8f0;border-radius:100px;padding:7px 22px;font-size:13px;font-weight:600;color:#374151;box-shadow:0 4px 15px rgba(0,0,0,.06);white-space:nowrap;backdrop-filter:blur(8px);}
.float-week-hint strong{color:var(--accent);font-weight:800;}
.float-complete-btn{width:100%;padding:17px;border:none;border-radius:20px;font-size:17px;font-weight:800;font-family:'Black Han Sans',sans-serif;cursor:pointer;transition:all .2s;letter-spacing:1px;}
.float-complete-btn.state-todo{background:#1952f5;color:#fff;box-shadow:0 8px 32px rgba(25,82,245,.42);}
.float-complete-btn.state-todo:hover{transform:translateY(-2px);box-shadow:0 14px 38px rgba(25,82,245,.48);}
.float-complete-btn.state-done{background:#1f2937;color:#fff;box-shadow:0 4px 14px rgba(0,0,0,.18);}
.float-complete-btn.state-done:hover{background:#111827;}

/* ÌîåÎ°úÌåÖ Î≤ÑÌäº ÌëúÏãúÎê† Îïå ÌïòÎã® Ïó¨Î∞± */
.float-fab.visible ~ * {}
#tabMy.has-float{padding-bottom:0;}
.dash-scroll.has-float-scroll{padding-bottom:160px;}

/* ÌôîÎ©¥ ÌùîÎì§Í∏∞ */
@keyframes screen-shake{
  0%,100%{transform:translateX(0);}
  10%{transform:translateX(-8px) rotate(-1deg);}
  20%{transform:translateX(8px) rotate(1deg);}
  30%{transform:translateX(-6px) rotate(-.5deg);}
  40%{transform:translateX(6px) rotate(.5deg);}
  50%{transform:translateX(-4px);}
  60%{transform:translateX(4px);}
  70%{transform:translateX(-2px);}
  80%{transform:translateX(2px);}
  90%{transform:translateX(-1px);}
}
.shake{animation:screen-shake .7s ease-out;}

/* TABS */
.tab-bar{display:flex;padding:0 20px;border-bottom:1px solid #f1f5f9;background:#fff;position:sticky;top:0;z-index:40;box-shadow:0 2px 8px rgba(0,0,0,.04);}
.tab-btn{flex:1;padding:14px 0 12px;font-size:14px;font-weight:700;font-family:'Noto Sans KR',sans-serif;background:transparent;border:none;color:#9ca3af;cursor:pointer;border-bottom:2px solid transparent;transition:color .15s,border-color .15s;margin-bottom:-1px;}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab-panel{display:none;}
.tab-panel.active{display:block;}

/* FRIENDS */
.friends-section{padding:20px;}
.friends-empty{text-align:center;color:var(--text-dim);font-size:13px;padding:60px 20px;line-height:2.2;}
.friend-list{display:flex;flex-direction:column;gap:10px;margin-bottom:4px;}
.friend-card{background:#fff;border:2px solid var(--border);border-radius:var(--radius);padding:14px 16px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all .2s;box-shadow:var(--shadow-sm);}
.friend-card:hover,.friend-card.active{border-color:var(--accent);background:var(--accent-light);transform:translateY(-1px);box-shadow:var(--shadow);}
.friend-avatar{width:44px;height:44px;background:var(--surface);border:2px solid var(--border);border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;}
.friend-avatar svg{width:38px;height:38px;}
.friend-info{flex:1;min-width:0;}
.friend-name{font-weight:700;font-size:14px;margin-bottom:3px;color:var(--text);}
.friend-stage{font-size:11px;color:var(--text-dim);}
.friend-pct{font-family:'Black Han Sans',sans-serif;font-size:20px;color:var(--accent);flex-shrink:0;}
.friend-detail{border:2px solid var(--border);border-radius:var(--radius);padding:16px;margin-top:8px;background:#fff;}
.friend-detail-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.friend-detail-name{font-family:'Black Han Sans',sans-serif;font-size:15px;letter-spacing:1px;color:var(--text);}
.fgoal-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;}
.fgoal-btn{background:#fff;border:2px solid var(--border);border-radius:12px;padding:11px 10px;cursor:pointer;text-align:left;transition:all .15s;height:72px;display:flex;flex-direction:column;justify-content:center;color:var(--text);box-shadow:var(--shadow-sm);-webkit-appearance:none;appearance:none;}
.fgoal-btn:hover,.fgoal-btn.fg-active{border-color:var(--accent);background:var(--accent-light);}
.fgoal-name{font-size:11px;font-weight:700;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text);}
.fgoal-pct{font-family:'Black Han Sans',sans-serif;font-size:16px;color:var(--accent);}
.fgoal-bar{height:3px;background:var(--surface2);border-radius:2px;overflow:hidden;margin-top:4px;}
.fgoal-bar-fill{height:100%;background:var(--accent);border-radius:2px;}

/* READ-ONLY CALENDAR */
.rocal-wrap{background:var(--surface2);border:2px solid var(--border);border-radius:12px;padding:12px;margin-bottom:14px;}
.rocal-label{font-size:10px;letter-spacing:1.5px;color:var(--text-dim);text-transform:uppercase;margin-bottom:8px;font-weight:700;}
.rocal-days{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:2px;}
.rocal-day{text-align:center;font-size:9px;color:var(--text-dim);padding:2px 0;font-weight:700;}
.rocal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;}
.rocal-cell{aspect-ratio:1;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:10px;background:#fff;border:1.5px solid var(--border);color:var(--text);font-weight:700;}
.rocal-cell.done{background:var(--accent);border-color:var(--accent);color:#fff;}
.rocal-cell.empty{background:transparent;border-color:transparent;}
.rocal-cell.today{border-color:var(--accent);color:var(--accent);box-shadow:0 0 0 1px rgba(25,82,245,.2);}

/* CHEER BOX */
.cheer-box{border-top:2px solid var(--border);padding-top:14px;}
.cheer-box-title{font-size:10px;letter-spacing:1.5px;color:var(--text-dim);text-transform:uppercase;margin-bottom:10px;font-weight:700;}
.cheer-list{display:flex;flex-direction:column;gap:7px;margin-bottom:12px;max-height:180px;overflow-y:auto;}
.cheer-item{background:#fff;border:2px solid var(--border);border-radius:12px;padding:10px 13px;}
.cheer-body{flex:1;min-width:0;}
.cheer-from{font-size:11px;color:var(--accent);font-weight:700;margin-bottom:3px;}
.cheer-text{font-size:13px;color:var(--text);line-height:1.5;}
.cheer-time{font-size:10px;color:var(--text-dim);margin-top:3px;}
.cheer-input-row{display:flex;gap:6px;align-items:center;}
.cheer-text-input{flex:1;background:#fff;border:2px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text);font-size:13px;font-family:'Noto Sans KR',sans-serif;outline:none;transition:all .2s;}
.cheer-text-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(25,82,245,.10);}
.cheer-send-btn{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-size:13px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;white-space:nowrap;box-shadow:0 3px 10px rgba(25,82,245,.25);}

/* ADMIN GROUP */
.group-card{background:#fff;border:2px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:10px;box-shadow:var(--shadow-sm);}
.group-card-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.group-card-name{font-family:'Black Han Sans',sans-serif;font-size:15px;letter-spacing:1px;color:var(--text);}
.group-member-list{display:flex;flex-direction:column;gap:6px;}
.group-member-row{display:flex;align-items:center;gap:10px;padding:6px 0;}
.group-member-name{font-size:13px;font-weight:700;flex:1;color:var(--text);}
.group-member-id{font-size:11px;color:var(--text-dim);}
.group-remove-btn{background:transparent;border:2px solid var(--border);color:var(--text-dim);border-radius:6px;padding:3px 8px;font-size:11px;cursor:pointer;font-family:'Noto Sans KR',sans-serif;transition:all .2s;}
.group-remove-btn:hover{border-color:var(--danger);color:var(--danger);}
.group-add-select{width:100%;background:#fff;border:2px solid var(--border);border-radius:10px;padding:9px 11px;color:var(--text);font-size:13px;font-family:'Noto Sans KR',sans-serif;outline:none;margin-top:10px;transition:border-color .2s;}
.group-add-select:focus{border-color:var(--accent);}
/* NOTICE */
.notice-banner{display:none;background:linear-gradient(90deg,#1952f5,#6b8fff);color:#fff;padding:10px 18px;cursor:pointer;align-items:center;gap:10px;}
.notice-banner.visible{display:flex;}
.notice-banner-icon{font-size:16px;flex-shrink:0;}
.notice-banner-title{flex:1;font-size:13px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.notice-banner-arrow{font-size:14px;flex-shrink:0;opacity:.8;}
.notice-modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1000;align-items:flex-start;justify-content:center;padding:0;}
.notice-modal-overlay.open{display:flex;}
.notice-modal{background:#fff;width:100%;max-width:480px;min-height:100vh;position:relative;overflow-y:auto;padding:0 0 40px;}
.notice-modal-header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px 14px;border-bottom:2px solid var(--border);position:sticky;top:0;background:#fff;z-index:10;}
.notice-modal-close{background:none;border:none;font-size:22px;cursor:pointer;color:var(--text-dim);padding:4px 8px;border-radius:8px;line-height:1;}
.notice-modal-close:hover{background:var(--surface2);}
.notice-modal-body{padding:24px 20px;}
.notice-modal-title{font-family:'Black Han Sans',sans-serif;font-size:22px;letter-spacing:1px;color:var(--text);margin-bottom:6px;}
.notice-modal-date{font-size:12px;color:var(--text-dim);margin-bottom:20px;}
.notice-modal-img{width:100%;border-radius:14px;margin-bottom:20px;display:block;}
.notice-modal-desc{font-size:15px;color:var(--text);line-height:1.8;white-space:pre-wrap;}
/* ADMIN NOTICE */
.admin-notice-form{background:#fff;border:2px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:12px;box-shadow:var(--shadow-sm);}
.admin-notice-row{display:flex;flex-direction:column;gap:6px;margin-bottom:14px;}
.admin-notice-label{font-size:12px;font-weight:700;color:var(--text-dim);letter-spacing:.5px;}
.admin-notice-input{background:#fff;border:2px solid var(--border);border-radius:10px;padding:10px 13px;font-size:14px;font-family:'Noto Sans KR',sans-serif;color:var(--text);outline:none;width:100%;box-sizing:border-box;transition:border-color .2s;}
.admin-notice-input:focus{border-color:var(--accent);}
.admin-notice-textarea{resize:vertical;min-height:80px;}
.admin-notice-target-row{display:flex;gap:8px;flex-wrap:wrap;}
.admin-notice-target-btn{border:2px solid var(--border);background:#fff;border-radius:8px;padding:7px 14px;font-size:13px;font-family:'Noto Sans KR',sans-serif;font-weight:700;cursor:pointer;color:var(--text-dim);transition:all .2s;}
.admin-notice-target-btn.active{border-color:var(--accent);color:var(--accent);background:var(--accent-light);}
.admin-notice-select{background:#fff;border:2px solid var(--border);border-radius:10px;padding:9px 11px;font-size:13px;font-family:'Noto Sans KR',sans-serif;color:var(--text);outline:none;width:100%;box-sizing:border-box;margin-top:8px;transition:border-color .2s;}
.admin-notice-select:focus{border-color:var(--accent);}
.notice-card{background:#fff;border:2px solid var(--border);border-radius:12px;padding:14px 16px;margin-bottom:8px;display:flex;align-items:center;gap:12px;box-shadow:var(--shadow-sm);}
.notice-card-info{flex:1;min-width:0;}
.notice-card-title{font-size:14px;font-weight:800;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.notice-card-meta{font-size:11px;color:var(--text-dim);margin-top:3px;}
.notice-card-del{background:none;border:2px solid var(--border);border-radius:7px;padding:4px 10px;font-size:12px;color:var(--text-dim);cursor:pointer;font-family:'Noto Sans KR',sans-serif;white-space:nowrap;transition:all .2s;}
.notice-card-del:hover{border-color:var(--danger);color:var(--danger);}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loadingScreen" class="screen active">
  <div class="mobile-wrap">
    <div class="loading-logo">ÎèôÎ¨º ÌÇ§Ïö∞Í∏∞</div>
    <div class="loading-spinner"></div>
  </div>
</div>

<!-- LOGIN -->
<div id="loginScreen" class="screen">
  <canvas id="loginCanvas" style="position:fixed;inset:0;width:100%;height:100%;z-index:0;pointer-events:none;"></canvas>
  <div class="mobile-wrap" style="position:relative;z-index:1;overflow:hidden;">
    <div class="login-top-bg"></div>
    <div class="login-hero">
      <div class="login-logo" id="loginLogoAnim">üê£</div>
      <div class="login-title">ÎèôÎ¨º ÌÇ§Ïö∞Í∏∞</div>
      <div class="login-sub">Î™©Ìëú Îã¨ÏÑ± Í≤åÏûÑ</div>
    </div>
    <div class="login-bottom-area">
      <div class="login-card">
        <div class="login-box">
          <div class="input-group"><label>ÏïÑÏù¥Îîî</label><input type="text" id="loginId" placeholder="ÏïÑÏù¥Îîî ÏûÖÎ†•" autocomplete="username"></div>
          <div class="input-group"><label>ÎπÑÎ∞ÄÎ≤àÌò∏</label><input type="password" id="loginPw" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏ ÏûÖÎ†•" autocomplete="current-password"></div>
          <div class="save-login-row">
            <input type="checkbox" id="saveLoginChk">
            <label for="saveLoginChk">ÏïÑÏù¥Îîî/ÎπÑÎ∞ÄÎ≤àÌò∏ Ï†ÄÏû•</label>
          </div>
          <button class="btn-primary" id="loginBtn" onclick="doLogin()">Î°úÍ∑∏Ïù∏</button>
          <div class="login-error" id="loginError">ÏïÑÏù¥Îîî ÎòêÎäî ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ADMIN -->
<div id="adminScreen" class="screen">
  <div class="mobile-wrap">
    <nav class="topnav">
      <div class="nav-logo">ÎèôÎ¨º ÌÇ§Ïö∞Í∏∞ <span class="nav-badge">ADMIN</span></div>
      <div class="nav-right"><button class="btn-sm" onclick="doLogout()">Î°úÍ∑∏ÏïÑÏõÉ</button></div>
    </nav>
    <div class="page-pad">
      <div class="admin-hero">
        <div class="admin-hero-title">ADMIN</div>
        <div class="admin-hero-sub">Ïú†Ï†Ä Í≥ÑÏ†ïÏùÑ ÏÉùÏÑ±ÌïòÍ≥† Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî</div>
      </div>
      <div class="create-form" style="margin-bottom:28px;">
        <div style="font-size:13px;color:var(--text-dim);line-height:2;">
          üîí Í≥ÑÏ†ï ÏÉùÏÑ± Î∞è Í∑∏Î£π Í¥ÄÎ¶¨Îäî <strong style="color:var(--accent);">Colab Ïñ¥ÎìúÎØº Ïä§ÌÅ¨Î¶ΩÌä∏</strong>Î•º ÏÇ¨Ïö©ÌïòÍ±∞ÎÇò<br>
          <strong style="color:var(--accent);">Firebase ÏΩòÏÜî</strong>ÏóêÏÑú ÏßÅÏ†ë Ï≤òÎ¶¨Ìï¥Ï£ºÏÑ∏Ïöî.
        </div>
      </div>
      <div style="margin-top:32px;">
        <div class="section-title" style="font-size:15px;margin-bottom:12px;">Îì±Î°ùÎêú Ïú†Ï†Ä</div>
        <div id="adminUserTable"></div>
        <div id="adminUserDetail"></div>
      </div>
      <div style="margin-top:32px;">
        <div class="section-title" style="font-size:15px;margin-bottom:12px;">Í∑∏Î£π Í¥ÄÎ¶¨</div>
        <div id="adminGroupList"></div>
      </div>
      <div style="margin-top:32px;padding-bottom:40px;">
        <div class="section-title" style="font-size:15px;margin-bottom:12px;">üì¢ Í≥µÏßÄÏÇ¨Ìï≠ Í¥ÄÎ¶¨</div>
        <!-- Í≥µÏßÄ Ï∂îÍ∞Ä Ìèº -->
        <div class="admin-notice-form">
          <div class="admin-notice-row">
            <div class="admin-notice-label">Ï†úÎ™© *</div>
            <input class="admin-notice-input" id="noticeTitle" placeholder="Í≥µÏßÄ Ï†úÎ™© ÏûÖÎ†•" maxlength="50">
          </div>
          <div class="admin-notice-row">
            <div class="admin-notice-label">ÎÇ¥Ïö©</div>
            <textarea class="admin-notice-input admin-notice-textarea" id="noticeDesc" placeholder="Í≥µÏßÄ ÎÇ¥Ïö© ÏûÖÎ†• (ÏÑ†ÌÉùÏÇ¨Ìï≠)"></textarea>
          </div>
          <div class="admin-notice-row">
            <div class="admin-notice-label">Ïù¥ÎØ∏ÏßÄ URL</div>
            <input class="admin-notice-input" id="noticeImg" placeholder="Ïù¥ÎØ∏ÏßÄ URL ÏûÖÎ†• (ÏÑ†ÌÉùÏÇ¨Ìï≠)">
          </div>
          <div class="admin-notice-row">
            <div class="admin-notice-label">ÎÖ∏Ï∂ú ÎåÄÏÉÅ *</div>
            <div class="admin-notice-target-row">
              <button class="admin-notice-target-btn active" id="noticeTargetAll" onclick="setNoticeTarget('all')">Ï†ÑÏ≤¥</button>
              <button class="admin-notice-target-btn" id="noticeTargetGroup" onclick="setNoticeTarget('group')">ÌäπÏ†ï Í∑∏Î£π</button>
              <button class="admin-notice-target-btn" id="noticeTargetUser" onclick="setNoticeTarget('user')">ÌäπÏ†ï ÏÇ¨Îûå</button>
            </div>
            <div id="noticeTargetDetail" style="display:none;"></div>
          </div>
          <button class="btn-accent" style="width:100%;" onclick="submitNotice()">Í≥µÏßÄ Ï∂îÍ∞Ä</button>
        </div>
        <!-- Í≥µÏßÄ Î™©Î°ù -->
        <div id="adminNoticeList"></div>
      </div>
    </div>
  </div>
</div>

<!-- TUTORIAL -->
<div id="tutorialScreen" class="screen">
  <div class="mobile-wrap">
    <div class="tut-topbar"><div class="tut-topbar-logo">QUEST</div></div>
    <div class="tut-progress">
      <div class="tut-step-dots" id="tutDots"></div>
      <div class="tut-track"><div class="tut-fill" id="tutFill" style="width:0%"></div></div>
    </div>
    <div class="tut-body">

      <!-- STEP 1: Î™©Ìëú ÏÑ§Ï†ï -->
      <div class="tut-step active" id="tutStep1">
        <div class="tut-bubble">
          <div class="tut-bubble-tag">STEP 1 ¬∑ Î™©Ìëú ÏÑ§Ï†ï</div>
          <div class="tut-bubble-text">Î®ºÏ†Ä <strong>Îã¨ÏÑ±ÌïòÍ≥† Ïã∂ÏùÄ Î™©Ìëú</strong>Î•º Ï†ïÌï¥Î≥ºÍ≤åÏöî.<br>ÏïÑÎûò Î™©ÌëúÎ•º ÌÉ≠Ìï¥ÏÑú ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî!</div>
        </div>
        <button id="tutGoalBtn" onclick="tutStep1Confirm()" style="width:100%;background:var(--surface);border:2px solid var(--accent);border-radius:12px;padding:18px 16px;color:var(--text);font-size:16px;font-weight:700;font-family:'Noto Sans KR',sans-serif;cursor:pointer;text-align:left;margin-bottom:20px;animation:pulse-border 1.2s ease-in-out infinite;transition:background .2s;">
          12Ïãú Ï†ÑÏóê ÏûêÍ∏∞
        </button>
      </div>

      <!-- STEP 2: Îã®ÏúÑ ÏÑ§Ï†ï -->
      <div class="tut-step" id="tutStep2">
        <div class="tut-bubble">
          <div class="tut-bubble-tag">STEP 2 ¬∑ Îã®ÏúÑ ÏÑ§Ï†ï</div>
          <div class="tut-bubble-text"><strong>ÏñºÎßàÎÇò ÏûêÏ£º</strong> Ïù¥ Î™©ÌëúÎ•º ÏàòÌñâÌï† Í±¥Í∞ÄÏöî?<br>Ï£º 4~5ÌöåÎ•º ÌÉ≠Ìï¥ÏÑú ÏÑ†ÌÉùÌï¥Î≥¥ÏÑ∏Ïöî!</div>
        </div>
        <div class="tut-preview">
          <div class="tut-preview-title" style="margin-bottom:12px;">Î™©Ìëú: <span id="tutGoalName2">-</span></div>
          <div class="unit-opts" id="tutUnitOpts" style="margin-bottom:0;"></div>
        </div>
      </div>

      <!-- STEP 3: Ï≤¥ÌÅ¨ Ï≤òÎ¶¨ -->
      <div class="tut-step" id="tutStep3">
        <div class="tut-bubble">
          <div class="tut-bubble-tag">STEP 3 ¬∑ ÏôÑÎ£å Ï≤¥ÌÅ¨</div>
          <div class="tut-bubble-text">Î™©ÌëúÎ•º ÏàòÌñâÌñàÎã§Î©¥ <strong>ÎÇ†ÏßúÎ•º ÌÉ≠Ìï¥ÏÑú</strong> ÏôÑÎ£å Ï≤òÎ¶¨Î•º Ìï¥Ïöî.<br>Ïù¥Î≤à Ï£º 4ÏùºÏùÑ Ï≤¥ÌÅ¨Ìï¥Î≥¥ÏÑ∏Ïöî!</div>
        </div>
        <div class="tut-preview">
          <div class="tut-preview-title" id="tutGoalName3">-</div>
          <div class="tut-cal-grid" id="tutCalDayRow"></div>
          <div class="tut-cal-grid" id="tutCalGrid"></div>
        </div>
        <div id="tutStep3Status" style="text-align:center;font-family:'Black Han Sans',sans-serif;font-size:14px;color:var(--text-dim);margin-bottom:8px;">0 / 4 Ï≤¥ÌÅ¨</div>
      </div>

      <!-- STEP 4: Î™©Ìëú ÏßÑÏ≤ôÎ•† + Ï†ÑÏ≤¥ ÏßÑÏ≤ôÎ•† Ìï©Ïπ® -->
      <div class="tut-step" id="tutStep4">
        <div class="tut-bubble">
          <div class="tut-bubble-tag">STEP 4 ¬∑ ÏßÑÏ≤ôÎ•†</div>
          <div class="tut-bubble-text">Ï≤¥ÌÅ¨Ìïú ÎÇ†ÏßúÎßåÌÅº <strong>Ìï¥Îãπ Î™©ÌëúÏùò ÏàòÌñâÎ•†Ïù¥ Ïò¨ÎùºÍ∞ÄÏöî!</strong><br>Î™®Îì† Î™©ÌëúÏùò ÏàòÌñâÎ•†ÏùÑ Ìï©ÏÇ∞Ìï¥ÏÑú Ï†ÑÏ≤¥ Îã¨ÏÑ±Î•†ÎèÑ Ìï®Íªò Ïò¨ÎùºÍ∞ÄÏöî.</div>
        </div>
        <div class="tut-preview highlight-box" id="tutGoalCard" style="margin-bottom:12px;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <div style="font-size:14px;font-weight:700;" id="tutGoalName4">-</div>
            <div class="tut-goal-pct" id="tutGoalPct4">0%</div>
          </div>
          <div class="tut-bar"><div class="tut-bar-fill" id="tutGoalBar4" style="width:0%"></div></div>
          <div style="font-size:12px;color:var(--text-dim);margin-top:8px;" id="tutGoalStat4">0/0</div>
        </div>
        <div class="tut-global-bar highlight-box" id="tutGlobalBar">
          <div class="tut-gb-label">Ïù¥Î≤à Îã¨</div>
          <div class="tut-gb-track"><div class="tut-gb-fill" id="tutGbFill" style="width:0%"></div></div>
          <div class="tut-gb-pct" id="tutGbPct">0%</div>
        </div>
        <button class="tut-confirm-btn" onclick="tutNextStep(5)">Îã§Ïùå ‚Üí</button>
      </div>

      <!-- STEP 5: Ï∫êÎ¶≠ÌÑ∞ -->
      <div class="tut-step" id="tutStep5">
        <div class="tut-bubble">
          <div class="tut-bubble-tag">STEP 5 ¬∑ ÎÇòÏùò Ï∫êÎ¶≠ÌÑ∞</div>
          <div class="tut-bubble-text">Ï†ÑÏ≤¥ Îã¨ÏÑ±Î•†Ïóê Îî∞Îùº <strong>Ï∫êÎ¶≠ÌÑ∞Í∞Ä ÏûêÎùºÎÇòÏöî!</strong><br>Ïó¥Ïã¨Ìûà Îã¨ÏÑ±Ìï†ÏàòÎ°ù Îçî Î©ãÏßÑ Ï∫êÎ¶≠ÌÑ∞Í∞Ä Îê† Í±∞ÏòàÏöî üåü</div>
        </div>
        <div class="tut-avatar-wrap highlight-box" id="tutAvatarWrap">
          <div class="tut-avatar-art" id="tutAvatarArt"></div>
          <div class="tut-avatar-stage" id="tutAvatarStage">1Îã®Í≥Ñ ¬∑ Ïïå</div>
          <div style="font-size:13px;color:var(--text-dim);">ÏàòÌñâÎ•†Ïù¥ ÎÜíÏïÑÏßàÏàòÎ°ù ÏÑ±Ïû•Ìï¥Ïöî</div>
        </div>
        <button class="tut-confirm-btn" onclick="tutFinish()">üéâ ÏãúÏûëÌïòÍ∏∞!</button>
      </div>

    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div id="dashboardScreen" class="screen">
  <div class="mobile-wrap">
    <nav class="topnav">
      <div class="nav-logo">ÎèôÎ¨º ÌÇ§Ïö∞Í∏∞</div>
      <div class="nav-right">
        <span class="nav-user" id="navUserName"></span>
        <button class="btn-sm" onclick="doLogout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
      </div>
    </nav>
    <!-- ÌÉ≠ Î∞î (Í∑∏Î£π ÏûàÏùÑ ÎïåÎßå ÏπúÍµ¨ ÌÉ≠ ÎÖ∏Ï∂ú) -->
    <div class="tab-bar" id="dashTabBar" style="display:none;">
      <button class="tab-btn active" onclick="switchTab('my')" id="tabBtnMy">üéØ ÎÇòÏùò Î™©Ìëú</button>
      <button class="tab-btn" onclick="switchTab('friends')" id="tabBtnFriends">üë• ÏπúÍµ¨</button>
    </div>
    <div class="dash-scroll">
    <!-- Í≥µÏßÄ Îù†Î∞∞ÎÑà -->
    <div class="notice-banner" id="noticeBanner" onclick="openNoticeModal()">
      <span class="notice-banner-icon">üì¢</span>
      <span class="notice-banner-title" id="noticeBannerTitle"></span>
      <span class="notice-banner-arrow">‚Ä∫</span>
    </div>
    <!-- ÎÇòÏùò Î™©Ìëú ÌÉ≠ -->
    <div class="tab-panel active" id="tabMy">
      <div class="avatar-section">
        <div class="avatar-art" id="avatarArt"></div>
        <div class="avatar-stage" id="avatarStage">1Îã®Í≥Ñ ¬∑ Ïïå</div>
        <div class="avatar-nickname-row" id="avatarNicknameRow">
          <div class="avatar-nickname" id="avatarNickname">ÎÇòÏùò Ï∫êÎ¶≠ÌÑ∞</div>
          <button class="pencil-btn" onclick="startEditNickname()">‚úèÔ∏è</button>
        </div>
        <div style="display:flex;align-items:center;gap:8px;justify-content:center;">
          <div id="avatarMsgWrap" style="display:flex;align-items:center;gap:8px;justify-content:center;">
          <div class="avatar-msg" id="avatarMsg">Ï¢ãÏùÄ ÏäµÍ¥Ä ÎßåÎìúÎäî Ï§ë</div>
          <button class="pencil-btn" onclick="startEditMsg()" style="flex-shrink:0;">‚úèÔ∏è</button>
          </div>
        </div>
      </div>
      <div class="goals-section">
        <div class="global-bar">
          <div class="gb-top">
            <div class="gb-label">Ïù¥Î≤à Îã¨ Îã¨ÏÑ±Î•†</div>
            <div class="gb-pct" id="gbPct">0%</div>
          </div>
          <div class="gb-track"><div class="gb-fill" id="gbFill" style="width:0%"></div></div>
        </div>
        <div class="goals-section-header" style="margin-top:20px;">
          <div class="goals-section-title">üéØ Î™©Ìëú</div>
        </div>
        <div class="goal-grid" id="goalGrid"></div>
      </div>
      <div class="detail-divider" style="margin-top:20px;"></div>
      <div class="detail-section" id="detailSection">
        <div class="detail-empty">Î™©ÌëúÎ•º ÏÑ†ÌÉùÌïòÎ©¥<br>ÏÉÅÏÑ∏ ÎÇ¥Ïö©Ïù¥ ÌéºÏ≥êÏßëÎãàÎã§</div>
      </div>
    </div>
    <!-- ÏπúÍµ¨ ÌÉ≠ -->
    <div class="tab-panel" id="tabFriends">
      <div class="friends-section" id="friendsSection"></div>
    </div>
    </div><!-- /dash-scroll -->
  </div>
</div>

<div class="confetti-container" id="confettiContainer"></div>

<!-- Í≥µÏßÄ Î™®Îã¨ -->
<div class="notice-modal-overlay" id="noticeModalOverlay">
  <div class="notice-modal">
    <div class="notice-modal-header">
      <span style="font-family:'Black Han Sans',sans-serif;font-size:15px;letter-spacing:1px;color:var(--text-dim);">üì¢ Í≥µÏßÄÏÇ¨Ìï≠</span>
      <button class="notice-modal-close" onclick="closeNoticeModal()">‚úï</button>
    </div>
    <div class="notice-modal-body" id="noticeModalBody"></div>
  </div>
</div>
<div class="week-clear-popup" id="weekClearPopup">
  <span class="week-clear-emoji">üèÜ</span>
  <div class="week-clear-title">Ïù¥Î≤à Ï£º Î™©Ìëú Îã¨ÏÑ±!</div>
  <div class="week-clear-sub">ÎåÄÎã®Ìï¥Ïöî! Ïù¥Î≤à Ï£ºÎèÑ ÏôÑÎ≤ΩÌñàÏñ¥Ïöî üéâ</div>
</div>
<div class="toast" id="toast"></div>

<!-- ÌîåÎ°úÌåÖ ÏôÑÎ£å Î≤ÑÌäº -->
<div class="float-fab" id="floatFab" style="display:none;">
  <div class="float-fab-inner">
    <div class="float-week-hint" id="floatWeekHint"></div>
    <button class="float-complete-btn" id="floatCompleteBtn" onclick="floatToggleToday()"></button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// Firebase import Ïã§Ìå® ÎåÄÎπÑ ÏïàÏ†ÑÏû•Ïπò - 8Ï¥à ÌõÑÏóêÎèÑ loadingÏù¥Î©¥ Í∞ïÏ†ú Î°úÍ∑∏Ïù∏ Ï†ÑÌôò
const _safetyTimer = setTimeout(() => {
  const loading = document.getElementById('loadingScreen');
  if (loading && loading.classList.contains('active')) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('loginScreen').classList.add('active');
  }
}, 8000);

const firebaseConfig = {
  apiKey: "AIzaSyAbEbLdJuWVai_NKTHuo1XtC8p76dmVPE0",
  authDomain: "grow-goal.firebaseapp.com",
  databaseURL: "https://grow-goal-default-rtdb.firebaseio.com",
  projectId: "grow-goal",
  storageBucket: "grow-goal.firebasestorage.app",
  messagingSenderId: "587441793315",
  appId: "1:587441793315:web:8ae5325a2af90953ce4496"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ===== ÏÉÅÏàò =====
const HEALTH_UNITS = ['health_sleep','health_workout'];
// Íµ¨Î≤ÑÏ†Ñ unit ÎßàÏù¥Í∑∏Î†àÏù¥ÏÖò
const LEGACY_UNIT_MAP = { w1:{unit:'weekly',freq:1}, w2:{unit:'weekly',freq:2}, w4:{unit:'weekly',freq:4}, w6:{unit:'weekly',freq:6} };
function migrateGoal(g){
  if(!g) return g;
  if(LEGACY_UNIT_MAP[g.unit]){
    return Object.assign({}, g, LEGACY_UNIT_MAP[g.unit]);
  }
  return g;
}
function getGoalFreq(g){
  if(!g) return 1;
  if(g.unit==='once') return 0;
  if(g.unit==='daily') return getMonthDays(new Date().getFullYear(), new Date().getMonth()+1);
  if(g.unit==='health_sleep') return 7;
  if(g.unit==='health_workout') return 2;
  return g.freq || 1; // weekly, biweekly
}
function getUnitLabel(g){
  if(!g) return '';
  if(g.unit==='once') return 'Ìïú Î≤à';
  if(g.unit==='daily') return 'Îß§Ïùº';
  if(g.unit==='health_sleep') return 'üåô ÏàòÎ©¥ ÏûêÎèô';
  if(g.unit==='health_workout') return 'üí™ Ïö¥Îèô ÏûêÎèô';
  if(g.unit==='weekly') return `Ï£º ${g.freq}Ìöå`;
  if(g.unit==='biweekly') return `2Ï£º ${g.freq}Ìöå`;
  return g.unit;
}
const MAX_GOALS   = 9;
const TUT_STEPS   = 5;

const CHEERS = [
  "Ïò§ÎäòÎèÑ Ìïú Í±∏Ïùå!","ÏûëÏùÄ ÏãúÏûëÏù¥ ÌÅ∞ Î≥ÄÌôîÎ•º ÎßåÎì§Ïñ¥Ïöî","Ìè¨Í∏∞ÌïòÏßÄ ÎßàÏÑ∏Ïöî!","Ïûò ÌïòÍ≥† ÏûàÏñ¥Ïöî!","Ïò§ÎäòÏùò ÎÖ∏Î†•Ïù¥ ÎÇ¥ÏùºÏùò ÎÇòÎ•º ÎßåÎì§Ïñ¥Ïöî",
  "Íæ∏Ï§ÄÌï®Ïù¥ ÏµúÍ≥†Ïùò Î¨¥Í∏∞ÏòàÏöî","Ïñ¥Ï†úÎ≥¥Îã§ ÎÇòÏùÄ Ïò§Îäò!","Ï°∞Í∏àÏî© ÎÇòÏïÑÍ∞ÄÎäî Ï§ë!","ÎãπÏã†ÏùÄ Ìï† Ïàò ÏûàÏñ¥Ïöî","Îß§ÏùºÏù¥ ÏÉàÎ°úÏö¥ Í∏∞ÌöåÏòàÏöî",
  "ÌûòÎÇ¥ÏÑ∏Ïöî, ÏùëÏõêÌï¥Ïöî!","Ïò§Îäò ÌïòÎ£®ÎèÑ ÏàòÍ≥†ÌñàÏñ¥Ïöî","ÏûëÏùÄ ÏäµÍ¥ÄÏù¥ Ïù∏ÏÉùÏùÑ Î∞îÍøîÏöî","Î©àÏ∂îÏßÄ ÏïäÏúºÎ©¥ Î∞òÎìúÏãú ÎèÑÎã¨Ìï¥Ïöî","Ï≤úÏ≤úÌûà Í∞ÄÎèÑ Í¥úÏ∞ÆÏïÑÏöî",
  "ÏßÄÍ∏à Ïù¥ ÏàúÍ∞ÑÏù¥ Ï§ëÏöîÌï¥Ïöî","Ïò§ÎäòÎèÑ Î©ãÏßÑ ÌïòÎ£®ÏòÄÏñ¥Ïöî","Ìïú Î≤àÏóê Ìïú Í±∏ÏùåÏî©","ÎãπÏã†Ïùò ÎÖ∏Î†•ÏùÑ ÏùëÏõêÌï¥Ïöî","Î™©ÌëúÏóê Í∞ÄÍπåÏõåÏßÄÍ≥† ÏûàÏñ¥Ïöî",
  "ÏûëÏùÄ ÏÑ±Í≥µÏùÑ Ï∂ïÌïòÌï¥Ïöî","Ïò§ÎäòÎèÑ Ïûò ÌñàÏñ¥Ïöî!","Ìè¨Í∏∞ÎûÄ ÏóÜÏñ¥Ïöî!","ÎÇ¥ÏùºÏùÄ Îçî Ïûò Îê† Í±∞ÏòàÏöî","ÏßÄÍ∏à Ïûò ÌïòÍ≥† ÏûàÏñ¥Ïöî",
  "Ïò§ÎäòÏùò ÎïÄÏù¥ ÎπõÎÇ† Í±∞ÏòàÏöî","ÏäµÍ¥ÄÏù¥ Ïö¥Î™ÖÏùÑ Î∞îÍøîÏöî","ÎãπÏã†ÏùÄ ÌäπÎ≥ÑÌï¥Ïöî","Îß§Ïùº Ï°∞Í∏àÏî© ÏÑ±Ïû• Ï§ë","ÌååÏù¥ÌåÖ!",
  "Ïò§Îäò ÌïòÎ£® ÏµúÏÑ†ÏùÑ Îã§ÌñàÏñ¥Ïöî","Í∏∞Î°ùÏù¥ ÏåìÏó¨ Ïã§Î†•Ïù¥ ÎèºÏöî","Íæ∏Ï§ÄÌïú ÎãπÏã†Ïù¥ Î©ãÏ†∏Ïöî","Ïò§ÎäòÎèÑ ÏäπÎ¶¨!","ÎÖ∏Î†•ÏùÄ Î∞∞Ïã†ÌïòÏßÄ ÏïäÏïÑÏöî",
  "Ïù¥ ÏàúÍ∞ÑÏùÑ Ï¶êÍ∏∞ÏÑ∏Ïöî","Ìïú Í±∏Ïùå Îçî ÎÇòÏïÑÍ∞îÏñ¥Ïöî","ÎãπÏã†Ïùò Í∞ÄÎä•ÏÑ±ÏùÄ Î¨¥ÌïúÌï¥Ïöî","Ìè¨Í∏∞ÌïòÏßÄ ÏïäÎäî ÎãπÏã† ÏµúÍ≥†","Ïò§ÎäòÎèÑ Ìï¥ÎÉàÏñ¥Ïöî!",
  "Î≥ÄÌôîÎäî ÏãúÏûëÎêêÏñ¥Ïöî","ÏßÄÏπòÏßÄ ÎßàÏÑ∏Ïöî, Í≥ß ÎπõÎÇ† Í±∞ÏòàÏöî","ÏùëÏõêÏù¥ Ìï®ÍªòÌï¥Ïöî","Ïò§ÎäòÎèÑ ÏÑ±Ïû•ÌñàÏñ¥Ïöî","ÎÇ¥ ÌéòÏù¥Ïä§ÎåÄÎ°ú Í∞ÄÏöî",
  "ÎãπÏã†Ïùò ÎÖ∏Î†•Ïù¥ ÎààÎ∂ÄÏÖîÏöî","ÌïòÎ£®ÌïòÎ£®Í∞Ä ÏåìÏó¨Ïöî","Ïò§ÎäòÎèÑ ÎÅùÍπåÏßÄ!","Ïã§Ìå®Ìï¥ÎèÑ Í¥úÏ∞ÆÏïÑÏöî, Îã§Ïãú ÏùºÏñ¥ÏÑúÎ©¥ ÎèºÏöî","Ïõ∞Îçò!",
  "ÏûëÏùÄ Î™©ÌëúÎ∂ÄÌÑ∞ Ï∞®Í∑ºÏ∞®Í∑º","ÏÑ±Í≥µÏùò Ïî®ÏïóÏùÑ Ïã¨Îäî Ï§ë","Ïò§Îäò ÌïòÎ£® Ï∂©Ï†Ñ ÏôÑÎ£å","ÎãπÏã†ÏùÄ ÏÑ±Ïû•ÌïòÎäî Ï§ëÏù¥ÏóêÏöî","Î©àÏ∂îÏßÄ ÏïäÎäî Ïö©Í∏∞!",
  "ÌïòÎ£®Î•º Ïûò ÎßàÎ¨¥Î¶¨ÌñàÏñ¥Ïöî","ÏßÄÍ∏àÏùò ÎÖ∏Î†•ÏùÑ ÎØøÏñ¥Ïöî","Î™®Îì† ÏàúÍ∞ÑÏù¥ ÏùòÎØ∏ ÏûàÏñ¥Ïöî","Ï¢ãÏùÄ ÏäµÍ¥Ä ÎßåÎìúÎäî Ï§ë","Ïò§ÎäòÎèÑ Ï¢ãÏùÄ ÏÑ†ÌÉù!",
  "ÎØ∏ÎûòÏùò ÎÇòÎ•º ÏúÑÌïú Ìà¨ÏûêÏòàÏöî","ÏßÄÍ∏à ÎãπÏã† ÏµúÍ≥†ÏòàÏöî","ÏûëÏùÄ Î≥ÄÌôîÍ∞Ä ÌÅ∞ Í∏∞Ï†ÅÏùÑ ÎßåÎì§Ïñ¥Ïöî","Ïò§ÎäòÎèÑ ÏûêÎûëÏä§Îü¨ÏõåÏöî","ÏïûÏúºÎ°úÎßå!",
  "ÎãπÏã†Ïùò Ïó¥Ï†ïÏù¥ ÎπõÎÇòÏöî","Ï°∞Í∏àÎßå Îçî ÌûòÎÇ¥Ïöî","Ìè¨Í∏∞ Í∏àÏßÄ!","Îß§Ïùº Ï°∞Í∏àÏî© Îçî Í∞ïÌï¥Ï†∏Ïöî","Ïò§ÎäòÏùò ÏäµÍ¥ÄÏù¥ ÎØ∏ÎûòÎ•º Í≤∞Ï†ïÌï¥Ïöî",
  "Ïûò ÏûêÍ≥† ÎÇ¥Ïùº Îòê ÌååÏù¥ÌåÖ!","Ïñ¥Ï†úÏùò ÎÇòÎ≥¥Îã§ ÎÇòÏïÑÏ°åÏñ¥Ïöî","ÌèâÎ≤îÌïú ÎÇ†ÎèÑ ÏÜåÏ§ëÌï¥Ïöî","Î£®Ìã¥Ïù¥ ÏÇ∂ÏùÑ Î∞îÍøîÏöî","Î™©ÌëúÎ•º Ìñ•Ìï¥ Ï†ÑÏßÑ Ï§ë!",
  "ÎãπÏã†Ïùò ÏùòÏßÄÎ†•Ïù¥ ÎåÄÎã®Ìï¥Ïöî","Ïò§Îäò ÌïòÎ£® ÏµúÍ≥†ÏòÄÏñ¥Ïöî","Ìïú Î≤à Îçî ÎèÑÏ†Ñ!","ÏßÄÍ∏à Ïù¥ ÏàúÍ∞ÑÏùÑ Ï¶êÍ≤®Ïöî","Ìè¨Í∏∞ÌïòÏßÄ ÏïäÎäî ÌûòÏù¥ ÏµúÍ≥†ÏòàÏöî",
  "ÎπõÎÇòÎäî ÎØ∏ÎûòÎ•º Ìñ•Ìï¥","Ïò§ÎäòÎèÑ Ìï¥Ìîº ÌÄòÏä§Ìä∏!","ÎÖ∏Î†•ÌïòÎäî ÎãπÏã†Ïù¥ ÏïÑÎ¶ÑÎã§ÏõåÏöî","ÎÇ¥ÏùºÎèÑ Í∞ôÏù¥ Ìï¥Ïöî","Ïò§ÎäòÏùò Ï≤¥ÌÅ¨Í∞Ä ÎπõÎÇòÏöî",
  "Ï°∞Í∏àÏî©, ÌôïÏã§ÌïòÍ≤å","ÎãπÏã†Ïùò Î£®Ìã¥Ïù¥ ÏôÑÏÑ±ÎêòÏñ¥ Í∞ÄÏöî","Ïù¥ ÏàúÍ∞ÑÏóê ÏßëÏ§ëÌï¥Ïöî","Ïò§ÎäòÎèÑ ÏôÑÎ≤ΩÌïú ÌïòÎ£®!","Íµø Ïû°!",
  "Ìïú Î∞úÏî© ÎÇòÏïÑÍ∞ÄÎäî Ï§ë","ÎãπÏã†Ïùò Íæ∏Ï§ÄÌï®Ïù¥ ÎåÄÎã®Ìï¥Ïöî","Ïò§ÎäòÎèÑ ÌõåÎ•≠ÌñàÏñ¥Ïöî","Î©ãÏßÑ ÏäµÍ¥ÄÏùÑ ÎßåÎìúÎäî Ï§ë","Í≥ÑÏÜç Í∞ÄÏöî!",
  "Ïò§ÎäòÎèÑ Í∏∞Î°ù ÏôÑÎ£å!","ÎãπÏã†ÏùÄ Îß§Ïùº ÏÑ±Ïû•Ìï¥Ïöî","Ïù¥ ÏäµÍ¥ÄÏù¥ ÎãπÏã†ÏùÑ Î∞îÍøÄ Í±∞ÏòàÏöî","Ïò§ÎäòÎèÑ Ï∂©Ïã§ÌñàÏñ¥Ïöî","ÌïúÍ≥ÑÎ•º ÎÑòÏñ¥ÏÑúÏöî",
  "ÍøàÏùÑ Ìñ•Ìïú ÏûëÏùÄ Î∞úÍ±∏Ïùå","Ïò§ÎäòÎèÑ ÌååÏù¥ÌåÖ ÎÑòÏ≥êÏöî","ÎãπÏã†Ïùò ÌïòÎ£®Í∞Ä ÎààÎ∂ÄÏÖîÏöî","ÏßÄÍ∏à Ïûò Îã¨Î¶¨Í≥† ÏûàÏñ¥Ïöî","ÎÇ¥ÏùºÎèÑ Í∏∞ÎåÄÎèºÏöî",
  "ÏûëÏùÄ ÏôÑÎ£åÍ∞Ä Î™®Ïó¨ ÏÑ±Í≥µÏù¥ ÎèºÏöî","Ïò§ÎäòÎèÑ Ï≤¥ÌÅ¨ ÏôÑÎ£å!","ÎãπÏã†Ïùò ÎÅàÍ∏∞Í∞Ä Î©ãÏ†∏Ïöî","Ìïú Í±∏ÏùåÏùò Í∏∞Ï†Å","Ïò§ÎäòÎèÑ Ïù¥Í≤®ÎÉàÏñ¥Ïöî!",
  "ÎÇ¥ ÏïàÏùò Í∞ÄÎä•ÏÑ±ÏùÑ ÎØøÏñ¥Ïöî","Ïò§ÎäòÎèÑ Î£®Ìã¥ ÏôÑÏÑ±!","ÎãπÏã†Ïùò ÎÖ∏Î†•ÏùÑ ÎØøÏñ¥Ïöî","Ï°∞Í∏àÏî© Îçî ÎÇòÏùÄ ÎÇòÎ°ú","Ïò§Îäò ÌïòÎ£® Ï±ôÍ≤ºÏñ¥Ïöî",
  "Ïò§ÎäòÎèÑ ÏµúÏÑ†!","ÎãπÏã†Ïùò ÏÑ±Ïû•Ïù¥ ÎäêÍª¥Ï†∏Ïöî","Î©àÏ∂îÏßÄ ÏïäÎäî Í≤ÉÏù¥ ÏµúÍ≥†ÏòàÏöî","Ïò§ÎäòÎèÑ Î∏åÎùºÎ≥¥!","Ìïú Î∞ú ÏïûÏÑúÍ∞ÄÎäî ÎãπÏã†",
  "Íæ∏Ï§ÄÌï®Ïù¥ Ïã§Î†•Ïù¥ ÎèºÏöî","Ïò§ÎäòÎèÑ ÌõåÎ•≠Ìïú ÏÑ†ÌÉù!","ÎãπÏã†Ïùò Í≤∞Ïã¨Ïù¥ ÎåÄÎã®Ìï¥Ïöî","Ïò§Îäò ÌïòÎ£® Ïûò Î≤ÑÌÖºÏñ¥Ïöî","ÎÇ¥ÏùºÏùò ÎÇòÏóêÍ≤å ÏÑ†Î¨ºÌïòÎäî Ïò§Îäò",
  "Ïò§ÎäòÎèÑ Ïâ¨ÏßÄ ÏïäÏïòÏñ¥Ïöî","ÎãπÏã†Ïùò ÏùòÏßÄÍ∞Ä ÎπõÎÇòÏöî","Î£®Ìã¥Ïùò Îã¨Ïù∏Ïù¥ ÎêòÏñ¥Í∞ÄÎäî Ï§ë","Ïò§ÎäòÎèÑ Í∏∞ÌäπÌï¥Ïöî","ÏäµÍ¥ÄÏù¥ ÎÇòÎ•º ÎßåÎì§Ïñ¥Ïöî",
  "ÏûëÏßÄÎßå ÌôïÏã§Ìïú ÏßÑÏ†Ñ","Ïò§ÎäòÎèÑ Ïä§Ïä§Î°ú Ïπ≠Ï∞¨Ìï¥Ïöî","ÎãπÏã†ÏùÄ Îß§Ïùº Îçî Í∞ïÌï¥Ï†∏Ïöî","Ïò§ÎäòÏùò ÎÖ∏Î†• Î∞ïÏàò!","ÏïûÎßå Î≥¥Í≥† Í∞ÄÏöî",
  "ÏßÄÍ∏à Ïù¥ ÏàúÍ∞ÑÏù¥ ÏÜåÏ§ëÌï¥Ïöî","Ïò§ÎäòÎèÑ Ìïú ÌéòÏù¥ÏßÄ ÏôÑÏÑ±","ÎãπÏã†Ïùò Ïó¨Ï†ïÏùÑ ÏùëÏõêÌï¥Ïöî","Îß§Ïùº Ï°∞Í∏àÏî© ÎπõÎÇòÏöî","Ïò§ÎäòÎèÑ Ïûò ÌñàÏñ¥!",
  "Ìè¨Í∏∞ÌïòÏßÄ ÏïäÎäî ÎãπÏã† Î©ãÏ†∏Ïöî","Ïò§ÎäòÏùò ÎèÑÏ†Ñ ÏÑ±Í≥µ!","ÎãπÏã†Ïùò ÌïòÎ£®Í∞Ä Í∞íÏ†∏Ïöî","Ïù¥ ÏäµÍ¥ÄÏù¥ Ïò§ÎûòÍ∞ÄÍ∏∏","Ïò§ÎäòÎèÑ Í±¥Í∞ïÌïú ÌïòÎ£®",
  "Ïò§ÎäòÎèÑ ÌååÏù¥ÌåÖ!","ÏûëÏùÄ Í≤ÉÏù¥ Î™®Ïó¨ ÏúÑÎåÄÌï¥Ï†∏Ïöî","ÎãπÏã†Ïùò ÌïòÎ£®Í∞Ä ÏÜåÏ§ëÌï¥Ïöî","Ïò§ÎäòÎèÑ Ïûò Ïù¥Í≤®ÎÉàÏñ¥Ïöî","Ìïú Í±∏ÏùåÏù¥ Í∏∞Ï†ÅÏùò ÏãúÏûë"
];

// ===== SVG ÏïÑÎ∞îÌÉÄ =====
const AVATARS = [
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><ellipse cx="40" cy="44" rx="22" ry="28" fill="#f0e8d0" stroke="#c8b89a" stroke-width="2"/><ellipse cx="33" cy="36" rx="4" ry="6" fill="rgba(255,255,255,0.3)"/><circle cx="40" cy="38" r="6" fill="#f0e8d0" stroke="#c8b89a" stroke-width="1"/><path d="M36,40 Q40,44 44,40" fill="none" stroke="#c8b89a" stroke-width="1.5" stroke-linecap="round"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><circle cx="40" cy="48" r="20" fill="#f5c518"/><circle cx="40" cy="28" r="14" fill="#f5c518"/><circle cx="35" cy="25" r="3" fill="#1a1a1a"/><circle cx="45" cy="25" r="3" fill="#1a1a1a"/><circle cx="35.5" cy="24.5" r="1" fill="white"/><circle cx="45.5" cy="24.5" r="1" fill="white"/><polygon points="40,30 37,34 43,34" fill="#f39c12"/><ellipse cx="28" cy="48" rx="7" ry="10" fill="#f5c518" transform="rotate(-20,28,48)"/><ellipse cx="52" cy="48" rx="7" ry="10" fill="#f5c518" transform="rotate(20,52,48)"/><line x1="34" y1="68" x2="30" y2="75" stroke="#f39c12" stroke-width="3" stroke-linecap="round"/><line x1="40" y1="68" x2="40" y2="75" stroke="#f39c12" stroke-width="3" stroke-linecap="round"/><line x1="46" y1="68" x2="50" y2="75" stroke="#f39c12" stroke-width="3" stroke-linecap="round"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><circle cx="40" cy="48" r="22" fill="#d4a574"/><circle cx="40" cy="30" r="16" fill="#d4a574"/><polygon points="24,20 20,8 32,18" fill="#d4a574"/><polygon points="56,20 60,8 48,18" fill="#d4a574"/><polygon points="25,19 22,11 31,18" fill="#f8b4b4"/><polygon points="55,19 58,11 49,18" fill="#f8b4b4"/><circle cx="34" cy="28" r="3.5" fill="#1a1a1a"/><circle cx="46" cy="28" r="3.5" fill="#1a1a1a"/><circle cx="34.8" cy="27.2" r="1.2" fill="white"/><circle cx="46.8" cy="27.2" r="1.2" fill="white"/><ellipse cx="40" cy="33" rx="4" ry="2.5" fill="#f8b4b4"/><path d="M36,35 Q40,38 44,35" fill="none" stroke="#c8846a" stroke-width="1.5" stroke-linecap="round"/><line x1="22" y1="30" x2="10" y2="27" stroke="#c8846a" stroke-width="1.5"/><line x1="22" y1="33" x2="10" y2="33" stroke="#c8846a" stroke-width="1.5"/><line x1="22" y1="36" x2="10" y2="39" stroke="#c8846a" stroke-width="1.5"/><line x1="58" y1="30" x2="70" y2="27" stroke="#c8846a" stroke-width="1.5"/><line x1="58" y1="33" x2="70" y2="33" stroke="#c8846a" stroke-width="1.5"/><line x1="58" y1="36" x2="70" y2="39" stroke="#c8846a" stroke-width="1.5"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><circle cx="40" cy="46" r="22" fill="#c8986a"/><circle cx="40" cy="28" r="16" fill="#c8986a"/><ellipse cx="24" cy="34" rx="9" ry="14" fill="#b8845a" transform="rotate(-10,24,34)"/><ellipse cx="56" cy="34" rx="9" ry="14" fill="#c8986a" transform="rotate(10,56,34)"/><circle cx="34" cy="26" r="3.5" fill="#1a1a1a"/><circle cx="46" cy="26" r="3.5" fill="#1a1a1a"/><circle cx="34.8" cy="25.2" r="1.2" fill="white"/><circle cx="46.8" cy="25.2" r="1.2" fill="white"/><ellipse cx="40" cy="32" rx="7" ry="5" fill="#b8845a"/><ellipse cx="40" cy="31" rx="5" ry="3" fill="#f8b4b4"/><path d="M34,35 Q40,40 46,35" fill="none" stroke="#8B5E3C" stroke-width="2" stroke-linecap="round"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><circle cx="40" cy="46" r="20" fill="#e8783a"/><circle cx="40" cy="28" r="15" fill="#e8783a"/><polygon points="26,20 18,6 34,18" fill="#e8783a"/><polygon points="54,20 62,6 46,18" fill="#e8783a"/><polygon points="27,19 20,8 33,18" fill="#f8f0e8"/><polygon points="53,19 60,8 47,18" fill="#f8f0e8"/><ellipse cx="40" cy="32" rx="10" ry="8" fill="#f8f0e8"/><circle cx="34" cy="26" r="3.5" fill="#1a1a1a"/><circle cx="46" cy="26" r="3.5" fill="#1a1a1a"/><circle cx="34.8" cy="25.2" r="1.2" fill="white"/><circle cx="46.8" cy="25.2" r="1.2" fill="white"/><ellipse cx="40" cy="33" rx="4" ry="2.5" fill="#1a1a1a"/><path d="M35,36 Q40,40 45,36" fill="none" stroke="#c85a2a" stroke-width="1.5" stroke-linecap="round"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><circle cx="40" cy="46" r="22" fill="#f8f8f8"/><circle cx="40" cy="28" r="16" fill="#f8f8f8"/><ellipse cx="29" cy="25" rx="8" ry="7" fill="#2a2a2a"/><ellipse cx="51" cy="25" rx="8" ry="7" fill="#2a2a2a"/><circle cx="29" cy="23" r="4" fill="#f8f8f8"/><circle cx="51" cy="23" r="4" fill="#f8f8f8"/><circle cx="30" cy="24" r="2.5" fill="#1a1a1a"/><circle cx="52" cy="24" r="2.5" fill="#1a1a1a"/><circle cx="30.8" cy="23.2" r="0.9" fill="white"/><circle cx="52.8" cy="23.2" r="0.9" fill="white"/><ellipse cx="40" cy="33" rx="5" ry="3.5" fill="#d4d4d4"/><circle cx="40" cy="32" r="2.5" fill="#f8a0a0"/><path d="M35,36 Q40,40 45,36" fill="none" stroke="#888" stroke-width="1.5" stroke-linecap="round"/><circle cx="22" cy="18" r="6" fill="#2a2a2a"/><circle cx="58" cy="18" r="6" fill="#2a2a2a"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><ellipse cx="28" cy="18" rx="7" ry="18" fill="#f0f0f0" stroke="#ddd" stroke-width="1"/><ellipse cx="52" cy="18" rx="7" ry="18" fill="#f0f0f0" stroke="#ddd" stroke-width="1"/><ellipse cx="28" cy="18" rx="4" ry="14" fill="#f8b4b4"/><ellipse cx="52" cy="18" rx="4" ry="14" fill="#f8b4b4"/><circle cx="40" cy="46" r="22" fill="#f0f0f0"/><circle cx="40" cy="30" r="15" fill="#f0f0f0"/><circle cx="34" cy="28" r="3.5" fill="#e87eb0"/><circle cx="46" cy="28" r="3.5" fill="#e87eb0"/><circle cx="34.6" cy="27.4" r="1.2" fill="#1a1a1a"/><circle cx="46.6" cy="27.4" r="1.2" fill="#1a1a1a"/><ellipse cx="40" cy="33" rx="4" ry="2.5" fill="#f8b4b4"/><path d="M35,36 Q40,40 45,36" fill="none" stroke="#d4849a" stroke-width="1.5" stroke-linecap="round"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><circle cx="40" cy="40" r="28" fill="#e8a830" opacity="0.4"/><circle cx="40" cy="40" r="22" fill="#e8a830" opacity="0.6"/><circle cx="40" cy="36" r="16" fill="#f5d040"/><circle cx="40" cy="32" r="14" fill="#f5d040"/><circle cx="34" cy="30" r="3.5" fill="#1a1a1a"/><circle cx="46" cy="30" r="3.5" fill="#1a1a1a"/><circle cx="34.8" cy="29.2" r="1.2" fill="white"/><circle cx="46.8" cy="29.2" r="1.2" fill="white"/><ellipse cx="40" cy="36" rx="6" ry="4" fill="#e8a830"/><ellipse cx="40" cy="35" rx="4.5" ry="2.8" fill="#f8a0a0"/><path d="M33,40 Q40,45 47,40" fill="none" stroke="#c87820" stroke-width="2" stroke-linecap="round"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><path d="M10,30 Q20,10 30,20 Q20,30 10,30Z" fill="#2ecc40"/><path d="M70,30 Q60,10 50,20 Q60,30 70,30Z" fill="#2ecc40"/><circle cx="40" cy="46" r="22" fill="#27ae60"/><circle cx="40" cy="28" r="15" fill="#27ae60"/><circle cx="34" cy="26" r="4" fill="#f1c40f"/><circle cx="46" cy="26" r="4" fill="#f1c40f"/><circle cx="35" cy="26" r="2.5" fill="#1a1a1a"/><circle cx="47" cy="26" r="2.5" fill="#1a1a1a"/><circle cx="35.8" cy="25.2" r="1" fill="white"/><circle cx="47.8" cy="25.2" r="1" fill="white"/><ellipse cx="40" cy="34" rx="5" ry="3" fill="#1a5c30"/><path d="M36,37 Q40,42 44,37" fill="none" stroke="#1a5c30" stroke-width="2" stroke-linecap="round"/></svg>`,
  `<svg viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg"><defs><linearGradient id="ugrd" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#f8b4d4"/><stop offset="50%" style="stop-color:#c8f135"/><stop offset="100%" style="stop-color:#35c8f1"/></linearGradient><linearGradient id="hgrd" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:#f1c835"/><stop offset="100%" style="stop-color:#f8b4d4"/></linearGradient></defs><circle cx="40" cy="46" r="22" fill="url(#ugrd)"/><circle cx="40" cy="28" r="15" fill="url(#ugrd)"/><path d="M40,6 L36,22 L44,22Z" fill="url(#hgrd)"/><circle cx="34" cy="26" r="3.5" fill="#1a1a1a"/><circle cx="46" cy="26" r="3.5" fill="#1a1a1a"/><circle cx="34.8" cy="25.2" r="1.4" fill="white"/><circle cx="46.8" cy="25.2" r="1.4" fill="white"/><ellipse cx="40" cy="32" rx="4" ry="2.5" fill="#f8d4e8"/><path d="M35,35 Q40,40 45,35" fill="none" stroke="#d4849a" stroke-width="1.5" stroke-linecap="round"/></svg>`
];
const STAGE_NAMES = ['Ïïå','Î≥ëÏïÑÎ¶¨','Í≥†ÏñëÏù¥','Í∞ïÏïÑÏßÄ','Ïó¨Ïö∞','ÌåêÎã§','ÌÜ†ÎÅº','ÏÇ¨Ïûê','ÎìúÎûòÍ≥§','Ïú†ÎãàÏΩò'];

// ===== ÏÉÅÌÉú =====
let currentUser = null;
let localDash = null;
let activeGoalIdx = null;
let viewMonth = null;
// selectedUnit Ï†úÍ±∞Îê® - selectedPeriod/selectedFreqÎ°ú ÎåÄÏ≤¥

// Apple HealthKit Ï†ÑÏ≤¥ Ïö¥Îèô ÌÉÄÏûÖ (Í≥µÏãù Î¨∏ÏÑú Í∏∞Ï§Ä)
const APPLE_WORKOUT_TYPES = [
  {key:'americanFootball', label:'ÎØ∏ÏãùÏ∂ïÍµ¨'},
  {key:'archery', label:'ÏñëÍ∂Å'},
  {key:'australianFootball', label:'Ìò∏Ï£ºÏãù Ï∂ïÍµ¨'},
  {key:'badminton', label:'Î∞∞ÎìúÎØºÌÑ¥'},
  {key:'baseball', label:'ÏïºÍµ¨'},
  {key:'basketball', label:'ÎÜçÍµ¨'},
  {key:'bowling', label:'Î≥ºÎßÅ'},
  {key:'boxing', label:'Î≥µÏã±'},
  {key:'climbing', label:'ÌÅ¥ÎùºÏù¥Î∞ç'},
  {key:'cricket', label:'ÌÅ¨Î¶¨Ïºì'},
  {key:'crossTraining', label:'ÌÅ¨Î°úÏä§ Ìä∏Î†àÏù¥Îãù'},
  {key:'curling', label:'Ïª¨ÎßÅ'},
  {key:'cycling', label:'ÏÇ¨Ïù¥ÌÅ¥'},
  {key:'dance', label:'ÎåÑÏä§'},
  {key:'elliptical', label:'ÏùºÎ¶ΩÌã∞Ïª¨'},
  {key:'equestrianSports', label:'ÏäπÎßà'},
  {key:'fencing', label:'ÌéúÏã±'},
  {key:'fishing', label:'ÎÇöÏãú'},
  {key:'functionalStrengthTraining', label:'Í∏∞Îä•ÏÑ± Í∑ºÎ†• Ïö¥Îèô'},
  {key:'golf', label:'Í≥®ÌîÑ'},
  {key:'gymnastics', label:'Ï≤¥Ï°∞'},
  {key:'handball', label:'Ìï∏ÎìúÎ≥º'},
  {key:'hiking', label:'ÌïòÏù¥ÌÇπ'},
  {key:'hockey', label:'ÌïòÌÇ§'},
  {key:'hunting', label:'ÌóåÌåÖ'},
  {key:'lacrosse', label:'ÎùºÌÅ¨Î°úÏä§'},
  {key:'martialArts', label:'Î¨¥Ïà†'},
  {key:'mindAndBody', label:'ÎßàÏùå Ï±ôÍπÄ'},
  {key:'mixedCardio', label:'Î≥µÌï© Ïú†ÏÇ∞ÏÜå'},
  {key:'paddleSports', label:'Ìå®Îì§ Ïä§Ìè¨Ï∏†'},
  {key:'pilates', label:'ÌïÑÎùºÌÖåÏä§'},
  {key:'play', label:'ÎÜÄÏù¥'},
  {key:'preparationAndRecovery', label:'Ï§ÄÎπÑ Î∞è ÌöåÎ≥µ'},
  {key:'racquetball', label:'ÎùºÏºìÎ≥º'},
  {key:'rowing', label:'Ï°∞Ï†ï'},
  {key:'rugby', label:'Îü≠ÎπÑ'},
  {key:'running', label:'Îã¨Î¶¨Í∏∞'},
  {key:'sailing', label:'Ìï≠Ìï¥'},
  {key:'skatingSports', label:'Ïä§ÏºÄÏù¥ÌåÖ'},
  {key:'snowSports', label:'ÏÑ§ÏÉÅ Ïä§Ìè¨Ï∏†'},
  {key:'soccer', label:'Ï∂ïÍµ¨'},
  {key:'softball', label:'ÏÜåÌîÑÌä∏Î≥º'},
  {key:'squash', label:'Ïä§ÏøºÏãú'},
  {key:'stairClimbing', label:'Í≥ÑÎã® Ïò§Î•¥Í∏∞'},
  {key:'surfingSports', label:'ÏÑúÌïë'},
  {key:'swimming', label:'ÏàòÏòÅ'},
  {key:'tableTennis', label:'ÌÉÅÍµ¨'},
  {key:'tennis', label:'ÌÖåÎãàÏä§'},
  {key:'trackAndField', label:'Ïú°ÏÉÅ'},
  {key:'traditionalStrengthTraining', label:'Ìó¨Ïä§ (Í∑ºÎ†• Ïö¥Îèô)'},
  {key:'volleyball', label:'Î∞∞Íµ¨'},
  {key:'walking', label:'Í±∑Í∏∞'},
  {key:'waterFitness', label:'ÏàòÏ§ë ÌîºÌä∏ÎãàÏä§'},
  {key:'waterPolo', label:'ÏàòÍµ¨'},
  {key:'waterSports', label:'ÏàòÏÉÅ Ïä§Ìè¨Ï∏†'},
  {key:'wrestling', label:'Î†àÏä¨ÎßÅ'},
  {key:'yoga', label:'ÏöîÍ∞Ä'},
  {key:'barre', label:'Î∞îÎ†à'},
  {key:'coreTraining', label:'ÏΩîÏñ¥ Ìä∏Î†àÏù¥Îãù'},
  {key:'crossCountrySkiing', label:'ÌÅ¨Î°úÏä§Ïª®Ìä∏Î¶¨ Ïä§ÌÇ§'},
  {key:'downhillSkiing', label:'Îã§Ïö¥Ìûê Ïä§ÌÇ§'},
  {key:'flexibility', label:'Ïú†Ïó∞ÏÑ± Ïö¥Îèô'},
  {key:'highIntensityIntervalTraining', label:'HIIT'},
  {key:'jumpRope', label:'Ï§ÑÎÑòÍ∏∞'},
  {key:'kickboxing', label:'ÌÇ•Î≥µÏã±'},
  {key:'snowboarding', label:'Ïä§ÎÖ∏Î≥¥Îî©'},
  {key:'stairs', label:'Ïä§ÌÖùÌçº'},
  {key:'stepTraining', label:'Ïä§ÌÖù Ìä∏Î†àÏù¥Îãù'},
  {key:'wheelchairWalkPace', label:'Ìú†Ï≤¥Ïñ¥ (Í±∑Í∏∞)'},
  {key:'wheelchairRunPace', label:'Ìú†Ï≤¥Ïñ¥ (Îã¨Î¶¨Í∏∞)'},
  {key:'taiChi', label:'ÌÉúÍ∑πÍ∂å'},
  {key:'mixedMetabolicCardioTraining', label:'Î≥µÌï© ÎåÄÏÇ¨ Ïú†ÏÇ∞ÏÜå'},
  {key:'discSports', label:'ÎîîÏä§ÌÅ¨ Ïä§Ìè¨Ï∏†'},
  {key:'fitnessGaming', label:'ÌîºÌä∏ÎãàÏä§ Í≤åÏûÑ'},
  {key:'cardioDance', label:'Ïπ¥ÎîîÏò§ ÎåÑÏä§'},
  {key:'socialDance', label:'ÏÜåÏÖú ÎåÑÏä§'},
  {key:'pickleball', label:'ÌîºÌÅ¥Î≥º'},
  {key:'cooldown', label:'Ïø®Îã§Ïö¥'},
  {key:'swimBikeRun', label:'Ìä∏ÎùºÏù¥Ïï†Ïä¨Î°†'},
  {key:'transition', label:'Ï†ÑÌôò Ïö¥Îèô'},
  {key:'underwaterDiving', label:'ÏàòÏ§ë Îã§Ïù¥Îπô'},
];
// ÌäúÌÜ†Î¶¨Ïñº ÏÉÅÌÉú
let tutState = { goalName:'', unit:'w4', checkedDays:new Set(), currentStep:1 };

// ===== ÌôîÎ©¥ =====
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}

// ===== INIT =====
async function init() {
  const saved = JSON.parse(localStorage.getItem('qb_login') || 'null');
  if (saved && saved.id && saved.pw) {
    showScreen('loadingScreen');
    try {
      // 5Ï¥à ÌÉÄÏûÑÏïÑÏõÉ
      const timeoutPromise = new Promise((_,reject) => setTimeout(()=>reject(new Error('timeout')), 5000));
      const snap = await Promise.race([get(ref(db,`users/${saved.id}`)), timeoutPromise]);
      if (snap.exists() && snap.val().password === saved.pw) {
        const u = snap.val();
        currentUser = {id:saved.id,...u};
        document.getElementById('navUserName').textContent = u.name;
        await loadDash();
        if (!localDash.tutorialDone) {
          tutState = { goalName:'', unit:'w4', checkedDays:new Set(), currentStep:1 };
          initTutorial();
          showScreen('tutorialScreen');
        } else {
          activeGoalIdx = null; viewMonth = null;
          showScreen('dashboardScreen');
          const grpSnap = await get(ref(db,'groups'));
          let hasGroup = false;
          if(grpSnap.exists()){
            hasGroup = Object.values(grpSnap.val()).some(g=> g.members && Object.values(g.members).includes(saved.id));
          }
          const tabBar = document.getElementById('dashTabBar');
          if(tabBar) tabBar.style.display = hasGroup ? 'flex' : 'none';
          renderDashboard();
        }
        clearTimeout(_safetyTimer);
        return;
      }
    } catch(e) {
      // ÏûêÎèô Î°úÍ∑∏Ïù∏ Ïã§Ìå® (ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò or ÌÉÄÏûÑÏïÑÏõÉ) ‚Üí Î°úÍ∑∏Ïù∏ ÌôîÎ©¥
    }
  }
  clearTimeout(_safetyTimer);
  // Ìèº Ï±ÑÏö∞Í∏∞
  if (saved) {
    document.getElementById('loginId').value = saved.id || '';
    document.getElementById('loginPw').value = saved.pw || '';
    document.getElementById('saveLoginChk').checked = true;
  }
  showScreen('loginScreen');
}
init();

// ===== LOGIN =====
window.doLogin = async function() {
  const id = document.getElementById('loginId').value.trim();
  const pw = document.getElementById('loginPw').value;
  const btn = document.getElementById('loginBtn');
  const saveChk = document.getElementById('saveLoginChk').checked;
  if (!id||!pw) return;
  btn.disabled=true; btn.textContent='ÌôïÏù∏ Ï§ë...';
  try {
    const snap = await get(ref(db,`users/${id}`));
    if (!snap.exists()||snap.val().password!==pw) {
      document.getElementById('loginError').style.display='block';
    } else {
      document.getElementById('loginError').style.display='none';
      // Î°úÍ∑∏Ïù∏ Ï†ïÎ≥¥ Ï†ÄÏû•/ÏÇ≠Ï†ú
      if (saveChk) localStorage.setItem('qb_login', JSON.stringify({id,pw}));
      else localStorage.removeItem('qb_login');
      const u = snap.val();
      currentUser = {id,...u};
      // lastLogin Í∏∞Î°ù
      await set(ref(db,`users/${id}/lastLogin`), new Date().toISOString());
      if (u.role==='admin') { showScreen('adminScreen'); renderAdminList(); }
      else {
        document.getElementById('navUserName').textContent = u.name;
        await loadDash();
        // ÌäúÌÜ†Î¶¨Ïñº ÏôÑÎ£å Ïó¨Î∂Ä ÌôïÏù∏
        if (!localDash.tutorialDone) {
          tutState = { goalName:'', unit:'w4', checkedDays:new Set(), currentStep:1 };
          initTutorial();
          showScreen('tutorialScreen');
        } else {
          activeGoalIdx = null; viewMonth = null;
          showScreen('dashboardScreen');
          // Í∑∏Î£π ÌôïÏù∏ ‚Üí ÏπúÍµ¨ ÌÉ≠ ÌëúÏãú Ïó¨Î∂Ä
          const grpSnap = await get(ref(db,'groups'));
          let hasGroup = false;
          if(grpSnap.exists()){
            hasGroup = Object.values(grpSnap.val()).some(g=> g.members && Object.values(g.members).includes(id));
          }
          const tabBar = document.getElementById('dashTabBar');
          if(tabBar) tabBar.style.display = hasGroup ? 'flex' : 'none';
          renderDashboard();
        }
      }
    }
  } catch(e) { showToast('‚ùå Ïó∞Í≤∞ Ïò§Î•ò'); }
  btn.disabled=false; btn.textContent='Î°úÍ∑∏Ïù∏';
};
['loginId','loginPw'].forEach(id=>{
  document.getElementById(id).addEventListener('keydown',e=>{ if(e.key==='Enter') window.doLogin(); });
});

window.doLogout = function() {
  currentUser=null; localDash=null; activeGoalIdx=null;
  document.getElementById('loginId').value='';
  document.getElementById('loginPw').value='';
  if (!document.getElementById('saveLoginChk').checked) localStorage.removeItem('qb_login');
  showScreen('loginScreen');
};

// ===== DB =====
async function loadDash() {
  const snap = await get(ref(db,`dashboards/${currentUser.id}`));
  localDash = snap.exists() ? snap.val() : {};
  if (!localDash.goals) localDash.goals=[];
  if (!localDash.completions) localDash.completions={};
}
async function saveDash() {
  localDash.lastUpdate = new Date().toISOString();
  await set(ref(db,`dashboards/${currentUser.id}`),localDash);
}

async function syncHealthGoalIndex() {
  // goals Î∞∞Ïó¥ ÏàúÌöåÌï¥ÏÑú health ÌÉÄÏûÖ Ïä¨Î°Ø Ïù∏Îç±Ïä§Î•º Î≥ÑÎèÑ Í≤ΩÎ°úÏóê Ï†ÄÏû•
  const goals = getAllGoals();
  const healthGoals = {};
  goals.forEach((g, i) => {
    if(!g) return;
    if(g.unit === 'health_sleep') healthGoals.sleep = i;
    if(g.unit === 'health_workout') {
      healthGoals.workout = i;
      if(g.workoutType) healthGoals.workoutType = g.workoutType;
    }
  });
  await set(ref(db, `users/${currentUser.id}/healthGoals`), healthGoals);
}

// ===== ADMIN =====
let adminUsers = {};
let adminSelectedId = null;

async function renderAdminList() {
  const tableEl = document.getElementById('adminUserTable');
  const detailEl = document.getElementById('adminUserDetail');
  if(!tableEl) { console.error('adminUserTable element not found'); return; }
  tableEl.innerHTML = '<div style="color:var(--text-dim);font-size:13px;padding:8px 0;">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
  if(detailEl) detailEl.innerHTML = '';
  adminSelectedId = null;
  try {
    const snap = await get(ref(db,'users'));
    if (!snap.exists()) {
      tableEl.innerHTML='<div style="color:var(--text-dim);font-size:13px;">Îì±Î°ùÎêú Ïú†Ï†Ä ÏóÜÏùå</div>';
      renderAdminGroups(); return;
    }
    adminUsers = snap.val();
    const users = Object.entries(adminUsers).filter(([,u])=> u && u.role!=='admin');
    if(users.length===0){
      tableEl.innerHTML='<div style="color:var(--text-dim);font-size:13px;">Îì±Î°ùÎêú Ïú†Ï†Ä ÏóÜÏùå</div>';
      renderAdminGroups(); return;
    }
    const dashSnap = await get(ref(db,'dashboards'));
    const allDash = dashSnap.exists() ? dashSnap.val() : {};
    const rows = users.map(([id,u])=>{
      try {
        const dash = allDash[id]||{};
        const goals = Array.isArray(dash.goals) ? dash.goals.filter(g=>g&&g.title) : [];
        const tutDone = dash.tutorialDone
          ? '<span style="color:var(--accent);font-size:11px;">ÏôÑÎ£å</span>'
          : '<span style="color:var(--text-dim);font-size:11px;">ÎØ∏ÏôÑÎ£å</span>';
        const name = (u && u.name) ? u.name : id;
        return `<tr class="user-row" onclick="adminSelectUser('${id}')" data-id="${id}">
          <td><div class="user-tbl-name">${esc(name)}</div></td>
          <td><div class="user-tbl-id">@${esc(id)}</div></td>
          <td><div class="user-tbl-goals">${goals.length}</div></td>
          <td>${tutDone}</td>
        </tr>`;
      } catch(rowErr) {
        console.error('row error for', id, rowErr);
        return `<tr><td colspan="4" style="color:var(--danger);font-size:11px;">@${id} Î°úÎìú Ïò§Î•ò</td></tr>`;
      }
    }).join('');

    tableEl.innerHTML = `<table class="user-table">
      <thead><tr>
        <th>Ïù¥Î¶Ñ</th><th>ÏïÑÏù¥Îîî</th><th>Î™©Ìëú</th><th>ÌäúÌÜ†Î¶¨Ïñº</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
    tableEl._allDash = allDash;
    renderAdminGroups();
    renderAdminNoticeList();
  } catch(e) {
    tableEl.innerHTML = `<div style="color:var(--danger);font-size:13px;padding:8px 0;">‚ùå Ïò§Î•ò: ${esc(String(e.message||e))}</div>`;
    console.error('renderAdminList error:', e);
  }
}

window.adminSelectUser = async function(id) {
  adminSelectedId = id;
  // ÏÑ†ÌÉù Ìñâ ÌïòÏù¥ÎùºÏù¥Ìä∏
  document.querySelectorAll('.user-row').forEach(r=>{
    r.classList.toggle('selected', r.dataset.id===id);
  });
  const tableEl = document.getElementById('adminUserTable');
  const allDash = tableEl._allDash || {};
  const u = adminUsers[id];
  const dash = allDash[id] || {};
  const goals = dash.goals || [];
  const completions = dash.completions || {};
  const now = new Date();
  const curY=now.getFullYear(), curM=now.getMonth()+1;

  // ÎßàÏßÄÎßâ Ï†ëÏÜç/ÏóÖÎç∞Ïù¥Ìä∏
  const lastLogin = u.lastLogin ? new Date(u.lastLogin).toLocaleString('ko-KR') : 'Í∏∞Î°ù ÏóÜÏùå';
  const lastUpdate = dash.lastUpdate ? new Date(dash.lastUpdate).toLocaleString('ko-KR') : 'Í∏∞Î°ù ÏóÜÏùå';

  // Î™©ÌëúÎ≥Ñ ÏßÑÏ≤ôÎ•† Í≥ÑÏÇ∞
  function calcGoalPct(g, gi) {
    if(!g||!g.unit) return null;
    g = migrateGoal(g);
    if(g.unit==='once') {
      const done = completions[`g${gi}_once`]===true ? 1 : 0;
      return {done,mod:1,pct:done*100,streakMonths:0};
    }
    const mod = goalModulus(g, gi, curY, curM);
    const pfx=`g${gi}_${curY}_${curM}_`;
    const done = Object.entries(completions).filter(([k,v])=>k.startsWith(pfx)&&v===true).length;
    const pct = mod>0?Math.min(100,Math.round(done/mod*100)):0;
    let streak=0;
    for(let i=0;i<3;i++){
      let y=curY,m=curM-i; if(m<=0){m+=12;y--;}
      const mod2=goalModulus(g,gi,y,m);
      const pfx2=`g${gi}_${y}_${m}_`;
      const done2=Object.entries(completions).filter(([k,v])=>k.startsWith(pfx2)&&v===true).length;
      const pct2=mod2>0?Math.min(100,Math.round(done2/mod2*100)):0;
      if(pct2>=50) streak++; else break;
    }
    return {done,mod,pct,streakMonths:streak};
  }

  const goalCards = goals.map((g,gi)=>{
    if(!g||!g.title) return '';
    const stat = calcGoalPct(g,gi);
    if(!stat) return '';
    const unitLabel = getUnitLabel(g);
    const streakTag = stat.streakMonths>=2 ? `<span class="admin-goal-tag highlight">üî• ${stat.streakMonths}Í∞úÏõî Ïó∞ÏÜç</span>` : '';
    const pctColor = stat.pct>=70?'var(--accent)':stat.pct>=40?'var(--accent2)':'var(--danger)';
    return `<div class="admin-goal-card">
      <div class="admin-goal-top">
        <div class="admin-goal-title">${esc(g.title)}</div>
        <div class="admin-goal-pct" style="color:${pctColor}">${stat.pct}%</div>
      </div>
      <div class="admin-goal-bar"><div class="admin-goal-bar-fill" style="width:${stat.pct}%;background:${pctColor};"></div></div>
      <div class="admin-goal-meta">
        <span class="admin-goal-tag">${unitLabel}</span>
        <span class="admin-goal-tag">${stat.done}/${stat.mod}Ïùº ÏôÑÎ£å</span>
        ${streakTag}
      </div>
    </div>`;
  }).filter(Boolean).join('');

  const totalGoals = goals.filter(g=>g&&g.title).length;
  const totalDone = goals.reduce((s,g,gi)=>{ if(!g||!g.unit||g.unit==='once') return s; const pfx=`g${gi}_${curY}_${curM}_`; return s+Object.entries(completions).filter(([k,v])=>k.startsWith(pfx)&&v===true).length; },0);

  document.getElementById('adminUserDetail').innerHTML = `
    <div class="admin-detail">
      <div class="admin-detail-header">
        <div>
          <div class="admin-detail-name">${esc(u.name)}</div>
          <div class="admin-detail-id">@${esc(id)}</div>
        </div>
        <button onclick="document.getElementById('adminUserDetail').innerHTML='';document.querySelectorAll('.user-row').forEach(r=>r.classList.remove('selected'));"
          style="background:transparent;border:1px solid var(--border);color:var(--text-dim);border-radius:6px;width:28px;height:28px;cursor:pointer;font-size:14px;">‚úï</button>
      </div>
      <div class="admin-meta-grid">
        <div class="admin-meta-card">
          <div class="admin-meta-label">ÎßàÏßÄÎßâ Ï†ëÏÜç</div>
          <div class="admin-meta-val">${lastLogin}</div>
        </div>
        <div class="admin-meta-card">
          <div class="admin-meta-label">ÎßàÏßÄÎßâ ÏóÖÎç∞Ïù¥Ìä∏</div>
          <div class="admin-meta-val">${lastUpdate}</div>
        </div>
        <div class="admin-meta-card">
          <div class="admin-meta-label">Îì±Î°ù Î™©Ìëú</div>
          <div class="admin-meta-val" style="font-family:'Black Han Sans',sans-serif;font-size:20px;color:var(--accent);">${totalGoals}Í∞ú</div>
        </div>
        <div class="admin-meta-card">
          <div class="admin-meta-label">Ïù¥Îã¨ ÏôÑÎ£å Ï≤¥ÌÅ¨</div>
          <div class="admin-meta-val" style="font-family:'Black Han Sans',sans-serif;font-size:20px;color:var(--accent2);">${totalDone}Ìöå</div>
        </div>
      </div>
      <div style="font-size:11px;letter-spacing:1.5px;color:var(--text-dim);text-transform:uppercase;margin-bottom:10px;">Î™©ÌëúÎ≥Ñ ÌòÑÌô© (Ïù¥Î≤à Îã¨)</div>
      <div class="admin-goal-list">
        ${goalCards || '<div class="admin-empty">Îì±Î°ùÎêú Î™©Ìëú ÏóÜÏùå</div>'}
      </div>
    </div>`;
  document.getElementById('adminUserDetail').scrollIntoView({behavior:'smooth',block:'nearest'});
};
window.createUser = async function() {
  const name=document.getElementById('newUserName').value.trim();
  const id=document.getElementById('newUserId').value.trim();
  const pw=document.getElementById('newUserPw').value.trim();
  if(!name||!id||!pw){showToast('‚ùå Î™®Îì† Ìï≠Î™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî');return;}
  if(!/^[a-zA-Z0-9_]+$/.test(id)){showToast('‚ùå ÏïÑÏù¥ÎîîÎäî ÏòÅÎ¨∏/Ïà´Ïûê/_Îßå Í∞ÄÎä•');return;}
  try {
    const snap=await get(ref(db,`users/${id}`));
    if(snap.exists()){showToast('‚ùå Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî ÏïÑÏù¥Îîî');return;}
    await set(ref(db,`users/${id}`),{name,password:pw,role:'user'});
    document.getElementById('newUserName').value='';
    document.getElementById('newUserId').value='';
    document.getElementById('newUserPw').value='';
    showToast(`‚úÖ ${name} Í≥ÑÏ†ï ÏÉùÏÑ± ÏôÑÎ£å!`);
    renderAdminList();
  } catch(e) { showToast('‚ùå Í≥ÑÏ†ï ÏÉùÏÑ± Ïã§Ìå®: '+e.message); }
};

// ===== TUTORIAL =====
function initTutorial() {
  // Ï†ê & Î∞î Î†åÎçî
  const dots = document.getElementById('tutDots');
  dots.innerHTML = Array(TUT_STEPS).fill(0).map((_,i)=>`<div class="tut-dot ${i===0?'active':''}" id="tutDot${i+1}"></div>`).join('');
  updateTutProgress(1);
  // Îã®ÏúÑ ÏÑ†ÌÉùÏßÄ Î†åÎçî - Ï£ºÎãπ 4ÌöåÎßå ÌÅ¥Î¶≠ Í∞ÄÎä•, ÎÇòÎ®∏ÏßÄ Îî§Îìú
  const uopts = document.getElementById('tutUnitOpts');
  uopts.innerHTML = `
    <div class="unit-opt" onclick="tutPickUnit('weekly',4)" style="animation:pulse-border 1.2s ease-in-out infinite;border-color:var(--accent);cursor:pointer;">Ï£º 4Ìöå</div>
    <div class="unit-opt" style="opacity:.25;pointer-events:none;cursor:not-allowed;">Îß§Ïùº</div>
    <div class="unit-opt" style="opacity:.25;pointer-events:none;cursor:not-allowed;">Ï£º 2Ìöå</div>
    <div class="unit-opt" style="opacity:.25;pointer-events:none;cursor:not-allowed;">2Ï£º 3Ìöå</div>
  `;
  buildTutCal();
}

function updateTutProgress(step) {
  tutState.currentStep = step;
  document.getElementById('tutFill').style.width = ((step-1)/(TUT_STEPS-1)*100)+'%';
  for(let i=1;i<=TUT_STEPS;i++) {
    const d = document.getElementById(`tutDot${i}`);
    if(!d) continue;
    d.className = 'tut-dot' + (i<step?' done':i===step?' active':'');
  }
  document.querySelectorAll('.tut-step').forEach(s=>s.classList.remove('active'));
  const el = document.getElementById(`tutStep${step}`);
  if(el) el.classList.add('active');
}

window.tutNextStep = function(n) { updateTutProgress(n); };

window.tutPickUnit = function(u, freq) {
  tutState.unit = u;
  tutState.freq = freq || 1;
  // ÏÑ†ÌÉù ÌëúÏãú ÌõÑ Ï¶âÏãú Îã§Ïùå Ïä§ÌÖù
  const el = document.querySelector(`#tutUnitOpts .unit-opt[onclick*="${u}"]`);
  if(el) { el.classList.add('selected'); el.style.animation='none'; }
  tutStep2Confirm();
};

window.tutStep1Confirm = function() {
  tutState.goalName = '12Ïãú Ï†ÑÏóê ÏûêÍ∏∞';
  document.getElementById('tutGoalName2').textContent = tutState.goalName;
  showToast('‚úÖ Î™©Ìëú ÏÑ§Ï†ï ÏôÑÎ£å!');
  setTimeout(()=> updateTutProgress(2), 400);
};

window.tutStep2Confirm = function() {
  buildTutCal();
  document.getElementById('tutGoalName3').textContent = tutState.goalName;
  showToast('‚úÖ Îã®ÏúÑ ÏÑ§Ï†ï ÏôÑÎ£å!');
  setTimeout(()=> updateTutProgress(3), 400);
};

// ÌäúÌÜ†Î¶¨Ïñº Îã¨Î†• (Ïù¥Î≤à Ï£º 7Ïùº, 4Ïùº ÌÅ¥Î¶≠ Ïú†ÎèÑ)
function buildTutCal() {
  const now = new Date();
  const dayOfWeek = now.getDay(); // 0=Ïùº
  // Ïù¥Î≤à Ï£º Ïõî~Ïùº (ÏõîÏöîÏùº Í∏∞Ï§Ä)
  const monday = new Date(now);
  monday.setDate(now.getDate() - ((dayOfWeek+6)%7));
  const days = Array(7).fill(0).map((_,i)=>{
    const d = new Date(monday);
    d.setDate(monday.getDate()+i);
    return d;
  });

  const DAY_KR=['Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†','Ïùº'];
  const dayRow = document.getElementById('tutCalDayRow');
  if(dayRow) dayRow.innerHTML = DAY_KR.map(d=>`<div class="tut-cal-day">${d}</div>`).join('');

  const grid = document.getElementById('tutCalGrid');
  if(!grid) return;

  // ÎåÄÏÉÅ ÎÇ†Ïßú: Ïù¥Î≤à Ï£º Ïõî~Î™© (Ïïû 4Ïùº) ÌïòÏù¥ÎùºÏù¥Ìä∏
  const targetDates = new Set(days.slice(0,4).map(d=>d.getDate()));

  grid.innerHTML = days.map(d=>{
    const isFut = d > now;
    const isChecked = tutState.checkedDays.has(d.getDate());
    const isTarget = targetDates.has(d.getDate()) && !isFut && !isChecked;
    const cls = ['tut-cal-cell', isChecked?'done':'', isFut?'future':'', isTarget?'target':''].filter(Boolean).join(' ');
    return `<div class="${cls}" onclick="${isFut?'':(`tutToggleDay(${d.getDate()})`)}">${d.getDate()}</div>`;
  }).join('');
}

window.tutToggleDay = function(day) {
  if(tutState.checkedDays.has(day)) tutState.checkedDays.delete(day);
  else tutState.checkedDays.add(day);
  buildTutCal();
  const cnt = tutState.checkedDays.size;
  const status = document.getElementById('tutStep3Status');
  if(status) {
    status.textContent = `${cnt} / 4 Ï≤¥ÌÅ¨`;
    status.style.color = cnt>=4?'var(--accent)':'var(--text-dim)';
  }
  if(cnt >= 4) {
    showToast('‚úÖ Ï≤¥ÌÅ¨ ÏôÑÎ£å!');
    setTimeout(()=> tutStep3Confirm(), 600);
  }
};

window.tutStep3Confirm = function() {
  if(tutState.checkedDays.size < 4) return;
  const now = new Date();
  const y=now.getFullYear(), m=now.getMonth()+1;
  const dim = new Date(y,m,0).getDate();
  const weeks = Math.ceil(dim/7);
  const freq = tutState.freq || 4;
  const mod = freq * weeks;
  const done = tutState.checkedDays.size;
  const pct = Math.min(100,Math.round(done/mod*100));

  document.getElementById('tutGoalName4').textContent = tutState.goalName;
  document.getElementById('tutGoalPct4').textContent = pct+'%';
  document.getElementById('tutGoalBar4').style.width = pct+'%';
  document.getElementById('tutGoalStat4').textContent = `${done}Ïùº ÏôÑÎ£å / Ïù¥Î≤à Îã¨ Î™©Ìëú ${mod}Ïùº`;
  document.getElementById('tutGbFill').style.width = pct+'%';
  document.getElementById('tutGbPct').textContent = pct+'%';
  const stage = Math.min(9,Math.floor(pct/10));
  document.getElementById('tutAvatarArt').innerHTML = AVATARS[stage];
  document.getElementById('tutAvatarStage').textContent = `${stage+1}Îã®Í≥Ñ ¬∑ ${STAGE_NAMES[stage]}`;
  updateTutProgress(4);
};

window.tutFinish = async function() {
  // ÌäúÌÜ†Î¶¨Ïñº Îç∞Ïù¥ÌÑ∞Î•º Ïã§Ï†ú DBÏóê Ï†ÄÏû•
  const now = new Date();
  const y=now.getFullYear(), m=now.getMonth()+1;
  if(!localDash.goals) localDash.goals=[];
  if(!localDash.completions) localDash.completions={};

  // Ïä¨Î°Ø 0Ïóê Î™©Ìëú Îì±Î°ù
  localDash.goals[0] = { title: tutState.goalName, unit: tutState.unit, freq: tutState.freq||4 };

  // Ï≤¥ÌÅ¨Ìïú ÎÇ†Ïßú Î∞òÏòÅ
  tutState.checkedDays.forEach(d=>{
    localDash.completions[`g0_${y}_${m}_${d}`] = true;
  });

  localDash.tutorialDone = true;
  await saveDash();

  showConfetti();
  setTimeout(async ()=>{
    activeGoalIdx = null; viewMonth = null;
    showScreen('dashboardScreen');
    const grpSnap = await get(ref(db,'groups'));
    let hasGroup = false;
    if(grpSnap.exists()){
      hasGroup = Object.values(grpSnap.val()).some(g=> g.members && Object.values(g.members).includes(currentUser.id));
    }
    const tabBar = document.getElementById('dashTabBar');
    if(tabBar) tabBar.style.display = hasGroup ? 'flex' : 'none';
    renderDashboard();
  }, 2800);
};

// ===== ÏΩòÌéòÌã∞ =====
function showConfetti() {
  const container = document.getElementById('confettiContainer');
  const colors = ['#1952f5','#6b8fff','#ff5e7d','#a78bfa','#34d399','#fbbf24'];
  container.innerHTML = '';
  for(let i=0;i<140;i++) {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    el.style.cssText = `
      left:${Math.random()*100}%;
      background:${colors[Math.floor(Math.random()*colors.length)]};
      width:${6+Math.random()*10}px;
      height:${6+Math.random()*10}px;
      border-radius:${Math.random()>0.5?'50%':'2px'};
      animation-duration:${1.8+Math.random()*2}s;
      animation-delay:${Math.random()*0.6}s;
    `;
    container.appendChild(el);
  }
  setTimeout(()=>{ container.innerHTML=''; }, 4000);
}
function showConfettiSmall() {
  const container = document.getElementById('confettiContainer');
  const colors = ['#1952f5','#6b8fff','#ff5e7d','#a78bfa','#34d399','#fbbf24'];
  for(let i=0;i<30;i++) {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    el.style.cssText = `
      left:${30+Math.random()*40}%;
      background:${colors[Math.floor(Math.random()*colors.length)]};
      width:${5+Math.random()*7}px;
      height:${5+Math.random()*7}px;
      border-radius:${Math.random()>0.5?'50%':'2px'};
      animation-duration:${1.2+Math.random()*1}s;
      animation-delay:${Math.random()*0.3}s;
    `;
    container.appendChild(el);
  }
  setTimeout(()=>{ container.innerHTML=''; }, 2500);
}

// ===== ÏßÑÏ≤ô Í≥ÑÏÇ∞ =====
function getMonthDays(y,m){ return new Date(y,m,0).getDate(); }
function getMonthWeeks(y,m){ return Math.ceil(getMonthDays(y,m)/7); }
function goalModulus(g,gi,y,m){
  if(!g||!g.unit||g.unit==='once') return 1;
  g = migrateGoal(g);
  if(g.unit==='daily'||g.unit==='health_sleep') return getMonthDays(y,m);
  if(g.unit==='health_workout') return 2 * getMonthWeeks(y,m);
  if(g.unit==='weekly') return (g.freq||1) * getMonthWeeks(y,m);
  if(g.unit==='biweekly') {
    // Ìïú Îã¨ÏùÑ 2Ï£º Îã®ÏúÑÎ°ú ÎÇòÎàî (4Ï£º Í∏∞Ï§Ä ‚Üí 2Î≤àÏùò 2Ï£º Í∏∞Í∞Ñ)
    const biweeks = Math.ceil(getMonthDays(y,m) / 14);
    return (g.freq||1) * biweeks;
  }
  return 1;
}
function goalDone(g,gi,y,m){
  if(!g||!g.unit) return 0;
  if(g.unit==='once') return localDash.completions[`g${gi}_once`]===true?1:0;
  const pfx=`g${gi}_${y}_${m}_`;
  return Object.entries(localDash.completions).filter(([k,v])=>k.startsWith(pfx)&&v===true).length;
}
function goalPct(g,gi,y,m){
  const mod=goalModulus(g,gi,y,m);
  const done=goalDone(g,gi,y,m);
  return {done,mod,pct:mod>0?Math.round(done/mod*100):0};
}
function globalPct(){
  const now=new Date(); const y=now.getFullYear(),m=now.getMonth()+1;
  let td=0,tm=0;
  getAllGoals().forEach((g,i)=>{
    if(!g||!g.unit) return;
    const {done,mod}=goalPct(g,i,y,m);
    td+=done; tm+=mod;
  });
  return tm>0?Math.round(td/tm*100):0;
}
function getAllGoals(){
  const g=[];
  for(let i=0;i<MAX_GOALS;i++) g.push(localDash.goals[i]||null);
  return g;
}

// ===== DASHBOARD =====
function renderDashboard(){
  const now=new Date();
  if(!viewMonth) viewMonth={year:now.getFullYear(),month:now.getMonth()+1};
  renderGlobal(); renderAvatar(); renderGoalGrid();
  if(activeGoalIdx!==null) renderDetail(activeGoalIdx);
  loadNoticeBanner();
}
function renderGlobal(){
  const p=globalPct();
  const fill=document.getElementById('gbFill');
  fill.style.width=Math.min(p,100)+'%';
  if(p>100){
    fill.style.background='linear-gradient(90deg,#1952f5 0%,#6b8fff 40%,#a78bfa 70%,#c084fc 100%)';
    fill.style.boxShadow='0 0 16px 4px rgba(167,139,250,.65), 0 0 6px 1px rgba(192,132,252,.4)';
  } else {
    fill.style.background='';
    fill.style.boxShadow='';
  }
  document.getElementById('gbPct').textContent=p+'%';
}
function renderAvatar(){
  const p=globalPct();
  const stage=Math.min(9,Math.floor(p/10));
  // ÏïÑÎ∞îÌÉÄ Ïù¥ÎØ∏ÏßÄ: Ìï≠ÏÉÅ ÌñÑÏä§ÌÑ∞ (Îã®Í≥ÑÎ≥Ñ Î≥ÄÍ≤Ω ÏóÜÏùå)
  const artEl=document.getElementById('avatarArt');
  if(!artEl._hamsterInit){
    artEl._hamsterInit=true;
    initHamsterAvatar(artEl);
  }
  document.getElementById('avatarStage').textContent=`${stage+1}Îã®Í≥Ñ ¬∑ ${STAGE_NAMES[stage]}`;
  const nick=localDash.nickname||currentUser.name||'ÎÇòÏùò Ï∫êÎ¶≠ÌÑ∞';
  const msg=localDash.msg||'Ï¢ãÏùÄ ÏäµÍ¥Ä ÎßåÎìúÎäî Ï§ë';

  // ÎãâÎÑ§ÏûÑ Ìñâ - Ìï≠ÏÉÅ Î≥¥Í∏∞ Î™®ÎìúÎ°ú Î≥µÏõê
  const nicknameRow=document.getElementById('avatarNicknameRow');
  nicknameRow.innerHTML=`<div class="avatar-nickname" id="avatarNickname">${esc(nick)}</div>
    <button class="pencil-btn" onclick="startEditNickname()">‚úèÔ∏è</button>`;

  // Î¨∏Íµ¨ Ìñâ - Ìï≠ÏÉÅ Î≥¥Í∏∞ Î™®ÎìúÎ°ú Î≥µÏõê
  const msgWrap=document.getElementById('avatarMsgWrap');
  if(msgWrap){
    msgWrap.innerHTML=`<div class="avatar-msg" id="avatarMsg">${esc(msg)}</div>
      <button class="pencil-btn" onclick="startEditMsg()" style="flex-shrink:0;">‚úèÔ∏è</button>`;
  }
}

window.startEditMsg=function(){
  cancelEditNickname();
  const cur=localDash.msg||'Ï¢ãÏùÄ ÏäµÍ¥Ä ÎßåÎìúÎäî Ï§ë';
  const wrap=document.getElementById('avatarMsgWrap');
  wrap.innerHTML=`<input id="msgInput" type="text" value="${escAttr(cur)}" maxlength="20" placeholder="Ìïú Ï§Ñ Î¨∏Íµ¨" class="nickname-input" style="font-size:14px;font-family:'Noto Sans KR',sans-serif;font-weight:400;letter-spacing:0;">
    <button onclick="saveMsg()" class="nickname-save-btn">Ï†ÄÏû•</button>`;
  document.getElementById('msgInput').focus();
  document.getElementById('msgInput').addEventListener('keydown',e=>{ if(e.key==='Enter') window.saveMsg(); });
};

window.saveMsg=async function(){
  const val=(document.getElementById('msgInput')||{}).value?.trim();
  if(!val){showToast('‚ùå Î¨∏Íµ¨Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî');return;}
  localDash.msg=val;
  await saveDash();
  showToast('‚úÖ Ï†ÄÏû• ÏôÑÎ£å!','done');
  renderAvatar();
};
function renderGoalGrid(){
  const goals=getAllGoals();
  const now=new Date(); const y=now.getFullYear(),m=now.getMonth()+1;
  let html='';
  for(let i=0;i<MAX_GOALS;i++){
    const g=goals[i];
    const isActive=activeGoalIdx===i;
    if(!g){
      html+=`<button class="goal-btn disabled" data-gi="${i}" onclick="selectGoal(${i})"><div class="goal-btn-title" style="color:var(--text-dim);text-align:center;width:100%;">Ôºã</div></button>`;
    } else if(!g.unit){
      html+=`<button class="goal-btn ${isActive?'active':''}" data-gi="${i}" onclick="selectGoal(${i})">
        <div class="unread-dot"></div>
        <div class="goal-btn-title">${esc(g.title||'Î™©Ìëú'+(i+1))}</div>
        <div class="goal-btn-need">Îã®ÏúÑ ÏÑ§Ï†ï ÌïÑÏöî</div>
      </button>`;
    } else {
      const {pct}=goalPct(g,i,y,m);
      html+=`<button class="goal-btn ${isActive?'active':''}" data-gi="${i}" onclick="selectGoal(${i})">
        <div class="unread-dot"></div>
        <div class="goal-btn-title">${esc(g.title||'Î™©Ìëú'+(i+1))}</div>
        <div class="goal-btn-pct">${pct}%</div>
        <div class="goal-btn-bar"><div class="goal-btn-fill" style="width:${pct}%"></div></div>
      </button>`;
    }
  }
  document.getElementById('goalGrid').innerHTML=html;
  // Î†åÎçî ÌõÑ unread Ï≤¥ÌÅ¨
  checkUnreadCheers();
}
window.selectGoal=function(idx){
  cancelEditNickname();
  cancelEditMsg();
  // Ïù¥ÎØ∏ ÌôúÏÑ±ÌôîÎêú Î™©Ìëú Îã§Ïãú ÎàÑÎ•¥Î©¥ Îã´Í∏∞
  if(activeGoalIdx===idx){
    activeGoalIdx=null;
    renderGoalGrid();
    document.getElementById('detailSection').innerHTML='';
    updateFloatFab();
    return;
  }
  activeGoalIdx=idx;
  renderGoalGrid();
  renderDetail(idx);
  updateFloatFab();
  markCheerRead(idx);
  setTimeout(()=>document.getElementById('detailSection').scrollIntoView({behavior:'smooth',block:'start'}),50);
};

// ===== DETAIL =====
function renderDetail(idx){
  const goals=getAllGoals();
  const g=goals[idx];
  const panel=document.getElementById('detailSection');
  if(!g){
    panel.innerHTML=`<div class="add-goal-card">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <div class="unit-card-title">ÏÉà Î™©Ìëú Ï∂îÍ∞Ä</div>
        <button onclick="closeDetailPanel()" style="background:transparent;border:1px solid var(--border);color:var(--text-dim);border-radius:6px;width:30px;height:30px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;">‚úï</button>
      </div>
      <input class="add-goal-input" id="newGoalTitle" type="text" placeholder="Î™©Ìëú Ïù¥Î¶Ñ ÏûÖÎ†•">
      <div class="unit-opts" id="unitOpts${idx}"></div>
      <button class="unit-confirm-btn" onclick="saveNewGoal(${idx})">Î™©Ìëú Îì±Î°ù</button>
    </div>`;
    renderUnitOpts(`unitOpts${idx}`,null,idx);
    return;
  }
  if(!g.unit){
    panel.innerHTML=`<div class="unit-card">
      <div class="unit-card-title">${esc(g.title)}</div>
      <div class="unit-card-sub">Îã¨ÏÑ± Îã®ÏúÑÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</div>
      <div class="unit-opts" id="unitOpts${idx}"></div>
      <button class="unit-confirm-btn" onclick="confirmUnit(${idx})">ÏÑ§Ï†ï ÏôÑÎ£å</button>
    </div>`;
    renderUnitOpts(`unitOpts${idx}`,null,idx);
    return;
  }
  if(g.unit==='once') renderOnce(panel,g,idx);
  else if(HEALTH_UNITS.includes(g.unit)) renderHealthGoal(panel,g,idx);
  else renderCalendar(panel,g,idx);
}

// selectedUnit ÎåÄÏã† selectedPeriod, selectedFreq ÏÇ¨Ïö©
const selectedPeriod = {};
const selectedFreq = {};
const selectedWorkoutType = {}; // idx -> workout type key

function getSelectedGoalSpec(idx){
  const p = selectedPeriod[idx];
  if(!p) return null;
  if(p==='once'||p==='daily'||p==='health_sleep') return {unit:p};
  if(p==='health_workout'){
    const wt = selectedWorkoutType[idx];
    if(!wt) return null; // Ïö¥Îèô ÌÉÄÏûÖ ÌïÑÏàò
    return {unit:p, workoutType:wt};
  }
  return {unit:p, freq: selectedFreq[idx]||1};
}

function renderUnitOpts(cid, cur, idx, curFreq){
  const c = document.getElementById(cid);
  if(!c) return;
  if(!selectedPeriod[idx]){
    if(cur) { selectedPeriod[idx]=cur; selectedFreq[idx]=curFreq||1; }
  }
  const p = selectedPeriod[idx];
  const periods = [
    {key:'daily', label:'Îß§Ïùº'},
    {key:'weekly', label:'Ï£ºÎãπ'},
    {key:'biweekly', label:'2Ï£ºÎãπ'},
    {key:'once', label:'Ìïú Î≤à'},
  ];
  const periodHtml = `
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:4px;">
      ${periods.map(({key,label})=>
        `<div class="unit-opt ${p===key?'selected':''}" onclick="pickPeriod('${key}',${idx},'${cid}')"
          style="padding:14px 4px;font-size:14px;text-align:center;">${label}</div>`
      ).join('')}
    </div>`;

  let freqHtml = '';
  if(p==='weekly'){
    freqHtml = `
      <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px;">
        ${[1,2,3,4,5,6,7].map(n=>
          `<div class="unit-opt ${selectedFreq[idx]===n?'selected':''}" onclick="pickFreq(${n},${idx},'${cid}')"
            style="padding:12px 4px;font-size:13px;text-align:center;">${n}Ìöå</div>`
        ).join('')}
      </div>`;
  } else if(p==='biweekly'){
    freqHtml = `
      <div style="display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px;">
        ${Array.from({length:14},(_,i)=>i+1).map(n=>
          `<div class="unit-opt ${selectedFreq[idx]===n?'selected':''}" onclick="pickFreq(${n},${idx},'${cid}')"
            style="padding:12px 4px;font-size:13px;text-align:center;">${n}Ìöå</div>`
        ).join('')}
      </div>`;
  }

  const healthHtml = `
    <div style="margin:14px 0 6px;font-size:11px;font-weight:700;color:#7c3aed;letter-spacing:1px;">‚åö Ïï†ÌîåÏõåÏπò ÏûêÎèô Ïó∞Îèô</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
      <div class="unit-opt ${p==='health_sleep'?'selected':''}" onclick="pickPeriod('health_sleep',${idx},'${cid}')"
        style="padding:14px 4px;font-size:14px;text-align:center;border-color:#c4b5fd;color:#7c3aed;background:${p==='health_sleep'?'#ede9fe':'#faf5ff'};">üåô ÏàòÎ©¥ ÏûêÎèô</div>
      <div class="unit-opt ${p==='health_workout'?'selected':''}" onclick="pickPeriod('health_workout',${idx},'${cid}')"
        style="padding:14px 4px;font-size:14px;text-align:center;border-color:#c4b5fd;color:#7c3aed;background:${p==='health_workout'?'#ede9fe':'#faf5ff'};">üí™ Ïö¥Îèô ÏûêÎèô</div>
    </div>
    ${p==='health_workout' ? renderWorkoutTypePicker(idx, cid) : ''}
  `;

  c.innerHTML = periodHtml + freqHtml + healthHtml;
}

function renderWorkoutTypePicker(idx, cid){
  const selected = selectedWorkoutType[idx];
  const selectedLabel = selected ? (APPLE_WORKOUT_TYPES.find(t=>t.key===selected)?.label||selected) : '';
  return `
    <div style="margin-top:10px;">
      <div style="font-size:12px;color:#7c3aed;font-weight:700;margin-bottom:6px;">Ïö¥Îèô Ï¢ÖÎ™© ÏÑ†ÌÉù <span style="color:#ef4444;">*</span></div>
      <div style="position:relative;">
        <input id="workoutSearch${idx}"
          type="text"
          placeholder="Ï¢ÖÎ™© Í≤ÄÏÉâ (Ïòà: Ìó¨Ïä§, ÏöîÍ∞Ä, Îã¨Î¶¨Í∏∞)"
          value="${selected ? selectedLabel : ''}"
          oninput="filterWorkoutTypes(this.value,${idx},'${cid}')"
          onfocus="showWorkoutDropdown(${idx},'${cid}')"
          style="width:100%;background:#fff;border:2px solid ${selected?'#7c3aed':'var(--border)'};border-radius:10px;padding:10px 13px;font-size:13px;font-family:'Noto Sans KR',sans-serif;color:var(--text);outline:none;box-sizing:border-box;">
        ${selected ? `<div style="position:absolute;right:10px;top:50%;transform:translateY(-50%);font-size:16px;">‚úì</div>` : ''}
      </div>
      <div id="workoutDropdown${idx}" style="display:none;max-height:200px;overflow-y:auto;border:1.5px solid #c4b5fd;border-radius:10px;margin-top:4px;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.1);">
        ${APPLE_WORKOUT_TYPES.map(t=>
          `<div onclick="selectWorkoutType('${t.key}','${t.label}',${idx},'${cid}')"
            style="padding:10px 14px;font-size:13px;cursor:pointer;${selected===t.key?'background:#ede9fe;color:#7c3aed;font-weight:700;':''}
            border-bottom:1px solid #f3f4f6;"
            onmouseover="this.style.background='#faf5ff'"
            onmouseout="this.style.background='${selected===t.key?'#ede9fe':'#fff'}'">
            ${t.label}
          </div>`
        ).join('')}
      </div>
    </div>`;
}

window.pickPeriod = function(key, idx, cid){
  selectedPeriod[idx] = key;
  if(key==='weekly' && !selectedFreq[idx]) selectedFreq[idx]=1;
  if(key==='biweekly' && !selectedFreq[idx]) selectedFreq[idx]=1;
  renderUnitOpts(cid, null, idx);
};
window.pickFreq = function(n, idx, cid){
  selectedFreq[idx] = n;
  renderUnitOpts(cid, null, idx);
};
window.showWorkoutDropdown = function(idx, cid){
  const dd = document.getElementById(`workoutDropdown${idx}`);
  if(dd) dd.style.display='block';
};
window.filterWorkoutTypes = function(query, idx, cid){
  const dd = document.getElementById(`workoutDropdown${idx}`);
  if(!dd) return;
  dd.style.display='block';
  const q = query.trim().toLowerCase();
  const filtered = q
    ? APPLE_WORKOUT_TYPES.filter(t=>t.label.toLowerCase().includes(q)||t.key.toLowerCase().includes(q))
    : APPLE_WORKOUT_TYPES;
  const selected = selectedWorkoutType[idx];
  dd.innerHTML = filtered.length
    ? filtered.map(t=>
        `<div onclick="selectWorkoutType('${t.key}','${t.label}',${idx},'${cid}')"
          style="padding:10px 14px;font-size:13px;cursor:pointer;${selected===t.key?'background:#ede9fe;color:#7c3aed;font-weight:700;':''}border-bottom:1px solid #f3f4f6;"
          onmouseover="this.style.background='#faf5ff'"
          onmouseout="this.style.background='${selected===t.key?'#ede9fe':'#fff'}'">
          ${t.label}
        </div>`
      ).join('')
    : `<div style="padding:12px 14px;font-size:13px;color:var(--text-dim);">Í≤ÄÏÉâ Í≤∞Í≥º ÏóÜÏùå</div>`;
};
window.selectWorkoutType = function(key, label, idx, cid){
  selectedWorkoutType[idx] = key;
  const input = document.getElementById(`workoutSearch${idx}`);
  if(input) input.value = label;
  const dd = document.getElementById(`workoutDropdown${idx}`);
  if(dd) dd.style.display='none';
  renderUnitOpts(cid, null, idx);
  // ÎìúÎ°≠Îã§Ïö¥ Îã´Í∏∞ ÌõÑ input Î≥µÏõê
  setTimeout(()=>{
    const inp = document.getElementById(`workoutSearch${idx}`);
    if(inp) inp.value = label;
  }, 50);
};

window.confirmUnit=async function(idx){
  const spec=getSelectedGoalSpec(idx);
  if(!spec){showToast('Îã®ÏúÑÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');return;}
  if((spec.unit==='weekly'||spec.unit==='biweekly')&&!spec.freq){showToast('ÌöüÏàòÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');return;}
  if(!localDash.goals[idx]) localDash.goals[idx]={};
  Object.assign(localDash.goals[idx], spec);
  await saveDash();
  if(HEALTH_UNITS.includes(spec.unit)) await syncHealthGoalIndex();
  showToast('‚úÖ Îã®ÏúÑ ÏÑ§Ï†ï ÏôÑÎ£å!');
  renderGoalGrid(); renderDetail(idx); renderGlobal(); renderAvatar();
};

window.saveNewGoal=async function(idx){
  const title=(document.getElementById('newGoalTitle')||{}).value?.trim();
  const spec=getSelectedGoalSpec(idx);
  if(!title){showToast('Î™©Ìëú Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî');return;}
  if(!spec){showToast(selectedPeriod[idx]==='health_workout'?'Ïö¥Îèô Ï¢ÖÎ™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî':'Îã®ÏúÑÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');return;}
  if((spec.unit==='weekly'||spec.unit==='biweekly')&&!spec.freq){showToast('ÌöüÏàòÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî');return;}
  if(!localDash.goals[idx]) localDash.goals[idx]={};
  localDash.goals[idx].title=title;
  Object.assign(localDash.goals[idx], spec);
  await saveDash();
  if(HEALTH_UNITS.includes(spec.unit)) await syncHealthGoalIndex();
  showToast('üéØ Î™©Ìëú Îì±Î°ù!');
  renderGoalGrid(); renderDetail(idx); renderGlobal(); renderAvatar();
};

window.enterEditUnit=function(idx){
  const goals=getAllGoals(); const g=migrateGoal(goals[idx]);
  const panel=document.getElementById('detailSection');
  panel.innerHTML=`<div class="unit-card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div class="unit-card-title">Î™©Ìëú ÏàòÏ†ï</div>
      <button onclick="renderDetail(${idx})" style="background:transparent;border:1px solid var(--border);color:var(--text-dim);border-radius:6px;width:30px;height:30px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;">‚úï</button>
    </div>
    <div style="font-size:11px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:6px;">Î™©Ìëú Ï†úÎ™©</div>
    <input id="editGoalTitle${idx}" type="text" value="${escAttr(g.title||'')}" placeholder="Î™©Ìëú Ïù¥Î¶Ñ" style="width:100%;background:#fff;border:2px solid var(--border);border-radius:10px;padding:11px 13px;color:var(--text);font-size:14px;font-family:'Noto Sans KR',sans-serif;outline:none;margin-bottom:20px;" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'">
    <div style="font-size:11px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:8px;">Îã¨ÏÑ± Îã®ÏúÑ</div>
    <div class="unit-opts" id="unitOpts${idx}"></div>
    <button class="unit-confirm-btn" onclick="confirmEditGoal(${idx})">ÏàòÏ†ï ÏôÑÎ£å</button>
  </div>`;
  selectedPeriod[idx]=g.unit;
  selectedFreq[idx]=g.freq||1;
  if(g.workoutType) selectedWorkoutType[idx]=g.workoutType;
  renderUnitOpts(`unitOpts${idx}`, g.unit, idx, g.freq);
};

window.confirmEditGoal=async function(idx){
  const titleEl=document.getElementById(`editGoalTitle${idx}`);
  const title=titleEl?titleEl.value.trim():'';
  const spec=getSelectedGoalSpec(idx);
  if(!title){showToast('‚ùå Î™©Ìëú Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî');return;}
  if(!spec){showToast('‚ùå Îã®ÏúÑÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');return;}
  if((spec.unit==='weekly'||spec.unit==='biweekly')&&!spec.freq){showToast('‚ùå ÌöüÏàòÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî');return;}
  if(!localDash.goals[idx]) localDash.goals[idx]={};
  localDash.goals[idx].title=title;
  // Í∏∞Ï°¥ freq Ï†úÍ±∞ ÌõÑ ÏÉà spec Ï†ÅÏö©
  delete localDash.goals[idx].freq;
  Object.assign(localDash.goals[idx], spec);
  await saveDash();
  if(HEALTH_UNITS.includes(spec.unit)) await syncHealthGoalIndex();
  showToast('‚úÖ ÏàòÏ†ï ÏôÑÎ£å!');
  renderGoalGrid(); renderDetail(idx);
};

window.closeDetailPanel=function(){
  activeGoalIdx=null;
  renderGoalGrid();
  document.getElementById('detailSection').innerHTML='<div class="detail-empty">Î™©ÌëúÎ•º ÏÑ†ÌÉùÌïòÎ©¥<br>ÏÉÅÏÑ∏ ÎÇ¥Ïö©Ïù¥ ÌéºÏ≥êÏßëÎãàÎã§</div>';
};

function renderHealthGoal(panel,g,idx){
  const isSleep = g.unit==='health_sleep';
  const icon = isSleep ? 'üåô' : 'üí™';
  const typeLabel = isSleep ? 'ÏàòÎ©¥ ÏûêÎèô Ïó∞Îèô' : 'Ïö¥Îèô ÏûêÎèô Ïó∞Îèô';
  const condLabel = isSleep ? 'ÌïòÎ£® 7ÏãúÍ∞Ñ Ïù¥ÏÉÅ ÏàòÎ©¥' : 'Ïö¥Îèô Í∏∞Î°ù Í∞êÏßÄ';
  const bannerHtml = `
    <div style="background:linear-gradient(135deg,#faf5ff,#ede9fe);border:1.5px solid #c4b5fd;border-radius:14px;padding:14px 16px;margin-bottom:16px;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
        <span style="font-size:18px;">${icon}</span>
        <span style="font-size:13px;font-weight:700;color:#7c3aed;">${typeLabel}</span>
        <span style="margin-left:auto;font-size:11px;background:#7c3aed;color:#fff;padding:2px 8px;border-radius:100px;">‚åö ÏûêÎèô</span>
      </div>
      <div style="font-size:12px;color:#6d28d9;line-height:1.6;">
        Ï°∞Í±¥: <strong>${condLabel}</strong><br>
        iPhone Îã®Ï∂ïÏñ¥ Ïï±Ïù¥ Îß§Ïùº ÏûêÎèôÏúºÎ°ú Ï≤¥ÌÅ¨Ìï¥Ï§òÏöî.<br>
        <span style="color:#9ca3af;font-size:11px;">ÏïÑÏßÅ Îã®Ï∂ïÏñ¥ ÏÑ§Ï†ï Ï†ÑÏù¥Î©¥ ÏàòÎèôÏúºÎ°úÎèÑ Ï≤¥ÌÅ¨ Í∞ÄÎä•Ìï¥Ïöî</span>
      </div>
    </div>
    <div id="healthCalWrap${idx}"></div>`;
  panel.innerHTML = bannerHtml;
  const wrap = document.getElementById(`healthCalWrap${idx}`);
  renderCalendar(panel, g, idx, wrap);
}

// renderCalendarÏóê wrap ÌååÎùºÎØ∏ÌÑ∞ Ï∂îÍ∞Ä Î≤ÑÏ†Ñ Ï≤òÎ¶¨Î•º ÏúÑÌï¥ Í∏∞Ï°¥ Ìï®Ïàò ÏãúÏûëÏóê Î∂ÑÍ∏∞ Ï∂îÍ∞Ä
function renderOnce(panel,g,idx){
  const done=localDash.completions[`g${idx}_once`]===true;
  panel.innerHTML=`<div class="once-card">
    <div class="cal-header">
      <div class="cal-goal-name">${esc(g.title)}</div>
      <div class="cal-meta">
        <div class="cal-unit-badge">${getUnitLabel(g)}</div>
        <button class="edit-unit-btn" onclick="enterEditUnit(${idx})">ÏàòÏ†ï</button>
      </div>
    </div>
    <div class="once-sub">ÏôÑÎ£åÌïòÎ©¥ Ïù¥ Î™©Ìëú 100% Îã¨ÏÑ±!</div>
    <button class="once-btn ${done?'done':''}" onclick="toggleOnce(${idx})">${done?'‚úÖ':'‚óã'}</button>
    ${done?'<div class="once-done">üéâ ÏôÑÎ£å!</div>':''}
  </div>`;
}
window.toggleOnce=async function(idx){
  const k=`g${idx}_once`;
  localDash.completions[k]=!(localDash.completions[k]===true);
  await saveDash();
  showToast(localDash.completions[k]?'üéâ ÏôÑÎ£å!':'‚Ü©Ô∏è Ìï¥Ï†ú');
  renderDetail(idx); renderGoalGrid(); renderGlobal(); renderAvatar();
};

function renderCalendar(panel,g,idx,wrap){
  const target = wrap || panel;
  g = migrateGoal(g);
  const now=new Date();
  const {year,month}=viewMonth;
  const {done,mod,pct}=goalPct(g,idx,year,month);
  const freq = (g.unit==='weekly'||g.unit==='biweekly') ? (g.freq||1) : (g.unit==='daily'?1: g.unit==='health_sleep'?1: g.unit==='health_workout'?1: 1);
  const firstDay=new Date(year,month-1,1).getDay();
  const dim=getMonthDays(year,month);
  const DAY=['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];

  // ÏàòÏ†ï Í∞ÄÎä• Î≤îÏúÑ: Ïù¥Î≤à Îã¨ + Ï†ÑÏõîÍπåÏßÄÎßå ÌóàÏö©
  const curY=now.getFullYear(), curM=now.getMonth()+1;
  const isEditableMonth = (year===curY && month===curM) ||
    (year===(curM===1?curY-1:curY) && month===(curM===1?12:curM-1));
  const isCur=year===curY&&month===curM;

  let weeks=[]; let week=[];
  for(let i=0;i<firstDay;i++) week.push(0);
  for(let d=1;d<=dim;d++){
    week.push(d);
    if(week.length===7){weeks.push(week);week=[];}
  }
  if(week.length>0){while(week.length<7)week.push(0);weeks.push(week);}
  let calHtml=`<div class="cal-day-row">${DAY.map(d=>`<div class="cal-day-lbl">${d}</div>`).join('')}</div><div class="cal-grid">`;
  weeks.forEach(w=>{
    const valid=w.filter(d=>d>0);
    const wdone=valid.filter(d=>localDash.completions[`g${idx}_${year}_${month}_${d}`]===true).length;
    const wok=wdone>=freq;
    w.forEach(d=>{
      if(d===0){calHtml+=`<div class="cal-cell empty"></div>`;return;}
      const dt=new Date(year,month-1,d);
      const isToday=dt.toDateString()===now.toDateString();
      const isFut=dt>now;
      const isDone=localDash.completions[`g${idx}_${year}_${month}_${d}`]===true;
      const isLocked=!isEditableMonth; // Ï†ÑÏ†ÑÏõî Ïù¥Ï†ÑÏùÄ Ïû†Í∏à
      const cls=['cal-cell',isDone?'done':'',isFut?'future':'',isToday?'cal-today':'',(!isDone&&wok&&!isFut)?'week-ok':'',isLocked?'locked':''].filter(Boolean).join(' ');
      const clickHandler = (isFut||isLocked) ? '' : `toggleDay(${idx},${d})`;
      calHtml+=`<div class="${cls}" onclick="${clickHandler}" ${isLocked?'title="Ï†ÑÏ†ÑÏõî Ïù¥Ï†Ñ Îç∞Ïù¥ÌÑ∞Îäî ÏàòÏ†ïÌï† Ïàò ÏóÜÏñ¥Ïöî"':''}>
        <div class="cal-dn">${d}</div><div class="cal-chk">‚úì</div>
      </div>`;
    });
  });
  calHtml+='</div>';

  // Ïù¥Î≤àÏ£º ÌòÑÌô© Í≥ÑÏÇ∞ (Ïù¥Î≤à Îã¨ Î≥¥Í≥† ÏûàÏùÑ ÎïåÎßå)
  let weekInfoHtml = '';
  if(isCur && g.unit !== 'once' && !HEALTH_UNITS.includes(g.unit)) {
    const today = now;
    const dow = today.getDay();
    const weekStartDate = new Date(today); weekStartDate.setDate(today.getDate()-dow);
    const weekEndDate = new Date(weekStartDate); weekEndDate.setDate(weekStartDate.getDate()+6);
    let wdone=0, wTotal=0;
    for(let dd=weekStartDate.getDate(); dd<=Math.min(weekEndDate.getDate(), getMonthDays(year,month)); dd++){
      const dt2=new Date(year,month-1,dd);
      if(dt2>today) break;
      wTotal++;
      if(localDash.completions[`g${idx}_${year}_${month}_${dd}`]===true) wdone++;
    }
    const wRemain = Math.max(0, freq-wdone);
    const isWeekClear = wdone>=freq;
    const CHEER_MSGS = [
      ['Ïù¥Î≤à Ï£º Í±∞Ïùò Îã§ ÏôîÏñ¥Ïöî!','ÎßàÏßÄÎßâ Ìïú Î≤àÎßå Îçî!'],
      ['ÏûòÌïòÍ≥† ÏûàÏñ¥Ïöî üí™','Ïù¥ Í∏∞ÏÑ∏ Ïú†ÏßÄÌï¥Ïöî!'],
      ['Ï¢ãÏùÄ ÏäµÍ¥ÄÏù¥ ÏåìÏù¥Í≥† ÏûàÏñ¥Ïöî üå±','Íæ∏Ï§ÄÌï®Ïù¥ ÏµúÍ≥†ÏòàÏöî!'],
      ['Ïò§ÎäòÎèÑ ÌååÏù¥ÌåÖ! ‚ú®','ÌïòÎ£®ÌïòÎ£®Í∞Ä ÏåìÏó¨Ïöî!'],
    ];
    const cheer = isWeekClear
      ? ['ÏôÑÎ≤ΩÌïú Ìïú Ï£º!üèÜ','Ïù¥Î≤à Ï£º Î™©ÌëúÎ•º Î™®Îëê Îã¨ÏÑ±ÌñàÏñ¥Ïöî!']
      : wRemain===1
        ? ['Í±∞Ïùò Îã§ ÏôîÏñ¥Ïöî! üî•','Ìïú Î≤àÎßå Îçî ÌïòÎ©¥ Ïù¥Î≤à Ï£º ÌÅ¥Î¶¨Ïñ¥!']
        : CHEER_MSGS[Math.min(wRemain-1, CHEER_MSGS.length-1)];
    weekInfoHtml = `
      <div class="week-info-card ${isWeekClear?'week-info-clear':''}">
        <div class="week-info-icon">${isWeekClear?'üèÜ':wRemain===1?'üî•':'üí™'}</div>
        <div class="week-info-body">
          <div class="week-info-main">${isWeekClear?'Ïù¥Î≤à Ï£º Î™©Ìëú Îã¨ÏÑ±!':`Ïù¥Î≤à Ï£º ${wRemain}Î≤à ÎÇ®ÏïòÏñ¥Ïöî`}</div>
          <div class="week-info-cheer">¬∑ ${cheer[0]}</div>
        </div>
      </div>`;
  }
  const lockBanner = !isEditableMonth
    ? `<div style="display:flex;align-items:center;gap:8px;background:rgba(241,53,53,.08);border:1px solid rgba(241,53,53,.2);border-radius:8px;padding:10px 12px;margin-bottom:10px;font-size:12px;color:var(--text-dim);">
        <span>üîí</span><span>Ï†ÑÏ†ÑÏõî Ïù¥Ï†Ñ Îç∞Ïù¥ÌÑ∞Îäî Ï°∞ÌöåÎßå Í∞ÄÎä•Ìï¥Ïöî</span>
       </div>`
    : '';
  target.innerHTML=`
    <div class="cal-header">
      <div class="cal-goal-name">${esc(g.title)}</div>
      <div class="cal-meta">
        <div class="cal-unit-badge">${getUnitLabel(g)}</div>
        <button class="edit-unit-btn" onclick="enterEditUnit(${idx})">ÏàòÏ†ï</button>
      </div>
    </div>
    <div class="month-nav">
      <button class="month-nav-btn" onclick="changeMonth(-1)">‚Äπ</button>
      <div class="month-label">${year}ÎÖÑ ${month}Ïõî</div>
      <button class="month-nav-btn" onclick="changeMonth(1)" ${isCur?'disabled':''}>‚Ä∫</button>
    </div>
    ${lockBanner}
    ${calHtml}
    ${renderStats(g,idx)}`;
  // ÎåìÍ∏Ä ÏòÅÏó≠ ÎπÑÎèôÍ∏∞ Î°úÎìú Î∞è ÏÇΩÏûÖ
  renderMyCheers(target, idx);
}
// ===== STATS =====
function renderStats(g, idx) {
  const now = new Date();
  const curY = now.getFullYear(), curM = now.getMonth()+1;

  // ÏµúÍ∑º 6Í∞úÏõî Îç∞Ïù¥ÌÑ∞ ÏàòÏßë
  const months = [];
  for(let i=5; i>=0; i--) {
    let y=curY, m=curM-i;
    if(m<=0){m+=12;y--;}
    const {done,mod,pct} = goalPct(g,idx,y,m);
    months.push({y,m,done,mod,pct,isCur:i===0});
  }

  const validMonths = months.filter(mo=>mo.mod>0);
  if(validMonths.length===0) return '';

  // ÌèâÍ∑† Í≥ÑÏÇ∞: Ïã§Ï†ú Ï≤¥ÌÅ¨ Îç∞Ïù¥ÌÑ∞Í∞Ä 1Í∞úÎùºÎèÑ ÏûàÎäî ÏõîÎßå Ìè¨Ìï®
  const avgMonths = validMonths.filter(mo=>mo.done>0);
  const avg = avgMonths.length>0
    ? Math.round(avgMonths.reduce((s,mo)=>s+mo.pct,0)/avgMonths.length)
    : 0;
  const maxMo = [...validMonths].sort((a,b)=>b.pct-a.pct)[0];
  const minMo = [...validMonths].sort((a,b)=>a.pct-b.pct)[0];
  const curMoData = months[5]; // Ïù¥Î≤à Îã¨
  const prevMoData = months[4]; // Ï†ÑÎã¨

  // Ïó∞ÏÜç Îã¨ÏÑ±(>= 50%) Í≥ÑÏÇ∞ - Ïù¥Î≤à Îã¨ Ìè¨Ìï® ÏµúÍ∑ºÎ∂ÄÌÑ∞ Ïó≠Ïàú
  let streak = 0;
  for(let i=validMonths.length-1; i>=0; i--) {
    if(validMonths[i].pct >= 50) streak++;
    else break;
  }

  const BAR_MAX_H = 160; // Í∑∏ÎûòÌîÑ ÏµúÎåÄ ÎÜíÏù¥ px
  const maxPct = Math.max(...validMonths.map(mo=>mo.pct), 1);

  const barsHtml = months.map(mo=>{
    const barH = mo.mod>0 ? Math.max(3, Math.round((mo.pct/maxPct)*BAR_MAX_H)) : 3;
    const lbl = `${mo.m}Ïõî`;
    const isCur = mo.isCur;
    return `<div class="stats-bar-wrap">
      <div class="stats-bar-col">
        <div class="stats-bar ${isCur?'current-month':'past'}" style="height:${barH}px;">
          <div class="stats-bar-pct">${mo.mod>0?mo.pct+'%':'-'}</div>
        </div>
      </div>
      <div class="stats-bar-lbl ${isCur?'current':''}">${lbl}</div>
    </div>`;
  }).join('');

  // ÌèâÍ∑†ÏÑ† ÏúÑÏπò
  const avgLinePx = avgMonths.length>0 ? Math.round((avg/maxPct)*BAR_MAX_H) : 0;
  const avgLineHtml = avgMonths.length>0 ? `<div class="stats-avg-line" style="bottom:${avgLinePx+20}px;"></div>` : '';

  // Ïù∏ÏÇ¨Ïù¥Ìä∏ Î©òÌä∏ ÏÉùÏÑ±
  const insights = buildInsights({months:validMonths, avg, maxMo, minMo, curMoData, prevMoData, streak, curY, curM});

  return `<div class="stats-section">
    <div class="stats-title">üìä 6Í∞úÏõî ÌÜµÍ≥Ñ</div>
    <div class="stats-chart" style="position:relative;">
      ${avgLineHtml}
      ${barsHtml}
    </div>
    <div class="stats-insight">
      ${insights.facts.map(f=>`<div class="stats-insight-row"><div class="stats-insight-icon">${f.icon}</div><div class="stats-insight-text">${f.text}</div></div>`).join('')}
    </div>
    <div class="stats-cheer">${insights.cheer}</div>
  </div>`;
}

function buildInsights({months, avg, maxMo, minMo, curMoData, prevMoData, streak, curY, curM}) {
  const facts = [];

  // 1. 6Í∞úÏõî ÌèâÍ∑†
  facts.push({icon:'üìà', text:`ÏµúÍ∑º 6Í∞úÏõî ÌèâÍ∑† ÏàòÌñâÎ•†ÏùÄ <strong>${avg}%</strong>ÏòàÏöî.`});

  // 2. Ï†ÑÏõî ÎåÄÎπÑ Î≥ÄÌôî
  if(prevMoData && prevMoData.mod>0 && curMoData.mod>0) {
    const diff = curMoData.pct - prevMoData.pct;
    if(diff > 0) {
      facts.push({icon:'üîº', text:`Ïù¥Î≤à Îã¨ÏùÄ ÏßÄÎÇúÎã¨Î≥¥Îã§ <strong>${diff}%p Ïò¨ÎûêÏñ¥Ïöî!</strong> ÏÑ±Ïû•ÌïòÍ≥† ÏûàÏñ¥Ïöî.`});
    } else if(diff < 0) {
      facts.push({icon:'üîΩ', text:`Ïù¥Î≤à Îã¨ÏùÄ ÏßÄÎÇúÎã¨Î≥¥Îã§ ${Math.abs(diff)}%p ÎÇ¥Î†§Í∞îÏñ¥Ïöî. Îã§Ïãú Ïò¨Î†§Î¥êÏöî!`});
    } else {
      facts.push({icon:'‚û°Ô∏è', text:`ÏßÄÎÇúÎã¨Í≥º Í∞ôÏùÄ ÏàòÌñâÎ•†Ïù¥ÏóêÏöî. Íæ∏Ï§ÄÌûà Ïú†ÏßÄÌïòÍ≥† ÏûàÎÑ§Ïöî!`});
    }
  }

  // 3. Ïó∞ÏÜç Îã¨ÏÑ± Í∏∞Î°ù
  if(streak >= 2) {
    facts.push({icon:'üî•', text:`<strong>${streak}Í∞úÏõî Ïó∞ÏÜç</strong>ÏúºÎ°ú 50% Ïù¥ÏÉÅ Îã¨ÏÑ± Ï§ëÏù¥ÏóêÏöî!`});
  }

  // 4. ÏµúÍ≥†/ÏµúÏ†Ä Îã¨
  if(months.length >= 3) {
    const maxLabel = `${maxMo.y===curY?'':maxMo.y+'ÎÖÑ '}${maxMo.m}Ïõî`;
    const minLabel = `${minMo.y===curY?'':minMo.y+'ÎÖÑ '}${minMo.m}Ïõî`;
    if(maxMo.m===curM && maxMo.y===curY) {
      facts.push({icon:'üèÜ', text:`Ïù¥Î≤à Îã¨Ïù¥ 6Í∞úÏõî Ï§ë <strong>Í∞ÄÏû• ÎÜíÏùÄ Îã¨</strong>Ïù¥ÏóêÏöî!`});
    } else {
      facts.push({icon:'üèÜ', text:`6Í∞úÏõî Ï§ë Í∞ÄÏû• ÏûòÌïú Îã¨ÏùÄ <strong>${maxLabel} (${maxMo.pct}%)</strong>Ïù¥ÏóàÏñ¥Ïöî.`});
    }
  }

  // ÏùëÏõê Î©òÌä∏ (ÏπúÍ∑ºÌïòÍ≥† Îî∞ÎúªÌïòÍ≤å)
  let cheer = '';
  if(avg >= 80) {
    cheer = `ÎåÄÎã®Ìï¥Ïöî! <strong>Íæ∏Ï§ÄÌûà Ïûò Ìï¥ÎÇ¥Í≥† ÏûàÏñ¥Ïöî üòä</strong><br>Ïù¥ ÌéòÏù¥Ïä§ÎùºÎ©¥ Î™©Ìëú Îã¨ÏÑ±ÏùÄ ÏãúÍ∞ÑÎ¨∏Ï†úÏòàÏöî. Í≥ÑÏÜç ÏùëÏõêÌï†Í≤åÏöî!`;
  } else if(avg >= 60) {
    cheer = `Ïûò ÌïòÍ≥† ÏûàÏñ¥Ïöî! <strong>ÌèâÍ∑† ${avg}%Î©¥ Ï†ïÎßê ÌõåÎ•≠Ìï¥Ïöî.</strong><br>ÏûëÏùÄ ÏäµÍ¥ÄÏù¥ ÏåìÏó¨ÏÑú ÌÅ∞ Î≥ÄÌôîÎ•º ÎßåÎì§Ïñ¥Í∞ÄÍ≥† ÏûàÏñ¥Ïöî üí™`;
  } else if(avg >= 40) {
    cheer = `Ï°∞Í∏àÏî© ÎÇòÏïÑÍ∞ÄÍ≥† ÏûàÏñ¥Ïöî! <strong>Íæ∏Ï§ÄÌûà ÌïòÎäî Í≤É ÏûêÏ≤¥Í∞Ä ÎåÄÎã®Ìï¥Ïöî.</strong><br>Ìè¨Í∏∞ÌïòÏßÄ ÏïäÎäî Í≤å Í∞ÄÏû• Ï§ëÏöîÌï¥Ïöî, Í∞ôÏù¥ Ìï¥Î¥êÏöî üòä`;
  } else if(avg >= 20) {
    cheer = `ÏãúÏûëÏù¥ Î∞òÏù¥ÏóêÏöî! <strong>Î™©ÌëúÎ•º ÏÑ∏Ïö∞Í≥† ÎèÑÏ†ÑÌïòÎäî Í≤É ÏûêÏ≤¥Í∞Ä Î©ãÏßÑ ÏùºÏù¥ÏóêÏöî.</strong><br>Ï°∞Í∏àÏî© Îçî ÎäòÎ†§Í∞Ä Î¥êÏöî, ÏùëÏõêÌïòÍ≥† ÏûàÏùÑÍ≤åÏöî üå±`;
  } else {
    cheer = `Ï≤úÏ≤úÌûà Í∞ÄÎèÑ Í¥úÏ∞ÆÏïÑÏöî! <strong>Ïò§Îäò ÌïòÎ£® ÌïòÎÇòÏî© ÏãúÏûëÌï¥Î¥êÏöî.</strong><br>ÏûëÏùÄ Ï≤¥ÌÅ¨ ÌïòÎÇòÍ∞Ä ÌÅ∞ Î≥ÄÌôîÏùò ÏãúÏûëÏù¥ÏóêÏöî üòå`;
  }

  // Ïù¥Î≤à Îã¨Ïù¥ ÏµúÍ≥†Î©¥ Ï∂îÍ∞Ä ÏùëÏõê
  if(curMoData.mod>0 && curMoData.pct===maxMo.pct && months.length>=2) {
    cheer = `üéâ Ïù¥Î≤à Îã¨ ÏµúÍ≥† Í∏∞Î°ùÏù¥ÏóêÏöî! <strong>ÏßÄÍ∏à Ïù¥ ÌùêÎ¶Ñ Í∑∏ÎåÄÎ°ú Ïú†ÏßÄÌï¥Î¥êÏöî.</strong><br>Ï†ïÎßê Ïûò ÌïòÍ≥† ÏûàÏñ¥Ïöî, ÏßÑÏã¨ÏúºÎ°ú ÏùëÏõêÌï¥Ïöî!`;
  }

  return {facts, cheer};
}

window.changeMonth=function(dir){
  let {year,month}=viewMonth;
  month+=dir;
  if(month<1){month=12;year--;}
  if(month>12){month=1;year++;}
  const now=new Date();
  if(year>now.getFullYear()||(year===now.getFullYear()&&month>now.getMonth()+1)) return;
  viewMonth={year,month};
  renderDetail(activeGoalIdx);
};
window.toggleDay=async function(idx,day){
  const {year,month}=viewMonth;
  const now=new Date();
  const curY=now.getFullYear(), curM=now.getMonth()+1;
  const isEditableMonth=(year===curY&&month===curM)||
    (year===(curM===1?curY-1:curY)&&month===(curM===1?12:curM-1));
  if(!isEditableMonth){ showToast('üîí Ï†ÑÏ†ÑÏõî Ïù¥Ï†ÑÏùÄ ÏàòÏ†ïÌï† Ïàò ÏóÜÏñ¥Ïöî','normal'); return; }

  const k=`g${idx}_${year}_${month}_${day}`;
  const wasDone = localDash.completions[k]===true;
  localDash.completions[k] = !wasDone;
  await saveDash();

  const g = migrateGoal(localDash.goals[idx]);
  const freq = (g?.unit==='weekly'||g?.unit==='biweekly') ? (g.freq||1) : 1;

  // ÏôÑÎ£å/Ìï¥Ï†ú ÌÜ†Ïä§Ìä∏
  if(!wasDone){
    showToast('üéâ ÏôÑÎ£å!','done');
    // ÏΩòÌéòÌã∞ ÏÜåÎüâ
    showConfettiSmall();

    // Ïù¥Î≤à Ï£º ÌÅ¥Î¶¨Ïñ¥ Ï≤¥ÌÅ¨
    const dt=new Date(year,month-1,day);
    const dow=dt.getDay();
    const weekStart=new Date(dt); weekStart.setDate(dt.getDate()-dow);
    const weekEnd=new Date(weekStart); weekEnd.setDate(weekStart.getDate()+6);
    let wdone=0;
    for(let d=weekStart.getDate(); d<=Math.min(weekEnd.getDate(), getMonthDays(year,month)); d++){
      if(new Date(year,month-1,d)>now) break;
      if(localDash.completions[`g${idx}_${year}_${month}_${d}`]===true) wdone++;
    }
    if(wdone===freq){
      // Ïù¥Î≤à Ï£º Îßâ ÌÅ¥Î¶¨Ïñ¥!
      setTimeout(()=>{
        showConfetti();
        shakeScreen();
        showWeekClear();
      }, 300);
    }
  } else {
    showToast('‚Ü©Ô∏è Ìï¥Ï†ú','undo');
  }

  renderDetail(idx); renderGoalGrid(); renderGlobal(); renderAvatar();
};

// ===== ÎãâÎÑ§ÏûÑ Ìé∏Ïßë =====
// Ìé∏Ïßë Î™®Îìú Í∞ïÏ†ú Ìï¥Ï†ú Ìó¨Ìçº
function cancelEditNickname(){
  const row=document.getElementById('avatarNicknameRow');
  if(row && row.querySelector('#nicknameInput')){
    const nick=localDash.nickname||currentUser.name||'ÎÇòÏùò Ï∫êÎ¶≠ÌÑ∞';
    row.innerHTML=`<div class="avatar-nickname" id="avatarNickname">${esc(nick)}</div>
      <button class="pencil-btn" onclick="startEditNickname()">‚úèÔ∏è</button>`;
  }
}
function cancelEditMsg(){
  if(!document.getElementById('msgInput')) return;
  const msg=localDash.msg||'Ï¢ãÏùÄ ÏäµÍ¥Ä ÎßåÎìúÎäî Ï§ë';
  const wrap=document.getElementById('avatarMsgWrap');
  if(wrap) wrap.innerHTML=`<div class="avatar-msg" id="avatarMsg">${esc(msg)}</div>
    <button class="pencil-btn" onclick="startEditMsg()" style="flex-shrink:0;">‚úèÔ∏è</button>`;
}
window.cancelEditNickname=cancelEditNickname;
window.cancelEditMsg=cancelEditMsg;

window.startEditNickname=function(){
  // Î¨∏Íµ¨ Ìé∏Ïßë Ï§ëÏù¥Î©¥ Î®ºÏ†Ä ÏõêÎûòÎåÄÎ°ú Î≥µÏõê
  cancelEditMsg();
  const row=document.getElementById('avatarNicknameRow');
  const cur=localDash.nickname||currentUser.name||'ÎÇòÏùò Ï∫êÎ¶≠ÌÑ∞';
  row.innerHTML=`<div class="nickname-edit-row">
    <input class="nickname-input" id="nicknameInput" type="text" value="${escAttr(cur)}" maxlength="12" placeholder="Ïï†Ïπ≠ ÏûÖÎ†•">
    <button class="nickname-save-btn" onclick="saveNickname()">Ï†ÄÏû•</button>
  </div>`;
  document.getElementById('nicknameInput').focus();
  document.getElementById('nicknameInput').addEventListener('keydown',e=>{if(e.key==='Enter') window.saveNickname();});
};
window.saveNickname=async function(){
  const val=(document.getElementById('nicknameInput')||{}).value?.trim();
  if(!val){showToast('‚ùå Ïï†Ïπ≠ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî');return;}
  localDash.nickname=val;
  await saveDash();
  showToast('‚úÖ Ï†ÄÏû• ÏôÑÎ£å!','done');
  renderAvatar();
};

// ===== HAMSTER AVATAR (Three.js) =====
async function initHamsterAvatar(container) {
  const W = 280, H = 280;
  const _THREE = await import('https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js');

  const scene = new _THREE.Scene();
  const camera = new _THREE.PerspectiveCamera(30, W/H, 0.1, 1000);
  camera.position.set(0, 0, 8.5);

  const renderer = new _THREE.WebGLRenderer({ antialias: true, alpha: true });
  renderer.setSize(W, H);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  container.innerHTML = '';
  container.appendChild(renderer.domElement);

  const ambientLight = new _THREE.AmbientLight(0xffffff, 0.85);
  scene.add(ambientLight);
  const dirLight = new _THREE.DirectionalLight(0xfff5e6, 0.8);
  dirLight.position.set(2, 5, 4);
  scene.add(dirLight);

  const orangeMat = new _THREE.MeshToonMaterial({ color: 0xf9c288 });
  const creamMat  = new _THREE.MeshToonMaterial({ color: 0xfff9ef });
  const pinkMat   = new _THREE.MeshToonMaterial({ color: 0xffb8c6 });
  const darkMat   = new _THREE.MeshBasicMaterial({ color: 0x332a26 });

  function createOutline(geometry, thickness=0.03, color=0x332211) {
    const m = new _THREE.MeshBasicMaterial({ color, side: _THREE.BackSide });
    const mesh = new _THREE.Mesh(geometry, m);
    mesh.scale.multiplyScalar(1 + thickness);
    return mesh;
  }

  const hamster = new _THREE.Group();
  scene.add(hamster);

  // Î™∏ÌÜµ
  const bodyGeom = new _THREE.SphereGeometry(1.2, 64, 64);
  const body = new _THREE.Mesh(bodyGeom, orangeMat);
  body.scale.set(1.05, 0.95, 0.95);
  body.add(createOutline(bodyGeom, 0.025, 0x5a3e2b));
  hamster.add(body);

  // Î∞∞
  const bellyGeom = new _THREE.SphereGeometry(1.05, 64, 64);
  const belly = new _THREE.Mesh(bellyGeom, creamMat);
  belly.position.set(0, -0.2, 0.2);
  belly.scale.set(1.05, 0.95, 1.0);
  belly.add(createOutline(bellyGeom, 0.02, 0x5a3e2b));
  hamster.add(belly);

  // Î≥ºÏÇ¥
  const cheekGeom = new _THREE.SphereGeometry(0.5, 32, 32);
  [-0.55, 0.55].forEach(x => {
    const c = new _THREE.Mesh(cheekGeom, creamMat);
    c.position.set(x, -0.25, 0.7);
    c.scale.set(1.1, 0.9, 0.8);
    c.add(createOutline(cheekGeom, 0.03, 0x5a3e2b));
    hamster.add(c);
  });

  // Ï£ºÎë•Ïù¥
  const muzzleGeom = new _THREE.SphereGeometry(0.35, 32, 32);
  const muzzle = new _THREE.Mesh(muzzleGeom, creamMat);
  muzzle.scale.set(1.2, 0.8, 0.8);
  muzzle.position.set(0, -0.15, 0.95);
  muzzle.add(createOutline(muzzleGeom, 0.025, 0x5a3e2b));
  hamster.add(muzzle);

  // ÏΩî
  const nose = new _THREE.Mesh(new _THREE.SphereGeometry(0.06, 16, 16), pinkMat);
  nose.position.set(0, 0.02, 1.22);
  hamster.add(nose);

  // ÏûÖ
  const mouth = new _THREE.Mesh(new _THREE.SphereGeometry(0.035, 16, 16), darkMat);
  mouth.scale.set(1, 0.8, 0.5);
  mouth.position.set(0, -0.06, 1.25);
  hamster.add(mouth);

  // Îàà
  const eyeGroups = [];
  [-0.33, 0.33].forEach(x => {
    const g = new _THREE.Group();
    const eye = new _THREE.Mesh(new _THREE.SphereGeometry(0.12, 32, 32), darkMat);
    eye.scale.set(1, 1.25, 0.5);
    const hl = new _THREE.Mesh(new _THREE.SphereGeometry(0.035, 16, 16), new _THREE.MeshBasicMaterial({color:0xffffff}));
    hl.position.set(0.03, 0.05, 0.06);
    g.add(eye, hl);
    g.position.set(x, 0.35, 1.02);
    eyeGroups.push(g);
    hamster.add(g);
  });

  // Í∑Ä
  [-0.65, 0.65].forEach((x, i) => {
    const g = new _THREE.Group();
    const earGeom = new _THREE.SphereGeometry(0.25, 32, 16);
    const outer = new _THREE.Mesh(earGeom, orangeMat);
    outer.scale.set(1, 1, 0.3);
    outer.add(createOutline(earGeom, 0.05, 0x5a3e2b));
    const inner = new _THREE.Mesh(new _THREE.SphereGeometry(0.15, 32, 16), pinkMat);
    inner.scale.set(1, 1, 0.3);
    inner.position.z = 0.05;
    g.add(outer, inner);
    g.position.set(x, 0.85, 0.2);
    g.rotation.z = i===0 ? 0.3 : -0.3;
    hamster.add(g);
  });

  // ÏÜê+Ïî®Ïïó
  const handsGroup = new _THREE.Group();
  handsGroup.position.set(0, -0.35, 1.35);
  hamster.add(handsGroup);

  const handGeom = new _THREE.SphereGeometry(0.1, 16, 16);
  [-0.16, 0.16].forEach(x => {
    const h = new _THREE.Mesh(handGeom, pinkMat);
    h.position.set(x, 0, 0);
    h.add(createOutline(handGeom, 0.08, 0x5a3e2b));
    handsGroup.add(h);
  });

  const seedGeom = new _THREE.SphereGeometry(0.08, 16, 16);
  seedGeom.scale(1, 2.2, 0.6);
  const seed = new _THREE.Mesh(seedGeom, darkMat);
  seed.position.set(0, 0.05, 0.05);
  seed.rotation.x = -0.1;
  const stripeGeom = new _THREE.SphereGeometry(0.02, 16, 16);
  stripeGeom.scale(1, 2.3, 0.7);
  const stripe = new _THREE.Mesh(stripeGeom, creamMat);
  stripe.position.z = 0.03;
  seed.add(stripe);
  handsGroup.add(seed);

  // Î∞ú
  const footGeom = new _THREE.SphereGeometry(0.12, 16, 16);
  [-0.35, 0.35].forEach(x => {
    const f = new _THREE.Mesh(footGeom, pinkMat);
    f.scale.set(1, 0.6, 1.3);
    f.position.set(x, -1.05, 0.6);
    f.add(createOutline(footGeom, 0.08, 0x5a3e2b));
    hamster.add(f);
  });

  // ÎßàÏö∞Ïä§ Ï∂îÏ†Å
  let targetY = 0, targetX = 0;
  const onMove = e => {
    const rect = container.getBoundingClientRect();
    const mx = ((e.clientX - rect.left) / rect.width) * 2 - 1;
    const my = -((e.clientY - rect.top) / rect.height) * 2 + 1;
    targetY = mx * 0.25;
    targetX = -my * 0.15;
  };
  window.addEventListener('mousemove', onMove);

  let t = 0, blinking = false;
  function loop() {
    if (!document.body.contains(renderer.domElement)) {
      window.removeEventListener('mousemove', onMove);
      renderer.dispose();
      return;
    }
    requestAnimationFrame(loop);
    t += 0.016;

    if (Math.random() > 0.995 && !blinking) {
      blinking = true;
      eyeGroups.forEach(e => e.scale.y = 0.1);
      setTimeout(() => { eyeGroups.forEach(e => e.scale.y = 1); blinking = false; }, 120);
    }

    const breath = 1 + Math.sin(t * 3) * 0.015;
    hamster.scale.set(breath, breath, breath);

    const nibble = Math.sin(t * 40) * 0.015;
    handsGroup.position.y = -0.35 + nibble;
    seed.rotation.z = Math.sin(t * 30) * 0.05;

    hamster.rotation.y += (targetY - hamster.rotation.y) * 0.08;
    hamster.rotation.x += (targetX - hamster.rotation.x) * 0.08;

    renderer.render(scene, camera);
  }
  loop();
}

// ===== FLOATING COMPLETE BUTTON =====
function updateFloatFab(){
  const fab = document.getElementById('floatFab');
  const btn = document.getElementById('floatCompleteBtn');
  const hint = document.getElementById('floatWeekHint');
  if(!fab || activeGoalIdx === null) {
    if(fab) { fab.style.display='none'; }
    document.querySelector('.dash-scroll')?.classList.remove('has-float-scroll');
    return;
  }
  const g = getAllGoals()[activeGoalIdx];
  if(!g || g.unit==='once' || HEALTH_UNITS.includes(g.unit)) { fab.style.display='none'; document.querySelector('.dash-scroll')?.classList.remove('has-float-scroll'); return; }

  const now = new Date();
  const todayKey = `g${activeGoalIdx}_${now.getFullYear()}_${now.getMonth()+1}_${now.getDate()}`;
  const isDone = localDash.completions[todayKey] === true;

  // Ïù¥Î≤à Ï£º ÌòÑÌô© Í≥ÑÏÇ∞
  const dow = now.getDay();
  const weekStart = new Date(now); weekStart.setDate(now.getDate()-dow);
  const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate()+6);
  const y=now.getFullYear(), m=now.getMonth()+1;
  let weekDone=0;
  for(let d=weekStart.getDate(); d<=Math.min(weekEnd.getDate(), new Date(y,m,0).getDate()); d++){
    if(localDash.completions[`g${activeGoalIdx}_${y}_${m}_${d}`]===true) weekDone++;
  }
  const freq = (g.unit==='daily'?7:({w1:1,w2:2,w4:4,w6:6}[g.unit]||1));
  const remain = Math.max(0, freq - weekDone);

  hint.innerHTML = remain===0
    ? 'üèÜ Ïù¥Î≤à Ï£º Î™©Ìëú Îã¨ÏÑ±!'
    : `üí™ Ïù¥Î≤à Ï£º <strong>${remain}Î≤à</strong> ÎÇ®ÏïòÏñ¥Ïöî. ÌååÏù¥ÌåÖ!`;
  btn.textContent = isDone ? '‚Ü© Ïò§Îäò ÏôÑÎ£å Ï∑®ÏÜå' : '‚úì Ïò§Îäò Î™©Ìëú Îã¨ÏÑ±!';
  btn.className = 'float-complete-btn ' + (isDone ? 'state-done' : 'state-todo');
  fab.style.display = 'block';
  document.querySelector('.dash-scroll')?.classList.add('has-float-scroll');
}

window.floatToggleToday = async function(){
  if(activeGoalIdx === null) return;
  const g = getAllGoals()[activeGoalIdx];
  if(!g) return;
  const now = new Date();
  const key = `g${activeGoalIdx}_${now.getFullYear()}_${now.getMonth()+1}_${now.getDate()}`;
  const cur = localDash.completions[key]===true;
  localDash.completions[key] = !cur;
  await saveDash();
  if(!cur){ showToast('üéâ ÏôÑÎ£å!','done'); showConfettiSmall(); }
  else { showToast('‚Ü©Ô∏è Ìï¥Ï†ú','undo'); }
  renderDetail(activeGoalIdx); renderGoalGrid(); renderGlobal();
  updateFloatFab();
  checkWeekClear(activeGoalIdx);
};

// ===== UTILS =====
window.renderDetail=renderDetail;
function escAttr(s){ return (s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function esc(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
function showToast(msg, type='normal'){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className='toast toast-'+type;
  t.classList.add('show');
  clearTimeout(t._t); t._t=setTimeout(()=>t.classList.remove('show'),2000);
}
window.showToast=showToast;

function shakeScreen(){
  const wrap=document.querySelector('#dashboardScreen .mobile-wrap');
  if(!wrap) return;
  wrap.classList.remove('shake');
  void wrap.offsetWidth; // reflow
  wrap.classList.add('shake');
  wrap.addEventListener('animationend',()=>wrap.classList.remove('shake'),{once:true});
}

function showWeekClear(){
  const popup=document.getElementById('weekClearPopup');
  popup.classList.add('show');
  setTimeout(()=>popup.classList.remove('show'), 2800);
}
window.showWeekClear=showWeekClear;

// ===== TAB =====
let currentTab = 'my';
window.switchTab = function(tab) {
  currentTab = tab;
  document.getElementById('tabBtnMy').classList.toggle('active', tab==='my');
  document.getElementById('tabBtnFriends').classList.toggle('active', tab==='friends');
  document.getElementById('tabMy').classList.toggle('active', tab==='my');
  document.getElementById('tabFriends').classList.toggle('active', tab==='friends');
  if(tab==='friends') renderFriendsTab();
};

// ===== FRIENDS =====
let myGroups = [];        // [{id,name,members:[userId,...]}]
let friendsData = {};     // {userId: {user, dash}}
let activeFriendId = null;
let activeFriendGoalIdx = null;
let selectedCheerEmoji = 'üí™';

async function loadGroups() {
  const snap = await get(ref(db,'groups'));
  if(!snap.exists()){ myGroups=[]; return; }
  myGroups = Object.entries(snap.val())
    .filter(([,g])=> g.members && Object.values(g.members).includes(currentUser.id))
    .map(([id,g])=>({id, name:g.name, members: Object.values(g.members||{})}));
}

async function renderFriendsTab() {
  const sec = document.getElementById('friendsSection');
  sec.innerHTML = '<div style="color:var(--text-dim);font-size:13px;text-align:center;padding:40px 0;">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
  await loadGroups();
  if(myGroups.length===0){
    sec.innerHTML = `<div class="friends-empty">üë•<br>ÏïÑÏßÅ ÏÜçÌïú Í∑∏Î£πÏù¥ ÏóÜÏñ¥Ïöî.<br>Ïñ¥ÎìúÎØºÏóêÍ≤å Í∑∏Î£π Î∞∞Ï†ïÏùÑ ÏöîÏ≤≠Ìï¥Î≥¥ÏÑ∏Ïöî!</div>`;
    return;
  }
  // Í∑∏Î£πÏõê Î™©Î°ù (ÎÇò Ï†úÏô∏, Ï§ëÎ≥µ Ï†úÍ±∞)
  const memberIds = [...new Set(myGroups.flatMap(g=>g.members))].filter(id=>id!==currentUser.id);
  if(memberIds.length===0){
    sec.innerHTML = `<div class="friends-empty">üë•<br>Í∞ôÏùÄ Í∑∏Î£πÏóê ÏπúÍµ¨Í∞Ä ÏóÜÏñ¥Ïöî.</div>`;
    return;
  }
  // ÏπúÍµ¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  const usersSnap = await get(ref(db,'users'));
  const dashSnap = await get(ref(db,'dashboards'));
  const allUsers = usersSnap.exists() ? usersSnap.val() : {};
  const allDash = dashSnap.exists() ? dashSnap.val() : {};
  friendsData = {};
  memberIds.forEach(id=>{ friendsData[id]={user:allUsers[id]||{name:id}, dash:allDash[id]||{}}; });

  const now = new Date();
  const curY=now.getFullYear(), curM=now.getMonth()+1;

  const cards = memberIds.map(id=>{
    const {user,dash} = friendsData[id];
    const completions = dash.completions||{};
    const goals = (dash.goals||[]).filter(g=>g&&g.unit&&g.unit!=='once');
    let td=0,tm=0;
    goals.forEach((g,gi)=>{
      const mg=migrateGoal(g);
      const mod=goalModulus(mg,gi,curY,curM);
      const pfx=`g${gi}_${curY}_${curM}_`;
      const done=Object.entries(completions).filter(([k,v])=>k.startsWith(pfx)&&v===true).length;
      td+=done; tm+=mod;
    });
    const pct = tm>0?Math.min(100,Math.round(td/tm*100)):0;
    const stage = Math.min(9,Math.floor(pct/10));
    const isActive = activeFriendId===id;
    return `<div class="friend-card ${isActive?'active':''}" onclick="toggleFriendDetail('${id}')">
      <div class="friend-avatar">${AVATARS[stage]}</div>
      <div class="friend-info">
        <div class="friend-name">${esc(user.name||id)}</div>
        <div class="friend-stage">${stage+1}Îã®Í≥Ñ ¬∑ ${STAGE_NAMES[stage]}</div>
      </div>
      <div class="friend-pct">${pct}%</div>
    </div>
    ${isActive ? buildFriendDetail(id) : ''}`;
  }).join('');

  sec.innerHTML = `<div class="friend-list">${cards}</div>`;
}

window.toggleFriendDetail = function(id) {
  if(activeFriendId===id){ activeFriendId=null; activeFriendGoalIdx=null; }
  else { activeFriendId=id; activeFriendGoalIdx=null; }
  renderFriendsTab();
};

function buildFriendDetail(id) {
  const {user,dash} = friendsData[id];
  const goals = (dash.goals||[]);
  const now = new Date();
  const curY=now.getFullYear(), curM=now.getMonth()+1;
  const completions = dash.completions||{};

  const goalBtns = goals.map((g,gi)=>{
    if(!g||!g.title||!g.unit||g.unit==='once') return '';
    const mg=migrateGoal(g);
    const mod=goalModulus(mg,gi,curY,curM);
    const pfx=`g${gi}_${curY}_${curM}_`;
    const done=Object.entries(completions).filter(([k,v])=>k.startsWith(pfx)&&v===true).length;
    const pct=mod>0?Math.min(100,Math.round(done/mod*100)):0;
    const isActive=activeFriendGoalIdx===gi;
    return `<div class="fgoal-btn ${isActive?'fg-active':''}" onclick="selectFriendGoal('${id}',${gi})">
      <div class="fgoal-name">${esc(g.title)}</div>
      <div class="fgoal-pct">${pct}%</div>
      <div class="fgoal-bar"><div class="fgoal-bar-fill" style="width:${pct}%"></div></div>
    </div>`;
  }).filter(Boolean).join('');

  let calAndCheer = '';
  if(activeFriendGoalIdx!==null) {
    const g = goals[activeFriendGoalIdx];
    if(g&&g.unit&&g.unit!=='once') {
      calAndCheer = buildROCal(id, activeFriendGoalIdx, g, completions, curY, curM)
                  + buildCheerBox(id, activeFriendGoalIdx);
    }
  }

  return `<div class="friend-detail">
    <div class="friend-detail-hdr">
      <div class="friend-detail-name">üëÄ ${esc(user.name||id)}Ïùò Î™©Ìëú</div>
    </div>
    <div class="fgoal-grid">${goalBtns||'<div style="color:var(--text-dim);font-size:12px;grid-column:1/-1;">Îì±Î°ùÎêú Î™©Ìëú ÏóÜÏùå</div>'}</div>
    ${calAndCheer}
  </div>`;
}

function buildROCal(friendId, gi, g, completions, y, m) {
  const now=new Date();
  const firstDay=new Date(y,m-1,1).getDay();
  const dim=new Date(y,m,0).getDate();
  const DAY=['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'];
  let cells='';
  for(let i=0;i<firstDay;i++) cells+=`<div class="rocal-cell empty"></div>`;
  for(let d=1;d<=dim;d++){
    const dt=new Date(y,m-1,d);
    const isToday=dt.toDateString()===now.toDateString();
    const isDone=completions[`g${gi}_${y}_${m}_${d}`]===true;
    cells+=`<div class="rocal-cell ${isDone?'done':''} ${isToday?'today':''}">${isDone?'‚úì':d}</div>`;
  }
  return `<div class="rocal-wrap">
    <div class="rocal-label">${y}ÎÖÑ ${m}Ïõî Îã¨Î†•</div>
    <div class="rocal-days">${DAY.map(d=>`<div class="rocal-day">${d}</div>`).join('')}</div>
    <div class="rocal-grid">${cells}</div>
  </div>`;
}

function buildCheerItem(c) {
  const dt = c.at ? new Date(c.at).toLocaleDateString('ko-KR',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
  return `<div class="cheer-item">
    <div class="cheer-body">
      <div class="cheer-from">${esc(c.fromName||c.from)}</div>
      <div class="cheer-text">${esc(c.text||'')}</div>
      <div class="cheer-time">${dt}</div>
    </div>
  </div>`;
}

function buildCheerBox(targetId, gi) {
  const cheers = window._cheerCache?.[`${targetId}_${gi}`] || [];
  const cheerItems = cheers.length===0
    ? '<div style="color:var(--text-dim);font-size:12px;text-align:center;padding:8px 0;">ÏïÑÏßÅ ÏùëÏõêÏù¥ ÏóÜÏñ¥Ïöî. Ï≤´ ÏùëÏõêÏùÑ Î≥¥ÎÇ¥Î≥¥ÏÑ∏Ïöî!</div>'
    : cheers.slice().reverse().map(buildCheerItem).join('');
  return `<div class="cheer-box">
    <div class="cheer-box-title">üí¨ ÏùëÏõê Î©îÏãúÏßÄ</div>
    <div class="cheer-list" id="cheerList_${targetId}_${gi}">${cheerItems}</div>
    <div class="cheer-input-row">
      <input class="cheer-text-input" id="cheerInput_${targetId}_${gi}" placeholder="ÏùëÏõê ÌïúÎßàÎîî... (Ïù¥Î™®ÏßÄÎèÑ Í∞ÄÎä• üòä)" maxlength="60">
      <button class="cheer-send-btn" onclick="sendCheer('${targetId}',${gi})">Î≥¥ÎÇ¥Í∏∞</button>
    </div>
  </div>`;
}

// ===== ÎÇ¥ Î™©Ìëú ÎåìÍ∏Ä Ïä§ÏôÄÏù¥ÌîÑ =====
async function renderMyCheers(panel, gi) {
  // Îç∞Ïù¥ÌÑ∞ Î°úÎìú
  await loadCheers(currentUser.id, gi);
  const cheers = (window._cheerCache?.[`${currentUser.id}_${gi}`] || [])
    .slice().sort((a,b)=> (b.at||'').localeCompare(a.at||''));

  // Í∏∞Ï°¥ ÏòÅÏó≠ Ï†úÍ±∞ ÌõÑ Ïû¨ÏÇΩÏûÖ
  const existing = panel.querySelector('.my-cheers-section');
  if(existing) existing.remove();

  const section = document.createElement('div');
  section.className = 'my-cheers-section';

  if(cheers.length === 0) {
    section.innerHTML = `<div class="my-cheers-title">üí¨ Î∞õÏùÄ ÏùëÏõê</div>
      <div class="my-cheers-empty">ÏïÑÏßÅ Î∞õÏùÄ ÏùëÏõêÏù¥ ÏóÜÏñ¥Ïöî<br>ÏπúÍµ¨ÏóêÍ≤å Î™©ÌëúÎ•º Í≥µÏú†Ìï¥Î≥¥ÏÑ∏Ïöî!</div>`;
    panel.appendChild(section);
    return;
  }

  // 5Í∞úÏî© ÌéòÏù¥ÏßÄ Î∂ÑÌï†
  const PAGE_SIZE = 5;
  const pages = [];
  for(let i=0; i<cheers.length; i+=PAGE_SIZE) pages.push(cheers.slice(i, i+PAGE_SIZE));
  let curPage = 0;

  function buildPages() {
    return pages.map((page, pi) => {
      const items = page.map(c => {
        const dt = c.at ? new Date(c.at).toLocaleDateString('ko-KR',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : '';
        return `<div class="my-cheer-card">
          <div class="my-cheer-from">${esc(c.fromName||c.from)}</div>
          <div class="my-cheer-text">${esc(c.text||'')}</div>
          <div class="my-cheer-time">${dt}</div>
        </div>`;
      }).join('');
      return `<div class="my-cheer-page">${items}</div>`;
    }).join('');
  }

  function buildDots() {
    return pages.map((_,i) =>
      `<div class="my-cheers-dot ${i===curPage?'active':''}" onclick="window._cheerGoPage(${gi},${i})"></div>`
    ).join('');
  }

  section.innerHTML = `<div class="my-cheers-title">üí¨ Î∞õÏùÄ ÏùëÏõê (${cheers.length}Í∞ú)</div>
    <div class="my-cheers-slider" id="cheerSlider_${gi}">
      <div class="my-cheers-track" id="cheerTrack_${gi}">${buildPages()}</div>
    </div>
    <div class="my-cheers-dots" id="cheerDots_${gi}">${buildDots()}</div>`;

  panel.appendChild(section);

  // Ïä§ÏôÄÏù¥ÌîÑ Ïù¥Î≤§Ìä∏
  const slider = section.querySelector(`#cheerSlider_${gi}`);
  const track = section.querySelector(`#cheerTrack_${gi}`);
  let startX = 0, isDragging = false;

  function goPage(p) {
    curPage = Math.max(0, Math.min(pages.length-1, p));
    track.style.transform = `translateX(-${curPage*100}%)`;
    section.querySelector(`#cheerDots_${gi}`).innerHTML = buildDots();
  }
  window._cheerGoPage = (gIdx, p) => { if(gIdx===gi) goPage(p); };

  slider.addEventListener('touchstart', e=>{ startX=e.touches[0].clientX; isDragging=true; }, {passive:true});
  slider.addEventListener('touchend', e=>{
    if(!isDragging) return;
    const dx = e.changedTouches[0].clientX - startX;
    if(dx < -40) goPage(curPage+1);
    else if(dx > 40) goPage(curPage-1);
    isDragging=false;
  }, {passive:true});

  // ÎßàÏö∞Ïä§ ÎìúÎûòÍ∑∏ÎèÑ ÏßÄÏõê
  slider.addEventListener('mousedown', e=>{ startX=e.clientX; isDragging=true; });
  slider.addEventListener('mouseup', e=>{
    if(!isDragging) return;
    const dx = e.clientX - startX;
    if(dx < -40) goPage(curPage+1);
    else if(dx > 40) goPage(curPage-1);
    isDragging=false;
  });
}


window.selectFriendGoal = async function(friendId, gi) {
  activeFriendGoalIdx = activeFriendGoalIdx===gi ? null : gi;
  // ÏùëÏõê Îç∞Ïù¥ÌÑ∞ ÎØ∏Î¶¨ Î°úÎìú
  if(activeFriendGoalIdx!==null) await loadCheers(friendId, gi);
  renderFriendsTab();
};

async function loadCheers(targetId, gi) {
  if(!window._cheerCache) window._cheerCache={};
  const snap = await get(ref(db,`cheers/${targetId}/${gi}`));
  window._cheerCache[`${targetId}_${gi}`] = snap.exists() ? Object.values(snap.val()) : [];
}

// ÏùΩÏùå Ï≤òÎ¶¨ - ÎÇ¥ Î™©ÌëúÏùò ÏùëÏõêÏùÑ ÌôïÏù∏ÌñàÏùÑ Îïå
async function markCheerRead(goalIdx) {
  if(!currentUser) return;
  await set(ref(db,`reads/${currentUser.id}/${goalIdx}`), new Date().toISOString());
}

// ÎÇ¥ Î™©ÌëúÏóê ÏùΩÏßÄ ÏïäÏùÄ ÏùëÏõêÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
async function checkUnreadCheers() {
  if(!currentUser) return;
  const goals = localDash.goals || [];
  const readsSnap = await get(ref(db,`reads/${currentUser.id}`));
  const reads = readsSnap.exists() ? readsSnap.val() : {};
  for(let gi=0; gi<goals.length; gi++) {
    const g = goals[gi];
    if(!g||!g.title) continue;
    const cheerSnap = await get(ref(db,`cheers/${currentUser.id}/${gi}`));
    if(!cheerSnap.exists()) continue;
    const cheers = Object.values(cheerSnap.val());
    const lastRead = reads[gi] || '1970-01-01T00:00:00.000Z';
    const hasUnread = cheers.some(c => c.at && c.at > lastRead);
    const btn = document.querySelector(`.goal-btn[data-gi="${gi}"]`);
    if(btn) btn.classList.toggle('has-unread', hasUnread);
  }
}

window.sendCheer = async function(targetId, gi) {
  const inputEl = document.getElementById(`cheerInput_${targetId}_${gi}`);
  const text = inputEl ? inputEl.value.trim() : '';
  if(!text){ showToast('‚ùå ÏùëÏõê Î©îÏãúÏßÄÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'); return; }
  const key = Date.now().toString();
  const cheer = { from:currentUser.id, fromName:currentUser.name||currentUser.id, text, at:new Date().toISOString() };
  await set(ref(db,`cheers/${targetId}/${gi}/${key}`), cheer);
  await loadCheers(targetId, gi);
  showToast('üíå ÏùëÏõêÏùÑ Î≥¥ÎÉàÏñ¥Ïöî!');
  const cheers = window._cheerCache[`${targetId}_${gi}`];
  const listEl = document.getElementById(`cheerList_${targetId}_${gi}`);
  if(listEl) listEl.innerHTML = cheers.slice().reverse().map(buildCheerItem).join('');
  if(inputEl) inputEl.value='';
};

// ===== ADMIN GROUP =====
window.createGroup = async function() {
  const name = document.getElementById('newGroupName').value.trim();
  if(!name){ showToast('‚ùå Í∑∏Î£π Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî'); return; }
  const key = 'g'+Date.now();
  await set(ref(db,`groups/${key}`),{name, members:{}});
  document.getElementById('newGroupName').value='';
  showToast(`‚úÖ "${name}" Í∑∏Î£π ÏÉùÏÑ± ÏôÑÎ£å!`);
  renderAdminGroups();
};

async function renderAdminGroups() {
  const el = document.getElementById('adminGroupList');
  if(!el) return;
  try {
    const [groupSnap, userSnap] = await Promise.all([get(ref(db,'groups')), get(ref(db,'users'))]);
    const allUsers = userSnap.exists() ? Object.entries(userSnap.val()).filter(([,u])=>u.role!=='admin') : [];
    if(!groupSnap.exists()){ el.innerHTML='<div style="color:var(--text-dim);font-size:13px;">ÏÉùÏÑ±Îêú Í∑∏Î£π ÏóÜÏùå</div>'; return; }
    const groups = Object.entries(groupSnap.val());
    el.innerHTML = groups.map(([gid,g])=>{
      const members = g.members ? Object.entries(g.members) : [];
      const memberRows = members.map(([mk,uid])=>{
        const u = allUsers.find(([id])=>id===uid);
        const name = u ? u[1].name : uid;
        return `<div class="group-member-row">
          <div class="group-member-name">${esc(name)}</div>
          <div class="group-member-id">@${esc(uid)}</div>
          <button class="group-remove-btn" onclick="removeGroupMember('${gid}','${mk}')">Ï†úÍ±∞</button>
        </div>`;
      }).join('');
      const addOptions = allUsers.filter(([uid])=>!members.some(([,m])=>m===uid))
        .map(([uid,u])=>`<option value="${uid}">${esc(u.name)} (@${uid})</option>`).join('');
      return `<div class="group-card">
        <div class="group-card-hdr">
          <div class="group-card-name">üìÅ ${esc(g.name)}</div>
          <button class="group-remove-btn" onclick="deleteGroup('${gid}')">Í∑∏Î£π ÏÇ≠Ï†ú</button>
        </div>
        <div class="group-member-list">
          ${memberRows || '<div style="color:var(--text-dim);font-size:12px;">Î©§Î≤Ñ ÏóÜÏùå</div>'}
        </div>
        ${addOptions ? `<select class="group-add-select" id="groupAddSel_${gid}" onchange="addGroupMember('${gid}')">
          <option value="">+ Î©§Î≤Ñ Ï∂îÍ∞Ä...</option>${addOptions}
        </select>` : ''}
      </div>`;
    }).join('');
  } catch(e) {
    el.innerHTML = `<div style="color:var(--danger);font-size:13px;">‚ùå Í∑∏Î£π Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: ${esc(e.message)}</div>`;
    console.error('renderAdminGroups error:', e);
  }
}

window.addGroupMember = async function(gid) {
  const sel = document.getElementById(`groupAddSel_${gid}`);
  const uid = sel ? sel.value : '';
  if(!uid) return;
  const key = uid.replace(/[^a-zA-Z0-9_]/g,'_');
  await set(ref(db,`groups/${gid}/members/${key}`), uid);
  showToast('‚úÖ Î©§Î≤Ñ Ï∂îÍ∞Ä ÏôÑÎ£å!');
  renderAdminGroups();
};

window.removeGroupMember = async function(gid, mk) {
  await set(ref(db,`groups/${gid}/members/${mk}`), null);
  showToast('‚úÖ Î©§Î≤Ñ Ï†úÍ±∞ ÏôÑÎ£å!');
  renderAdminGroups();
};

window.deleteGroup = async function(gid) {
  await set(ref(db,`groups/${gid}`), null);
  showToast('üóëÔ∏è Í∑∏Î£π ÏÇ≠Ï†ú ÏôÑÎ£å!');
  renderAdminGroups();
};

// ===== NOTICE =====
let _noticeTarget = 'all';

function setNoticeTarget(type) {
  _noticeTarget = type;
  ['all','group','user'].forEach(t => {
    document.getElementById(`noticeTarget${t.charAt(0).toUpperCase()+t.slice(1)}`)
      ?.classList.toggle('active', t===type);
  });
  const detail = document.getElementById('noticeTargetDetail');
  if(type === 'all') {
    detail.style.display = 'none';
    detail.innerHTML = '';
    return;
  }
  detail.style.display = 'block';
  renderNoticeTargetDetail(type);
}
window.setNoticeTarget = setNoticeTarget;

async function renderNoticeTargetDetail(type) {
  const detail = document.getElementById('noticeTargetDetail');
  detail.innerHTML = '<div style="font-size:12px;color:var(--text-dim);padding:8px 0;">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
  if(type === 'user') {
    const snap = await get(ref(db,'users'));
    if(!snap.exists()){ detail.innerHTML='<div style="font-size:12px;color:var(--text-dim);">Ïú†Ï†Ä ÏóÜÏùå</div>'; return; }
    const users = Object.entries(snap.val());
    detail.innerHTML = `<select class="admin-notice-select" id="noticeTargetUserId">
      <option value="">-- Ïú†Ï†Ä ÏÑ†ÌÉù --</option>
      ${users.map(([id,u])=>`<option value="${esc(id)}">${esc(u.name)} (@${esc(id)})</option>`).join('')}
    </select>`;
  } else {
    const snap = await get(ref(db,'groups'));
    if(!snap.exists()){ detail.innerHTML='<div style="font-size:12px;color:var(--text-dim);">Í∑∏Î£π ÏóÜÏùå</div>'; return; }
    const groups = Object.entries(snap.val());
    detail.innerHTML = `<select class="admin-notice-select" id="noticeTargetGroupId">
      <option value="">-- Í∑∏Î£π ÏÑ†ÌÉù --</option>
      ${groups.map(([id,g])=>`<option value="${esc(id)}">${esc(g.name)}</option>`).join('')}
    </select>`;
  }
}

window.submitNotice = async function() {
  const title = document.getElementById('noticeTitle').value.trim();
  if(!title){ showToast('‚ùå Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî'); return; }
  const desc = document.getElementById('noticeDesc').value.trim();
  const img = document.getElementById('noticeImg').value.trim();

  let target = { type: _noticeTarget };
  if(_noticeTarget === 'user') {
    const uid = document.getElementById('noticeTargetUserId')?.value;
    if(!uid){ showToast('‚ùå Ïú†Ï†ÄÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî'); return; }
    target.id = uid;
  } else if(_noticeTarget === 'group') {
    const gid = document.getElementById('noticeTargetGroupId')?.value;
    if(!gid){ showToast('‚ùå Í∑∏Î£πÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî'); return; }
    target.id = gid;
  }

  const noticeId = `notice_${Date.now()}`;
  const notice = { title, desc, img, target, createdAt: Date.now(), createdBy: currentUser.id };
  await set(ref(db, `notices/${noticeId}`), notice);
  showToast('‚úÖ Í≥µÏßÄ Ï∂îÍ∞Ä ÏôÑÎ£å!');

  // Ìèº Ï¥àÍ∏∞Ìôî
  document.getElementById('noticeTitle').value = '';
  document.getElementById('noticeDesc').value = '';
  document.getElementById('noticeImg').value = '';
  setNoticeTarget('all');
  renderAdminNoticeList();
};

async function renderAdminNoticeList() {
  const el = document.getElementById('adminNoticeList');
  if(!el) return;
  el.innerHTML = '<div style="font-size:12px;color:var(--text-dim);padding:8px 0;">Î∂àÎü¨Ïò§Îäî Ï§ë...</div>';
  const snap = await get(ref(db,'notices'));
  if(!snap.exists()){ el.innerHTML='<div style="font-size:12px;color:var(--text-dim);padding:8px 0;">Îì±Î°ùÎêú Í≥µÏßÄ ÏóÜÏùå</div>'; return; }
  const notices = Object.entries(snap.val()).sort((a,b)=>b[1].createdAt-a[1].createdAt);
  el.innerHTML = notices.map(([id,n])=>{
    const d = new Date(n.createdAt);
    const dateStr = `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
    const targetStr = n.target?.type==='all' ? 'Ï†ÑÏ≤¥' : n.target?.type==='group' ? `Í∑∏Î£π:${n.target.id}` : `Ïú†Ï†Ä:${n.target.id}`;
    return `<div class="notice-card">
      <div class="notice-card-info">
        <div class="notice-card-title">${esc(n.title)}</div>
        <div class="notice-card-meta">${dateStr} ¬∑ ${targetStr}</div>
      </div>
      <button class="notice-card-del" onclick="deleteNotice('${id}')">ÏÇ≠Ï†ú</button>
    </div>`;
  }).join('');
}

window.deleteNotice = async function(id) {
  await set(ref(db,`notices/${id}`), null);
  showToast('üóëÔ∏è Í≥µÏßÄ ÏÇ≠Ï†ú ÏôÑÎ£å!');
  renderAdminNoticeList();
  loadNoticeBanner();
};

// ÎåÄÏãúÎ≥¥Îìú Îù†Î∞∞ÎÑà - ÎÇ¥ Í≥µÏßÄ Î°úÎìú
async function loadNoticeBanner() {
  const banner = document.getElementById('noticeBanner');
  const bannerTitle = document.getElementById('noticeBannerTitle');
  if(!banner || !currentUser) return;

  const snap = await get(ref(db,'notices'));
  if(!snap.exists()){ banner.classList.remove('visible'); return; }

  const now = Date.now();
  const uid = currentUser.id;

  // Í∑∏Î£π Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞ (ÏÜåÏÜç Í∑∏Î£π ÌôïÏù∏Ïö©)
  const grpSnap = await get(ref(db,'groups'));
  const myGroups = [];
  if(grpSnap.exists()){
    Object.entries(grpSnap.val()).forEach(([gid,g])=>{
      if(g.members && Object.values(g.members).includes(uid)) myGroups.push(gid);
    });
  }

  // ÎÇòÏóêÍ≤å Ìï¥ÎãπÌïòÎäî Í≥µÏßÄ ÌïÑÌÑ∞ÎßÅ (ÏµúÏã† 1Í∞ú)
  const notices = Object.entries(snap.val())
    .map(([id,n])=>({id,...n}))
    .filter(n => {
      if(!n.target) return true;
      if(n.target.type==='all') return true;
      if(n.target.type==='user') return n.target.id===uid;
      if(n.target.type==='group') return myGroups.includes(n.target.id);
      return false;
    })
    .sort((a,b)=>b.createdAt-a.createdAt);

  if(notices.length===0){ banner.classList.remove('visible'); return; }

  const latest = notices[0];

  // Ïù¥ÎØ∏ ÌÅ¥Î¶≠Ìïú Í≥µÏßÄÏù∏ÏßÄ ÌôïÏù∏
  const readKey = `notice_read_${latest.id}_${uid}`;
  if(localStorage.getItem(readKey)){ banner.classList.remove('visible'); return; }

  // Î∞∞ÎÑà ÌëúÏãú
  bannerTitle.textContent = latest.title;
  banner._noticeId = latest.id;
  banner._noticeData = latest;
  banner.classList.add('visible');
}

function openNoticeModal() {
  const banner = document.getElementById('noticeBanner');
  const n = banner._noticeData;
  if(!n) return;

  const d = new Date(n.createdAt);
  const dateStr = `${d.getFullYear()}ÎÖÑ ${d.getMonth()+1}Ïõî ${d.getDate()}Ïùº`;

  const body = document.getElementById('noticeModalBody');
  body.innerHTML = `
    <div class="notice-modal-title">${esc(n.title)}</div>
    <div class="notice-modal-date">üìÖ ${dateStr}</div>
    ${n.img ? `<img class="notice-modal-img" src="${esc(n.img)}" alt="Í≥µÏßÄ Ïù¥ÎØ∏ÏßÄ" onerror="this.style.display='none'">` : ''}
    ${n.desc ? `<div class="notice-modal-desc">${esc(n.desc)}</div>` : ''}
  `;

  document.getElementById('noticeModalOverlay').classList.add('open');

  // ÏùΩÏùå Ï≤òÎ¶¨ ‚Üí Î∞∞ÎÑà Ïà®ÍπÄ
  const readKey = `notice_read_${n.id}_${currentUser.id}`;
  localStorage.setItem(readKey, '1');
  banner.classList.remove('visible');
}
window.openNoticeModal = openNoticeModal;

function closeNoticeModal() {
  document.getElementById('noticeModalOverlay').classList.remove('open');
}
window.closeNoticeModal = closeNoticeModal;
</script>
<script>
(function(){
  const canvas = document.getElementById('loginCanvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const EMOJIS = ['üê£','üê•','üê¢','ü¶ã','üå±','‚≠ê','‚ú®','üî•','üí™','üéØ','üèÜ','üåü'];
  let W, H, particles=[], floaters=[];

  function resize(){
    W=canvas.width=window.innerWidth;
    H=canvas.height=window.innerHeight;
  }
  window.addEventListener('resize', resize);
  resize();

  // Îñ†Îã§ÎãàÎäî Ïù¥Î™®ÏßÄ ÌååÌã∞ÌÅ¥
  class Floater {
    constructor(){this.reset(true);}
    reset(init=false){
      this.x = Math.random()*W;
      this.y = init ? Math.random()*H : H+40;
      this.emoji = EMOJIS[Math.floor(Math.random()*EMOJIS.length)];
      this.size = 16 + Math.random()*20;
      this.speedY = 0.3 + Math.random()*0.5;
      this.speedX = (Math.random()-0.5)*0.4;
      this.opacity = 0.12 + Math.random()*0.18;
      this.rot = (Math.random()-0.5)*0.04;
      this.angle = Math.random()*Math.PI*2;
      this.wobble = 0.3 + Math.random()*0.5;
    }
    update(){
      this.y -= this.speedY;
      this.x += Math.sin(this.angle)*this.wobble + this.speedX;
      this.angle += 0.02;
      if(this.y < -50) this.reset();
    }
    draw(){
      ctx.save();
      ctx.globalAlpha = this.opacity;
      ctx.font = `${this.size}px serif`;
      ctx.textAlign='center';
      ctx.textBaseline='middle';
      ctx.translate(this.x, this.y);
      ctx.rotate(this.angle*0.1);
      ctx.fillText(this.emoji, 0, 0);
      ctx.restore();
    }
  }

  // Î∞òÏßùÏù¥Îäî Ï†ê ÌååÌã∞ÌÅ¥
  class Spark {
    constructor(){this.reset(true);}
    reset(init=false){
      this.x=Math.random()*W;
      this.y=init?Math.random()*H:Math.random()*H;
      this.r=0.5+Math.random()*1.5;
      this.opacity=0;
      this.maxOp=0.15+Math.random()*0.25;
      this.phase=Math.random()*Math.PI*2;
      this.speed=0.02+Math.random()*0.03;
      const colors=['#1952f5','#6b8fff','#ff5e7d','#a78bfa','#34d399'];
      this.color=colors[Math.floor(Math.random()*colors.length)];
    }
    update(){
      this.phase+=this.speed;
      this.opacity=this.maxOp*Math.abs(Math.sin(this.phase));
    }
    draw(){
      ctx.save();
      ctx.globalAlpha=this.opacity;
      ctx.beginPath();
      ctx.arc(this.x,this.y,this.r,0,Math.PI*2);
      ctx.fillStyle=this.color;
      ctx.fill();
      ctx.restore();
    }
  }

  // ÎßàÏö∞Ïä§/ÌÑ∞Ïπò Ïù∏ÌÑ∞ÎûôÏÖò - ÌÅ¥Î¶≠ÌïòÎ©¥ Ïù¥Î™®ÏßÄ ÌÑ∞Ïßê
  function burst(cx,cy){
    for(let i=0;i<6;i++){
      const f=new Floater();
      f.x=cx; f.y=cy;
      f.speedY=1+Math.random()*2;
      f.speedX=(Math.random()-0.5)*3;
      f.opacity=0.6;
      f.size=20+Math.random()*16;
      floaters.push(f);
    }
  }
  canvas.addEventListener('click',e=>burst(e.clientX,e.clientY));
  canvas.style.pointerEvents='auto';

  // Ï¥àÍ∏∞ ÏÉùÏÑ±
  for(let i=0;i<18;i++) floaters.push(new Floater());
  for(let i=0;i<60;i++) particles.push(new Spark());

  let animId;
  function loop(){
    ctx.clearRect(0,0,W,H);
    particles.forEach(p=>{p.update();p.draw();});
    floaters.forEach(f=>{f.update();f.draw();});
    // Ï¥ù floater Ïàò Ïú†ÏßÄ
    while(floaters.length>40) floaters.shift();
    animId=requestAnimationFrame(loop);
  }
  loop();

  // Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ Î≤óÏñ¥ÎÇòÎ©¥ Ïï†Îãà Î©àÏ∂§
  const obs=new MutationObserver(()=>{
    const ls=document.getElementById('loginScreen');
    if(ls&&ls.classList.contains('active')) {
      if(!animId) loop();
    } else {
      cancelAnimationFrame(animId); animId=null;
    }
  });
  obs.observe(document.body,{subtree:true,attributes:true,attributeFilter:['class']});
})();
</script>
</body>
</html>
